<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Rsync 备份服务 | Prous</title><meta name="description" content="RSYNC + 全网备份RSYNC&#x3D;Remote Sync 远程同步 高效，一定要结合 shell官方网站：https:&#x2F;&#x2F;rsync.samba.org&#x2F;Author： Andrew Tridgell, Wayne Davison, and othersAndrew Tridgell 是 Samba 项目的领导者和主要开发人员，同时还在参与开发 rsync、Linux Kernel。rsync"><meta name="keywords" content="Rsync备份"><meta name="author" content="Prous"><meta name="copyright" content="Prous"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="http://yoursite.com/2019/02/11/rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="Rsync 备份服务"><meta property="og:url" content="http://yoursite.com/2019/02/11/rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1/"><meta property="og:site_name" content="Prous"><meta property="og:description" content="RSYNC + 全网备份RSYNC&#x3D;Remote Sync 远程同步 高效，一定要结合 shell官方网站：https:&#x2F;&#x2F;rsync.samba.org&#x2F;Author： Andrew Tridgell, Wayne Davison, and othersAndrew Tridgell 是 Samba 项目的领导者和主要开发人员，同时还在参与开发 rsync、Linux Kernel。rsync"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg"><meta property="article:published_time" content="2019-02-11T11:24:00.000Z"><meta property="article:modified_time" content="2020-08-02T12:40:46.656Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-02 20:40:46'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://www.kococ.cn/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">62</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">59</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RSYNC-%E5%85%A8%E7%BD%91%E5%A4%87%E4%BB%BD"><span class="toc-number">1.</span> <span class="toc-text">RSYNC + 全网备份</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Rysnc-%E7%89%B9%E6%80%A7%E5%92%8C%E4%BC%98%E7%82%B9"><span class="toc-number">2.</span> <span class="toc-text">Rysnc 特性和优点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%A4%87%E4%BB%BD%E5%88%86%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">常见备份分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%AB%AF%E5%8F%A3"><span class="toc-number">2.2.</span> <span class="toc-text">运行模式和端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E8%B5%B7%E7%AB%AF%E5%92%8C%E5%A4%87%E4%BB%BD%E6%BA%90"><span class="toc-number">2.3.</span> <span class="toc-text">发起端和备份源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text">数据同步方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xinetd-%E7%AE%A1%E7%90%86-Rsync-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.5.</span> <span class="toc-text">Xinetd 管理 Rsync 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E7%A8%8B%E5%BA%8F%E5%8A%9F%E8%83%BD-1-vs-4"><span class="toc-number">2.6.</span> <span class="toc-text">rsync 程序功能: 1 vs 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.7.</span> <span class="toc-text">rsync 命令的工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E6%9C%8D%E5%8A%A1%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-YUM"><span class="toc-number">2.8.</span> <span class="toc-text">rsync 服务守护进程方式部署流程 (YUM)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E6%A8%A1%E5%BC%8F%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE%E5%8E%9F%E7%90%86-centos7-rsync-3-1-2"><span class="toc-number">2.9.</span> <span class="toc-text">rsync 守护进程模式传输数据原理 (centos7 rsync - 3.1.2)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%85%8D%E4%BA%A4%E4%BA%92%E4%BC%A0%E8%BE%93%E6%95%B0%E6%8D%AE"><span class="toc-number">2.10.</span> <span class="toc-text">如何实现免交互传输数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">2.11.</span> <span class="toc-text">rsync 命令参数说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E6%8E%92%E9%99%A4%E5%8A%9F%E8%83%BD-%E8%BF%87%E6%BB%A4"><span class="toc-number">2.12.</span> <span class="toc-text">rsync 服务实现备份数据排除功能 (过滤)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-66-%E5%AE%9E%E6%88%98%E5%86%85%E5%AE%B9"><span class="toc-number">3.</span> <span class="toc-text">6.66 实战内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A8%E9%80%81-backup-%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%89%80%E6%9C%89%E5%86%85%E5%AE%B9%E8%87%B3-Rsync-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.1.</span> <span class="toc-text">6.1 客户端推送 backup 目录下所有内容至 Rsync 服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8B%89%E5%8F%96-Rsync-%E6%9C%8D%E5%8A%A1%E7%AB%AF-backup-%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E8%87%B3%E6%9C%AC%E5%9C%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84-backup-%E7%9B%AE%E5%BD%95"><span class="toc-number">3.2.</span> <span class="toc-text">6.2 客户端拉取 Rsync 服务端 backup 模块数据至本地客户端的 &#x2F;backup 目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-Rsync-%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E6%97%A0%E5%B7%AE%E5%BC%82%E5%90%8C%E6%AD%A5"><span class="toc-number">3.3.</span> <span class="toc-text">6.3 Rsync 实现数据无差异同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-Rsync-%E7%9A%84-Limit-%E9%99%90%E9%80%9F"><span class="toc-number">3.4.</span> <span class="toc-text">6.4 Rsync 的 Limit 限速</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-77-%E5%85%A8%E7%BD%91%E5%A4%87%E4%BB%BD%E6%A1%88%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">7.77 全网备份案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%9C%80%E6%B1%82%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">7.1 客户端需求：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E4%BB%BB%E5%8A%A1-%E6%8B%86%E8%A7%A3"><span class="toc-number">4.2.</span> <span class="toc-text">7.2 任务 拆解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%8E%A8%E9%80%81"><span class="toc-number">4.3.</span> <span class="toc-text">7.3 推送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%9C%80%E6%B1%82%EF%BC%9A"><span class="toc-number">4.4.</span> <span class="toc-text">7.4 服务端需求：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">4.5.</span> <span class="toc-text">7.5 服务端步骤：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%9C%80%E8%A6%81%E6%AF%8F%E5%A4%A9%E9%82%AE%E4%BB%B6%E6%A0%A1%E9%AA%8C%E7%9A%84%E7%BB%93%E6%9E%9C%E9%80%9A%E7%9F%A5%E7%BB%99%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">4.6.</span> <span class="toc-text">服务端需要每天邮件校验的结果通知给管理员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B1%87%E6%80%BB"><span class="toc-number">4.7.</span> <span class="toc-text">第八章 配置文件汇总</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%84%9A%E6%9C%AC%EF%BC%9A"><span class="toc-number">4.8.</span> <span class="toc-text">8.1 客户端脚本：</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Prous</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Rsync 备份服务</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-02-11T11:24:00.000Z" title="发表于 2019-02-11 19:24:00">2019-02-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-02T12:40:46.656Z" title="更新于 2020-08-02 20:40:46">2020-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux%E5%9F%BA%E7%A1%80/">Linux基础</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="https://cdn.jsdelivr.net/gh/xoxoyun/MCDN/usr/uploads/2020/%E8%83%8C%E6%99%AF%E5%9B%BE%E5%BA%93/5.jpg" alt="此图像的alt属性为空；文件名为4.jpg"></p>
<h1 id="RSYNC-全网备份"><a href="#RSYNC-全网备份" class="headerlink" title="RSYNC + 全网备份"></a>RSYNC + 全网备份</h1><p>RSYNC=Remote Sync 远程同步 高效，一定要结合 shell<br>官方网站：<a target="_blank" rel="noopener" href="https://rsync.samba.org/">https://rsync.samba.org/</a><br>Author： Andrew Tridgell, Wayne Davison, and others<br>Andrew Tridgell 是 Samba 项目的领导者和主要开发人员，同时还在参与开发 rsync、Linux Kernel。<br><code>rsync --version</code> #查看 rsync 版本，可以看到相关作者信息</p>
<p>与 SCP 的比较：scp = 无法备份大量数据，类似 windows 的复制<br><strong>rsync = 边复制 ，边统计，边比较</strong></p>
<h1 id="Rysnc-特性和优点"><a href="#Rysnc-特性和优点" class="headerlink" title="Rysnc 特性和优点"></a>Rysnc 特性和优点</h1><p>可以镜像保存整个目录树和文件系统。<br>可以很容易做到保持原来文件的权限、时间、软硬链接等等。<br>无须特殊权限即可安装。<br>快速：第一次同步时 rsync 会复制全部内容，但在下一次只传输修改过的文件。<br>压缩传输：rsync 在传输数据的过程中可以实行压缩及解压缩操作，因此可以使用更少的带宽。<br>安全：可以使用 scp、ssh 等方式来传输文件，当然也可以通过直接的 socket 连接。<br>支持匿名传输，以方便进行网站镜象。<br>选择性保持：符号连接，硬链接，文件属性，权限，时间等</p>
<h2 id="常见备份分类"><a href="#常见备份分类" class="headerlink" title="常见备份分类"></a>常见备份分类</h2><p><strong>完整备份，差异备份，增量备份</strong></p>
<ul>
<li>完整备份：每次备份都是从备份源将所有的文件或目录备份到目的地</li>
<li>差量备份：备份上次完全备份以后有变化的数据 (他针对的上次的完全备份，他备份过程中不清除存档属性)</li>
<li>增量备份：备份上次备份以后有变化的数据.(他才不管是那种类型的备份，有变化的数据就备份，他会清除存档属性)</li>
</ul>
<h2 id="运行模式和端口"><a href="#运行模式和端口" class="headerlink" title="运行模式和端口"></a>运行模式和端口</h2><ul>
<li>采用 C/S 模式（客户端 / 服务器模式） [就是一个点到点的传输，直接使用 rsync 命令]</li>
<li>端口：873</li>
</ul>
<h2 id="发起端和备份源"><a href="#发起端和备份源" class="headerlink" title="发起端和备份源"></a>发起端和备份源</h2><p>四个名词的解释：</p>
<ul>
<li>发起端：负责发起 rsync 同步操作的客户机叫做发起端，通知服务器我要备份你的数据</li>
<li>备份源：负责相应来自客户机 rsync 同步操作的服务器脚在备份源，需要备份的服务器</li>
<li>服务端：运行 rsyncd 服务，一般来说，需要备份的服务器</li>
<li>客户端：存放备份数据</li>
</ul>
<h2 id="数据同步方式"><a href="#数据同步方式" class="headerlink" title="数据同步方式"></a>数据同步方式</h2><ul>
<li>推 push：一台主机负责把数据传送给其他主机，服务器开销很大，比较适合后端服务器少的情况</li>
<li>拉 pull：所有主机定时去找一主机拉数据，可能就会导致数据缓慢</li>
<li>推：目的主机配置为 rsync 服务器，源主机周期性的使用 rsync 命令把要同步的目录推过去（需要备份的机器是客户端，存储备份的机器是服务端）</li>
<li>拉：源主机配置为 rsync 服务器，目的主机周期性的使用 rsync 命令把要同步的目录拉过来（需要备份的机器是服务端，存储备份的机器是客户端）两种方案，rsync 都有对应的命令来实现</li>
</ul>
<h2 id="Xinetd-管理-Rsync-工作原理"><a href="#Xinetd-管理-Rsync-工作原理" class="headerlink" title="Xinetd 管理 Rsync 工作原理"></a>Xinetd 管理 Rsync 工作原理</h2><p><img src="http://www.kococ.cn/usr/uploads/2020/01/10285241.jpg"></p>
<p>使用 rsync 来同步是先通过 xinetd 监听 873 号端口，如果 rsync 进来的是 873 号端口，那么 xinetd 就会通知它所管辖的 rsync 服务来做回应，接下来就是 rsync 俩服务于之间的通讯</p>
<h2 id="rsync-程序功能-1-vs-4"><a href="#rsync-程序功能-1-vs-4" class="headerlink" title="rsync 程序功能: 1 vs 4"></a>rsync 程序功能: 1 vs 4</h2><p><code>rsync == cp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# cp -a &#x2F;etc&#x2F;hosts &#x2F;tmp&#x2F;cp_hosts</span><br><span class="line">[root@backup ~]# ll &#x2F;tmp&#x2F;cp_hosts </span><br><span class="line">-rw-r--r-- 1 root root 375 Feb 21 17:17 &#x2F;tmp&#x2F;cp_hosts</span><br><span class="line">[root@backup ~]# rsync -a &#x2F;etc&#x2F;hosts &#x2F;tmp&#x2F;rsync_hosts</span><br><span class="line">[root@backup ~]# ll &#x2F;tmp&#x2F;rsync_hosts</span><br><span class="line">-rw-r--r-- 1 root root 375 Feb 21 17:17 &#x2F;tmp&#x2F;rsync_hosts</span><br></pre></td></tr></table></figure>

<p><code>rsync == scp(远程备份)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp -rp &#x2F;etc&#x2F;sysconfig&#x2F;  172.16.1.31:&#x2F;tmp&#x2F;</span><br><span class="line">rsync -rp &#x2F;oldboy_dir&#x2F;  172.16.1.31:&#x2F;tmp&#x2F;</span><br><span class="line"></span><br><span class="line">利用rsync传输目录时:</span><br><span class="line">传输的目录后面如果存在   &#x2F; &#x3D;&#x3D; &#x2F;xoxo_dir&#x2F;  表示将目录下面的数据内容进行全部传输</span><br><span class="line">传输的目录后面如果不存在 &#x2F; &#x3D;&#x3D; &#x2F;xoxo_dir   表示将目录本身和目录下面的数据内容进行全部传输</span><br></pre></td></tr></table></figure>

<p><code>rsync == rm</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# mkdir &#x2F;null</span><br><span class="line">[root@backup ~]# ll &#x2F;null&#x2F;</span><br><span class="line">total 0</span><br><span class="line">[root@backup ~]# rsync -rp --delete &#x2F;null&#x2F; 172.16.1.31:&#x2F;tmp&#x2F;</span><br><span class="line">root@172.16.1.31&#39;s password: </span><br><span class="line">--delete : 无差异同步--我有什么,你也有什么;我没有什么,你也不能有</span><br><span class="line">           实现不同主机之间数据高度一致</span><br></pre></td></tr></table></figure>

<p><code>rsync == ls</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 tmp]# ls &#x2F;tmp&#x2F;</span><br><span class="line">oldboy.txt</span><br><span class="line">[root@nfs01 tmp]# rsync &#x2F;tmp&#x2F;</span><br><span class="line">drwxr-xr-x             24 2019&#x2F;02&#x2F;21 17:42:52 .</span><br><span class="line">-rw-r--r--              0 2019&#x2F;02&#x2F;21 17:41:46 xoxo.txt</span><br></pre></td></tr></table></figure>

<h2 id="rsync-命令的工作模式"><a href="#rsync-命令的工作模式" class="headerlink" title="rsync 命令的工作模式"></a>rsync 命令的工作模式</h2><p><strong>本地备份数据 cp</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Local:  rsync [OPTION...] SRC... [DEST]</span><br><span class="line">src:  要备份的数据信息</span><br><span class="line">DEST: 将数据存储在什么位置    </span><br></pre></td></tr></table></figure>

<p><strong>远程备份数据 scp</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Access via remote shell:</span><br><span class="line">Pull: rsync [OPTION...] [USER@]HOST:SRC... [DEST]  -- 下载</span><br><span class="line">[USER@]  -- 指定以什么用户身份传输数据</span><br><span class="line">HOST     -- 指定远程主机IP地址或者主机名称</span><br><span class="line">SRC      -- 远程主机上要进行下载的数据信息</span><br><span class="line">DEST     -- 将远程主机信息保存到本地主机的什么路径中</span><br><span class="line"></span><br><span class="line">Push: rsync [OPTION...] SRC... [USER@]HOST:DEST    -- 上传</span><br><span class="line">SRC      -- 本地主机上要进行上传的数据信息</span><br><span class="line">DEST     -- 将本地主机信息保存到远程主机的什么路径中</span><br></pre></td></tr></table></figure>

<p><strong>守护进程方式远程备份数据：(推荐)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Access via rsync daemon:</span><br><span class="line">Pull: rsync [OPTION...] [USER@]HOST::SRC... [DEST] -- 下载</span><br><span class="line">      [USER@]  -- 指定一个认证用户信息</span><br><span class="line">      HOST     -- 指定远程主机IP地址或者主机名称</span><br><span class="line">      SRC      -- 远程主机上要进行下载的模块信息???</span><br><span class="line">      DEST     -- 将远程主机信息保存到本地主机的什么路径中</span><br><span class="line">      </span><br><span class="line">      rsync [OPTION...] rsync:&#x2F;&#x2F;[USER@]HOST[:PORT]&#x2F;SRC... [DEST]</span><br><span class="line">            </span><br><span class="line">Push: rsync [OPTION...] SRC... [USER@]HOST::DEST   -- 上传</span><br><span class="line">      SRC      -- 本地主机上要进行上传的数据信息</span><br><span class="line">      [USER@]  -- 指定一个认证用户信息</span><br><span class="line">      HOST     -- 指定远程主机IP地址或者主机名称</span><br><span class="line">      DEST     -- 将本地主机信息保存到远程主机的什么模块信息???</span><br><span class="line">      </span><br><span class="line">      rsync [OPTION...] SRC... rsync:&#x2F;&#x2F;[USER@]HOST[:PORT]&#x2F;DEST</span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<ol>
<li>可以控制传输的连接数量 (同一时刻)</li>
<li>可以实现免交互方式进行传输数据</li>
<li>具有单独的传输认证进制</li>
</ol>
<h2 id="rsync-服务守护进程方式部署流程-YUM"><a href="#rsync-服务守护进程方式部署流程-YUM" class="headerlink" title="rsync 服务守护进程方式部署流程 (YUM)"></a>rsync 服务守护进程方式部署流程 (YUM)</h2><p>rsync 服务端 (rsync 服务进程)<br>第一个：安装部署软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# rpm -qa rsync</span><br><span class="line">rsync-3.1.2-4.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>第二个：编写配置文件<br>PS: 只要是一个守护进程服务，都会存在配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;rsyncd.conf</span><br><span class="line">#rsync_config</span><br><span class="line">#created by HQ at 2017</span><br><span class="line">##rsyncd.conf start##    -- 注释信息 </span><br><span class="line">uid &#x3D; rsync              -- 管理备份目录(属主信息是rsync)</span><br><span class="line">gid &#x3D; rsync              -- 管理备份目录(属组信息是rsync)</span><br><span class="line">port &#x3D; 873               -- 守护进程服务端口信息</span><br><span class="line">fake super &#x3D; yes        -- 假超级</span><br><span class="line">use chroot &#x3D; no          -- 安全的配置</span><br><span class="line">max connections &#x3D; 200    -- 同时可以有多少客户端连接rsync服务器</span><br><span class="line">timeout &#x3D; 300            -- 超时时间,显示空闲连接存活时间</span><br><span class="line">pid file &#x3D; &#x2F;var&#x2F;run&#x2F;rsyncd.pid   --- 保存进程pid号码信息</span><br><span class="line">lock file &#x3D; &#x2F;var&#x2F;run&#x2F;rsync.lock  --- 真正的限制同时的连接数</span><br><span class="line">log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log   --- rsync程序日志文件</span><br><span class="line">ignore errors            -- 在备份传输数据时,一些不严重问题先进行忽略</span><br><span class="line">read only &#x3D; false        -- 备份目录设置为可读可写</span><br><span class="line">list &#x3D; true              -- 使客户端可以查看服务端的模块信息</span><br><span class="line">hosts allow &#x3D; 172.16.1.0&#x2F;24   --- 设置允许哪些主机或网段可以向备份服务器存储数据(白名单)</span><br><span class="line">hosts deny &#x3D; 0.0.0.0&#x2F;32       --- 设置禁止哪些主机或网段可以向备份服务器存储数据(黑名单)</span><br><span class="line">auth users &#x3D; rsync_backup     --- 认证用户</span><br><span class="line">secrets file &#x3D; &#x2F;etc&#x2F;rsync.password  --- 认证用户密码文件(信息:rsync_backup:oldboy123)</span><br><span class="line">[backup]                            --- 模块信息</span><br><span class="line">comment &#x3D; &quot;backup dir by oldboy&quot;    --- 模块注释说明信息</span><br><span class="line">path &#x3D; &#x2F;backup                      --- 定义一个备份目录</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第三个：创建一个 rsync 虚拟用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -s &#x2F;sbin&#x2F;nologin -M rsync </span><br></pre></td></tr></table></figure>

<p>第四个：创建备份目录 授予备份目录相关权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;backup</span><br><span class="line">chmod rsync.rsync -R &#x2F;backup</span><br></pre></td></tr></table></figure>

<p>第五个：创建认证密码文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;rsync_backup:oldboy123&quot; &gt;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">chmod 600 &#x2F;etc&#x2F;rsync.password</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>第六个：启动 rsync 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rsyncd</span><br><span class="line">systemctl enable rsyncd</span><br></pre></td></tr></table></figure>

<p>rsync 客户端<br>进行传输测试 切记关闭 SElinux 与防火墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 tmp]# rsync -avz &#x2F;etc&#x2F;hosts  rsync_backup@172.16.1.41::backup</span><br><span class="line">Password: </span><br></pre></td></tr></table></figure>

<h2 id="rsync-守护进程模式传输数据原理-centos7-rsync-3-1-2"><a href="#rsync-守护进程模式传输数据原理-centos7-rsync-3-1-2" class="headerlink" title="rsync 守护进程模式传输数据原理 (centos7 rsync - 3.1.2)"></a>rsync 守护进程模式传输数据原理 (centos7 rsync - 3.1.2)</h2><blockquote>
<p>a 在客户端执行守护进程备份数据命令</p>
<p>b 完成数据传输认证过程 (用户名 密码信息)</p>
<p>c 完成用户映射过程 将客户端用户 — 服务端的 rsync 用户</p>
<p>d 完成传输文件属主 属组信息的修改 — 修改为 rsync</p>
</blockquote>
<h2 id="如何实现免交互传输数据"><a href="#如何实现免交互传输数据" class="headerlink" title="如何实现免交互传输数据"></a>如何实现免交互传输数据</h2><p>完成 rsync 客户端配置过程<br>第一：创建密码文件 修改密码文件权限为 600</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 123456 &gt;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">chmod 600 &#x2F;etc&#x2F;rsync.password</span><br></pre></td></tr></table></figure>

<p>第二：进行传输测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz &#x2F;tmp&#x2F;123456.txt rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br></pre></td></tr></table></figure>

<h2 id="rsync-命令参数说明"><a href="#rsync-命令参数说明" class="headerlink" title="rsync 命令参数说明"></a>rsync 命令参数说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-v, --verbose      --- 显示传输数据过程信息</span><br><span class="line">-z, --compress     --- 将传输数据进行压缩</span><br><span class="line">-a, --archive       --- 归档参数 -rtopgDl </span><br><span class="line">-r, --recursive    --- 递归传输数据</span><br><span class="line">-t, --times        --- 保持文件修改时间不变</span><br><span class="line">-o, --owner        --- 保持文件属主信息不变(在配置文件中uid设置为root用户)</span><br><span class="line">-g, --group        --- 保持文件属组信息不变(在配置文件中gid设置为root用户)</span><br><span class="line">-p, --perms        --- 保持文件权限不变</span><br><span class="line">-D                 --- 保持设置文件信息不变</span><br><span class="line">-l, --links        --- 只传输链接文件,不会传输源文件中的内容 (bug)</span><br><span class="line">-L,                --- 只传输链接文件,会传输源文件中的内容    </span><br><span class="line">-P, --progress     --- 显示数据传输的进度信息</span><br></pre></td></tr></table></figure>

<p>PS: 如果想让选项 - o 和 - g 参数生效，需要将配置文件的 uid 和 gid 改为 root, 需要将 fake super 参数进行注释或者改为 no</p>
<h2 id="rsync-服务实现备份数据排除功能-过滤"><a href="#rsync-服务实现备份数据排除功能-过滤" class="headerlink" title="rsync 服务实现备份数据排除功能 (过滤)"></a>rsync 服务实现备份数据排除功能 (过滤)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--exclude&#x3D;PATTERN    注意: 排除数据信息要写上相对路径</span><br><span class="line">--exclude-from&#x3D;file        利用exclude-from参数排除数据信息时, 建议后面接绝对路径信息</span><br></pre></td></tr></table></figure>

<p>准备环境:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 tmp]# mkdir &#x2F;xoxo&#x2F;&#123;01..03&#125; -p</span><br><span class="line">[root@nfs01 tmp]# touch &#x2F;xoxo&#x2F;&#123;01..03&#125;&#x2F;&#123;a..c&#125;.txt</span><br><span class="line">[root@nfs01 tmp]# tree &#x2F;xoxo&#x2F;</span><br><span class="line">&#x2F;xoxo&#x2F;</span><br><span class="line">├── 01</span><br><span class="line">│?? ├── a.txt</span><br><span class="line">│?? ├── b.txt</span><br><span class="line">│?? └── c.txt</span><br><span class="line">├── 02</span><br><span class="line">│?? ├── a.txt</span><br><span class="line">│?? ├── b.txt</span><br><span class="line">│?? └── c.txt</span><br><span class="line">└── 03</span><br><span class="line">    ├── a.txt</span><br><span class="line">    ├── b.txt</span><br><span class="line">    └── c.txt</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>进行排除操作：排除 01 目录都不传输 排除 02 目录 c.txt 文件不要传输</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 tmp]# rsync -avz &#x2F;xoxo&#x2F; --exclude&#x3D;01&#x2F; --exclude&#x3D;02&#x2F;c.txt rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">.&#x2F;</span><br><span class="line">02&#x2F;</span><br><span class="line">02&#x2F;a.txt</span><br><span class="line">02&#x2F;b.txt</span><br><span class="line">03&#x2F;</span><br><span class="line">03&#x2F;a.txt</span><br><span class="line">03&#x2F;b.txt</span><br><span class="line">03&#x2F;c.txt</span><br><span class="line"></span><br><span class="line">sent 375 bytes  received 134 bytes  1,018.00 bytes&#x2F;sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br><span class="line"></span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;xoxo&#x2F; --exclude-from&#x3D;&#x2F;xoxo&#x2F;exlude_file rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">.&#x2F;</span><br><span class="line">02&#x2F;</span><br><span class="line">02&#x2F;a.txt</span><br><span class="line">02&#x2F;b.txt</span><br><span class="line">03&#x2F;</span><br><span class="line">03&#x2F;a.txt</span><br><span class="line">03&#x2F;b.txt</span><br><span class="line">03&#x2F;c.txt</span><br><span class="line"></span><br><span class="line">sent 375 bytes  received 134 bytes  1,018.00 bytes&#x2F;sec</span><br><span class="line">total size is 0  speedup is 0.00</span><br><span class="line"></span><br><span class="line">[root@nfs01 xoxo]# cat exlude_file </span><br><span class="line">01&#x2F;</span><br><span class="line">02&#x2F;c.txt</span><br><span class="line">exlude_file</span><br><span class="line">PS: 利用exclude-from参数排除数据信息时, 建议后面接绝对路径信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>rsync 服务实现无差异同步</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--delete :  使客户端数据信息和备份服务端数据信息保持高度一致</span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;xoxo&#x2F; --delete rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">deleting 01&#x2F;c.txt</span><br><span class="line">deleting 01&#x2F;b.txt</span><br><span class="line">deleting 01&#x2F;a.txt</span><br><span class="line">deleting 01&#x2F;</span><br><span class="line">.&#x2F;</span><br><span class="line"></span><br><span class="line">sent 235 bytes  received 72 bytes  614.00 bytes&#x2F;sec</span><br><span class="line">total size is 25  speedup is 0.08</span><br></pre></td></tr></table></figure>

<p><strong>rsync 备份服务实现存储数据访问控制</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hosts allow &#x3D; 172.16.1.0&#x2F;24   白名单</span><br><span class="line">hosts deny &#x3D; 0.0.0.0&#x2F;32       黑名单</span><br><span class="line">理解rsync服务访问控制原理</span><br><span class="line">第一种情况: 只有白名单 没有黑名单</span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;xoxo&#x2F; --delete rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line"></span><br><span class="line">sent 228 bytes  received 22 bytes  500.00 bytes&#x2F;sec</span><br><span class="line">total size is 25  speedup is 0.10</span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;xoxo&#x2F; --delete rsync_backup@10.0.0.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">@ERROR: Unknown module &#39;backup&#39;</span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1648) [sender&#x3D;3.1.2]</span><br></pre></td></tr></table></figure>

<p><strong>rsync 服务模块列表功能</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list &#x3D; false    在客户端上可以显示服务端的所有模块信息</span><br><span class="line">PS: 建议将此功能关闭    </span><br></pre></td></tr></table></figure>

<p><strong>rsync 服务备份目录层级创建功能</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PS: 无法创建多级目录</span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;etc&#x2F;hosts  rsync_backup@172.16.1.41::backup&#x2F;01&#x2F; --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">created directory 01</span><br><span class="line">hosts</span><br><span class="line"></span><br><span class="line">sent 227 bytes  received 68 bytes  590.00 bytes&#x2F;sec</span><br><span class="line">total size is 371  speedup is 1.26</span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;etc&#x2F;hosts  rsync_backup@172.16.1.41::backup&#x2F;01&#x2F;02&#x2F;03&#x2F;04&#x2F; --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">rsync: mkdir &quot;01&#x2F;02&#x2F;03&#x2F;04&quot; (in backup) failed: No such file or directory (2)</span><br><span class="line">rsync error: error in file IO (code 11) at main.c(657) [Receiver&#x3D;3.1.2]</span><br><span class="line">[root@nfs01 xoxo]# </span><br><span class="line">[root@nfs01 xoxo]# rsync -avz &#x2F;etc&#x2F;hosts  rsync_backup@172.16.1.41::backup&#x2F;01&#x2F;02&#x2F; --password-file&#x3D;&#x2F;etc&#x2F;rsync.password</span><br><span class="line">sending incremental file list</span><br><span class="line">created directory 01&#x2F;02</span><br><span class="line">hosts</span><br><span class="line"></span><br><span class="line">sent 227 bytes  received 71 bytes  596.00 bytes&#x2F;sec</span><br><span class="line">total size is 371  speedup is 1.24</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<h1 id="6-66-实战内容"><a href="#6-66-实战内容" class="headerlink" title="6.66 实战内容"></a>6.66 实战内容</h1><h2 id="6-1-客户端推送-backup-目录下所有内容至-Rsync-服务端"><a href="#6-1-客户端推送-backup-目录下所有内容至-Rsync-服务端" class="headerlink" title="6.1 客户端推送 backup 目录下所有内容至 Rsync 服务端"></a>6.1 客户端推送 backup 目录下所有内容至 Rsync 服务端</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz &#x2F;backup&#x2F; rsync_backup@172.16.1.41::backup</span><br></pre></td></tr></table></figure>

<h2 id="6-2-客户端拉取-Rsync-服务端-backup-模块数据至本地客户端的-backup-目录"><a href="#6-2-客户端拉取-Rsync-服务端-backup-模块数据至本地客户端的-backup-目录" class="headerlink" title="6.2 客户端拉取 Rsync 服务端 backup 模块数据至本地客户端的 /backup 目录"></a>6.2 客户端拉取 Rsync 服务端 backup 模块数据至本地客户端的 /backup 目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz rsync_backup@172.16.1.41::backup &#x2F;backup&#x2F;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-Rsync-实现数据无差异同步"><a href="#6-3-Rsync-实现数据无差异同步" class="headerlink" title="6.3 Rsync 实现数据无差异同步"></a>6.3 Rsync 实现数据无差异同步</h2><p>拉取远端数据：远端与本地保持一致，远端没有本地有会被删除，造成客户端数据丢失</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz --delete rsync_backup@172.16.1.41::backup &#x2F;data&#x2F;</span><br></pre></td></tr></table></figure>

<p>推送数据至远端：本地与远端保持一致，本地没有远端会被删除，造成服务器端数据丢失</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz --delete &#x2F;data&#x2F; rsync_backup@172.16.1.41::backup</span><br></pre></td></tr></table></figure>

<h2 id="6-4-Rsync-的-Limit-限速"><a href="#6-4-Rsync-的-Limit-限速" class="headerlink" title="6.4 Rsync 的 Limit 限速"></a>6.4 Rsync 的 Limit 限速</h2><p>企业案例：某 DBA 使用 rsync 拉取备份数据时，由于文件过大导致内部交换机带宽被沾满，导致用户的请求无法响应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz --bwlimit&#x3D;1 rsync_backup@172.16.1.41::backup &#x2F;data&#x2F;</span><br></pre></td></tr></table></figure>

<h1 id="7-77-全网备份案例"><a href="#7-77-全网备份案例" class="headerlink" title="7.77 全网备份案例"></a>7.77 全网备份案例</h1><h2 id="7-1-客户端需求："><a href="#7-1-客户端需求：" class="headerlink" title="7.1 客户端需求："></a>7.1 客户端需求：</h2><p>客户端需求：</p>
<ul>
<li>1. 客户端 每天凌晨 1 点在服务器本地打包备份 (系统配置文件日志文件其他目录应用配置等文件)</li>
<li>2. 客户端备份的数据必须存放至以主机名 ip 地址当前时间命名的目录中</li>
<li>3. 客户端最后通过 rsync 推送本地已经打包好的备份文件至 backup 服务器</li>
<li>4. 客户端服务器本地保留最近 7 天的数据，避免浪费磁盘空间</li>
</ul>
<h2 id="7-2-任务-拆解"><a href="#7-2-任务-拆解" class="headerlink" title="7.2 任务 拆解"></a>7.2 任务 拆解</h2><p>1. 客户端 每天凌晨 1 点在服务器本地打包备份 (系统配置文件日志文件其他目录应用配置等文件)<br>系统配置文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;fstab</span><br><span class="line">&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p>日志文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;messages</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

<p>打包压缩:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F; &amp;&amp; tar zcvf &#x2F;backup&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd</span><br><span class="line">cd &#x2F; &amp;&amp; tar zcvf &#x2F;backup&#x2F;log.tar.gz var&#x2F;log&#x2F;messages var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

<p>2. 客户端备份的数据必须存放至以主机名 ip 地址当前时间命名的目录中<br>命名要求:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs_172.16.1.31_2019-07-17</span><br></pre></td></tr></table></figure>

<p>主机名:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostname</span><br></pre></td></tr></table></figure>

<p>ip 地址:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2&#123;print $2&#125;&#39;或者hostname -i (前提需要定义好hosts文件)</span><br></pre></td></tr></table></figure>

<p>时间:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date +%F</span><br></pre></td></tr></table></figure>

<p>拼接在一起:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs ~]# echo &quot;$(hostname)_$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2&#123;print $2&#125;&#39;)_$(date</span><br><span class="line">+%F)&quot;</span><br><span class="line">nfs_172.16.1.31_2019-07-17</span><br></pre></td></tr></table></figure>

<p>3. 客户端最后通过 rsync 推送本地已经打包好的备份文件至 backup 服务器的 /backup</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzP &#x2F;backup&#x2F; oldzhang@172.16.1.41::backup</span><br></pre></td></tr></table></figure>

<p>4. 创建测试数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs &#x2F;backup]# cat date.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">for i in &#123;1..30&#125;</span><br><span class="line">do</span><br><span class="line">Backup&#x3D;&quot;&#x2F;backup&#x2F;$(hostname)_$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2&#123;print $2&#125;&#39;)_$(date</span><br><span class="line">+%F)&quot;</span><br><span class="line">date -s 2019&#x2F;07&#x2F;$&#123;i&#125;</span><br><span class="line">mkdir -p $&#123;Backup&#125;</span><br><span class="line">cd &#x2F; &amp;&amp; tar zcvf $&#123;Backup&#125;&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd</span><br><span class="line">cd &#x2F; &amp;&amp; tar zcvf $&#123;Backup&#125;&#x2F;log.tar.gz var&#x2F;log&#x2F;messages var&#x2F;log&#x2F;secure</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>5. 客户端服务器本地保留最近 7 天的数据，避免浪费磁盘空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F;backup&#x2F; -mtime +7 |xargs rm -rf</span><br></pre></td></tr></table></figure>

<p>6. 调试脚本参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -x xxx.sh</span><br></pre></td></tr></table></figure>

<p>7. 最终脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs &#x2F;server&#x2F;scripts]# cat push_rsync.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">PATH&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin&quot;</span><br><span class="line">BACKUP&#x3D;&#x2F;backup</span><br><span class="line">HOST&#x3D;$(hostname)</span><br><span class="line">TIME&#x3D;$(date +%F)</span><br><span class="line">IP&#x3D;$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2&#123;print $2&#125;&#39;)</span><br><span class="line">DEST&#x3D;$&#123;HOST&#125;_$&#123;IP&#125;_$&#123;TIME&#125;</span><br><span class="line">#1.创建目录</span><br><span class="line">mkdir $&#123;BACKUP&#125;&#x2F;$&#123;DEST&#125; -p</span><br><span class="line">#2.打包数据</span><br><span class="line">cd &#x2F; &amp;&amp; tar zcvf $&#123;BACKUP&#125;&#x2F;$&#123;DEST&#125;&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd</span><br><span class="line">cd &#x2F; &amp;&amp; tar zcvf $&#123;BACKUP&#125;&#x2F;$&#123;DEST&#125;&#x2F;log.tar.gz var&#x2F;log&#x2F;messages</span><br><span class="line">var&#x2F;log&#x2F;secure</span><br></pre></td></tr></table></figure>

<h2 id="7-3-推送"><a href="#7-3-推送" class="headerlink" title="7.3 推送"></a>7.3 推送</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avzP $&#123;BACKUP&#125;&#x2F; rsync_backup@172.16.1.41::backup</span><br></pre></td></tr></table></figure>

<p>删除 7 天前文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find $&#123;BACKUP&#125;&#x2F; -mtime +7 |xargs rm -rf</span><br></pre></td></tr></table></figure>

<p>8. 注意踩坑<br>我们的备份脚本最终会以定时任务的形式实现，而定时任务能识别的 PATH 变量有限，所以最好在脚本里添加 PATH 变量，或者脚本里命令写绝对路径。</p>
<h2 id="7-4-服务端需求："><a href="#7-4-服务端需求：" class="headerlink" title="7.4 服务端需求："></a>7.4 服务端需求：</h2><p>1. 服务端部署 rsync，用于接收客户端推送过来的备份数据<br>2. 服务端需要每天校验客户端推送过来的数据是否完整<br>3. 服务端需要每天校验的结果通知给管理员<br>4. 服务端仅保留 6 个月的备份数据，其余的全部删除<br>注意：所有服务器的备份目录必须都为 /backup</p>
<h2 id="7-5-服务端步骤："><a href="#7-5-服务端步骤：" class="headerlink" title="7.5 服务端步骤："></a>7.5 服务端步骤：</h2><p>服务端需要每天校验客户端推送过来的数据是否完整<br>1. 要在客户端做<br>2. 做一个标记，贴一个防撕贴<br>第一种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd nfs_172.16.1.31_2019-07-23&#x2F; &amp;&amp; md5sum log.tar.gz &gt; md5.txt</span><br></pre></td></tr></table></figure>

<p>第二种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum log.tar.gz sys.tar.gz &gt;md5.txt</span><br></pre></td></tr></table></figure>

<p>第三种</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum *.tar.gz &gt;md5.txt</span><br></pre></td></tr></table></figure>

<p><code>实现命令</code>:<br>1. 客户端增加 md5 校验的步骤:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5sum $&#123;BACKUP&#125;&#x2F;$&#123;DEST&#125;&#x2F;*.tar.gz &gt; $&#123;BACKUP&#125;&#x2F;$&#123;DEST&#125;&#x2F;md5.txt</span><br></pre></td></tr></table></figure>

<p>2. 服务端校验命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F;backup&#x2F;*_$(date +%F) -name &quot;md5.txt&quot;|xargs md5sum -c</span><br></pre></td></tr></table></figure>

<h2 id="服务端需要每天邮件校验的结果通知给管理员"><a href="#服务端需要每天邮件校验的结果通知给管理员" class="headerlink" title="服务端需要每天邮件校验的结果通知给管理员"></a>服务端需要每天邮件校验的结果通知给管理员</h2><p>1. 安装配置 mailx:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install mailx -y</span><br></pre></td></tr></table></figure>

<p>2. 邮件配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@backup &#x2F;server&#x2F;scripts]# cat &#x2F;etc&#x2F;mail.rc </span><br><span class="line">set from&#x3D;38867033@qq.com</span><br><span class="line">set smtp&#x3D;smtps:&#x2F;&#x2F;smtp.qq.com:465</span><br><span class="line">set smtp-auth-user&#x3D;38867033@qq.com</span><br><span class="line">set smtp-auth-password&#x3D;xxxxxxxxSMTP授权码</span><br><span class="line">set smtp-auth&#x3D;login</span><br><span class="line">set ssl-verify&#x3D;ignore</span><br><span class="line">set nss-config-dir&#x3D;&#x2F;etc&#x2F;pki&#x2F;nssdb&#x2F;</span><br></pre></td></tr></table></figure>

<p>3. 服务端生成校验结果文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find &#x2F;backup&#x2F;*_$(date +%F) -name &quot;md5.txt&quot;|xargs md5sum -c &gt;</span><br><span class="line">&#x2F;backup&#x2F;check.txt</span><br></pre></td></tr></table></figure>

<p>4. 校验发送命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail -s &quot;check-rsync-$(date +%F)&quot; 38867033@qq.com &lt; &#x2F;backup&#x2F;check.txt</span><br></pre></td></tr></table></figure>

<h2 id="第八章-配置文件汇总"><a href="#第八章-配置文件汇总" class="headerlink" title="第八章 配置文件汇总"></a>第八章 配置文件汇总</h2><h2 id="8-1-客户端脚本："><a href="#8-1-客户端脚本：" class="headerlink" title="8.1 客户端脚本："></a>8.1 客户端脚本：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 &#x2F;server&#x2F;scripts]# cat push_rsync.sh </span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">#1.定义变量</span><br><span class="line">PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin</span><br><span class="line">Host&#x3D;$(hostname)</span><br><span class="line">Addr&#x3D;$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2&#123;print $2&#125;&#39;)</span><br><span class="line">Date&#x3D;$(date +%F)</span><br><span class="line">Dest&#x3D;$&#123;Host&#125;_$&#123;Addr&#125;_$&#123;Date&#125;</span><br><span class="line">Path&#x3D;&#x2F;backup</span><br><span class="line">#2.创建备份目录</span><br><span class="line">[ -d $Path&#x2F;$Dest ] || mkdir -p $Path&#x2F;$Dest</span><br><span class="line">#3.备份对应的文件</span><br><span class="line">cd &#x2F; &amp;&amp; \</span><br><span class="line">    [ -f $Path&#x2F;$Dest&#x2F;system.tar.gz ] || tar czf $Path&#x2F;$Dest&#x2F;system.tar.gz etc&#x2F;fstab etc&#x2F;rsyncd.conf &amp;&amp; \</span><br><span class="line">    [ -f $Path&#x2F;$Dest&#x2F;log.tar.gz ] || tar czf $Path&#x2F;$Dest&#x2F;log.tar.gz var&#x2F;log&#x2F;messages var&#x2F;log&#x2F;secure &amp;&amp; \</span><br><span class="line">#4.携带 md5 验证信息</span><br><span class="line">[ -f $Path&#x2F;$Dest&#x2F;flag ] || md5sum $Path&#x2F;$Dest&#x2F;*.tar.gz &gt;$Path&#x2F;$Dest&#x2F;flag_$Date</span><br><span class="line">#5.推送本地数据至备份服务器</span><br><span class="line">export RSYNC_PASSWORD&#x3D;123456</span><br><span class="line">rsync -avz $Path&#x2F; rsync_backup@172.16.1.41::backup</span><br><span class="line">#6.本地保留最近 7 天的数据</span><br><span class="line">find $Path&#x2F; -type d -mtime +7|xargs rm -rf</span><br></pre></td></tr></table></figure>

<p><strong>8.2 服务端脚本：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@backup &#x2F;server&#x2F;scripts]# cat check_backup.sh </span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">#1.定义全局的变量</span><br><span class="line">export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin</span><br><span class="line">#2.定义局部变量</span><br><span class="line">Path&#x3D;&#x2F;backup</span><br><span class="line">Date&#x3D;$(date +%F)</span><br><span class="line">#3.查看 flag 文件,并对该文件进行校验, 然后将校验的结果保存至 result_时间</span><br><span class="line">find $Path&#x2F; -type f -name &quot;flag_$Date&quot;|xargs md5sum -c &gt;$Path&#x2F;result_$&#123;Date&#125;</span><br><span class="line">#4.将校验的结果发送邮件给管理员</span><br><span class="line">mail -s &quot;Rsync Backup $Date&quot; 38867033@qq.com &lt;$Path&#x2F;result_$&#123;Date&#125;</span><br><span class="line">#5.删除超过 7 天的校验结果文件, 删除超过 180 天的备份数据文件</span><br><span class="line">find $Path&#x2F; -type f -name &quot;result*&quot; -mtime +7|xargs rm -f</span><br><span class="line">find $Path&#x2F; -type d -mtime +180|xargs rm -rf</span><br></pre></td></tr></table></figure>

<p><strong>8.3 服务端 rsync 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@backup &#x2F;server&#x2F;scripts]# cat &#x2F;etc&#x2F;rsyncd.conf </span><br><span class="line">uid &#x3D; www </span><br><span class="line">gid &#x3D; www </span><br><span class="line">port &#x3D; 873</span><br><span class="line">fake super &#x3D; yes</span><br><span class="line">use chroot &#x3D; no</span><br><span class="line">max connections &#x3D; 200</span><br><span class="line">timeout &#x3D; 600</span><br><span class="line">ignore errors</span><br><span class="line">read only &#x3D; false</span><br><span class="line">list &#x3D; false</span><br><span class="line">auth users &#x3D; rsync_backup</span><br><span class="line">secrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd</span><br><span class="line">log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log</span><br><span class="line">#####################################</span><br><span class="line">[backup]</span><br><span class="line">comment &#x3D; welcome to 123456edu backup!</span><br><span class="line">path &#x3D; &#x2F;backup</span><br><span class="line"></span><br><span class="line">[data]</span><br><span class="line">path &#x3D; &#x2F;data</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Prous</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/02/11/rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1/">http://yoursite.com/2019/02/11/rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Prous</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Rsync%E5%A4%87%E4%BB%BD/">Rsync备份</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/03/12/git-%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git 命令集合</div></div></a></div><div class="next-post pull-right"><a href="/2019/02/11/ansible-%E6%9C%8D%E5%8A%A1-%E5%89%A7%E6%9C%AC-%E8%A7%92%E8%89%B2/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/xoxoyun/MCDN/usr/uploads/2020/%E8%83%8C%E6%99%AF%E5%9B%BE%E5%BA%93/12.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ansible 服务 - 剧本 - 角色</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Prous</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="icp"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="/img/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer="defer" id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>