<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ansible 服务 - 剧本 - 角色 | Prous</title><meta name="description" content="第一章 Ansible 介绍1. 什么是 AnsibleAnsible 是 python 中的一套模块，系统中的一套自动化工具，只需要使用 ssh 协议连接及可用来系统管理、自动化执行命令等任务。 2. 为什么需要 Ansible？批量管理功能： 可以实现批量系统操作配置 可以实现批量软件服务部署 可以实现批量文件数据分发 可以实现批量系统信息收集  管理服务意义： 提高工作的效率（部署综合架构）"><meta name="keywords" content="Ansible,自动化运维"><meta name="author" content="Prous"><meta name="copyright" content="Prous"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="https://xoxoyun.gitee.io/2019/02/11/ansible-%E6%9C%8D%E5%8A%A1-%E5%89%A7%E6%9C%AC-%E8%A7%92%E8%89%B2/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="Ansible 服务 - 剧本 - 角色"><meta property="og:url" content="https://xoxoyun.gitee.io/2019/02/11/ansible-%E6%9C%8D%E5%8A%A1-%E5%89%A7%E6%9C%AC-%E8%A7%92%E8%89%B2/"><meta property="og:site_name" content="Prous"><meta property="og:description" content="第一章 Ansible 介绍1. 什么是 AnsibleAnsible 是 python 中的一套模块，系统中的一套自动化工具，只需要使用 ssh 协议连接及可用来系统管理、自动化执行命令等任务。 2. 为什么需要 Ansible？批量管理功能： 可以实现批量系统操作配置 可以实现批量软件服务部署 可以实现批量文件数据分发 可以实现批量系统信息收集  管理服务意义： 提高工作的效率（部署综合架构）"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/kococ/IMAGE/50.jpg"><meta property="article:published_time" content="2019-02-11T10:18:00.000Z"><meta property="article:modified_time" content="2020-08-03T04:23:00.819Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-03 12:23:00'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://www.kococ.cn/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">64</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">61</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-Ansible-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">第一章 Ansible 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-Ansible"><span class="toc-number">1.1.</span> <span class="toc-text">1. 什么是 Ansible</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Ansible%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 为什么需要 Ansible？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">批量管理功能：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E6%84%8F%E4%B9%89%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">管理服务意义：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E7%AE%80%E5%8D%95%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">安装部署简单：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0-Ansible"><span class="toc-number">1.6.</span> <span class="toc-text">如何学习 Ansible?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-Ansible-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text">第二章 Ansible 安装部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-Ansible-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="toc-number">3.</span> <span class="toc-text">第三章 Ansible 主机清单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-Ansible-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">第四章 Ansible 常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E6%A8%A1%E5%9D%97"><span class="toc-number">4.1.</span> <span class="toc-text">0. 如何学习模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ping"><span class="toc-number">4.2.</span> <span class="toc-text">1.ping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-shell-%E4%B8%87%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">4.3.</span> <span class="toc-text">3.shell 万能模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-copy-%E6%8B%B7%E8%B4%9D%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">4.copy 拷贝文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#02-%E5%9C%A8%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6%E6%97%B6%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%B1%9E%E4%B8%BB%E5%92%8C%E5%B1%9E%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">02. 在传输文件时修改文件属主和属组信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#03-%E5%9C%A8%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6%E6%97%B6%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E7%9A%84%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="toc-number">4.6.</span> <span class="toc-text">03. 在传输文件时修改文件的权限信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#04-%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%B9%B6%E7%9B%B4%E6%8E%A5%E5%86%99%E5%85%A5%E5%86%85%E5%AE%B9"><span class="toc-number">4.7.</span> <span class="toc-text">04. 创建文件并直接写入内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#05-%E5%A4%8D%E5%88%B6%E7%9B%AE%E5%BD%95"><span class="toc-number">4.8.</span> <span class="toc-text">05. 复制目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-file-%E8%AE%BE%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="toc-number">4.9.</span> <span class="toc-text">5.file 设置文件属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-script-%E6%A8%A1%E5%9D%97"><span class="toc-number">4.10.</span> <span class="toc-text">6.script 模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-cron"><span class="toc-number">4.11.</span> <span class="toc-text">7.cron</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-user"><span class="toc-number">4.12.</span> <span class="toc-text">8.user</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-group"><span class="toc-number">4.13.</span> <span class="toc-text">9.group</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-yum"><span class="toc-number">4.14.</span> <span class="toc-text">10.yum</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-service"><span class="toc-number">4.15.</span> <span class="toc-text">11.service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-mount"><span class="toc-number">4.16.</span> <span class="toc-text">12.mount</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-archive"><span class="toc-number">4.17.</span> <span class="toc-text">14.archive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-setup-%E8%8E%B7%E5%8F%96%E4%B8%BB%E6%9C%BA%E4%BF%A1%E6%81%AF"><span class="toc-number">4.18.</span> <span class="toc-text">15.setup 获取主机信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-%E6%9F%A5%E7%9C%8B%E5%B8%AE%E5%8A%A9"><span class="toc-number">4.19.</span> <span class="toc-text">16. 查看帮助</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ansible-%E8%BE%93%E5%87%BA%E4%BF%A1%E6%81%AF%E9%A2%9C%E8%89%B2%E8%A7%A3%E9%87%8A"><span class="toc-number">4.20.</span> <span class="toc-text">Ansible 输出信息颜色解释</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97-%E5%89%A7%E6%9C%AC"><span class="toc-number">5.</span> <span class="toc-text">模块 - 剧本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E4%BD%BF%E7%94%A8-ansible-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E5%AE%89%E8%A3%85-rsync-%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.</span> <span class="toc-text">第一章 使用 ansible 模块实现安装 rsync 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#01-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-number">6.1.</span> <span class="toc-text">01. 服务端操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#02-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-number">6.2.</span> <span class="toc-text">02. 客户端操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-playbook-%E5%89%A7%E6%9C%AC"><span class="toc-number">7.</span> <span class="toc-text">第二章 playbook 剧本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%89%A7%E6%9C%AC%E4%B9%A6%E5%86%99"><span class="toc-number">8.</span> <span class="toc-text">第四章 剧本书写</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E5%89%A7%E6%9C%AC%E9%AB%98%E7%BA%A7-%E7%89%B9%E6%80%A7"><span class="toc-number">9.</span> <span class="toc-text">第五章 剧本高级 特性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible-%E8%A7%92%E8%89%B2"><span class="toc-number">10.</span> <span class="toc-text">Ansible 角色</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-Ansible-rolers-%E4%BB%8B%E7%BB%8D"><span class="toc-number">11.</span> <span class="toc-text">第一章 Ansible rolers 介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%A7%92%E8%89%B2%E7%9B%AE%E5%BD%95%E8%A7%84%E5%88%92"><span class="toc-number">12.</span> <span class="toc-text">第二章 角色目录规划</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%BC%96%E5%86%99-init-%E8%A7%92%E8%89%B2%E5%89%A7%E6%9C%AC"><span class="toc-number">13.</span> <span class="toc-text">第三章 编写 init 角色剧本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E7%BC%96%E5%86%99-rsync-%E8%A7%92%E8%89%B2%E5%89%A7%E6%9C%AC"><span class="toc-number">14.</span> <span class="toc-text">第四章 编写 rsync 角色剧本</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/50.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Prous</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Ansible 服务 - 剧本 - 角色</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-02-11T10:18:00.000Z" title="发表于 2019-02-11 18:18:00">2019-02-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-03T04:23:00.819Z" title="更新于 2020-08-03 12:23:00">2020-08-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96/">自动化</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="第一章-Ansible-介绍"><a href="#第一章-Ansible-介绍" class="headerlink" title="第一章 Ansible 介绍"></a>第一章 Ansible 介绍</h1><h2 id="1-什么是-Ansible"><a href="#1-什么是-Ansible" class="headerlink" title="1. 什么是 Ansible"></a>1. 什么是 Ansible</h2><p>Ansible 是 python 中的一套模块，系统中的一套自动化工具，只需要使用 ssh 协议连接及可用来系统管理、自动化执行命令等任务。</p>
<h2 id="2-为什么需要-Ansible？"><a href="#2-为什么需要-Ansible？" class="headerlink" title="2. 为什么需要 Ansible？"></a>2. 为什么需要 Ansible？</h2><h2 id="批量管理功能："><a href="#批量管理功能：" class="headerlink" title="批量管理功能："></a>批量管理功能：</h2><ol>
<li>可以实现批量系统操作配置</li>
<li>可以实现批量软件服务部署</li>
<li>可以实现批量文件数据分发</li>
<li>可以实现批量系统信息收集</li>
</ol>
<h2 id="管理服务意义："><a href="#管理服务意义：" class="headerlink" title="管理服务意义："></a>管理服务意义：</h2><ol>
<li>提高工作的效率（部署综合架构）</li>
<li>提高工作准确度</li>
<li>减少维护的成本</li>
<li>减少重复性工作</li>
</ol>
<h2 id="安装部署简单："><a href="#安装部署简单：" class="headerlink" title="安装部署简单："></a>安装部署简单：</h2><ol>
<li>没有配置文件（不需要配置）</li>
<li>不需要启动服务</li>
<li>客户端没有需要部署任务</li>
</ol>
<h2 id="如何学习-Ansible"><a href="#如何学习-Ansible" class="headerlink" title="如何学习 Ansible?"></a>如何学习 Ansible?</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.官方文档</span><br><span class="line">2.帮助文档</span><br><span class="line">3.其他人写好的文档</span><br></pre></td></tr></table></figure>

<h1 id="第二章-Ansible-安装部署"><a href="#第二章-Ansible-安装部署" class="headerlink" title="第二章 Ansible 安装部署"></a>第二章 Ansible 安装部署</h1><p><strong>Ansible 的安装部署十分简单，只需要 yum 安装就行 （需要 epel 源）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# yum install ansible -y</span><br></pre></td></tr></table></figure>

<h1 id="第三章-Ansible-主机清单"><a href="#第三章-Ansible-主机清单" class="headerlink" title="第三章 Ansible 主机清单"></a>第三章 Ansible 主机清单</h1><p>/etc/ansible/hosts 主机资产清单文件，用于定义被管理主机的认证信息， 例如 ssh 登录用户名、密码以及 key 相关信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.主机支持主机名通配以及正则表达式，例如 web[1:3].xoxo.com 代表三台主机</span><br><span class="line">2.主机支持基于非标准的 ssh 端口，例如 web1.xoxo.com:6666</span><br><span class="line">3.主机支持指定变量，可对个别主机的特殊配置，如登陆用户，密码</span><br><span class="line">4.主机组支持指定变量[group_name:vars]，同时支持嵌套组[game:children]</span><br></pre></td></tr></table></figure>

<p>1. 指定主机组相关配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#主机组</span><br><span class="line">[root@xoxo1 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">[webserver]</span><br><span class="line">192.168.10.2 </span><br><span class="line">192.168.10.3</span><br><span class="line">#主机+端口+密码</span><br><span class="line">[webserver]</span><br><span class="line">192.168.10.2 ansible_ssh_port&#x3D;22 ansible_ssh_user&#x3D;root ansible_ssh_pass&#x3D;&#39;123456&#39;</span><br><span class="line">192.168.10.3 ansible_ssh_port&#x3D;22 ansible_ssh_user&#x3D;root ansible_ssh_pass&#x3D;&#39;123456&#39;</span><br><span class="line">#对整个主机组都生效的变量</span><br><span class="line">[webserver:vars]</span><br><span class="line">ansible_ssh_pass&#x3D;&#39;123456&#39;</span><br><span class="line"></span><br><span class="line">#针对所有webserver组都生效的变量</span><br><span class="line">[webserver:vars]       </span><br><span class="line">ansible_ssh_pass&#x3D;&#39;123456&#39;</span><br></pre></td></tr></table></figure>

<h1 id="第四章-Ansible-常用模块"><a href="#第四章-Ansible-常用模块" class="headerlink" title="第四章 Ansible 常用模块"></a>第四章 Ansible 常用模块</h1><h2 id="0-如何学习模块"><a href="#0-如何学习模块" class="headerlink" title="0. 如何学习模块"></a>0. 如何学习模块</h2><p>ansible 官方网站:<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ansible.com/">https://docs.ansible.com/</a><br>模块的应用语法格式:<br>ansible 主机名称 / 主机组名称 / 主机地址信息 /all -m (指定应用的模块信息) 模块名称 -a (指定动作信息) “执行什么动作”</p>
<h2 id="1-ping"><a href="#1-ping" class="headerlink" title="1.ping"></a>1.ping</h2><p>应用场景：<br>测试主机和 ansible 之间的连通性<br>举例：<br>对 webserver 主机组测试是否连通</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible webserver -m ping</span><br></pre></td></tr></table></figure>

<p>2.command 简单模块<br>应用场景：<br>类似 shell, 但是只能执行简单的命令，复杂的命令和有些符号并不能识别，用的比较少<br>01. 查看主机名，可以执行成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# ansible webserver -m ping       </span><br><span class="line">192.168.10.3 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.10.2 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>02. 使用 awk 拼接查看主机 IP 执行失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# ansible webserver -m command -a &quot;ifconfig eth0|grep 10&quot;     </span><br><span class="line">192.168.10.2 | FAILED | rc&#x3D;255 &gt;&gt;</span><br><span class="line">SIOCSIFADDR: 没有那个设备</span><br><span class="line">eth0|grep: ERROR while getting interface flags: 没有那个设备non-zero return code</span><br><span class="line">192.168.10.3 | FAILED | rc&#x3D;255 &gt;&gt;</span><br><span class="line">SIOCSIFADDR: 没有那个设备</span><br><span class="line">eth0|grep: ERROR while getting interface flags: 没有那个设备non-zero return code</span><br></pre></td></tr></table></figure>

<h2 id="3-shell-万能模块"><a href="#3-shell-万能模块" class="headerlink" title="3.shell 万能模块"></a>3.shell 万能模块</h2><p>万能模块，所有命令都可以执行，和本地执行效果一样<br>01. 使用管道查询 IP 地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# ansible webserver -m shell -a &quot;ifconfig eth0|grep 192.168.10&quot;</span><br><span class="line">192.168.10.3 | CHANGED | rc&#x3D;0 &gt;&gt;</span><br><span class="line">        inet 192.168.10.41  netmask 255.255.255.0  broadcast 192.168.10.255</span><br><span class="line">192.168.10.2 | CHANGED | rc&#x3D;0 &gt;&gt;</span><br><span class="line">        inet 192.168.10.31  netmask 255.255.255.0  broadcast 192.168.10.255</span><br></pre></td></tr></table></figure>

<p>02. 批量执行脚本<br>在其他主机上创建一个脚本，内容为打印主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; echo.sh &lt;&lt; EOF </span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">echo &quot;$(hostname)&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>然后使用 ansible 的 shell 模块批量执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# ansible webserver -m shell -a &quot;&#x2F;bin&#x2F;bash &#x2F;root&#x2F;echo.sh&quot;</span><br><span class="line">192.168.10.3 | CHANGED | rc&#x3D;0 &gt;&gt;</span><br><span class="line">backup</span><br><span class="line"></span><br><span class="line">192.168.10.2 | CHANGED | rc&#x3D;0 &gt;&gt;</span><br><span class="line">nfs01</span><br></pre></td></tr></table></figure>

<h2 id="4-copy-拷贝文件"><a href="#4-copy-拷贝文件" class="headerlink" title="4.copy 拷贝文件"></a>4.copy 拷贝文件</h2><p>01. 拷贝 xoxo1 的 hostsname 文件到其他主机的 /opt 目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 ~]# ansible 192.168.10.2 -m copy -a &quot;src&#x3D;&#x2F;etc&#x2F;hostname dest&#x3D;&#x2F;opt&quot;</span><br><span class="line">192.168.10.2 | CHANGED &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;f434396716e2c9aed47cfde87c491cce5a2c08fa&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;&#x2F;opt&#x2F;hostname&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;318d7defb693a2eb0d4f1a7a96575a57&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 4, </span><br><span class="line">    &quot;src&quot;: &quot;&#x2F;root&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-1563780990.63-144254987732501&#x2F;source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="02-在传输文件时修改文件属主和属组信息"><a href="#02-在传输文件时修改文件属主和属组信息" class="headerlink" title="02. 在传输文件时修改文件属主和属组信息"></a>02. 在传输文件时修改文件属主和属组信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m copy -a &quot;src&#x3D;&#x2F;root&#x2F;rsync.password dest&#x3D;&#x2F;etc&#x2F; owner&#x3D;xoxo group&#x3D;xoxo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="03-在传输文件时修改文件的权限信息"><a href="#03-在传输文件时修改文件的权限信息" class="headerlink" title="03. 在传输文件时修改文件的权限信息"></a>03. 在传输文件时修改文件的权限信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m copy -a &quot;src&#x3D;&#x2F;root&#x2F;rsync.password dest&#x3D;&#x2F;etc&#x2F; mode&#x3D;0600&quot;</span><br></pre></td></tr></table></figure>

<h2 id="04-创建文件并直接写入内容"><a href="#04-创建文件并直接写入内容" class="headerlink" title="04. 创建文件并直接写入内容"></a>04. 创建文件并直接写入内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m copy -a &quot;content&#x3D;&#39;xoxo&#39; dest&#x3D;&#x2F;etc&#x2F;rsync.password mode&#x3D;0600&quot;</span><br></pre></td></tr></table></figure>

<h2 id="05-复制目录"><a href="#05-复制目录" class="headerlink" title="05. 复制目录"></a>05. 复制目录</h2><p>src 后面目录没有 /: 将目录本身以及目录下面的内容都进行远程传输复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m copy -a &quot;src&#x3D;&#x2F;data dest&#x3D;&#x2F;data&quot;</span><br></pre></td></tr></table></figure>

<p>src 后面目录有 /: 只将目录下面的内容都进行远程传输复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m copy -a &quot;src&#x3D;&#x2F;data&#x2F; dest&#x3D;&#x2F;data&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">src #推送数据的源文件信息</span><br><span class="line">dest #推送数据的目标路径</span><br><span class="line">backup #对推送传输过去的文件，进行备份</span><br><span class="line">content #直接批量在被管理端文件中添加内容</span><br><span class="line">group #将本地文件推送到远端，指定文件属组信息</span><br><span class="line">owner #将本地文件推送到远端，指定文件属主信息</span><br><span class="line">mode #将本地文件推送到远端，指定文件权限信息</span><br></pre></td></tr></table></figure>

<h2 id="5-file-设置文件属性"><a href="#5-file-设置文件属性" class="headerlink" title="5.file 设置文件属性"></a>5.file 设置文件属性</h2><p>01. 创建文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m file -a &quot;path&#x3D;&#x2F;root&#x2F;xoxo state&#x3D;directory&quot;</span><br></pre></td></tr></table></figure>

<p>02. 创建文件并更改属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m file -a &quot;path&#x3D;&#x2F;root&#x2F;test.txt state&#x3D;touch mode&#x3D;777 owner&#x3D;root group&#x3D;root&quot;</span><br></pre></td></tr></table></figure>

<p>03. 创建软链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m file -a &quot;src&#x3D;&#x2F;root&#x2F;abc path&#x3D;&#x2F;root&#x2F;abc_link state&#x3D;link&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">path #指定远程主机目录或文件信息</span><br><span class="line">recurse #递归授权</span><br><span class="line">state</span><br><span class="line">directory #在远端创建目录</span><br><span class="line">touch #在远端创建文件</span><br><span class="line">link #link 或 hard 表示创建链接文件</span><br><span class="line">absent #表示删除文件或目录</span><br><span class="line">mode #设置文件或目录权限</span><br><span class="line">owner #设置文件或目录属主信息</span><br><span class="line">group #设置文件或目录属组信息</span><br></pre></td></tr></table></figure>

<h2 id="6-script-模块"><a href="#6-script-模块" class="headerlink" title="6.script 模块"></a>6.script 模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 编写脚本</span><br><span class="line">[root@xoxo1 ~]# mkdir -p &#x2F;server&#x2F;scripts</span><br><span class="line">[root@xoxo1 ~]# cat &#x2F;server&#x2F;scripts&#x2F;yum.sh</span><br><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;bash</span><br><span class="line">yum install -y iftop</span><br><span class="line">#在本地运行模块，等同于在远程执行，不需要将脚本文件进行推送目标主机执行</span><br><span class="line">[root@xoxo1 ~]# ansible xoxo -m script -a &quot;&#x2F;server&#x2F;scripts&#x2F;yum.sh&quot;</span><br></pre></td></tr></table></figure>

<h2 id="7-cron"><a href="#7-cron" class="headerlink" title="7.cron"></a>7.cron</h2><p>01. 创建一条定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m cron -a &quot;minute&#x3D;* hour&#x3D;* day&#x3D;* month&#x3D;* weekday&#x3D;* job&#x3D;&#39;&#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;server&#x2F;scripts&#x2F;test.sh&#39;&quot;</span><br></pre></td></tr></table></figure>

<p>02. 添加定时任务注释信息，防止重复</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m cron -a &quot;name&#x3D;&#39;cron01&#39; job&#x3D;&#39;&#x2F;bin&#x2F;sh &#x2F;server&#x2F;scripts&#x2F;test.sh&#39;&quot;</span><br></pre></td></tr></table></figure>

<p>03. 删除相应定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m cron -a &quot;name&#x3D;&#39;ansible cron02&#39; minute&#x3D;0 hour&#x3D;0 job&#x3D;&#39;&#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;server&#x2F;scripts&#x2F;test.sh&#39; state&#x3D;absent&quot;</span><br></pre></td></tr></table></figure>

<p>04. 注释相应定时任务，使定时任务失效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m cron -a &quot;name&#x3D;&#39;ansible cron01&#39; minute&#x3D;0 hour&#x3D;0 job&#x3D;&#39;&#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F;server&#x2F;scripts&#x2F;test.sh&#39; disabled&#x3D;no&quot;</span><br></pre></td></tr></table></figure>

<h2 id="8-user"><a href="#8-user" class="headerlink" title="8.user"></a>8.user</h2><p>01. 创建用户指定 uid,gid，不创建家目录也不允许登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m user -a &quot;name&#x3D;oldgirl uid&#x3D;888 group&#x3D;888 shell&#x3D;&#x2F;sbin&#x2F;nologin</span><br><span class="line">create_home&#x3D;no&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uid #指定用户的 uid</span><br><span class="line">group #指定用户组名称</span><br><span class="line">groups #指定附加组名称</span><br><span class="line">password #给用户添加密码</span><br><span class="line">shell #指定用户登录 shell</span><br><span class="line">create_home #是否创建家目录</span><br></pre></td></tr></table></figure>

<h2 id="9-group"><a href="#9-group" class="headerlink" title="9.group"></a>9.group</h2><p>01. 创建用户组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m group -a &quot;name&#x3D;yongheng gid&#x3D;888 state&#x3D;present&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name #指定创建的组名</span><br><span class="line">gid #指定组的 gid</span><br><span class="line">state</span><br><span class="line">absent #移除远端主机的组</span><br><span class="line">present #创建远端主机的组（默认）</span><br></pre></td></tr></table></figure>

<h2 id="10-yum"><a href="#10-yum" class="headerlink" title="10.yum"></a>10.yum</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m yum -a &quot;name&#x3D;httpd state&#x3D;installed&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name       #指定要安装的软件包名称</span><br><span class="line">state      #指定使用 yum 的方法</span><br><span class="line">installed， present #安装软件包</span><br><span class="line">removed， absent #移除软件包</span><br><span class="line">latest     #安装最新软件包</span><br></pre></td></tr></table></figure>

<h2 id="11-service"><a href="#11-service" class="headerlink" title="11.service"></a>11.service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m service -a &quot;name&#x3D;nfs state&#x3D;stopped enabled&#x3D;yes&quot;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name # 定义要启动服务的名称</span><br><span class="line">state # 指定服务状态</span><br><span class="line">started #启动服务</span><br><span class="line">stopped #停止服务</span><br><span class="line">restarted #重启服务</span><br><span class="line">reloaded #重载服务</span><br><span class="line">enabled #开机自启</span><br></pre></td></tr></table></figure>

<h2 id="12-mount"><a href="#12-mount" class="headerlink" title="12.mount"></a>12.mount</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible xoxo -m mount -a &quot;src&#x3D;192.168.10.2:&#x2F;data path&#x3D;&#x2F;data fstype&#x3D;nfs opts&#x3D;defaults</span><br><span class="line">state&#x3D;present&quot;</span><br><span class="line">ansible web -m mount -a &quot;src&#x3D;192.168.10.2:&#x2F;data path&#x3D;&#x2F;data fstype&#x3D;nfs opts&#x3D;defaults</span><br><span class="line">state&#x3D;mounted&quot;</span><br><span class="line"> web -m mount -a &quot;src&#x3D;192.168.10.2:&#x2F;data path&#x3D;&#x2F;data fstype&#x3D;nfs opts&#x3D;defaults</span><br><span class="line">state&#x3D;unmounted&quot;</span><br><span class="line">web -m mount -a &quot;src&#x3D;192.168.10.2:&#x2F;data path&#x3D;&#x2F;data fstype&#x3D;nfs opts&#x3D;defaults</span><br><span class="line">state&#x3D;absent&quot;</span><br></pre></td></tr></table></figure>

<p>状态解释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">present # 开机挂载，仅将挂载配置写入&#x2F;etc&#x2F;fstab</span><br><span class="line">mounted # 挂载设备，并将配置写入&#x2F;etc&#x2F;fstab</span><br><span class="line">unmounted # 卸载设备，不会清除&#x2F;etc&#x2F;fstab 写入的配置</span><br><span class="line">absent # 卸载设备，会清理&#x2F;etc&#x2F;fstab 写入的配置</span><br></pre></td></tr></table></figure>

<p>13.unarchive<br>01. 解压远程服务器的压缩包到指定目录<br>创建压缩包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc &amp;&amp; tar zxvf &#x2F;opt&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;hosts</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m unarchive -a &quot;src&#x3D;&#x2F;opt&#x2F;sys.tar.gz dest&#x3D;&#x2F;opt&#x2F; remote_src&#x3D;yes&quot;</span><br></pre></td></tr></table></figure>

<p>02. 把本地文件解压到目标机器指定目录<br>创建命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F; &amp;&amp; tar zcvf &#x2F;opt&#x2F;log.tar.gz var&#x2F;log&#x2F;messages</span><br></pre></td></tr></table></figure>

<h2 id="14-archive"><a href="#14-archive" class="headerlink" title="14.archive"></a>14.archive</h2><p>01. 压缩单个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m archive -a &quot;path&#x3D;&#x2F;var&#x2F;log&#x2F;message dest&#x3D;&#x2F;tmp&#x2F;log.tar.gz format&#x3D;gz force_archive&#x3D;true&quot; </span><br></pre></td></tr></table></figure>

<h2 id="15-setup-获取主机信息"><a href="#15-setup-获取主机信息" class="headerlink" title="15.setup 获取主机信息"></a>15.setup 获取主机信息</h2><p>01. 直接执行获取主机信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.10.2 -m setup</span><br></pre></td></tr></table></figure>

<p>02. 只将主机某个信息打印出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@xoxo1 &#x2F;server&#x2F;scripts&#x2F;test]# ansible 192.168.10.3 -m setup -a &quot;filter&#x3D;ansible_all_ipv4_addresses&quot;              </span><br><span class="line">192.168.10.3 | SUCCESS &#x3D;&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</span><br><span class="line">            &quot;192.168.10.3&quot;, </span><br><span class="line">            &quot;192.168.10.41&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;&#x2F;usr&#x2F;bin&#x2F;python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="16-查看帮助"><a href="#16-查看帮助" class="headerlink" title="16. 查看帮助"></a>16. 查看帮助</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc -l</span><br><span class="line">ansible-doc copy</span><br></pre></td></tr></table></figure>

<h2 id="Ansible-输出信息颜色解释"><a href="#Ansible-输出信息颜色解释" class="headerlink" title="Ansible 输出信息颜色解释"></a>Ansible 输出信息颜色解释</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">01. 绿色信息:  查看主机信息&#x2F;对主机未做改动</span><br><span class="line">02. 黄色信息:  对主机数据信息做了修改</span><br><span class="line">03. 红色信息:  命令执行出错了</span><br><span class="line">04. 粉色信息:  忠告信息</span><br><span class="line">05. 蓝色信息:  显示ansible命令执行的过程</span><br></pre></td></tr></table></figure>

<h1 id="模块-剧本"><a href="#模块-剧本" class="headerlink" title="模块 - 剧本"></a>模块 - 剧本</h1><h1 id="第一章-使用-ansible-模块实现安装-rsync-服务"><a href="#第一章-使用-ansible-模块实现安装-rsync-服务" class="headerlink" title="第一章 使用 ansible 模块实现安装 rsync 服务"></a>第一章 使用 ansible 模块实现安装 rsync 服务</h1><h2 id="01-服务端操作"><a href="#01-服务端操作" class="headerlink" title="01. 服务端操作"></a>01. 服务端操作</h2><p>第一步：安装软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m yum -a &quot;name&#x3D;rsync state&#x3D;installed&quot;</span><br></pre></td></tr></table></figure>

<p>第二步：编写文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m copy -a &quot;src&#x3D;&#x2F;server&#x2F;scripts&#x2F;rsyncd.conf dest&#x3D;&#x2F;etc&#x2F;&quot;</span><br></pre></td></tr></table></figure>

<p>第三步：创建用户组和用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m group -a &quot;name&#x3D;www gid&#x3D;666&quot;</span><br><span class="line">ansible 172.16.1.41 -m user -a &quot;name&#x3D;www create_home&#x3D;no shell&#x3D;&#x2F;sbin&#x2F;nologin group&#x3D;www uid&#x3D;666&quot;</span><br></pre></td></tr></table></figure>

<p>第四步：创建目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m file -a &quot;dest&#x3D;&#x2F;backup state&#x3D;directory owner&#x3D;www group&#x3D;www&quot;</span><br></pre></td></tr></table></figure>

<p>第五步：创建密码文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m copy -a &quot;content&#x3D;&#39;rsync_backup:Andu dest&#x3D;&#x2F;etc&#x2F;rsync.password mode&#x3D;600&quot;</span><br></pre></td></tr></table></figure>

<p>第六步：启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m service -a &quot;name&#x3D;rsyncd state&#x3D;started enabled&#x3D;yes&quot;</span><br></pre></td></tr></table></figure>

<h2 id="02-客户端操作"><a href="#02-客户端操作" class="headerlink" title="02. 客户端操作"></a>02. 客户端操作</h2><p>第一步：安装软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 172.16.1.41 -m yum -a &quot;name&#x3D;rsync state&#x3D;installed&quot;</span><br></pre></td></tr></table></figure>

<h1 id="第二章-playbook-剧本"><a href="#第二章-playbook-剧本" class="headerlink" title="第二章 playbook 剧本"></a>第二章 playbook 剧本</h1><p>1. 什么是 playbook 剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">playbook 翻译过来就是“剧本”， 那 playbook 组成如下</span><br><span class="line">play: 定义的是主机的角色</span><br><span class="line">task: 定义的是具体执行的任务</span><br><span class="line">playbook: 由一个或多个 play 组成，一个 play 可以包含多个 task 任务</span><br></pre></td></tr></table></figure>

<p><code>简单理解为: 使用不同的模块完成一件事情</code></p>
<p>2.playbook 的优势</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">功能比ansible命令更强大</span><br><span class="line">能很好的控制先后执行顺序, 以及依赖关系</span><br><span class="line">语法展现更加的直观</span><br><span class="line">ansible命令无法持久使用， playbook 可以持久使用</span><br><span class="line"></span><br><span class="line">第三章 剧本的书写格式要求</span><br></pre></td></tr></table></figure>

<p>01. 剧本的组成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- host: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">   file_name: andu</span><br><span class="line">  tasks:</span><br><span class="line">   - name: touch new files</span><br><span class="line">   shell: touch &#x2F;tmp&#x2F;&#123;&#123;file_name&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>02. 注意缩进</p>
<ul>
<li>1. 合理的信息缩进，两个空格表示一个缩进关系</li>
<li>2. 一定不要使用 tab</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">标题一</span><br><span class="line">_ _ 标题二</span><br><span class="line">_ _ _ _ 标题三</span><br></pre></td></tr></table></figure>

<p>03. 冒号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">所有冒号后面都要加上空格</span><br><span class="line">hosts: 172.16.1.41</span><br><span class="line">tasks:</span><br><span class="line">yum: name&#x3D;rsync state&#x3D;installed </span><br></pre></td></tr></table></figure>

<p>04. 短横线 - 列表功能<br>使用短横线构成列表信息，短横线后面需要有空格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 老张</span><br><span class="line">  男</span><br><span class="line">- 爱好</span><br><span class="line">  游泳</span><br></pre></td></tr></table></figure>

<h1 id="第四章-剧本书写"><a href="#第四章-剧本书写" class="headerlink" title="第四章 剧本书写"></a>第四章 剧本书写</h1><p>01. 文件名格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">剧本文件拓展名为xxx.yaml</span><br><span class="line">1.方便识别文件是一个剧本文件</span><br><span class="line">2.文件编写时会有颜色提示</span><br></pre></td></tr></table></figure>

<p>练习：写一个剧本，使用 yum/copy/service 模块安装部署启动 rsync 服务<br>rsync 剧本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts]# cat rsync_install.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-add group</span><br><span class="line">    group: name&#x3D;www gid&#x3D;666</span><br><span class="line">  - name: 02-add user</span><br><span class="line">    user: name&#x3D;www create_home&#x3D;no shell&#x3D;&#x2F;sbin&#x2F;nologin group&#x3D;www uid&#x3D;666</span><br><span class="line">  - name: 03-install rsync</span><br><span class="line">    yum: name&#x3D;rsync state&#x3D;installed</span><br><span class="line">  - name: 04-copy rsync conf</span><br><span class="line">    copy: src&#x3D;&#x2F;server&#x2F;scripts&#x2F;rsyncd.conf dest&#x3D;&#x2F;etc&#x2F;</span><br><span class="line">  - name: 05-create passwd conf</span><br><span class="line">    copy: content&#x3D;&#39;rsync_backup:xoxo&#39; dest&#x3D;&#x2F;etc&#x2F;rsync.passwd mode&#x3D;600</span><br><span class="line">  - name: 06-create backup dir</span><br><span class="line">    file: path&#x3D;&#x2F;backup state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">  - name: 07-create backup dir</span><br><span class="line">    file: path&#x3D;&#x2F;data state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">  - name: 08-start rsyncd service</span><br><span class="line">    service: name&#x3D;rsyncd state&#x3D;started</span><br><span class="line">  - name: 09-enabled rsyncd service</span><br><span class="line">    systemd: name&#x3D;rsyncd enabled&#x3D;yes</span><br></pre></td></tr></table></figure>

<p>nfs 剧本：<br>NFS 服务端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts]# cat nfs_server_install.yaml </span><br><span class="line">- hosts: nfs_server</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-add group</span><br><span class="line">    group: name&#x3D;www gid&#x3D;&#39;666&#39;</span><br><span class="line">  - name: 02-add user</span><br><span class="line">    user: name&#x3D;www create_home&#x3D;no shell&#x3D;&#x2F;sbin&#x2F;nologin group&#x3D;www uid&#x3D;666</span><br><span class="line">  - name: 03-install nfs service</span><br><span class="line">    yum: name&#x3D;nfs-utils state&#x3D;latest</span><br><span class="line">  - name: 04-copy nfs exports</span><br><span class="line">    copy: src&#x3D;&#x2F;server&#x2F;scripts&#x2F;exports dest&#x3D;&#x2F;etc&#x2F;</span><br><span class="line">  - name: 05-create data dir</span><br><span class="line">    file: path&#x3D;&#x2F;data state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">  - name: 06-start rpcbind</span><br><span class="line">    service: name&#x3D;rpcbind state&#x3D;started</span><br><span class="line">  - name: 07-start nfs</span><br><span class="line">    service: name&#x3D;nfs state&#x3D;started</span><br><span class="line">  - name: 08-enable rpcbind                                                                                                                                      </span><br><span class="line">    systemd: name&#x3D;rpcbind enabled&#x3D;yes</span><br><span class="line">  - name: 09-enable nfs </span><br><span class="line">    systemd: name&#x3D;nfs enabled&#x3D;yes</span><br></pre></td></tr></table></figure>

<p>nfs 客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts]# cat nfs_client_install.yaml </span><br><span class="line">- hosts: nfs_client</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-add group</span><br><span class="line">    group: name&#x3D;www gid&#x3D;666</span><br><span class="line">  - name: 02-add user</span><br><span class="line">    user: name&#x3D;www create_home&#x3D;no shell&#x3D;&#x2F;sbin&#x2F;nologin group&#x3D;www uid&#x3D;666</span><br><span class="line">  - name: 03-install nfs service</span><br><span class="line">    yum: name&#x3D;nfs-utils state&#x3D;latest</span><br><span class="line">  - name: 04-create data dir</span><br><span class="line">    file: path&#x3D;&#x2F;data state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">  - name: 05-start rpcbind</span><br><span class="line">    service: name&#x3D;rpcbind state&#x3D;started</span><br><span class="line">  - name: 06-enable rpcbind</span><br><span class="line">    systemd: name&#x3D;rpcbind enabled&#x3D;yes</span><br><span class="line">  - name: 07-mount data</span><br><span class="line">    mount: path&#x3D;&#x2F;data src&#x3D;172.16.1.31:&#x2F;data fstype&#x3D;nfs opts&#x3D;defaults state&#x3D;mounted</span><br></pre></td></tr></table></figure>

<p>02. 检查剧本语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --syntax-check nfs_client_install.yaml </span><br></pre></td></tr></table></figure>

<p>03. 模拟执行剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -C nfs_client_install.yaml </span><br></pre></td></tr></table></figure>

<p>04. 执行剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook nfs_client_install.yaml </span><br></pre></td></tr></table></figure>

<h1 id="第五章-剧本高级-特性"><a href="#第五章-剧本高级-特性" class="headerlink" title="第五章 剧本高级 特性"></a>第五章 剧本高级 特性</h1><p>我们已经体验了使用剧本来安装服务，但是上述的简单 ansible 剧本存在一定的局限性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.全部写成一行虽然看起来整洁，但是有一些特性没办法使用</span><br><span class="line">2.比如同时需要创建多个目录，启动多个服务，需要重复写多条语句</span><br><span class="line">3.参数不直观，不好修改</span><br><span class="line">4.剧本里写的是启动服务，如果配置文件发生变化，重复执行不会重启服务</span><br><span class="line">不过没有关系，等学习了下面的高级特性，然后我们可以换一种写法</span><br></pre></td></tr></table></figure>

<p>01. 循环<br>官方网址:<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html</a><br>使用情景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.需要创建多个目录</span><br><span class="line">2.需要启动多个服务</span><br></pre></td></tr></table></figure>

<p>具体实现：<br>1. 同时创建 2 个目录 /data 和 /backup</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat loops.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-create dir data and backuo</span><br><span class="line">    file:</span><br><span class="line">      path: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      state: directory</span><br><span class="line">      owner: www</span><br><span class="line">      group: www</span><br><span class="line">    loop: </span><br><span class="line">    - &#x2F;data</span><br><span class="line">    - &#x2F;backup</span><br></pre></td></tr></table></figure>

<p>2. 同时启动 2 个服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat service.yaml </span><br><span class="line">- hosts: 172.16.1.31</span><br><span class="line">  tasks: </span><br><span class="line">  - name: 01-start rpcbind nfs service</span><br><span class="line">    service: </span><br><span class="line">      name: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      state: started</span><br><span class="line">    loop:</span><br><span class="line">      - rpcbind</span><br><span class="line">      - nfs</span><br></pre></td></tr></table></figure>

<p>02. 变量<br>官方网址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;docs.ansible.com&#x2F;ansible&#x2F;latest&#x2F;user_guide&#x2F;playbooks_variables.html</span><br></pre></td></tr></table></figure>

<p>使用情景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.自定义某个名称，在任务中会多次引用</span><br><span class="line">2.从主机收集的系统信息中提取某个变量并引用，例如网卡信息</span><br></pre></td></tr></table></figure>

<p>具体实现：<br>1. 自定义一个文件名变量，创建文件时引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat vars.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  vars:</span><br><span class="line">    file_name: Andu</span><br><span class="line"></span><br><span class="line">  tasks: </span><br><span class="line">  - name: 01-use vars create dir</span><br><span class="line">    file: </span><br><span class="line">      path: &quot;&#x2F;root&#x2F;&#123;&#123; file_name &#125;&#125;&quot;</span><br><span class="line">      state: directory</span><br><span class="line">      owner: www</span><br><span class="line">      group: www</span><br></pre></td></tr></table></figure>

<p>2. 使用变量获取主机的 eth1 地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat ip.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-get ip address</span><br><span class="line">    shell: &quot;echo &#123;&#123; ansible_facts.eth1.ipv4.address &#125;&#125; &gt; &#x2F;root&#x2F;ip_eth1.txt&quot;</span><br></pre></td></tr></table></figure>

<p>3. 在主机 hosts 中指定变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# tail -5 &#x2F;etc&#x2F;ansible&#x2F;hosts</span><br><span class="line">[backup]</span><br><span class="line">172.16.1.41</span><br><span class="line"></span><br><span class="line">[backup:vars]</span><br><span class="line">file_name&#x3D;&quot;Andu&quot;</span><br></pre></td></tr></table></figure>

<p>03. 注册变量<br>使用情景：将配置文件的状态注册成一个变量，方便其他任务引用<br>具体实现：<br>1. 将配置文件的状态注册成一个服务变量并打印出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat register.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-register rsync status</span><br><span class="line">    shell: netstat -lntp|grep rsync</span><br><span class="line">    register: rsync_port</span><br><span class="line"></span><br><span class="line">  - name: 02-out rsync status</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; rsync_port.stdout_lines &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>打印多个信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- hosts: nfs</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-echo hostname</span><br><span class="line">    shell: echo $(hostname)</span><br><span class="line">    register: nfs_hostname</span><br><span class="line"></span><br><span class="line">  - name: debug nfs_hostname</span><br><span class="line">    debug:</span><br><span class="line">      msg: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">    loop:</span><br><span class="line">      - &quot;&#123;&#123; nfs_hostname.stdout &#125;&#125;&quot;</span><br><span class="line">      - &quot;&#123;&#123; nfs_hostname.cmd &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>04. 服务管理<br>官方文档:<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html?highlight=handlers#handlers-running-operations-on-change">https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html?highlight=handlers#handlers-running-operations-on-change</a><br>使用情景：如果配置文件发生了变化，就重启服务，否则什么都不操作<br>具体实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# cat handlers.yaml </span><br><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-if nfs conf changed,then restart nfs service</span><br><span class="line">    copy:</span><br><span class="line">      src: exports</span><br><span class="line">      dest: &#x2F;etc&#x2F;</span><br><span class="line">    notify: Restart_Nfs_Server</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">  - name: Restart_Nfs_Server</span><br><span class="line">    service: </span><br><span class="line">      name: nfs</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>

<p>05. 标签<br>使用情景：从我们指定的任务开始执行，而不是从头到尾执行一遍<br>具体实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- hosts: 172.16.1.41</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-add group</span><br><span class="line">    group: name&#x3D;www gid&#x3D;666</span><br><span class="line">    tags: 01-add-group</span><br><span class="line">  - name: 02-add user</span><br><span class="line">    user: name&#x3D;www create_home&#x3D;no shell&#x3D;&#x2F;sbin&#x2F;nologin group&#x3D;www uid&#x3D;666</span><br><span class="line">    tags: 02-add-user</span><br><span class="line">  - name: 03-install rsync</span><br><span class="line">    yum: name&#x3D;rsync state&#x3D;installed</span><br><span class="line">    tags: 03-install-rsync</span><br><span class="line">  - name: 04-copy rsync conf</span><br><span class="line">    copy: src&#x3D;&#x2F;server&#x2F;scripts&#x2F;rsyncd.conf dest&#x3D;&#x2F;etc&#x2F;</span><br><span class="line">    tags: 04-copy-conf</span><br><span class="line">  - name: 05-create passwd conf</span><br><span class="line">    copy: content&#x3D;&#39;rsync_backup:xoxo&#39; dest&#x3D;&#x2F;etc&#x2F;rsync.passwd mode&#x3D;600</span><br><span class="line">    tags: 05-create-passwd</span><br><span class="line">  - name: 06-create backup dir</span><br><span class="line">    file: path&#x3D;&#x2F;backup state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">    tags: 06-create-backup</span><br><span class="line">  - name: 07-create backup dir</span><br><span class="line">    file: path&#x3D;&#x2F;data state&#x3D;directory owner&#x3D;www group&#x3D;www</span><br><span class="line">    tags: 07-create-data</span><br><span class="line">  - name: 08-start rsyncd service</span><br><span class="line">    service: name&#x3D;rsyncd state&#x3D;started</span><br><span class="line">    tags: 08-start-rsyncd</span><br><span class="line">  - name: 09-enabled rsyncd service</span><br><span class="line">    systemd: name&#x3D;rsyncd enabled&#x3D;yes</span><br><span class="line">    tags: 09-enable</span><br></pre></td></tr></table></figure>

<p>调用标签：<br>1. 打印出 playbook 里要执行的所有标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 &#x2F;server&#x2F;scripts&#x2F;test]# ansible-playbook --list-tags tags2.yml </span><br><span class="line"></span><br><span class="line">playbook: tags2.yml</span><br><span class="line"></span><br><span class="line">  play #1 (172.16.1.41): 172.16.1.41    TAGS: []</span><br><span class="line">      TASK TAGS: [01-add-group, 02-add-user, 03-install-rsync, 04-copy-conf, 05-create-passwd, 06-create-backup, 07-create-data, 08-start-rsyncd, 09-enable]</span><br></pre></td></tr></table></figure>

<p>2. 指定运行某个标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -t 05-create-passwd tags2.yml</span><br></pre></td></tr></table></figure>

<p>3. 指定运行多个标签，使用逗号隔开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -t 05-create-passwd,06-create-backup tags2.yml</span><br></pre></td></tr></table></figure>

<p>3. 指定不运行某个标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --skip-tags&#x3D;05-create-passwd tags2.yml</span><br></pre></td></tr></table></figure>

<p>4. 指定不运行多个标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --skip-tags&#x3D;05-create-passwd,06-create-backup tags2.yml</span><br></pre></td></tr></table></figure>

<p>06. 运行检查规范<br>00. 检查剧本拼写规范</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --syntax-check check.yaml </span><br></pre></td></tr></table></figure>

<p>01. 检查这个任务执行的主机对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --list-host check.yaml </span><br></pre></td></tr></table></figure>

<p>02. 检查这个剧本需要执行哪些任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --list-tasks check.yaml </span><br></pre></td></tr></table></figure>

<p>03. 检查这个剧本执行哪些 tag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --list-tags check.yaml</span><br></pre></td></tr></table></figure>

<p>04. 模拟执行剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -C check.yaml</span><br></pre></td></tr></table></figure>

<p>第 6 章 实战剧本部署 rsync/nfs/lsyncd<br>脚本实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">- hosts: rsync_server</span><br><span class="line">  vars: </span><br><span class="line">    rsync_conf_path: &#39;&#x2F;server&#x2F;scripts&#x2F;rsync_yaml&#x2F;rsyncd.conf&#39;</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: 01-install rsync</span><br><span class="line">    yum: </span><br><span class="line">      name: rsync </span><br><span class="line">      state: installed</span><br><span class="line"></span><br><span class="line">  - name: 02-backup &amp; copy</span><br><span class="line">    copy:</span><br><span class="line">      src: &quot;&#123;&#123; rsync_conf_path &#125;&#125;&quot;</span><br><span class="line">      dest: &#x2F;etc&#x2F;</span><br><span class="line">      backup: yes</span><br><span class="line">    notify:</span><br><span class="line">      - restart rsyncd</span><br><span class="line"></span><br><span class="line">  - name: 03-create user group</span><br><span class="line">    group: </span><br><span class="line">      name: www </span><br><span class="line">      gid: 666</span><br><span class="line"></span><br><span class="line">  - name: 04-create user user </span><br><span class="line">    user: </span><br><span class="line">      name: www </span><br><span class="line">      create_home: no </span><br><span class="line">      shell: &#x2F;sbin&#x2F;nologin </span><br><span class="line">      group: www </span><br><span class="line">      uid: 666 </span><br><span class="line"> </span><br><span class="line">  - name: 05-create backup dir</span><br><span class="line">    file: </span><br><span class="line">      dest: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      state: directory </span><br><span class="line">      owner: www </span><br><span class="line">      group: www</span><br><span class="line">    loop:</span><br><span class="line">      - &#x2F;backup</span><br><span class="line">      - &#x2F;data </span><br><span class="line"></span><br><span class="line">  - name: 06-create passwd</span><br><span class="line">    copy: </span><br><span class="line">      content: &#39;rsync_backup:Andu&#39; </span><br><span class="line">      dest: &#x2F;etc&#x2F;rsync.passwd </span><br><span class="line">      mode: &#39;0600&#39;</span><br><span class="line"></span><br><span class="line">  - name: 09-start rsynd</span><br><span class="line">    service: </span><br><span class="line">      name: rsyncd </span><br><span class="line">      state: started </span><br><span class="line">      enabled: yes</span><br><span class="line">    tags: 09_start_rsynd</span><br><span class="line"></span><br><span class="line">  handlers:  </span><br><span class="line">  - name: restart rsyncd</span><br><span class="line">    service: </span><br><span class="line">      name: rsyncd</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>

<p>01.rsync 剧本<br>02.nfs 剧本<br>03.lsync 剧本</p>
<h1 id="Ansible-角色"><a href="#Ansible-角色" class="headerlink" title="Ansible 角色"></a>Ansible 角色</h1><h1 id="第一章-Ansible-rolers-介绍"><a href="#第一章-Ansible-rolers-介绍" class="headerlink" title="第一章 Ansible rolers 介绍"></a>第一章 Ansible rolers 介绍</h1><p>官方地址:<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html</a></p>
<h1 id="第二章-角色目录规划"><a href="#第二章-角色目录规划" class="headerlink" title="第二章 角色目录规划"></a>第二章 角色目录规划</h1><p>01. 目录说明:<br><code>官方的目录结构，必须这样定义！</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cd &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;</span><br><span class="line">[root@m01 &#x2F;etc&#x2F;ansible&#x2F;roles]# tree</span><br><span class="line">.</span><br><span class="line">├── nfs                   #角色名称</span><br><span class="line">│   ├── files             #存放需要copy的文件</span><br><span class="line">│   ├── handlers          #触发任务剧本</span><br><span class="line">│   ├── tasks             #具体任务剧本</span><br><span class="line">│   ├── templates         #模版文件</span><br><span class="line">│   └── vars              #存放变量文件</span><br></pre></td></tr></table></figure>

<p>02. 创建项目目录<br>因为每台服务器都需要创建用户组，用户，安装服务等，所以我们可以将这些相同的任务单独创建一个 init 初始化角色。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">角色规划：</span><br><span class="line">1.init      #初始化任务</span><br><span class="line">2.rsync     #rsync服务</span><br><span class="line">3.nfs       #nfs服务</span><br><span class="line">4.lsyncd    #lsyncd服务</span><br></pre></td></tr></table></figure>

<p>创建角色目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cd &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;</span><br><span class="line">[root@m01 &#x2F;etc&#x2F;ansible&#x2F;roles]# mkdir &#123;init,nfs,rsync,lsyncd&#125;&#x2F;&#123;vars,tasks,templates,handlers,files&#125; -p     </span><br><span class="line">[root@m01 &#x2F;etc&#x2F;ansible&#x2F;roles]# tree</span><br><span class="line">&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;</span><br><span class="line">.</span><br><span class="line">├── init</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">├── lsyncd</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">├── nfs</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">├── rsync</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">└── site.yml</span><br></pre></td></tr></table></figure>

<h1 id="第三章-编写-init-角色剧本"><a href="#第三章-编写-init-角色剧本" class="headerlink" title="第三章 编写 init 角色剧本"></a>第三章 编写 init 角色剧本</h1><p>01. 创建对应目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;init&#x2F;&#123;vars,tasks,templates,handlers,files&#125; -p</span><br></pre></td></tr></table></figure>

<p>02. 编写任务剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;init&#x2F;tasks&#x2F;main.yml </span><br></pre></td></tr></table></figure>

<p>01. 配置 base 源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: 01_configure_yum_repos</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: base </span><br><span class="line">    description: base yum repo</span><br><span class="line">    baseurl:</span><br><span class="line">      - http:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;centos&#x2F;$releasever&#x2F;os&#x2F;$basearch&#x2F;</span><br><span class="line">    gpgcheck: no</span><br></pre></td></tr></table></figure>

<p>02. 配置 epel 源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: 02_configure_yum_Repos</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: epel</span><br><span class="line">    description: epel yum repo</span><br><span class="line">    baseurl:</span><br><span class="line">      - https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;epel&#x2F;7&#x2F;$basearch</span><br><span class="line">    gpgcheck: no</span><br></pre></td></tr></table></figure>

<p>03. 安装常用软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- name: 03_install_server</span><br><span class="line">  yum: </span><br><span class="line">    name: &quot;&#123;&#123; packages &#125;&#125;&quot; </span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">    - ntpdate </span><br><span class="line">    - lsof</span><br><span class="line">    - tree </span><br><span class="line">    - iftop</span><br><span class="line">    - iotop</span><br></pre></td></tr></table></figure>

<p>04. 创建用户组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: 04_create_group</span><br><span class="line">  group:</span><br><span class="line">    name: www</span><br><span class="line">    gid: 666</span><br></pre></td></tr></table></figure>

<p>05. 创建用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: 05_create_user</span><br><span class="line">  user:</span><br><span class="line">    name: www</span><br><span class="line">    uid: 666</span><br><span class="line">    group: www </span><br><span class="line">    shell: &#x2F;sbin&#x2F;nologin</span><br><span class="line">    create_home: no</span><br></pre></td></tr></table></figure>

<p>06. 创建数据目录和脚本目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- name: 06_create_dir</span><br><span class="line">  file:</span><br><span class="line">    path: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">    state: directory</span><br><span class="line">    mode: &#39;0755&#39;</span><br><span class="line">  loop:</span><br><span class="line">    - &#x2F;data</span><br><span class="line">    - &#x2F;server&#x2F;scripts</span><br></pre></td></tr></table></figure>

<p>07. 创建同步时间定时任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: 07_cron_ntpdate</span><br><span class="line">  cron: </span><br><span class="line">    name: Time_Update</span><br><span class="line">    minute: &quot;*&#x2F;5&quot;</span><br><span class="line">    job: &#39;&#x2F;sbin&#x2F;ntpdate time1.aliyun.com&#39;</span><br></pre></td></tr></table></figure>

<p>08. 拷贝优化后的 ssh 配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- name: 08_copy_ssh</span><br><span class="line">  template: </span><br><span class="line">    src: sshd_config.j2</span><br><span class="line">    dest: &#x2F;etc&#x2F;ssh&#x2F;sshd_config </span><br><span class="line">    mode: &#39;0600&#39;</span><br><span class="line">    backup: yes</span><br><span class="line">  notify: restart sshd</span><br></pre></td></tr></table></figure>

<p>03. 编写 jinja 模版文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# tree &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;init&#x2F;templates&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;init&#x2F;templates&#x2F;</span><br><span class="line">└── sshd_config.j2</span><br></pre></td></tr></table></figure>

<p>04. 编写 handlers 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;init&#x2F;handlers&#x2F;main.yml </span><br><span class="line">- name: restart sshd </span><br><span class="line">  service: </span><br><span class="line">    name: sshd </span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<h1 id="第四章-编写-rsync-角色剧本"><a href="#第四章-编写-rsync-角色剧本" class="headerlink" title="第四章 编写 rsync 角色剧本"></a>第四章 编写 rsync 角色剧本</h1><p>01. 创建对应目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;&#123;vars,tasks,templates,handlers,files&#125; -p</span><br></pre></td></tr></table></figure>

<p>02. 编写任务剧本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;tasks&#x2F;main.yml    </span><br></pre></td></tr></table></figure>

<p>01. 安装 rsync 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- name: 01_install_rsync</span><br><span class="line">  yum: </span><br><span class="line">    name: rsync </span><br><span class="line">    state: installed</span><br></pre></td></tr></table></figure>

<p>02. 拷贝配置文件模版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- name: 02_copy_conf</span><br><span class="line">  template:</span><br><span class="line">    src: &quot;&#123;&#123; item.src&#125;&#125;&quot;</span><br><span class="line">    dest: &quot;&#x2F;etc&#x2F;&#123;&#123; item.dest &#125;&#125;&quot;</span><br><span class="line">    mode: &quot;&#123;&#123; item.mode &#125;&#125;&quot;</span><br><span class="line">    backup: yes</span><br><span class="line">  loop:</span><br><span class="line">    - &#123; src: &#39;rsyncd.conf.j2&#39;,  dest: &#39;rsyncd.conf&#39;,  mode: &#39;0644&#39; &#125;</span><br><span class="line">    - &#123; src: &#39;rsync.passwd.j2&#39;, dest: &#39;rsync.passwd&#39;, mode: &#39;0600&#39; &#125;</span><br><span class="line">  notify:</span><br><span class="line">    - restart rsyncd</span><br></pre></td></tr></table></figure>

<p>03. 创建备份目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: 03_create_backup_dir</span><br><span class="line">  file: </span><br><span class="line">    dest: &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">    state: directory </span><br><span class="line">    owner: www </span><br><span class="line">    group: www</span><br><span class="line">  loop:</span><br><span class="line">    - &#x2F;backup</span><br><span class="line">    - &#x2F;data </span><br></pre></td></tr></table></figure>

<p>04. 启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: 04_start_rsynd</span><br><span class="line">  service: </span><br><span class="line">    name: rsyncd </span><br><span class="line">    state: started </span><br><span class="line">    enabled: yes</span><br></pre></td></tr></table></figure>

<p>03. 编写 jinja 模版文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# tree &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;templates&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;templates&#x2F;</span><br><span class="line">├── rsyncd.conf.j2</span><br><span class="line">└── rsync.passwd.j2</span><br><span class="line"></span><br><span class="line">[root@m01 ~]# cat  &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;templates&#x2F;rsync.passwd.j2 </span><br><span class="line">&#123;&#123; user_rsyncd &#125;&#125;:&#123;&#123; passwd_rsyncd &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@m01 ~]# cat  &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;templates&#x2F;rsyncd.conf.j2 </span><br><span class="line">uid &#x3D; www </span><br><span class="line">gid &#x3D; www </span><br><span class="line">port &#x3D; 873</span><br><span class="line">fake super &#x3D; yes</span><br><span class="line">use chroot &#x3D; no</span><br><span class="line">max connections &#x3D; 200</span><br><span class="line">timeout &#x3D; 600</span><br><span class="line">ignore errors</span><br><span class="line">read only &#x3D; false</span><br><span class="line">list &#x3D; false</span><br><span class="line">auth users &#x3D; &#123;&#123; user_rsyncd &#125;&#125;</span><br><span class="line">secrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd</span><br><span class="line">log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log</span><br><span class="line">[backup]</span><br><span class="line">path &#x3D; &#x2F;backup</span><br><span class="line">[data]</span><br><span class="line">path &#x3D; &#x2F;data</span><br></pre></td></tr></table></figure>

<p>04. 编写变量文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;vars&#x2F;main.yml </span><br><span class="line">user_rsyncd: rsync_backup </span><br><span class="line">passwd_rsyncd: Andu </span><br></pre></td></tr></table></figure>

<p>05. 编写 handlers 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;handlers&#x2F;main.yml </span><br><span class="line">- name: restart rsyncd</span><br><span class="line">  service: </span><br><span class="line">    name: rsyncd </span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<p>06. 编写主任务文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;site.yml </span><br><span class="line">- hosts: rsync </span><br><span class="line">  roles:</span><br><span class="line">    - init</span><br><span class="line">    - rsync</span><br></pre></td></tr></table></figure>

<p>07. 最终目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# tree &#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;</span><br><span class="line">&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F;rsync&#x2F;</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── rsyncd.conf.j2</span><br><span class="line">│   └── rsync.passwd.j2</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>

<p>第四章 编写 nfs 角色剧本 (省略)<br>01. 创建对应目录<br>02. 编写任务剧本<br>03. 编写 jinja 模版文件<br>04. 编写变量文件<br>05. 编写 handlers 文件<br>06. 编写主任务文件<br>第五章 编写 lsyncd 角色剧本<br>01. 创建对应目录<br>02. 编写任务剧本<br>03. 编写 jinja 模版文件<br>04. 编写变量文件<br>05. 编写 handlers 文件<br>06. 编写主任务文件</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Prous</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xoxoyun.gitee.io/2019/02/11/ansible-%E6%9C%8D%E5%8A%A1-%E5%89%A7%E6%9C%AC-%E8%A7%92%E8%89%B2/">https://xoxoyun.gitee.io/2019/02/11/ansible-%E6%9C%8D%E5%8A%A1-%E5%89%A7%E6%9C%AC-%E8%A7%92%E8%89%B2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xoxoyun.gitee.io" target="_blank">Prous</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a><a class="post-meta__tags" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/">自动化运维</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/kococ/IMAGE/50.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/02/11/rsync-%E5%A4%87%E4%BB%BD%E6%9C%8D%E5%8A%A1/"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/57.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Rsync 备份服务</div></div></a></div><div class="next-post pull-right"><a href="/2019/02/11/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3ssh%E6%9C%8D%E5%8A%A1/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/14.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">一文了解SSH服务</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/50.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Prous</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">既来之 则安之</div><div class="icp"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="/img/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="712292593" data-server="netease" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="true" data-order="random" data-preload="none" data-autoplay="true" muted></div><script src="https://cdn.jsdelivr.net/gh/xiabo2/CDN@latest/fishes.js"></script><canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer="defer" id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: [
    'title',
    'meta[name=description]',
    '#config_change',
    '#body-wrap',
    '#rightside-config-hide',
    '#rightside-config-show',
    '.js-pjax'
  ],
  cacheBust: false,
})

document.addEventListener('pjax:complete', function () {
  refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

})

document.addEventListener('pjax:send', function () {
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

  //reset font-size
  $('body').css('font-size') !== originFontSize && $('body').css('font-size', parseFloat(originFontSize))
})</script></div></body></html>