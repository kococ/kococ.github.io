<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ELK日志收集系统概括 | 北青永恒</title><meta name="keywords" content="ELK,filebeat,Kibana,日志收集"><meta name="author" content="Thaons"><meta name="copyright" content="Thaons"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="ELK收集日志作者：Andu 2019&#x2F;6&#x2F;30精华文章第1章 ELK介绍 没有日志收集平台的时候如何分析日志？什么是ELK&#x2F;EFLK? ELK的数据流转流程?  官方演示地址：  https:&#x2F;&#x2F;demo.elastic.co&#x2F;  第2章 日志收集分类 代理层：nginx,haproxy  web层：nginx,tomcat  数据库层：mysql,redis,mongo,elasticsear">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK日志收集系统概括">
<meta property="og:url" content="https://kococ.cn/posts/14304/index.html">
<meta property="og:site_name" content="北青永恒">
<meta property="og:description" content="ELK收集日志作者：Andu 2019&#x2F;6&#x2F;30精华文章第1章 ELK介绍 没有日志收集平台的时候如何分析日志？什么是ELK&#x2F;EFLK? ELK的数据流转流程?  官方演示地址：  https:&#x2F;&#x2F;demo.elastic.co&#x2F;  第2章 日志收集分类 代理层：nginx,haproxy  web层：nginx,tomcat  数据库层：mysql,redis,mongo,elasticsear">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg">
<meta property="article:published_time" content="2020-03-11T01:45:00.000Z">
<meta property="article:modified_time" content="2020-10-20T04:17:22.532Z">
<meta property="article:author" content="Thaons">
<meta property="article:tag" content="ELK">
<meta property="article:tag" content="filebeat">
<meta property="article:tag" content="Kibana">
<meta property="article:tag" content="日志收集">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="https://kococ.cn/posts/14304/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.0.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-10-20 12:17:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><link rel="stylesheet" href="/css/footer.css"><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xoxoyun/img/raw/master/image/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">74</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">77</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.2020web.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC1%E7%AB%A0-ELK%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">第1章 ELK介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0-%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%88%86%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">第2章 日志收集分类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC3%E7%AB%A0-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ELK"><span class="toc-number">3.</span> <span class="toc-text">第3章 安装部署ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%AE%98%E6%96%B9%E5%9C%B0%E5%9D%80"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 官方地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEjava"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 安装配置java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 更新时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEelasticsearch"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 安装配置elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E7%9B%AE%E5%BD%95%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 相关配置目录及配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-ES%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 ES配置文件解读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%E6%8A%A5%E9%94%99"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 启动失败报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-%E9%94%81%E5%AE%9A%E5%86%85%E5%AD%98%E5%A4%B1%E8%B4%A5%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 锁定内存失败解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5-%E6%A3%80%E6%9F%A5%E5%90%AF%E5%8A%A8%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F"><span class="toc-number">3.4.5.</span> <span class="toc-text">3.4.5 检查启动是否成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEes-head%E6%8F%92%E4%BB%B6"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 服务模式安装配置es-head插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E6%8F%92%E4%BB%B6%E5%AE%98%E6%96%B9%E5%9C%B0%E5%9D%80"><span class="toc-number">3.5.1.</span> <span class="toc-text">3.5.1 插件官方地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2elasticsearch-head"><span class="toc-number">3.5.2.</span> <span class="toc-text">3.5.2 使用docker部署elasticsearch-head</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-%E4%BD%BF%E7%94%A8nodejs%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="toc-number">3.5.3.</span> <span class="toc-text">3.5.3 使用nodejs编译安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-4-%E4%BF%AE%E6%94%B9ES%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81%E8%B7%A8%E5%9F%9F"><span class="toc-number">3.5.4.</span> <span class="toc-text">3.5.4 修改ES配置文件支持跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-5-%E7%BD%91%E9%A1%B5%E8%AE%BF%E9%97%AE"><span class="toc-number">3.5.5.</span> <span class="toc-text">3.5.5 网页访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%92%E4%BB%B6%E5%BD%A2%E5%BC%8F%E5%AE%89%E8%A3%85es-head"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 谷歌浏览器插件形式安装es-head</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEkibana"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 安装配置kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-1-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEkibana"><span class="toc-number">3.7.1.</span> <span class="toc-text">3.7.1 安装配置kibana</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E5%AE%89%E8%A3%85filebeat%E5%92%8Clogstash"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 安装filebeat和logstash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-docker%E5%AE%89%E8%A3%85elk"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 docker安装elk</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-%E4%BD%BF%E7%94%A8filebeat%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">4.</span> <span class="toc-text">第4章 使用filebeat配置日志收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 收集nginx日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%AE%89%E8%A3%85nginx%E5%92%8Cab%E5%B7%A5%E5%85%B7"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1 安装nginx和ab工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2 启动测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">4.1.3.</span> <span class="toc-text">4.1.3 查看日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E9%85%8D%E7%BD%AEfilebeat%E6%94%B6%E9%9B%86%E6%99%AE%E9%80%9A%E6%97%A5%E5%BF%97"><span class="toc-number">4.1.4.</span> <span class="toc-text">4.1.4 配置filebeat收集普通日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-5-kibana%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.5.</span> <span class="toc-text">4.1.5 kibana配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-6-%E4%BF%AE%E6%94%B9nginx%E6%97%A5%E5%BF%97%E4%B8%BAjson%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.1.6.</span> <span class="toc-text">4.1.6 修改nginx日志为json格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-7-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%98%AF%E5%90%A6%E4%B8%BAjson%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.1.7.</span> <span class="toc-text">4.1.7 查看日志是否为json格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-8-%E6%94%B6%E9%9B%86%E5%A4%9A%E4%B8%AA%E6%97%A5%E5%BF%97%E5%B9%B6%E5%88%86%E7%B1%BB%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">4.1.8.</span> <span class="toc-text">4.1.8 收集多个日志并分类创建索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%94%B6%E9%9B%86tomcat%E6%97%A5%E5%BF%97"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 收集tomcat日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%AE%89%E8%A3%85tomcat"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 安装tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 启动检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E8%AE%BF%E9%97%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 访问测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E4%BF%AE%E6%94%B9%E6%97%A5%E5%BF%97%E4%B8%BAjson%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.2.4.</span> <span class="toc-text">4.2.4 修改日志为json格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-%E9%87%8D%E5%90%AF%E7%A1%AE%E8%AE%A4%E6%97%A5%E5%BF%97%E6%98%AF%E5%90%A6%E4%B8%BAjson%E6%A0%BC%E5%BC%8F"><span class="toc-number">4.2.5.</span> <span class="toc-text">4.2.5 重启确认日志是否为json格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-6-filebeat%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.6.</span> <span class="toc-text">4.2.6 filebeat配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-7-%E9%85%8D%E7%BD%AEtomcat%E6%94%B6%E9%9B%86%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-number">4.2.7.</span> <span class="toc-text">4.2.7 配置tomcat收集多个域名的日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%94%B6%E9%9B%86java%E6%97%A5%E5%BF%97"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 收集java日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E5%AE%98%E6%96%B9%E5%9C%B0%E5%9D%80"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 官方地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-filebeat%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 filebeat配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%94%B6%E9%9B%86docker%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 收集docker日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E5%AE%89%E8%A3%85docker"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.4.1 安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E8%BF%90%E8%A1%8Cnginx%E9%95%9C%E5%83%8F"><span class="toc-number">4.4.2.</span> <span class="toc-text">4.4.2 运行nginx镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E9%85%8D%E7%BD%AEfilebeat%E6%94%B6%E9%9B%86%E5%8D%95%E4%B8%AAdocker%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.3.</span> <span class="toc-text">4.4.3 配置filebeat收集单个docker日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-%E4%BD%BF%E7%94%A8%E9%80%9A%E9%85%8D%E7%AC%A6%E6%94%B6%E9%9B%86%E6%89%80%E6%9C%89%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.4.</span> <span class="toc-text">4.4.4 使用通配符收集所有容器的日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-5-%E9%85%8D%E7%BD%AEfilebeat%E9%80%9A%E8%BF%87%E6%A0%87%E7%AD%BE%E6%94%B6%E9%9B%86%E5%A4%9A%E4%B8%AA%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97"><span class="toc-number">4.4.5.</span> <span class="toc-text">4.4.5 配置filebeat通过标签收集多个容器日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-6-%E9%85%8D%E7%BD%AEfilebeat%E9%80%9A%E8%BF%87%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B%E5%92%8C%E6%97%A5%E5%BF%97%E7%B1%BB%E5%9E%8B%E5%A4%9A%E6%9D%A1%E4%BB%B6%E5%88%9B%E5%BB%BA%E4%B8%8D%E5%90%8C%E7%B4%A2%E5%BC%95"><span class="toc-number">4.4.6.</span> <span class="toc-text">4.4.6 配置filebeat通过服务类型和日志类型多条件创建不同索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-7-%E9%AA%8C%E8%AF%81%E6%8F%90%E4%BA%A4%E6%96%B0%E9%95%9C%E5%83%8F%E8%BF%90%E8%A1%8C%E5%90%8E%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%83%85%E5%86%B5"><span class="toc-number">4.4.7.</span> <span class="toc-text">4.4.7 验证提交新镜像运行后日志收集情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-8-%E4%BF%AE%E6%94%B9docker%E5%AE%B9%E5%99%A8%E5%86%85%E6%97%A5%E5%BF%97%E7%B1%BB%E5%9E%8B%E4%B8%BAjson"><span class="toc-number">4.4.8.</span> <span class="toc-text">4.4.8 修改docker容器内日志类型为json</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC5%E7%AB%A0-%E4%BD%BF%E7%94%A8filledeat-modules%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">第5章 使用filledeat modules配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%AE%98%E6%96%B9%E7%BD%91%E5%9D%80"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 官方网址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E4%BD%BF%E7%94%A8%E6%A8%A1%E7%89%88%E9%85%8D%E7%BD%AEnginx%E6%AD%A3%E5%B8%B8%E6%97%A5%E5%BF%97"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 使用模版配置nginx正常日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-filebeat%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 filebeat配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-filebeat-modules%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 filebeat modules配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97message%E5%92%8Csecure%E6%97%A5%E5%BF%97"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 使用模块收集系统日志message和secure日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E5%AF%BC%E5%85%A5kibana%E8%A7%86%E5%9B%BE"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 导入kibana视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97%E6%94%B6%E9%9B%86mysql%E6%97%A5%E5%BF%97%E5%92%8C%E6%85%A2%E6%97%A5%E5%BF%97"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 使用模块收集mysql日志和慢日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97%E6%94%B6%E9%9B%86mongo%E6%97%A5%E5%BF%97%E5%92%8Credis%E6%97%A5%E5%BF%97"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 使用模块收集mongo日志和redis日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97"><span class="toc-number">6.</span> <span class="toc-text">第6章 使用缓存收集日志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BD%BF%E7%94%A8%E5%8D%95%E5%8F%B0redis%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 使用单台redis作为缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95redis"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1 安装启动测试redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E9%85%8D%E7%BD%AEnginx%E7%9A%84json%E6%97%A5%E5%BF%97"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2 配置nginx的json日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E9%85%8D%E7%BD%AEfilebeat%E5%86%99%E5%85%A5%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84key%E4%B8%AD"><span class="toc-number">6.1.3.</span> <span class="toc-text">6.1.3 配置filebeat写入到不同的key中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4-%E9%85%8D%E7%BD%AElogstash%E8%AF%BB%E5%8F%96%E4%B8%8D%E5%90%8C%E7%9A%84key"><span class="toc-number">6.1.4.</span> <span class="toc-text">6.1.4 配置logstash读取不同的key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-5-filebeat%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%86%99%E5%85%A5%E5%88%B0%E4%B8%80%E4%B8%AAkey%E4%B8%AD"><span class="toc-number">6.1.5.</span> <span class="toc-text">6.1.5 filebeat收集日志写入到一个key中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-6-logstash%E6%A0%B9%E6%8D%AEtag%E5%8C%BA%E5%88%86%E4%B8%80%E4%B8%AAkey%E9%87%8C%E7%9A%84%E4%B8%8D%E5%90%8C%E6%97%A5%E5%BF%97"><span class="toc-number">6.1.6.</span> <span class="toc-text">6.1.6 logstash根据tag区分一个key里的不同日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8nginx-keepalived%E4%BB%A3%E7%90%86%E5%A4%9A%E5%8F%B0redis"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 使用nginx+keepalived代理多台redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1 解决方案介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">6.2.2 nginx配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-redis%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.3.</span> <span class="toc-text">6.2.3 redis配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-4-%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C%E6%B5%8B%E8%AF%95"><span class="toc-number">6.2.4.</span> <span class="toc-text">6.2.4 模拟故障测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-5-logstash%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.5.</span> <span class="toc-text">6.2.5 logstash配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-6-%E4%BD%BF%E7%94%A8supervisor%E6%89%B9%E9%87%8F%E7%AE%A1%E7%90%86%E5%A4%9A%E4%B8%AAlogstash%E8%BF%9B%E7%A8%8B"><span class="toc-number">6.2.6.</span> <span class="toc-text">6.2.6 使用supervisor批量管理多个logstash进程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E4%BD%BF%E7%94%A8kafka%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 使用kafka作为缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.3.1.</span> <span class="toc-text">6.3.1 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-zookeeper%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.2.</span> <span class="toc-text">6.3.2 zookeeper安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-3-kafka%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.3.</span> <span class="toc-text">6.3.3 kafka安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-4-kafka%E9%9B%86%E7%BE%A4%E6%94%B6%E5%8F%91%E6%B6%88%E6%81%AF%E6%B5%8B%E8%AF%95"><span class="toc-number">6.3.4.</span> <span class="toc-text">6.3.4 kafka集群收发消息测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-5-filebeat%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.5.</span> <span class="toc-text">6.3.5 filebeat配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-6-logstash%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.6.</span> <span class="toc-text">6.3.6 logstash配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC7%E7%AB%A0-%E9%85%8D%E7%BD%AElogstash%E5%90%8C%E6%AD%A5mysql%E6%95%B0%E6%8D%AE"><span class="toc-number">7.</span> <span class="toc-text">第7章 配置logstash同步mysql数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC8%E7%AB%A0-kibana%E7%94%BB%E5%9B%BE%E5%B1%95%E7%A4%BA"><span class="toc-number">8.</span> <span class="toc-text">第8章 kibana画图展示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC9%E7%AB%A0-grafana%E7%94%BB%E5%9B%BE%E5%B1%95%E7%A4%BA"><span class="toc-number">9.</span> <span class="toc-text">第9章 grafana画图展示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-%E5%A6%82%E4%BD%95%E5%9C%A8%E5%85%AC%E5%8F%B8%E6%8E%A8%E5%B9%BFELK%E9%A1%B9%E7%9B%AE"><span class="toc-number">10.</span> <span class="toc-text">第10章 如何在公司推广ELK项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98"><span class="toc-number">11.</span> <span class="toc-text">第11章 面试问题</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">北青永恒</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://www.2020web.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">ELK日志收集系统概括</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-11T01:45:00.000Z" title="发表于 2020-03-11 09:45:00">2020-03-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-10-20T04:17:22.532Z" title="更新于 2020-10-20 12:17:22">2020-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Devops/">Devops</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><table>
<thead>
<tr>
<th>ELK收集日志</th>
</tr>
</thead>
<tbody><tr>
<td><strong>作者：Andu</strong>  <strong>2019/6/30</strong></td>
</tr>
<tr>
<td>精华文章</td>
</tr>
<tr>
<td></td>
</tr>
</tbody></table>
<h1 id="第1章-ELK介绍"><a href="#第1章-ELK介绍" class="headerlink" title="第1章 ELK介绍"></a>第1章 ELK介绍</h1><p>没有日志收集平台的时候如何分析日志？什么是ELK/EFLK? ELK的数据流转流程?</p>
<p>官方演示地址：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://demo.elastic.co/">https://demo.elastic.co/</a></p>
<h1 id="第2章-日志收集分类"><a href="#第2章-日志收集分类" class="headerlink" title="第2章 日志收集分类"></a>第2章 日志收集分类</h1><p>代理层：nginx,haproxy</p>
<p>web层：nginx,tomcat</p>
<p>数据库层：mysql,redis,mongo,elasticsearch</p>
<p>操作系统层：source,message</p>
<h1 id="第3章-安装部署ELK"><a href="#第3章-安装部署ELK" class="headerlink" title="第3章 安装部署ELK"></a>第3章 安装部署ELK</h1><h2 id="3-1-官方地址"><a href="#3-1-官方地址" class="headerlink" title="3.1 官方地址"></a>3.1 官方地址</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/index.html">https://www.elastic.co/guide/index.html</a></p>
<h2 id="3-2-安装配置java"><a href="#3-2-安装配置java" class="headerlink" title="3.2 安装配置java"></a>3.2 安装配置java</h2><pre><code>[root@Andu ~]# yum install java-1.8.0-openjdk.x86_64 -y[[A1\]](#_msocom_1) 

[root@Andu ~]# java -version 

openjdk version &quot;1.8.0_212&quot;

OpenJDK Runtime Environment (build 1.8.0_212-b04)

OpenJDK 64-Bit Server VM (build 25.212-b04, mixed mode)</code></pre>
<h2 id="3-3-更新时间"><a href="#3-3-更新时间" class="headerlink" title="3.3 更新时间"></a>3.3 更新时间</h2><pre><code>yum install ntpdate -y

ntpdate time1.aliyun.com[[A2\]](#_msocom_2) </code></pre>
<h2 id="3-4-安装配置elasticsearch"><a href="#3-4-安装配置elasticsearch" class="headerlink" title="3.4 安装配置elasticsearch"></a>3.4 安装配置elasticsearch</h2><pre><code>[root@Andu ~]# mkdir /data/soft/ -p

[root@Andu ~]# cd /data/soft/

[root@Andu soft]# rz

[root@Andu soft]# ll

总用量 506120

-rw-r--r-- 1 root root 114059630 2月 25 11:09 elasticsearch-6.6.0.rpm

-rw-r--r-- 1 root root 36581177 4月 27 12:29 elasticsearch-head.tar.gz

-rw-r--r-- 1 root root 11790119 2月 25 11:08 filebeat-6.6.0-x86_64.rpm

-rw-r--r-- 1 root root 185123116 2月 25 11:11 kibana-6.6.0-x86_64.rpm

-rw-r--r-- 1 root root 170703770 2月 25 11:38 logstash-6.6.0.rpm

[root@Andu soft]# rpm -ivh elasticsearch-6.6.0.rpm 

警告：elasticsearch-6.6.0.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID d88e42b4: NOKEY

准备中...             ################################# [100%]

Creating elasticsearch group... OK

Creating elasticsearch user... OK

正在升级/安装...

  1:elasticsearch-0:6.6.0-1     ################################# [100%]

\### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd

 sudo systemctl daemon-reload

 sudo systemctl enable elasticsearch.service

\### You can start elasticsearch service by executing

 sudo systemctl start elasticsearch.serviceCreated elasticsearch keystore in /etc/elasticsearch</code></pre>
<h3 id="3-4-1-相关配置目录及配置文件"><a href="#3-4-1-相关配置目录及配置文件" class="headerlink" title="3.4.1 相关配置目录及配置文件"></a>3.4.1 相关配置目录及配置文件</h3><pre><code>[root@Andu ~]# rpm -qc elasticsearch 

/etc/elasticsearch/elasticsearch.yml

/etc/elasticsearch/jvm.options

/etc/elasticsearch/log4j2.properties

/etc/elasticsearch/role_mapping.yml

/etc/elasticsearch/roles.yml

/etc/elasticsearch/users

/etc/elasticsearch/users_roles

/etc/init.d/elasticsearch

/etc/sysconfig/elasticsearch

/usr/lib/sysctl.d/elasticsearch.conf

/usr/lib/systemd/system/elasticsearch.service</code></pre>
<h3 id="3-4-2-ES配置文件解读"><a href="#3-4-2-ES配置文件解读" class="headerlink" title="3.4.2 ES配置文件解读"></a>3.4.2 ES配置文件解读</h3><pre><code>[root@Andu soft]# vim /etc/elasticsearch/elasticsearch.yml

[root@Andu soft]# grep ^[a-z] /etc/elasticsearch/elasticsearch.yml 

node.name: node-1

path.data: /var/lib/elasticsearch[[A3\]](#_msocom_3) 

path.logs: /var/log/elasticsearch[[A4\]](#_msocom_4) 

bootstrap.memory_lock: true[[A5\]](#_msocom_5) 

network.host: 192.168.10.66,127.0.0.1[[A6\]](#_msocom_6) 

http.port: 9200[[A7\]](#_msocom_7) 

[root@Andu soft]# systemctl daemon-reload

[root@Andu soft]# systemctl enable elasticsearch.service

Created symlink from /etc/systemd/system/multi-user.target.wants/elasticsearch.service to /usr/lib/systemd/system/elasticsearch.service.

[root@Andu soft]# systemctl start elasticsearch.service</code></pre>
<h3 id="3-4-3-启动失败报错"><a href="#3-4-3-启动失败报错" class="headerlink" title="3.4.3 启动失败报错"></a>3.4.3 启动失败报错</h3><p>此时启动会发现失败，原因是内存锁定失败</p>
<pre><code>[2019-05-12T14:39:58,764][ERROR][o.e.b.Bootstrap     ] [node-1] node validation exception

[1] bootstrap checks failed

[1]: memory locking requested for elasticsearch process but memory is not locked</code></pre>
<h3 id="3-4-4-锁定内存失败解决方案"><a href="#3-4-4-锁定内存失败解决方案" class="headerlink" title="3.4.4 锁定内存失败解决方案"></a>3.4.4 锁定内存失败解决方案</h3><p>官方解决方案</p>
<pre><code>https://www.elastic.co/guide/en/elasticsearch/reference/6.4/setup-configuration-memory.html

https://www.elastic.co/guide/en/elasticsearch/reference/6.4/setting-system-settings.html#sysconfig

\### 修改启动配置文件

vim /usr/lib/systemd/system/elasticsearch.service</code></pre>
<p>​<br>​<br>    ### 增加如下参数</p>
<pre><code>[Service]

LimitMEMLOCK=infinity</code></pre>
<p>​<br>​<br>    ### 重新启动</p>
<pre><code>systemctl daemon-reload</code></pre>
<p>​<br>​<br>    systemctl restart elasticsearch</p>
<h3 id="3-4-5-检查启动是否成功"><a href="#3-4-5-检查启动是否成功" class="headerlink" title="3.4.5 检查启动是否成功"></a>3.4.5 检查启动是否成功</h3><pre><code>  [root@Andu ~]# netstat -lntup|grep 9200

    tcp6    0   0 192.168.10.66:9200   :::*          LISTEN   15824/java     

    tcp6    0   0 127.0.0.1:9200     :::*          LISTEN   15824/java

    [root@Andu ~]# curl localhost:9200   

    &#123;

     &quot;name&quot; : &quot;node-1&quot;,

     &quot;cluster_name&quot; : &quot;elasticsearch&quot;,

     &quot;cluster_uuid&quot; : &quot;As5ZlEQ2Syq0ktLL0hg5XA&quot;,

     &quot;version&quot; : &#123;

      &quot;number&quot; : &quot;6.6.0&quot;,

      &quot;build_flavor&quot; : &quot;default&quot;,

      &quot;build_type&quot; : &quot;rpm&quot;,

      &quot;build_hash&quot; : &quot;a9861f4&quot;,

      &quot;build_date&quot; : &quot;2019-01-24T11:27:09.439740Z&quot;,

      &quot;build_snapshot&quot; : false,

      &quot;lucene_version&quot; : &quot;7.6.0&quot;,

      &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,

      &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;

     &#125;,

     &quot;tagline&quot; : &quot;You Know, for Search&quot;

    &#125;</code></pre>
<h2 id="3-5-服务模式安装配置es-head插件"><a href="#3-5-服务模式安装配置es-head插件" class="headerlink" title="3.5 服务模式安装配置es-head插件"></a>3.5 服务模式安装配置es-head插件</h2><h3 id="3-5-1-插件官方地址"><a href="#3-5-1-插件官方地址" class="headerlink" title="3.5.1 插件官方地址"></a>3.5.1 插件官方地址</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<h3 id="3-5-2-使用docker部署elasticsearch-head"><a href="#3-5-2-使用docker部署elasticsearch-head" class="headerlink" title="3.5.2 使用docker部署elasticsearch-head"></a>3.5.2 使用docker部署elasticsearch-head</h3><pre><code>docker pull alivv/elasticsearch-head

docker run --name es-head -p 9100:9100 -dit alivv/elasticsearch-head</code></pre>
<h3 id="3-5-3-使用nodejs编译安装"><a href="#3-5-3-使用nodejs编译安装" class="headerlink" title="3.5.3 使用nodejs编译安装"></a>3.5.3 使用nodejs编译安装</h3><p>官网地址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://nodejs.org/en/download/package-manager/">https://nodejs.org/en/download/package-manager/</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://nodejs.org/dist/latest-v10.x/">https://nodejs.org/dist/latest-v10.x/</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://npm.taobao.org/">http://npm.taobao.org</a></p>
<p>下载安装</p>
<pre><code>yum install nodejs npm openssl screen -y</code></pre>
<p>​<br>​<br>    node -v</p>
<pre><code>npm -v

npm install -g cnpm --registry=https://registry.npm.taobao.org

cd /opt/             

git clone git://github.com/mobz/elasticsearch-head.git

cd elasticsearch-head/</code></pre>
<p>​<br>​<br>    cnpm install</p>
<pre><code>screen -S es-head

cnpm run start

Ctrl+A+D</code></pre>
<h3 id="3-5-4-修改ES配置文件支持跨域"><a href="#3-5-4-修改ES配置文件支持跨域" class="headerlink" title="3.5.4 修改ES配置文件支持跨域"></a>3.5.4 修改ES配置文件支持跨域</h3><p>官方说明：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.6/modules-http.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.6/modules-http.html</a></p>
<p>配置参数：</p>
<pre><code>http.cors.enabled: true 

http.cors.allow-origin: &quot;*&quot;</code></pre>
<h3 id="3-5-5-网页访问"><a href="#3-5-5-网页访问" class="headerlink" title="3.5.5 网页访问"></a>3.5.5 网页访问</h3><pre><code>IP地址:9200/9100</code></pre>
<h2 id="3-6-谷歌浏览器插件形式安装es-head"><a href="#3-6-谷歌浏览器插件形式安装es-head" class="headerlink" title="3.6 谷歌浏览器插件形式安装es-head"></a>3.6 谷歌浏览器插件形式安装es-head</h2><p>[tip type=”info”]<br>使用服务模式安装es-head插件过程比较繁琐，网络不好的时候还会经常卡住，幸运的是es-head插件官方还提供了另外一种更简便的方式，就是google chrome的插件<br>[/tip]</p>
<p>[collapse title=”优势”]<br>1.免安装，直接下载插件安装在浏览器即可</p>
<p>2.只要浏览器和服务器可以通信就能使用</p>
<p>[/collapse]</p>
<h2 id="3-7-安装配置kibana"><a href="#3-7-安装配置kibana" class="headerlink" title="3.7 安装配置kibana"></a>3.7 安装配置kibana</h2><h3 id="3-7-1-安装配置kibana"><a href="#3-7-1-安装配置kibana" class="headerlink" title="3.7.1 安装配置kibana"></a>3.7.1 安装配置kibana</h3><pre><code>[root@Andu soft]# rpm -ivh kibana-6.6.0-x86_64.rpm

[root@Andu soft]# grep &quot;^[a-z]&quot; /etc/kibana/kibana.yml

server.port: 5601

server.host: &quot;192.168.10.66&quot;

elasticsearch.hosts: [&quot;http://localhost:9200&quot;]

kibana.index: &quot;.kibana

[root@Andu soft]# systemctl start kibana

[root@Andu soft]# systemctl status kibana

[root@Andu soft]# netstat -lntup|grep 5601

tcp    0   0 192.168.10.66:5601   0.0.0.0:*        LISTEN   16442/node</code></pre>
<h2 id="3-8-安装filebeat和logstash"><a href="#3-8-安装filebeat和logstash" class="headerlink" title="3.8 安装filebeat和logstash"></a>3.8 安装filebeat和logstash</h2><pre><code>rpm -ivh filebeat-6.6.0-x86_64.rpm

rpm -ivh logstash-6.6.0.rpm </code></pre>
<h2 id="3-9-docker安装elk"><a href="#3-9-docker安装elk" class="headerlink" title="3.9 docker安装elk"></a>3.9 docker安装elk</h2><pre><code>version: &#39;3&#39;

services:

 elasticsearch:

  image: elasticsearch:v1

  container_name: elasticsearch

  environment:

   \- cluster.name=docker-cluster

   \- bootstrap.memory_lock=true

   \- &quot;ES_JAVA_OPTS=-Xms8g -Xmx8g&quot;

   \- &quot;discovery.zen.ping.unicast.hosts=elasticsearch&quot;

  ulimits:

   memlock:

​    soft: -1

​    hard: -1

  volumes:

   \- /data/docker_es_data:/usr/share/elasticsearch/data

  ports:

   \- 19200:9200

  networks:

   \- esnet

 elasticsearch-head:

  image: elasticsearch-head:v1

  container_name: elasticsearch-head

  ports:

   \- 19100:9100

  networks:

   \- esnet

 kibana:

  image: kibana:v1

  container_name: kibana

  environment:

   \- ELASTICSEARCH_URL=&quot;http://elasticsearch:9200&quot;

   \- kibana.index=&quot;.kibana&quot;

  ports:

   \- 15601:5601

  networks:

   \- esnet

 logstash:

  image: logstash:v1

  container_name: logstash 

  environment:

   \- ELASTICSEARCH_URL=&quot;http://elasticsearch:9200&quot;

  ports:

   \- 16379:6379

  networks:

   \- esnet

networks:

 esnet:</code></pre>
<h1 id="第4章-使用filebeat配置日志收集"><a href="#第4章-使用filebeat配置日志收集" class="headerlink" title="第4章 使用filebeat配置日志收集"></a>第4章 使用filebeat配置日志收集</h1><h2 id="4-1-收集nginx日志"><a href="#4-1-收集nginx日志" class="headerlink" title="4.1 收集nginx日志"></a>4.1 收集nginx日志</h2><h3 id="4-1-1-安装nginx和ab工具"><a href="#4-1-1-安装nginx和ab工具" class="headerlink" title="4.1.1 安装nginx和ab工具"></a>4.1.1 安装nginx和ab工具</h3><pre><code>[root@Andu ~]# yum install nginx httpd-tools -y</code></pre>
<h3 id="4-1-2-启动测试"><a href="#4-1-2-启动测试" class="headerlink" title="4.1.2 启动测试"></a>4.1.2 启动测试</h3><pre><code>[root@Andu ~]#  wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

[root@Andu ~]# systemctl start nginx

[root@Andu ~]# netstat -lntup|grep nginx

tcp    0   0 0.0.0.0:80       0.0.0.0:*        LISTEN   1888/nginx: master 

tcp6    0   0 :::80          :::*          LISTEN   1888/nginx: master

[root@Andu ~]# ab -c 10 -n 100 192.168.10.66/

[root@Andu ~]# ab -c 10 -n 100 192.168.10.66/test.html</code></pre>
<h3 id="4-1-3-查看日志"><a href="#4-1-3-查看日志" class="headerlink" title="4.1.3 查看日志"></a>4.1.3 查看日志</h3><pre><code>[root@Andu ~]# tail -f /var/log/nginx/access.log 

192.168.10.66 - - [13/May/2019:00:24:02 +0800] &quot;GET /test.html HTTP/1.0&quot; 404 3650 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;

192.168.10.66 - - [13/May/2019:00:24:02 +0800] &quot;GET /test.html HTTP/1.0&quot; 404 3650 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;

.......................................</code></pre>
<h3 id="4-1-4-配置filebeat收集普通日志"><a href="#4-1-4-配置filebeat收集普通日志" class="headerlink" title="4.1.4 配置filebeat收集普通日志"></a>4.1.4 配置filebeat收集普通日志</h3><p>相关网址</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/7.x/filebeat-input-log.html">https://www.elastic.co/guide/en/beats/filebeat/7.x/filebeat-input-log.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/7.x/configuration-template.html">https://www.elastic.co/guide/en/beats/filebeat/7.x/configuration-template.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/7.x/configuration-template.html">https://www.elastic.co/guide/en/beats/filebeat/7.x/configuration-template.html</a></p>
<p>正确配置</p>
<pre><code>filebeat.inputs:

\- type: log

 enabled: true

 paths:

  \- /var/log/nginx/access.log

 json.keys_under_root: true

 json.overwrite_keys: true</code></pre>
<p>​<br>​<br>    setup.kibana:</p>
<pre><code> host: &quot;192.168.10.66:5601&quot;</code></pre>
<p>​<br>​<br>    output.elasticsearch:</p>
<pre><code> hosts: [&quot;192.168.10.66:9200&quot;]

 index: &quot;nginx-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM&#125;&quot;

setup.template.name: &quot;nginx&quot;

setup.template.pattern: &quot;nginx-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="4-1-5-kibana配置"><a href="#4-1-5-kibana配置" class="headerlink" title="4.1.5 kibana配置"></a>4.1.5 kibana配置</h3><pre><code>management--&gt;index patterns--&gt;nginx--&gt;@timestamp</code></pre>
<h3 id="4-1-6-修改nginx日志为json格式"><a href="#4-1-6-修改nginx日志为json格式" class="headerlink" title="4.1.6 修改nginx日志为json格式"></a>4.1.6 修改nginx日志为json格式</h3><pre><code> log_format main &#39;&#123; &quot;time_local&quot;: &quot;$time_local&quot;, &#39;

​              &#39;&quot;remote_addr&quot;: &quot;$remote_addr&quot;, &#39;

​              &#39;&quot;referer&quot;: &quot;$http_referer&quot;, &#39;

​              &#39;&quot;request&quot;: &quot;$request&quot;, &#39;

​              &#39;&quot;status&quot;: $status, &#39;

​              &#39;&quot;bytes&quot;: $body_bytes_sent, &#39;

​              &#39;&quot;agent&quot;: &quot;$http_user_agent&quot;, &#39;

​              &#39;&quot;x_forwarded&quot;: &quot;$http_x_forwarded_for&quot;, &#39;

​              &#39;&quot;up_addr&quot;: &quot;$upstream_addr&quot;,&#39;

​              &#39;&quot;up_host&quot;: &quot;$upstream_http_host&quot;,&#39;

​              &#39;&quot;upstream_time&quot;: &quot;$upstream_response_time&quot;,&#39;

​              &#39;&quot;request_time&quot;: &quot;$request_time&quot;&#39;

  &#39; &#125;&#39;;</code></pre>
<h3 id="4-1-7-查看日志是否为json格式"><a href="#4-1-7-查看日志是否为json格式" class="headerlink" title="4.1.7 查看日志是否为json格式"></a>4.1.7 查看日志是否为json格式</h3><pre><code>[root@Andu ~]# tail -f /var/log/nginx/access.log  

&#123; &quot;time_local&quot;: &quot;13/May/2019:00:30:51 +0800&quot;, &quot;remote_addr&quot;: &quot;192.168.10.66&quot;, &quot;referer&quot;: &quot;-&quot;, &quot;request&quot;: &quot;GET /test.html HTTP/1.0&quot;, &quot;status&quot;: 404, &quot;bytes&quot;: 3650, &quot;agent&quot;: &quot;ApacheBench/2.3&quot;, &quot;x_forwarded&quot;: &quot;-&quot;, &quot;up_addr&quot;: &quot;-&quot;,&quot;up_host&quot;: &quot;-&quot;,&quot;upstream_time&quot;: &quot;-&quot;,&quot;request_time&quot;: &quot;0.000&quot; &#125;

&#123; &quot;time_local&quot;: &quot;13/May/2019:00:30:51 +0800&quot;, &quot;remote_addr&quot;: &quot;192.168.10.66&quot;, &quot;referer&quot;: &quot;-&quot;, &quot;request&quot;: &quot;GET /test.html HTTP/1.0&quot;, &quot;status&quot;: 404, &quot;bytes&quot;: 3650, &quot;agent&quot;: &quot;ApacheBench/2.3&quot;, &quot;x_forwarded&quot;: &quot;-&quot;, &quot;up_addr&quot;: &quot;-&quot;,&quot;up_host&quot;: &quot;-&quot;,&quot;upstream_time&quot;: &quot;-&quot;,&quot;request_time&quot;: &quot;0.000&quot; &#125;</code></pre>
<h3 id="4-1-8-收集多个日志并分类创建索引"><a href="#4-1-8-收集多个日志并分类创建索引" class="headerlink" title="4.1.8 收集多个日志并分类创建索引"></a>4.1.8 收集多个日志并分类创建索引</h3><p>[tip type=”info”]<br>filebeat配置<br>[/tip]</p>
<pre><code>[root@Andu filebeat]# cat filebeat.yml 

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/access.log

 json.keys_under_root: true

 json.overwrite_keys: true

 tags: [&quot;access&quot;]

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/error.log

 tags: [&quot;error&quot;]

setup.template.settings:

 index.number_of_shards: 3

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.elasticsearch:

 hosts: [&quot;localhost:9200&quot;]

 indices:

  \- index: &quot;nginx_access-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    tags: &quot;access&quot;

  \- index: &quot;nginx_error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    tags: &quot;error&quot;

setup.template.name: &quot;nginx&quot;

setup.template.pattern: &quot;nginx_*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h2 id="4-2-收集tomcat日志"><a href="#4-2-收集tomcat日志" class="headerlink" title="4.2 收集tomcat日志"></a>4.2 收集tomcat日志</h2><h3 id="4-2-1-安装tomcat"><a href="#4-2-1-安装tomcat" class="headerlink" title="4.2.1 安装tomcat"></a>4.2.1 安装tomcat</h3><pre><code>yum install tomcat tomcat-webapps tomcat-admin-webapps tomcat-docs-webapp tomcat-javadoc -y</code></pre>
<h3 id="4-2-2-启动检查"><a href="#4-2-2-启动检查" class="headerlink" title="4.2.2 启动检查"></a>4.2.2 启动检查</h3><pre><code>[root@Andu ~]# systemctl start tomcat

[root@Andu ~]# systemctl status tomcat

[root@Andu ~]# lsof -i:8080

COMMAND  PID  USER  FD  TYPE DEVICE SIZE/OFF NODE NAME

java  18915 tomcat  49u IPv6 61950   0t0 TCP *:webcache (LISTEN)</code></pre>
<h3 id="4-2-3-访问测试"><a href="#4-2-3-访问测试" class="headerlink" title="4.2.3 访问测试"></a>4.2.3 访问测试</h3><h3 id="4-2-4-修改日志为json格式"><a href="#4-2-4-修改日志为json格式" class="headerlink" title="4.2.4 修改日志为json格式"></a>4.2.4 修改日志为json格式</h3><pre><code>[root@Andu ~]# vim /etc/tomcat/server.xml

[root@Andu ~]# cat -n /etc/tomcat/server.xml

\----------------

  137     &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;

  138         prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;

  139         pattern=&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;/&gt;

\----------------</code></pre>
<h3 id="4-2-5-重启确认日志是否为json格式"><a href="#4-2-5-重启确认日志是否为json格式" class="headerlink" title="4.2.5 重启确认日志是否为json格式"></a>4.2.5 重启确认日志是否为json格式</h3><pre><code>[root@Andu ~]# systemctl restart tomcat

[root@Andu ~]# tail -f /var/log/tomcat/localhost_access_log.2019-05-13.txt 

&#123;&quot;clientip&quot;:&quot;192.168.47.1&quot;,&quot;ClientUser&quot;:&quot;-&quot;,&quot;authenticated&quot;:&quot;-&quot;,&quot;AccessTime&quot;:&quot;[13/May/2019:13:18:03 +0800]&quot;,&quot;method&quot;:&quot;GET /docs/images/tomcat.gif HTTP/1.1&quot;,&quot;status&quot;:&quot;200&quot;,&quot;SendBytes&quot;:&quot;2066&quot;,&quot;Query?string&quot;:&quot;&quot;,&quot;partner&quot;:&quot;http://192.168.10.66:8080/docs/realm-howto.html&quot;,&quot;AgentVersion&quot;:&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.109 Safari/537.36&quot;&#125;</code></pre>
<p>在线解析测试正确</p>
<h3 id="4-2-6-filebeat配置"><a href="#4-2-6-filebeat配置" class="headerlink" title="4.2.6 filebeat配置"></a>4.2.6 filebeat配置</h3><pre><code>[root@Andu ~]# cat /etc/filebeat/filebeat.yml 

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/tomcat/localhost_access_log*

 json.keys_under_root: true

 json.overwrite_keys: true

tags: [&quot;tomcat&quot;][[A16\]](#_msocom_16) 

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.elasticsearch:

 hosts: [&quot;localhost:9200&quot;]

 index: &quot;tomcat-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

 when.contains:

​    tags: &quot;tomcat&quot;

setup.template.name: &quot;tomcat&quot;

setup.template.pattern: &quot;tomcatn-*&quot;

setup.template.enabled: false

setup.template.overwrite: true[[A17\]](#_msocom_17) </code></pre>
<p>[tip type=”success”]<br>亲测可用配置为如下<br>[/tip]</p>
<pre><code>filebeat.inputs:

\#################tomcat#############

\- type: log

 enabled: true

 paths:

  \- /var/log/tomcat/localhost_access_log.*.txt

 json.keys_under_root: true

 json.overwrite_keys: true

\#################output#############

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.elasticsearch:

 hosts: [&quot;192.168.10.66:9200&quot;]

 indices:

  \- index: &quot;tomcat-access-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM&#125;&quot;

setup.template.name: &quot;tomcat&quot;

setup.template.pattern: &quot;tomcat-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="4-2-7-配置tomcat收集多个域名的日志"><a href="#4-2-7-配置tomcat收集多个域名的日志" class="headerlink" title="4.2.7 配置tomcat收集多个域名的日志"></a>4.2.7 配置tomcat收集多个域名的日志</h3><p>配置多个host标签</p>
<h2 id="4-3-收集java日志"><a href="#4-3-收集java日志" class="headerlink" title="4.3 收集java日志"></a>4.3 收集java日志</h2><h3 id="4-3-1-官方地址"><a href="#4-3-1-官方地址" class="headerlink" title="4.3.1 官方地址"></a>4.3.1 官方地址</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.6/multiline-examples.html">https://www.elastic.co/guide/en/beats/filebeat/6.6/multiline-examples.html</a></p>
<p>因为java日志的输出信息非常多，需要将多行拼成一个事件，所以需要多行匹配模式</p>
<p>因为elasticsearch本身就是java开发的，所以我们可以直接收集ES的日志</p>
<h3 id="4-3-2-filebeat配置"><a href="#4-3-2-filebeat配置" class="headerlink" title="4.3.2 filebeat配置"></a>4.3.2 filebeat配置</h3><pre><code>[root@Andu ~]# cat /etc/filebeat/filebeat.yml    

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/elasticsearch/elasticsearch.log

 multiline.pattern: &#39;^\[&#39;

 multiline.negate: true

 multiline.match: after

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.elasticsearch:

 hosts: [&quot;localhost:9200&quot;]

 index: &quot;es-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

setup.template.name: &quot;es&quot;

setup.template.pattern: &quot;es-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h2 id="4-4-收集docker日志"><a href="#4-4-收集docker日志" class="headerlink" title="4.4 收集docker日志"></a>4.4 收集docker日志</h2><h3 id="4-4-1-安装docker"><a href="#4-4-1-安装docker" class="headerlink" title="4.4.1 安装docker"></a>4.4.1 安装docker</h3><pre><code>rm -fr /etc/yum.repos.d/local.repo

curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo

sed -i &#39;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g&#39; /etc/yum.repos.d/docker-ce.repo

yum install docker-ce -y

systemctl start docker

vi /etc/docker/daemon.json

&#123;

 &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]

 &#125;

systemctl restart docker</code></pre>
<h3 id="4-4-2-运行nginx镜像"><a href="#4-4-2-运行nginx镜像" class="headerlink" title="4.4.2 运行nginx镜像"></a>4.4.2 运行nginx镜像</h3><pre><code>docker pull nginx

docker run --name nginx -p 80:80 -d nginx

docker ps

docker logs -f nginx</code></pre>
<h3 id="4-4-3-配置filebeat收集单个docker日志"><a href="#4-4-3-配置filebeat收集单个docker日志" class="headerlink" title="4.4.3 配置filebeat收集单个docker日志"></a>4.4.3 配置filebeat收集单个docker日志</h3><p>官方介绍：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-input-docker.html">https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-input-docker.html</a></p>
<p>首先查看docker容器的ID</p>
<pre><code>docker inspect nginx-test|grep -w &quot;Id&quot;</code></pre>
<p>配置文件</p>
<pre><code>filebeat.inputs:

\- type: docker

 containers.ids: 

  \- &#39;2338d5038f7a2eac96d84d6cf424fb1829bd754ec5e0df944bdd29ba6d61a54e&#39;

 tags: [&quot;docker-nginx&quot;] 

output.elasticsearch:

 hosts: [&quot;localhost:9200&quot;]

 index: &quot;docker-nginx-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

setup.template.name: &quot;docker&quot;

setup.template.pattern: &quot;docker-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="4-4-4-使用通配符收集所有容器的日志"><a href="#4-4-4-使用通配符收集所有容器的日志" class="headerlink" title="4.4.4 使用通配符收集所有容器的日志"></a>4.4.4 使用通配符收集所有容器的日志</h3><p>新版本的filebeat增加了收集多个容器的日志的选项</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/7.2/filebeat-input-container.html">https://www.elastic.co/guide/en/beats/filebeat/7.2/filebeat-input-container.html</a></p>
<h3 id="4-4-5-配置filebeat通过标签收集多个容器日志"><a href="#4-4-5-配置filebeat通过标签收集多个容器日志" class="headerlink" title="4.4.5 配置filebeat通过标签收集多个容器日志"></a>4.4.5 配置filebeat通过标签收集多个容器日志</h3><p>假如我们有多个docker镜像或者重新提交了新镜像，那么直接指定ID的就不是太方便了。</p>
<p>我们从当前的容器提交一个新的镜像并且运行起来</p>
<pre><code>docker commit nginx nginx:v2

docker images

docker run --name nginx -p 8080:80 -d nginx:v2</code></pre>
<p>此时我们的容器目录下就有了两个不同的容器目录</p>
<pre><code>[root@elk-176 containers]# ls /var/lib/docker/containers/         

2338d5038f7a2eac96d84d6cf424fb1829bd754ec5e0df944bdd29ba6d61a54e 3bb5250e7e50a4ed8d1fae7a43d3bf4294864ac4e0af125ae5231cd9bd76b914</code></pre>
<p>如果直接配置filebeat存到es里本台机器所有的容器日志都会混在一起没有办法区分</p>
<p>多容器日志收集处理：</p>
<p>其实收集的日志本质来说还是文件，而这个日志是以容器-json.log命名存放在默认目录下的json格式的文件：</p>
<pre><code>[root@elk-176 ~]# head -1 /var/lib/docker/containers/2338d5038f7a2eac96d84d6cf424fb1829bd754ec5e0df944bdd29ba6d61a54e/2338d5038f7a2eac96d84d6cf424fb1829bd754ec5e0df944bdd29ba6d61a54e-json.log

&#123;&quot;log&quot;:&quot;192.168.47.1 - - [23/May/2019:19:12:04 +0000] \&quot;GET / HTTP/1.1\&quot; 200 612 \&quot;-\&quot; \&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Safari/537.36\&quot; \&quot;-\&quot;\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,&quot;time&quot;:&quot;2019-05-23T19:12:04.939212514Z&quot;&#125;</code></pre>
<p>但是每个容器的ID都不一样，为了区分不同服务运行的不同容器，可以使用docker-compose通过给容器添加labels标签来作为区分</p>
<p>然后filbeat把容器日志当作普通的json格式来解析并传输到es</p>
<p>操作步骤：</p>
<p>1.安装docker-compose</p>
<pre><code>yum install -y python2-pip</code></pre>
<p>2.这里使用pip安装，默认源为国外，可以使用国内加速，相关网站</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/">https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</a></p>
<p>pip加速操作命令</p>
<pre><code>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U

pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></pre>
<p>3.继续安装docker-compose</p>
<pre><code>pip install docker-compose</code></pre>
<p>4.检查</p>
<pre><code>docker-compose version</code></pre>
<p>5.编写docker-compose.yml</p>
<pre><code>[root@elk-176 ~]# cat docker-compose.yml 

version: &#39;3&#39;

services:

 nginx:

  image: nginx:v2</code></pre>
<p>  # 设置labels</p>
<pre><code> labels:

   service: nginx

  \# logging设置增加labels.service

  logging:

   options:

​    labels: &quot;service&quot;

  ports:

   \- &quot;8080:80&quot;

 db:

  image: nginx:latest

  \# 设置labels

  labels:

   service: db 

  \# logging设置增加labels.service

  logging:

   options:

​    labels: &quot;service&quot;

  ports:

   \- &quot;80:80&quot;</code></pre>
<p>6.清理镜像</p>
<pre><code>docker ps -a|awk &#39;NR&gt;1&#123;print &quot;docker rm&quot;,$1&#125;&#39;|bash</code></pre>
<p>7.运行docker-compose.yml</p>
<pre><code>docker-compose up -d</code></pre>
<p>8.检查日志是否增加了lable标签</p>
<pre><code>[root@elk-176 ~]# tail -1 /var/lib/docker/containers/b2c1f4f7f5a2967fe7d12c1db124ae41f009ec663c71608575a4773beb6ca5f8/b2c1f4f7f5a2967fe7d12c1db124ae41f009ec663c71608575a4773beb6ca5f8-json.log

&#123;&quot;log&quot;:&quot;192.168.47.1 - - [23/May/2019:13:22:32 +0000] \&quot;GET / HTTP/1.1\&quot; 304 0 \&quot;-\&quot; \&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Safari/537.36\&quot; \&quot;-\&quot;\n&quot;,&quot;stream&quot;:&quot;stdout&quot;,&quot;attrs&quot;:&#123;&quot;service&quot;:&quot;nginx&quot;&#125;,&quot;time&quot;:&quot;2019-05-23T13:22:32.478708392Z&quot;&#125;</code></pre>
<p>9.配置filebeat</p>
<pre><code>[root@elk-176 ~]# cat /etc/filebeat/filebeat.yml   

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/lib/docker/containers/*/*-json.log

 json.keys_under_root: true

 json.overwrite_keys: true

output.elasticsearch:

 hosts: [&quot;192.168.10.66:9200&quot;]

 indices:

  \- index: &quot;docker-nginx-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    attrs.service: &quot;nginx&quot;

  \- index: &quot;docker-db-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    attrs.service: &quot;db&quot;

setup.template.name: &quot;docker&quot;

setup.template.pattern: &quot;docker-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="4-4-6-配置filebeat通过服务类型和日志类型多条件创建不同索引"><a href="#4-4-6-配置filebeat通过服务类型和日志类型多条件创建不同索引" class="headerlink" title="4.4.6 配置filebeat通过服务类型和日志类型多条件创建不同索引"></a>4.4.6 配置filebeat通过服务类型和日志类型多条件创建不同索引</h3><p>目前为止，已经可以按服务来收集日志了，但是错误日志和正确日志混在了一起，不好区分，所以可以进一步进行条件判断，根据服务和日志类型创建不同的索引</p>
<p>filebeat配置文件</p>
<pre><code>[root@elk-176 ~]# cat /etc/filebeat/filebeat.yml     

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/lib/docker/containers/*/*-json.log

 json.keys_under_root: true

 json.overwrite_keys: true

output.elasticsearch:

 hosts: [&quot;192.168.10.66:9200&quot;]

 indices:

  \- index: &quot;docker-nginx-access-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​     attrs.service: &quot;nginx&quot;

​     stream: &quot;stdout&quot;

  \- index: &quot;docker-nginx-error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​     attrs.service: &quot;nginx&quot;

​     stream: &quot;stderr&quot;

  \- index: &quot;docker-db-access-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​     attrs.service: &quot;db&quot;

​     stream: &quot;stdout&quot;

  \- index: &quot;docker-db-error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​     attrs.service: &quot;db&quot;

​     stream: &quot;stderr&quot;

setup.template.name: &quot;docker&quot;

setup.template.pattern: &quot;docker-*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="4-4-7-验证提交新镜像运行后日志收集情况"><a href="#4-4-7-验证提交新镜像运行后日志收集情况" class="headerlink" title="4.4.7 验证提交新镜像运行后日志收集情况"></a>4.4.7 验证提交新镜像运行后日志收集情况</h3><p>1.提交新镜像</p>
<pre><code>[root@elk-176 ~]# docker ps -a

CONTAINER ID    IMAGE        COMMAND         CREATED       STATUS           PORTS        NAMES

f92f4d747584    nginx:latest    &quot;nginx -g &#39;daemon of…&quot;  45 minutes ago   Exited (0) 51 seconds ago            root_db_1

b2c1f4f7f5a2    nginx:v2      &quot;nginx -g &#39;daemon of…&quot;  45 minutes ago   Exited (0) 51 seconds ago            root_nginx_1

[root@elk-176 ~]# docker commit root_nginx_1 nginx:v3     

sha256:4457e2b7afc719ef185c75c02031b11c1407efe2e2e57b85f0c9347d04a9ff00

[root@elk-176 ~]# docker commit root_db_1 nginx:v4

sha256:a7e8d8b3290c817194956aa06fc486ef928853121d9c6224fd64fe759c967dda

[root@elk-176 ~]# docker images

REPOSITORY     TAG         IMAGE ID      CREATED       SIZE

nginx        v4          a7e8d8b3290c    35 seconds ago   109MB

nginx        v3         4457e2b7afc7    45 seconds ago   109MB

nginx        v2         c181c6355cd9    2 hours ago     109MB

nginx        latest        53f3fd8007f7    2 weeks ago     109MB</code></pre>
<p>2.修改并运行docker-compose</p>
<pre><code>[root@elk-176 ~]# cat docker-compose.yml 

version: &#39;3&#39;

services:

 nginx:

  image: nginx:v3

  \# 设置labels

  labels:

   service: nginx

  \# logging设置增加labels.service

  logging:

   options:

​    labels: &quot;service&quot;

  ports:

   \- &quot;8080:80&quot;

 db:

  image: nginx:v4

  \# 设置labels

  labels:

   service: db 

  \# logging设置增加labels.service

  logging:

   options:

​    labels: &quot;service&quot;

  ports:

   \- &quot;80:80&quot;

[root@elk-176 ~]# docker-compose up -d

Starting root_nginx_1 ... 

Starting root_nginx_1 ... done

Starting root_db_1  ... done

[root@elk-176 ~]# docker ps

CONTAINER ID    IMAGE        COMMAND         CREATED       STATUS       PORTS         NAMES

04308aa3928b    nginx:v4       &quot;nginx -g &#39;daemon of…&quot;  30 seconds ago   Up 1 second     0.0.0.0:80-&gt;80/tcp   root_db_1

49d2e2210e6f    nginx:v3       &quot;nginx -g &#39;daemon of…&quot;  30 seconds ago   Up 1 second     0.0.0.0:8080-&gt;80/tcp  root_nginx_1</code></pre>
<p>3.访问并查看是否有新数据生成</p>
<pre><code>curl logcalhost/zhangya.html

curl logcalhost:8080/zhangya.html</code></pre>
<p>4.经过查看发现已经成功收集到了日志，这样我们就做到了不用修改filebeat配置文件也可以持续的收集新镜像的日志并按分类创建不同的索引</p>
<h3 id="4-4-8-修改docker容器内日志类型为json"><a href="#4-4-8-修改docker容器内日志类型为json" class="headerlink" title="4.4.8 修改docker容器内日志类型为json"></a>4.4.8 修改docker容器内日志类型为json</h3><p>刚才收集的docker内的日志类型为普通格式，如果我们修改为json格式会如何呢？</p>
<h1 id="第5章-使用filledeat-modules配置"><a href="#第5章-使用filledeat-modules配置" class="headerlink" title="第5章 使用filledeat modules配置"></a>第5章 使用filledeat modules配置</h1><h2 id="5-1-官方网址"><a href="#5-1-官方网址" class="headerlink" title="5.1 官方网址"></a>5.1 官方网址</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/beats/filebeat/6.6/configuration-filebeat-modules.html">https://www.elastic.co/guide/en/beats/filebeat/6.6/configuration-filebeat-modules.html</a></p>
<h2 id="5-2-使用模版配置nginx正常日志"><a href="#5-2-使用模版配置nginx正常日志" class="headerlink" title="5.2 使用模版配置nginx正常日志"></a>5.2 使用模版配置nginx正常日志</h2><p>社区论坛：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://discuss.elastic.co/t/filebeat-module-custom-index/181350">https://discuss.elastic.co/t/filebeat-module-custom-index/181350</a></p>
<h3 id="5-2-1-filebeat配置文件"><a href="#5-2-1-filebeat配置文件" class="headerlink" title="5.2.1 filebeat配置文件"></a>5.2.1 filebeat配置文件</h3><pre><code>[root@Andu ~]# cat /etc/filebeat/filebeat.yml 

filebeat.config.modules:

 path: $&#123;path.config&#125;/modules.d/*.yml

 reload.enabled: true

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.elasticsearch:

 hosts: [&quot;localhost:9200&quot;]

 indices:

  \- index: &quot;nginx_access-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    fileset.name: &quot;access&quot;

  \- index: &quot;nginx_error-%&#123;[beat.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;

   when.contains:

​    fileset.name: &quot;error&quot;

setup.template.name: &quot;nginx&quot;

setup.template.pattern: &quot;nginx_*&quot;

setup.template.enabled: false

setup.template.overwrite: true</code></pre>
<h3 id="5-2-2-filebeat-modules配置"><a href="#5-2-2-filebeat-modules配置" class="headerlink" title="5.2.2 filebeat modules配置"></a>5.2.2 filebeat modules配置</h3><p>使用nginx模版配置需要安装2个插件，默认从官网下载速度太慢，可以提前下载然后离线安装</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/ingest-geoip.html">https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/ingest-geoip.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/plugin-management-custom-url.html">https://www.elastic.co/guide/en/elasticsearch/plugins/6.6/plugin-management-custom-url.html</a></p>
<p>在线安装：</p>
<pre><code>[root@Andu ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-user-agent

[root@Andu ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-geoip</code></pre>
<p>离线下载安装：</p>
<pre><code>[root@Andu ~]# wget https://artifacts.elastic.co/downloads/elasticsearch-plugins/ingest-user-agent/ingest-user-agent-6.6.0.zip

[root@Andu ~]# wget https://artifacts.elastic.co/downloads/elasticsearch-plugins/ingest-geoip/ingest-geoip-6.6.0.zip

[root@Andu ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin install file:///root/ingest-geoip-6.6.0.zip 

[root@Andu ~]# /usr/share/elasticsearch/bin/elasticsearch-plugin install file:///root/ingest-user-agent-6.6.0.zip </code></pre>
<p>激活nginx模块：</p>
<pre><code>[root@Andu ~]# filebeat modules enable nginx      

[root@Andu ~]# egrep -v &quot;#|^$&quot; /etc/filebeat/modules.d/nginx.yml    

\- module: nginx

 access:

  enabled: true

  var.paths: [&quot;/var/log/nginx/access.log&quot;]

 error:

  enabled: true

  var.paths: [&quot;/var/log/nginx/error.log&quot;</code></pre>
<p>注意：6.7之后这两个插件默认集成到了elasticsearch，不需要单独安装了</p>
<h2 id="5-3-使用模块收集系统日志message和secure日志"><a href="#5-3-使用模块收集系统日志message和secure日志" class="headerlink" title="5.3 使用模块收集系统日志message和secure日志"></a>5.3 使用模块收集系统日志message和secure日志</h2><p>如果不需要转换，也可以直接按普通日志模式收集message和secure日志</p>
<h2 id="5-4-导入kibana视图"><a href="#5-4-导入kibana视图" class="headerlink" title="5.4 导入kibana视图"></a>5.4 导入kibana视图</h2><p>默认如果使用filbeat模版导入视图会把所有的服务都导入进去,而我们实际上并不需要这么多视图，</p>
<p>而且默认的视图模版只能匹配filebeat-*开头的索引，所以这里我们有2个需要需要解决：</p>
<p>1.通过一定处理只导入我们需要的模版</p>
<p>2.导入的视图模版索引名称可以自定义</p>
<p>解决方法：</p>
<p>1.备份一份filebeat的kibana视图，删除不需要的视图模版文件</p>
<p>2.修改视图文件里默认的索引名称为我们需要的索引名称</p>
<pre><code>cp -a /usr/share/filebeat/kibana /root

find . -type f ! -name &quot;*nginx*&quot;|xargs rm -rf

sed -i &#39;s#filebeat\-\*#nginx\-\*#g&#39; Filebeat-nginx-overview.json </code></pre>
<p>替换索引名称</p>
<pre><code>filebeat setup --dashboards -E setup.dashboards.directory=/root/kibana/</code></pre>
<h2 id="5-5-使用模块收集mysql日志和慢日志"><a href="#5-5-使用模块收集mysql日志和慢日志" class="headerlink" title="5.5 使用模块收集mysql日志和慢日志"></a>5.5 使用模块收集mysql日志和慢日志</h2><h2 id="5-6-使用模块收集mongo日志和redis日志"><a href="#5-6-使用模块收集mongo日志和redis日志" class="headerlink" title="5.6 使用模块收集mongo日志和redis日志"></a>5.6 使用模块收集mongo日志和redis日志</h2><h1 id="第6章-使用缓存收集日志"><a href="#第6章-使用缓存收集日志" class="headerlink" title="第6章 使用缓存收集日志"></a>第6章 使用缓存收集日志</h1><p>当日志的数量非常多的时候，可能需要引入缓存层作为临时存储数据的地方，防止因为ES处理不过来导致日志丢失的情况。</p>
<p>filebeat支持将日志发送到redis或者kafka作为消息队列缓存。</p>
<p>但是使用了缓存层，就不能使用模版来配置日志收集了。</p>
<p>所以最好日志是json格式</p>
<h2 id="6-1-使用单台redis作为缓存"><a href="#6-1-使用单台redis作为缓存" class="headerlink" title="6.1 使用单台redis作为缓存"></a>6.1 使用单台redis作为缓存</h2><p>这里需要说明，如果使用redis作为缓存</p>
<p>可以将不同的日志类型单独写成一个键，这样好处是清晰，但是缺点是logstash写起来起来复杂</p>
<p>也可以将所有的日志全部写入到一个键中，然后靠后端的logstash去过滤处理。</p>
<h3 id="6-1-1-安装启动测试redis"><a href="#6-1-1-安装启动测试redis" class="headerlink" title="6.1.1 安装启动测试redis"></a>6.1.1 安装启动测试redis</h3><pre><code>[root@Andu ~]# yum install redis -y

[root@Andu ~]# systemctl status redis

[root@Andu ~]# redis-cli 

127.0.0.1:6379&gt; set k1 v1

OK

127.0.0.1:6379&gt; GEt k1

&quot;v1&quot;

127.0.0.1:6379&gt;</code></pre>
<h3 id="6-1-2-配置nginx的json日志"><a href="#6-1-2-配置nginx的json日志" class="headerlink" title="6.1.2 配置nginx的json日志"></a>6.1.2 配置nginx的json日志</h3><p>将nginx的日志调整为json格式</p>
<pre><code>  log_format json &#39;&#123; &quot;time_local&quot;: &quot;$time_local&quot;, &#39;

​              &#39;&quot;remote_addr&quot;: &quot;$remote_addr&quot;, &#39;

​              &#39;&quot;referer&quot;: &quot;$http_referer&quot;, &#39;

​              &#39;&quot;request&quot;: &quot;$request&quot;, &#39;

​              &#39;&quot;status&quot;: $status, &#39;

​              &#39;&quot;bytes&quot;: $body_bytes_sent, &#39;

​              &#39;&quot;agent&quot;: &quot;$http_user_agent&quot;, &#39;

​              &#39;&quot;x_forwarded&quot;: &quot;$http_x_forwarded_for&quot;, &#39;

​              &#39;&quot;up_addr&quot;: &quot;$upstream_addr&quot;,&#39;

​              &#39;&quot;up_host&quot;: &quot;$upstream_http_host&quot;,&#39;

​              &#39;&quot;upstream_time&quot;: &quot;$upstream_response_time&quot;,&#39;

​              &#39;&quot;request_time&quot;: &quot;$request_time&quot;&#39; &#39; &#125;&#39;;</code></pre>
<h3 id="6-1-3-配置filebeat写入到不同的key中"><a href="#6-1-3-配置filebeat写入到不同的key中" class="headerlink" title="6.1.3 配置filebeat写入到不同的key中"></a>6.1.3 配置filebeat写入到不同的key中</h3><pre><code>[root@Andu ~]# cat /etc/filebeat/filebeat.yml 

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/access.log

 json.keys_under_root: true

 json.overwrite_keys: true

 tags: [&quot;access&quot;]

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/error.log

 tags: [&quot;error&quot;]

setup.template.settings:

 index.number_of_shards: 3

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.redis:

 hosts: [&quot;localhost&quot;]

 keys:

  \- key: &quot;nginx_access&quot;  

   when.contains:

​    tags: &quot;access&quot;

  \- key: &quot;nginx_error&quot;

   when.contains:

​    tags: &quot;error&quot;</code></pre>
<h3 id="6-1-4-配置logstash读取不同的key"><a href="#6-1-4-配置logstash读取不同的key" class="headerlink" title="6.1.4 配置logstash读取不同的key"></a>6.1.4 配置logstash读取不同的key</h3><pre><code>[root@Andu ~]# cat /etc/logstash/conf.d/redis.conf  

input &#123;

 redis &#123;

  host =&gt; &quot;127.0.0.1&quot;

  port =&gt; &quot;6379&quot;

  db =&gt; &quot;0&quot;

  key =&gt; &quot;nginx_access&quot;

  data_type =&gt; &quot;list&quot;

 &#125;

 redis &#123;

  host =&gt; &quot;127.0.0.1&quot;

  port =&gt; &quot;6379&quot;

  db =&gt; &quot;0&quot;

  key =&gt; &quot;nginx_error&quot;

  data_type =&gt; &quot;list&quot;

 &#125;

&#125;</code></pre>
<p>​<br>​<br>    filter {</p>
<pre><code> mutate &#123;

  convert =&gt; [&quot;upstream_time&quot;, &quot;float&quot;]

  convert =&gt; [&quot;request_time&quot;, &quot;float&quot;]

 &#125;

&#125;</code></pre>
<p>​<br>​<br>    output {</p>
<pre><code>  stdout &#123;&#125;

  if &quot;access&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_access-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

  if &quot;error&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_error-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

&#125;</code></pre>
<h3 id="6-1-5-filebeat收集日志写入到一个key中"><a href="#6-1-5-filebeat收集日志写入到一个key中" class="headerlink" title="6.1.5 filebeat收集日志写入到一个key中"></a>6.1.5 filebeat收集日志写入到一个key中</h3><pre><code>[root@Andu ~]# cat /etc/filebeat/filebeat.yml 

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/access.log

 json.keys_under_root: true

 json.overwrite_keys: true

 tags: [&quot;access&quot;]

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/error.log

 tags: [&quot;error&quot;]

setup.template.settings:

 index.number_of_shards: 3

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.redis:

 hosts: [&quot;localhost&quot;]

 key: &quot;filebeat&quot;</code></pre>
<h3 id="6-1-6-logstash根据tag区分一个key里的不同日志"><a href="#6-1-6-logstash根据tag区分一个key里的不同日志" class="headerlink" title="6.1.6 logstash根据tag区分一个key里的不同日志"></a>6.1.6 logstash根据tag区分一个key里的不同日志</h3><p>[root@Andu ~]# cat /etc/logstash/conf.d/redis.conf </p>
<pre><code>input &#123;

 redis &#123;

  host =&gt; &quot;127.0.0.1&quot;

  port =&gt; &quot;6379&quot;

  db =&gt; &quot;0&quot;

  key =&gt; &quot;filebeat&quot;

  data_type =&gt; &quot;list&quot;

 &#125;

&#125;

filter &#123;

 mutate &#123;

  convert =&gt; [&quot;upstream_time&quot;, &quot;float&quot;]

  convert =&gt; [&quot;request_time&quot;, &quot;float&quot;]

 &#125;

&#125;

output &#123;

  if &quot;access&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_access-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

  if &quot;error&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_error-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

&#125;</code></pre>
<h2 id="6-2-使用nginx-keepalived代理多台redis"><a href="#6-2-使用nginx-keepalived代理多台redis" class="headerlink" title="6.2 使用nginx+keepalived代理多台redis"></a>6.2 使用nginx+keepalived代理多台redis</h2><h3 id="6-2-1-解决方案介绍"><a href="#6-2-1-解决方案介绍" class="headerlink" title="6.2.1 解决方案介绍"></a>6.2.1 解决方案介绍</h3><p>上面我们实验了单台redis作为收集日志的缓存层，但是单台redis存在一个问题，就是单点故障</p>
<p>虽然可以做持久化处理，但是加入服务器坏掉或者修复时间未知的情况下还是有可能会丢数据。</p>
<p>redis集群方案有哨兵和集群，但可惜的是filebeat和logstash都不支持这两种方案。</p>
<p>不过利用我们目前所学的知识完全可以解决这个问题，虽然不是彻底解决，但是已经很好了</p>
<p>方案如下：</p>
<p>1.使用nginx+keepalived反向代理负载均衡到后面的多台redis</p>
<p>2.考虑到redis故障切换中数据一致性的问题，所以最好我们只使用2台redis,并且只工作一台，另外一台作为backup，只有第一台坏掉后，第二台才会工作。</p>
<p>3.filebeat的oputut的redis地址为keepalived的虚拟IP</p>
<p>4.logstash可以启动多个节点来加速读取redis的数据</p>
<p>5.后端可以采用多台es集群来做支撑</p>
<h3 id="6-2-2-nginx配置文件"><a href="#6-2-2-nginx配置文件" class="headerlink" title="6.2.2 nginx配置文件"></a>6.2.2 nginx配置文件</h3><p>注意：添加stream模块，要在nginx.conf里最后添加，而不是在conf.d里面添加子配置</p>
<pre><code>[root@lb02 ~]# cat /etc/nginx/nginx.conf

..........................

stream &#123;

 upstream redis &#123;

   server 10.0.0.51:6381 max_fails=2 fail_timeout=10s;

   server 10.0.0.51:6382 max_fails=2 fail_timeout=10s backup;

 &#125;</code></pre>
<p>​<br>​<br>     server {</p>
<pre><code>​     listen 6379;

​     proxy_connect_timeout 1s;

​     proxy_timeout 3s;

​     proxy_pass redis;

 &#125;

&#125;</code></pre>
<h3 id="6-2-3-redis配置"><a href="#6-2-3-redis配置" class="headerlink" title="6.2.3 redis配置"></a>6.2.3 redis配置</h3><pre><code>[root@db01 /opt/redis_6381/conf]# cat /opt/redis_6381/conf/redis_6381.conf       

bind 10.0.0.51

port 6381

daemonize yes

pidfile /opt/redis_6381/pid/redis_6381.pid

logfile /opt/redis_6381/logs/redis_6381.log

databases 16

save 900 1

save 300 10

save 60 10000

stop-writes-on-bgsave-error yes

rdbcompression yes

rdbchecksum yes

dbfilename redis_6381.rdb

dir /data/redis_6381</code></pre>
<h3 id="6-2-4-模拟故障测试"><a href="#6-2-4-模拟故障测试" class="headerlink" title="6.2.4 模拟故障测试"></a>6.2.4 模拟故障测试</h3><h3 id="6-2-5-logstash配置"><a href="#6-2-5-logstash配置" class="headerlink" title="6.2.5 logstash配置"></a>6.2.5 logstash配置</h3><h3 id="6-2-6-使用supervisor批量管理多个logstash进程"><a href="#6-2-6-使用supervisor批量管理多个logstash进程" class="headerlink" title="6.2.6 使用supervisor批量管理多个logstash进程"></a>6.2.6 使用supervisor批量管理多个logstash进程</h3><h2 id="6-3-使用kafka作为缓存"><a href="#6-3-使用kafka作为缓存" class="headerlink" title="6.3 使用kafka作为缓存"></a>6.3 使用kafka作为缓存</h2><h3 id="6-3-1-介绍"><a href="#6-3-1-介绍" class="headerlink" title="6.3.1 介绍"></a>6.3.1 介绍</h3><h3 id="6-3-2-zookeeper安装配置"><a href="#6-3-2-zookeeper安装配置" class="headerlink" title="6.3.2 zookeeper安装配置"></a>6.3.2 zookeeper安装配置</h3><h3 id="6-3-3-kafka安装配置"><a href="#6-3-3-kafka安装配置" class="headerlink" title="6.3.3 kafka安装配置"></a>6.3.3 kafka安装配置</h3><h3 id="6-3-4-kafka集群收发消息测试"><a href="#6-3-4-kafka集群收发消息测试" class="headerlink" title="6.3.4 kafka集群收发消息测试"></a>6.3.4 kafka集群收发消息测试</h3><h3 id="6-3-5-filebeat配置"><a href="#6-3-5-filebeat配置" class="headerlink" title="6.3.5 filebeat配置"></a>6.3.5 filebeat配置</h3><pre><code>[root@kafka-175 conf.d]# cat /etc/filebeat/filebeat.yml 

filebeat.inputs:

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/access.log

 json.keys_under_root: true

 json.overwrite_keys: true

 tags: [&quot;access&quot;]

\- type: log

 enabled: true 

 paths:

  \- /var/log/nginx/error.log

 tags: [&quot;error&quot;]

setup.template.settings:

 index.number_of_shards: 3

setup.kibana:

 host: &quot;192.168.10.66:5601&quot;

output.kafka:

 hosts: [&quot;192.168.10.66:9092&quot;,&quot;192.168.47.176:9092&quot;,&quot;192.168.47.177:9092&quot;]

 topic: elklog</code></pre>
<h3 id="6-3-6-logstash配置"><a href="#6-3-6-logstash配置" class="headerlink" title="6.3.6 logstash配置"></a>6.3.6 logstash配置</h3><pre><code>[root@kafka-175 conf.d]# cat /etc/logstash/conf.d/kafka.conf

input&#123;

 kafka&#123;

  bootstrap_servers=&gt;&quot;192.168.10.66:9092&quot;

  topics=&gt;[&quot;elklog&quot;]

  group_id=&gt;&quot;logstash&quot;

  codec =&gt; &quot;json&quot;

 &#125;

&#125;

filter &#123;

 mutate &#123;

  convert =&gt; [&quot;upstream_time&quot;, &quot;float&quot;]                                                            

  convert =&gt; [&quot;request_time&quot;, &quot;float&quot;]

 &#125;

&#125;

output &#123;

  if &quot;access&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_access-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

  if &quot;error&quot; in [tags] &#123;

   elasticsearch &#123;

​    hosts =&gt; &quot;http://localhost:9200&quot;

​    manage_template =&gt; false

​    index =&gt; &quot;nginx_error-%&#123;+yyyy.MM.dd&#125;&quot;

   &#125;

  &#125;

&#125;</code></pre>
<h1 id="第7章-配置logstash同步mysql数据"><a href="#第7章-配置logstash同步mysql数据" class="headerlink" title="第7章 配置logstash同步mysql数据"></a>第7章 配置logstash同步mysql数据</h1><p>略</p>
<h1 id="第8章-kibana画图展示"><a href="#第8章-kibana画图展示" class="headerlink" title="第8章 kibana画图展示"></a>第8章 kibana画图展示</h1><p>略</p>
<h1 id="第9章-grafana画图展示"><a href="#第9章-grafana画图展示" class="headerlink" title="第9章 grafana画图展示"></a>第9章 grafana画图展示</h1><p>除了kibana外，grafana也支持从es调取数据并展示</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://grafana.com/docs/features/datasources/elasticsearch/#using-elasticsearch-in-grafana">https://grafana.com/docs/features/datasources/elasticsearch/#using-elasticsearch-in-grafana</a></p>
<h1 id="第10章-如何在公司推广ELK项目"><a href="#第10章-如何在公司推广ELK项目" class="headerlink" title="第10章 如何在公司推广ELK项目"></a>第10章 如何在公司推广ELK项目</h1><p>如何在公司推广ELK的项目</p>
<p>1.优先表达出对其他人带来的便利和好处</p>
<p>- 领导</p>
<p>- 开发</p>
<p>- 测试</p>
<p>- DBA</p>
<p>– 以后你自己相查什么数据都可以直接查</p>
<p>– 以前插个日志运维得查10分钟，现在你只要点几下鼠标就ok了</p>
<p>– 我专门为你们部门定制了一个图形面板，你看看效果，有啥不满意的尽管说，我优先给你们部门解决</p>
<p>2.对于运维来说，json日志更友好</p>
<p>- 告诉领导，json格式更友好，做出测试环境，并给领导演示json格式优点</p>
<p>- 提前统计好到底需要收集哪些日志</p>
<p>- 要求能转成json的就转成json</p>
<p>- 自己改不了的，给领导说，让开发改成json格式</p>
<p>- 那行，领导你看，如果不改成json，就只能是这个效果了，后续的新需求，可能就满足不了了</p>
<p>- 并不是说所有日志，必须是json</p>
<p>3.推广演示</p>
<p>- 提前都准备好文档和ppt还有测试环境</p>
<p>- 一定要对比传统分析日志和ELK之后带来的巨大改变</p>
<h1 id="第11章-面试问题"><a href="#第11章-面试问题" class="headerlink" title="第11章 面试问题"></a>第11章 面试问题</h1><hr>
<p> [<a href="#_msoanchor_1">A1]</a>ELK每个组件都需要JAVA环境</p>
<p> [<a href="#_msoanchor_2">A2]</a>搭建群集一定要同步时间</p>
<p> [<a href="#_msoanchor_3">A3]</a>数据库存储目录</p>
<p> [<a href="#_msoanchor_4">A4]</a>日志文件存储位置</p>
<p> [<a href="#_msoanchor_5">A5]</a>锁定内存</p>
<p> [<a href="#_msoanchor_6">A6]</a>监听地址，最好添加上本机地址</p>
<p> [<a href="#_msoanchor_7">A7]</a>监听端口</p>
<p> [<a href="#_msoanchor_8">A8]</a>配置filebeat支持json格式传输到Es</p>
<p> [<a href="#_msoanchor_9">A9]</a>修改索引名称，推荐以月份结尾，因为Kibana支持月份</p>
<p> [<a href="#_msoanchor_10">A10]</a>关闭默认模板索引</p>
<p> [<a href="#_msoanchor_11">A11]</a>引用设置索引</p>
<p> [<a href="#_msoanchor_13">A13]</a>定义JSON键值对，使得ES读数据更加明显索引更加奥里给</p>
<p> [<a href="#_msoanchor_14">A14]</a>定义错误日志存放目录，tags指定下方可指定条件，可以是键值里得任何一种。</p>
<p> [<a href="#_msoanchor_15">A15]</a>当tags是error的时候收集日志简直不要奥里给</p>
<p> [<a href="#_msoanchor_16">A16]</a>如果只监听一个服务不用添加条件：定义条件</p>
<p> [<a href="#_msoanchor_17">A17]</a>不用纠结每添加一种服务就要该名称 只要之前改过，就可以不用修改就可以使用</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Thaons</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kococ.cn/posts/14304/">https://kococ.cn/posts/14304/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kococ.cn" target="_blank">北青永恒</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ELK/">ELK</a><a class="post-meta__tags" href="/tags/filebeat/">filebeat</a><a class="post-meta__tags" href="/tags/Kibana/">Kibana</a><a class="post-meta__tags" href="/tags/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/">日志收集</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/52358/"><img class="prev-cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0081.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Tomcat认知梳理</div></div></a></div><div class="next-post pull-right"><a href="/posts/28194/"><img class="next-cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0143.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jenkins（CA/CI）部署</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/4652/" title="ELK 部署文档"><img class="cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0061.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-24</div><div class="title">ELK 部署文档</div></div></a></div><div><a href="/posts/44280/" title="ELK-Nginx日志分析及绘图"><img class="cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0192.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-27</div><div class="title">ELK-Nginx日志分析及绘图</div></div></a></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Thaons</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">既来之 则安之</div><div class="icp"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="https://gitee.com/xoxoyun/img/raw/master/image/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="712292593" data-server="netease" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="true" data-order="random" data-preload="none" data-autoplay="true" muted></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>