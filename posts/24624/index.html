<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis-5.x梳理文档 | 北青永恒</title><meta name="keywords" content="Redis5.0"><meta name="author" content="Thaons"><meta name="copyright" content="Thaons"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="一文学会Redis的简单应用与高可用集群">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis-5.x梳理文档">
<meta property="og:url" content="https://kococ.cn/posts/24624/index.html">
<meta property="og:site_name" content="北青永恒">
<meta property="og:description" content="一文学会Redis的简单应用与高可用集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0016.jpg">
<meta property="article:published_time" content="2021-01-04T01:35:19.000Z">
<meta property="article:modified_time" content="2021-01-04T01:36:32.630Z">
<meta property="article:author" content="Thaons">
<meta property="article:tag" content="Redis5.0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0016.jpg"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="https://kococ.cn/posts/24624/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.0.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-01-04 09:36:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><link rel="stylesheet" href="/css/footer.css"><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xoxoyun/img/raw/master/image/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">85</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">87</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://video.kococ.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-5-x"><span class="toc-number">1.</span> <span class="toc-text">Redis-5.x</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC1%E7%AB%A0-%E5%85%B3%E7%B3%BB%E5%9E%8B%E4%B8%8E%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">第1章 关系型与非关系型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0-Redis%E9%87%8D%E8%A6%81%E7%89%B9%E6%80%A7"><span class="toc-number">3.</span> <span class="toc-text">第2章 Redis重要特性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC3%E7%AB%A0-redis%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.</span> <span class="toc-text">第3章 redis应用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0-Redis%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">第4章 Redis安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-redis%E5%AE%98%E7%BD%91"><span class="toc-number">5.1.</span> <span class="toc-text">1.redis官网</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="toc-number">5.2.</span> <span class="toc-text">2.版本选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%A7%84%E5%88%92%E7%9B%AE%E5%BD%95"><span class="toc-number">5.3.</span> <span class="toc-text">3.规划目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4"><span class="toc-number">5.4.</span> <span class="toc-text">4.安装命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.5.</span> <span class="toc-text">5.配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">5.6.</span> <span class="toc-text">6.启动命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%A3%80%E6%9F%A5"><span class="toc-number">5.7.</span> <span class="toc-text">7.检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%BF%9E%E6%8E%A5redis%E7%BB%88%E7%AB%AF"><span class="toc-number">5.8.</span> <span class="toc-text">8.连接redis终端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%85%B3%E9%97%AD%E5%91%BD%E4%BB%A4"><span class="toc-number">5.9.</span> <span class="toc-text">9.关闭命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-system%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.10.</span> <span class="toc-text">10.system启动配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC5%E7%AB%A0-Redis%E5%85%A8%E5%B1%80%E5%91%BD%E4%BB%A4"><span class="toc-number">6.</span> <span class="toc-text">第5章 Redis全局命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-redis%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.1.</span> <span class="toc-text">0.redis数据格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95key"><span class="toc-number">6.2.</span> <span class="toc-text">1.写入测试key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%9A%84key"><span class="toc-number">6.3.</span> <span class="toc-text">2.查看所有的key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E6%9C%89%E5%A4%9A%E5%B0%91%E4%B8%AAkey"><span class="toc-number">6.4.</span> <span class="toc-text">3.查看有多少个key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E6%9F%90%E4%B8%AAKey%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">6.5.</span> <span class="toc-text">4.查看某个Key是否存在</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%A0%E9%99%A4key"><span class="toc-number">6.6.</span> <span class="toc-text">5.删除key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%94%AE%E8%BF%87%E6%9C%9F"><span class="toc-number">6.7.</span> <span class="toc-text">6.键过期</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="toc-number">7.</span> <span class="toc-text">第6章 字符串操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AAkey"><span class="toc-number">7.1.</span> <span class="toc-text">1.设置一个key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%AAkey"><span class="toc-number">7.2.</span> <span class="toc-text">2.查看一个key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AAkey"><span class="toc-number">7.3.</span> <span class="toc-text">3.设置多个key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E5%A4%9A%E4%B8%AAkey"><span class="toc-number">7.4.</span> <span class="toc-text">4.查看多个key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%A4%A9%E7%84%B6%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-number">7.5.</span> <span class="toc-text">5.天然计数器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC7%E7%AB%A0-%E5%88%97%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">8.</span> <span class="toc-text">第7章 列表操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%8F%92%E5%85%A5%E5%88%97%E8%A1%A8"><span class="toc-number">8.1.</span> <span class="toc-text">1.插入列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E5%88%97%E8%A1%A8%E9%95%BF%E5%BA%A6"><span class="toc-number">8.2.</span> <span class="toc-text">2.查看列表长度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E5%88%97%E8%A1%A8%E5%86%85%E5%AE%B9"><span class="toc-number">8.3.</span> <span class="toc-text">3.查看列表内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4%E5%88%97%E8%A1%A8%E5%85%83%E7%B4%A0"><span class="toc-number">8.4.</span> <span class="toc-text">4.删除列表元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%A0%E9%99%A4%E6%95%B4%E4%B8%AA%E5%88%97%E8%A1%A8"><span class="toc-number">8.5.</span> <span class="toc-text">5.删除整个列表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC8%E7%AB%A0-hash%E6%93%8D%E4%BD%9C"><span class="toc-number">9.</span> <span class="toc-text">第8章 hash操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-mysql%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E7%BC%93%E5%AD%98%E5%88%B0redis"><span class="toc-number">9.1.</span> <span class="toc-text">1.mysql数据如何缓存到redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAHash%E6%95%B0%E6%8D%AE"><span class="toc-number">9.2.</span> <span class="toc-text">2.创建一个Hash数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8Bhash%E9%87%8C%E6%8C%87%E5%AE%9A%E7%9A%84%E5%80%BC"><span class="toc-number">9.3.</span> <span class="toc-text">3.查看hash里指定的值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8BHash%E9%87%8C%E6%89%80%E6%9C%89%E7%9A%84%E5%80%BC"><span class="toc-number">9.4.</span> <span class="toc-text">4.查看Hash里所有的值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC9%E7%AB%A0-%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C-set"><span class="toc-number">10.</span> <span class="toc-text">第9章 集合操作 set</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E9%9B%86%E5%90%88"><span class="toc-number">10.1.</span> <span class="toc-text">1.创建集合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E9%9B%86%E5%90%88%E6%88%90%E5%91%98"><span class="toc-number">10.2.</span> <span class="toc-text">2.查看集合成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E9%9B%86%E5%90%88%E7%9A%84%E4%BA%A4%E9%9B%86"><span class="toc-number">10.3.</span> <span class="toc-text">3.查看集合的交集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E9%9B%86%E5%90%88%E7%9A%84%E5%B9%B6%E9%9B%86"><span class="toc-number">10.4.</span> <span class="toc-text">4.查看集合的并集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E9%9B%86%E5%90%88%E7%9A%84%E5%B7%AE%E9%9B%86"><span class="toc-number">10.5.</span> <span class="toc-text">5.查看集合的差集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E6%88%90%E5%91%98"><span class="toc-number">10.6.</span> <span class="toc-text">6.删除一个成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%B3%A8%E6%84%8F"><span class="toc-number">10.7.</span> <span class="toc-text">6.注意</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C"><span class="toc-number">11.</span> <span class="toc-text">第10章 有序集合操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98"><span class="toc-number">11.1.</span> <span class="toc-text">1.添加成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%A1%E7%AE%97%E6%88%90%E5%91%98%E4%B8%AA%E6%95%B0"><span class="toc-number">11.2.</span> <span class="toc-text">2.计算成员个数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%AE%A1%E7%AE%97%E6%9F%90%E4%B8%AA%E6%88%90%E5%91%98%E5%88%86%E6%95%B0"><span class="toc-number">11.3.</span> <span class="toc-text">3.计算某个成员分数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8C%89%E7%85%A7%E9%99%8D%E5%BA%8F%E6%9F%A5%E7%9C%8B%E6%88%90%E5%91%98%E5%90%8D%E6%AC%A1%EF%BC%9A"><span class="toc-number">11.4.</span> <span class="toc-text">4.按照降序查看成员名次：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%8C%89%E7%85%A7%E5%8D%87%E5%BA%8F%E6%9F%A5%E7%9C%8B%E6%88%90%E5%91%98%E5%90%8D%E6%AC%A1%EF%BC%9A"><span class="toc-number">11.5.</span> <span class="toc-text">5.按照升序查看成员名次：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%88%A0%E9%99%A4%E6%88%90%E5%91%98"><span class="toc-number">11.6.</span> <span class="toc-text">6.删除成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%A2%9E%E5%8A%A0%E6%88%90%E5%91%98%E5%88%86%E6%95%B0"><span class="toc-number">11.7.</span> <span class="toc-text">7.增加成员分数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%BF%94%E5%9B%9E%E6%8C%87%E5%AE%9A%E6%8E%92%E5%90%8D%E8%8C%83%E5%9B%B4%E7%9A%84%E6%88%90%E5%91%98"><span class="toc-number">11.8.</span> <span class="toc-text">8.返回指定排名范围的成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E8%BF%94%E5%9B%9E%E6%8C%87%E5%AE%9A%E5%88%86%E6%95%B0%E8%8C%83%E5%9B%B4%E7%9A%84%E6%88%90%E5%91%98"><span class="toc-number">11.9.</span> <span class="toc-text">9.返回指定分数范围的成员</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E8%BF%94%E5%9B%9E%E6%8C%87%E5%AE%9A%E5%88%86%E6%95%B0%E8%8C%83%E5%9B%B4%E7%9A%84%E6%88%90%E5%91%98%E7%9A%84%E4%B8%AA%E6%95%B0"><span class="toc-number">11.10.</span> <span class="toc-text">10.返回指定分数范围的成员的个数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">12.</span> <span class="toc-text">第11章 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RDB%E5%92%8CAOF%E4%BB%8B%E7%BB%8D"><span class="toc-number">12.1.</span> <span class="toc-text">1.RDB和AOF介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AERDB"><span class="toc-number">12.2.</span> <span class="toc-text">2.配置RDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-RDB%E7%BB%93%E8%AE%BA"><span class="toc-number">12.3.</span> <span class="toc-text">3.RDB结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-AOF%E9%85%8D%E7%BD%AE"><span class="toc-number">12.4.</span> <span class="toc-text">4.AOF配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-AOF%E9%87%8D%E5%86%99%E6%9C%BA%E5%88%B6"><span class="toc-number">12.5.</span> <span class="toc-text">5.AOF重写机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-aof%E5%92%8Crdb%E5%AE%9E%E9%AA%8C"><span class="toc-number">12.6.</span> <span class="toc-text">6.aof和rdb实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E6%98%AFrdb%E8%BF%98%E6%98%AFaof"><span class="toc-number">12.7.</span> <span class="toc-text">7.如何选择是rdb还是aof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-aof%E6%96%87%E4%BB%B6%E6%95%85%E9%9A%9C%E6%A8%A1%E6%8B%9F%E5%AE%9E%E9%AA%8C%E7%BB%93%E8%AE%BA"><span class="toc-number">12.8.</span> <span class="toc-text">8.aof文件故障模拟实验结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%AE%9E%E9%AA%8C%EF%BC%9A%E5%A6%82%E6%9E%9C%E8%AE%BE%E7%BD%AE%E4%BA%86%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%EF%BC%8C%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE%E4%BC%9A%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86"><span class="toc-number">12.9.</span> <span class="toc-text">9.实验：如果设置了过期时间，恢复数据会如何处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC12%E7%AB%A0-redis%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-number">13.</span> <span class="toc-text">第12章 redis用户认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">13.1.</span> <span class="toc-text">1.写入配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81%E7%99%BB%E9%99%86"><span class="toc-number">13.2.</span> <span class="toc-text">2.使用密码登陆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88redis%E7%9A%84%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81%E8%BF%99%E4%B9%88%E7%AE%80%E5%8D%95%EF%BC%9F"><span class="toc-number">13.3.</span> <span class="toc-text">3.为什么redis的密码认证这么简单？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC13%E7%AB%A0-%E7%A6%81%E7%94%A8%E6%88%96%E9%87%8D%E5%91%BD%E5%90%8D%E5%8D%B1%E9%99%A9%E5%91%BD%E4%BB%A4"><span class="toc-number">14.</span> <span class="toc-text">第13章 禁用或重命名危险命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A6%81%E7%94%A8%E5%8D%B1%E9%99%A9%E5%91%BD%E4%BB%A4"><span class="toc-number">14.1.</span> <span class="toc-text">1.禁用危险命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9D%A5%E8%87%AAjson%E7%9A%84%E7%81%B5%E9%AD%82%E6%8B%B7%E9%97%AE%EF%BC%9Ashutdown%E7%A6%81%E7%94%A8%E4%BA%86-%E8%AE%A9%E5%90%8E%E7%94%A8kill"><span class="toc-number">14.2.</span> <span class="toc-text">2.来自json的灵魂拷问：shutdown禁用了 让后用kill?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC14%E7%AB%A0-Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">15.</span> <span class="toc-text">第14章 Redis主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E7%AC%AC%E4%BA%8C%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">15.1.</span> <span class="toc-text">1.快速部署第二台服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-db01%E6%8F%92%E5%85%A5%E6%B5%8B%E8%AF%95%E5%91%BD%E4%BB%A4"><span class="toc-number">15.2.</span> <span class="toc-text">2.db01插入测试命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">15.3.</span> <span class="toc-text">3.配置主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">15.4.</span> <span class="toc-text">4.主从复制的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%8F%96%E6%B6%88%E5%A4%8D%E5%88%B6"><span class="toc-number">15.5.</span> <span class="toc-text">5.取消复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%B3%A8%E6%84%8F"><span class="toc-number">15.6.</span> <span class="toc-text">6.主从复制注意</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%AE%89%E5%85%A8%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">15.7.</span> <span class="toc-text">7.安全的操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC15%E7%AB%A0-Redis%E5%93%A8%E5%85%B5"><span class="toc-number">16.</span> <span class="toc-text">第15章 Redis哨兵</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%93%A8%E5%85%B5%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">16.1.</span> <span class="toc-text">1.哨兵的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%9B%AE%E5%BD%95%E5%92%8C%E7%AB%AF%E5%8F%A3%E8%A7%84%E5%88%92"><span class="toc-number">16.2.</span> <span class="toc-text">2.目录和端口规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B23%E5%8F%B0redis%E5%8D%95%E8%8A%82%E7%82%B9"><span class="toc-number">16.3.</span> <span class="toc-text">3.部署3台redis单节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#db01%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">16.3.1.</span> <span class="toc-text">db01操作：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#db02%E5%92%8Cdb03%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">16.3.2.</span> <span class="toc-text">db02和db03的操作：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">16.4.</span> <span class="toc-text">4.配置主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%83%A8%E7%BD%B2%E5%93%A8%E5%85%B5%E8%8A%82%E7%82%B9-3%E5%8F%B0%E6%9C%BA%E5%99%A8%E9%83%BD%E6%93%8D%E4%BD%9C"><span class="toc-number">16.5.</span> <span class="toc-text">5.部署哨兵节点-3台机器都操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%BC%96%E5%86%99%E5%93%A8%E5%85%B5system%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3%E5%8F%B0%E6%9C%BA%E5%99%A8%E9%83%BD%E6%93%8D%E4%BD%9C"><span class="toc-number">16.6.</span> <span class="toc-text">6.编写哨兵system配置文件-3台机器都操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%90%AF%E5%8A%A8%E5%93%A8%E5%85%B5%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">16.7.</span> <span class="toc-text">7.启动哨兵并检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%AA%8C%E8%AF%81%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">16.8.</span> <span class="toc-text">8.验证主节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">16.9.</span> <span class="toc-text">9.模拟故障转移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D%E4%B8%8A%E7%BA%BF"><span class="toc-number">16.10.</span> <span class="toc-text">10.模拟故障修复上线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E6%9D%A5%E8%87%AAjson%E7%9A%84%E7%81%B5%E9%AD%82%E5%8F%91%E9%97%AE%EF%BC%9A%E8%83%BD%E5%A4%9F%E7%BB%99redis-%E8%8A%82%E7%82%B9%E5%8A%A0%E6%9D%83-%E6%9D%A5%E7%A1%AE%E5%AE%9A%E4%BC%98%E5%85%88%E5%A4%87%E9%80%89%E4%B8%BB%E8%8A%82%E7%82%B9%E5%98%9B"><span class="toc-number">16.11.</span> <span class="toc-text">11.来自json的灵魂发问：能够给redis 节点加权 来确定优先备选主节点嘛?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC16%E7%AB%A0-%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2Redis%E9%9B%86%E7%BE%A4"><span class="toc-number">17.</span> <span class="toc-text">第16章 手动部署Redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%83%A7%E9%A5%BC%E7%9A%84%E4%B8%8D%E8%B6%B3"><span class="toc-number">17.1.</span> <span class="toc-text">1.烧饼的不足</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%9B%86%E7%BE%A4%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="toc-number">17.2.</span> <span class="toc-text">2.集群重要概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%9B%AE%E5%BD%95%E8%A7%84%E5%88%92"><span class="toc-number">17.3.</span> <span class="toc-text">3.目录规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-db01%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">17.4.</span> <span class="toc-text">4.db01的操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-db02%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">17.5.</span> <span class="toc-text">5.db02的操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-db03%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">17.6.</span> <span class="toc-text">6.db03的操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%9B%86%E7%BE%A4%E6%89%8B%E5%8A%A8%E5%8F%91%E7%8E%B0%E8%8A%82%E7%82%B9"><span class="toc-number">17.7.</span> <span class="toc-text">7.集群手动发现节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%9B%86%E7%BE%A4%E6%89%8B%E5%8A%A8%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D"><span class="toc-number">17.8.</span> <span class="toc-text">8.集群手动分配槽位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A7%BD%E4%BD%8D%E8%A7%84%E5%88%92"><span class="toc-number">17.8.1.</span> <span class="toc-text">1.槽位规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D"><span class="toc-number">17.8.2.</span> <span class="toc-text">2.分配槽位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">17.8.3.</span> <span class="toc-text">3.查看集群状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%A4%8D%E5%88%B6%E5%85%B3%E7%B3%BB"><span class="toc-number">17.9.</span> <span class="toc-text">9.手动部署复制关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-%E5%85%88%E8%8E%B7%E5%8F%96%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF"><span class="toc-number">17.9.1.</span> <span class="toc-text">0.先获取集群节点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%88%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%896381%E7%9A%84%E5%86%85%E5%AE%B9%E5%92%8C%E4%B8%8D%E9%9C%80%E8%A6%81%E5%86%85%E5%AE%B9"><span class="toc-number">17.9.2.</span> <span class="toc-text">1.先删除所有6381的内容和不需要内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%BB%E5%9B%BE"><span class="toc-number">17.9.3.</span> <span class="toc-text">2.画图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%A1%AE%E5%AE%9A%E5%A4%8D%E5%88%B6%E5%85%B3%E7%B3%BB"><span class="toc-number">17.9.4.</span> <span class="toc-text">3.确定复制关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%A3%80%E6%9F%A5%E5%A4%8D%E5%88%B6%E5%85%B3%E7%B3%BB"><span class="toc-number">17.9.5.</span> <span class="toc-text">4.检查复制关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%9B%86%E7%BE%A4%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">17.10.</span> <span class="toc-text">10.集群插入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B0%9D%E8%AF%95%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE%E5%8F%91%E7%8E%B0%E6%8A%A5%E9%94%99"><span class="toc-number">17.10.1.</span> <span class="toc-text">1.尝试插入一条数据发现报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9B%AE%E5%89%8D%E7%9A%84%E7%8E%B0%E8%B1%A1"><span class="toc-number">17.10.2.</span> <span class="toc-text">2.目前的现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="toc-number">17.10.3.</span> <span class="toc-text">3.问题原因</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E6%98%AF%E5%90%A6%E8%B6%B3%E5%A4%9F%E8%B6%B3%E8%BF%B9%E8%B6%B3%E5%A4%9F%E5%B9%B3%E5%9D%87"><span class="toc-number">17.11.</span> <span class="toc-text">11.验证集群是否足够足迹足够平均</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0-%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-number">17.11.1.</span> <span class="toc-text">0.写入测试数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%AA%8C%E8%AF%81%E8%B6%B3%E5%A4%9F%E5%B9%B3%E5%9D%87"><span class="toc-number">17.11.2.</span> <span class="toc-text">1.验证足够平均:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%AA%8C%E8%AF%81%E8%B6%B3%E5%A4%9F%E9%9A%8F%E6%9C%BA%EF%BC%9A"><span class="toc-number">17.11.3.</span> <span class="toc-text">2.验证足够随机：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%85%81%E8%AE%B8%E8%8A%82%E7%82%B9%E7%9A%84key%E5%9C%A82-%E8%AF%AF%E5%B7%AE%E7%9A%84%E4%BE%9D%E6%8D%AE%E6%9D%A5%E6%BA%90%EF%BC%9A"><span class="toc-number">17.11.4.</span> <span class="toc-text">3.允许节点的key在2%误差的依据来源：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%EF%BC%9A"><span class="toc-number">17.11.5.</span> <span class="toc-text">4.检查集群健康状态：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC17%E7%AB%A0-%E5%AE%9E%E6%88%98-%E6%A7%BD%E4%BD%8D%E5%88%86%E9%85%8D%E9%94%99%E8%AF%AF%E5%A6%82%E4%BD%95%E8%B0%83%E6%95%B4"><span class="toc-number">18.</span> <span class="toc-text">第17章 实战-槽位分配错误如何调整</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%85%E9%9A%9C%E8%83%8C%E6%99%AF"><span class="toc-number">18.1.</span> <span class="toc-text">1.故障背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%89%8D%E6%8F%90"><span class="toc-number">18.2.</span> <span class="toc-text">2.前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9E%E9%AA%8C%E7%8E%B0%E8%B1%A1"><span class="toc-number">18.3.</span> <span class="toc-text">3.实验现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF1%EF%BC%9A%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%EF%BC%8C%E9%87%8D%E5%81%9A%E9%9B%86%E7%BE%A4%EF%BC%8C%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">18.4.</span> <span class="toc-text">解决思路1：备份数据，重做集群，导入数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF2-%E8%8E%B7%E5%BE%97%E6%89%80%E6%9C%89key%E7%9A%84%E5%90%8D%E7%A7%B0%EF%BC%8C%E5%AF%BC%E5%87%BA%E5%86%8D%E5%AF%BC%E5%85%A5"><span class="toc-number">18.5.</span> <span class="toc-text">解决思路2:获得所有key的名称，导出再导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF3-%E6%B5%81%E6%B0%B4%E7%BA%BF-pipline"><span class="toc-number">18.6.</span> <span class="toc-text">解决思路3: 流水线 pipline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF4-%E4%BD%BF%E7%94%A8redis-cli%E5%B7%A5%E5%85%B7%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D"><span class="toc-number">18.7.</span> <span class="toc-text">解决思路4: 使用redis-cli工具重新分配槽位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF5-%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E5%9C%A8%E7%BA%BF%E5%AF%BC%E5%85%A5"><span class="toc-number">18.8.</span> <span class="toc-text">解决思路5:直接使用工具在线导入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC18%E7%AB%A0-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2redis%E9%9B%86%E7%BE%A4"><span class="toc-number">19.</span> <span class="toc-text">第18章 使用工具自动部署redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%81%A2%E5%A4%8D%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">19.1.</span> <span class="toc-text">1.恢复集群初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">19.2.</span> <span class="toc-text">2.使用工具初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4"><span class="toc-number">19.3.</span> <span class="toc-text">3.检查集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC19%E7%AB%A0-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E6%89%A9%E5%AE%B9"><span class="toc-number">20.</span> <span class="toc-text">第19章 使用工具扩容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9D%A5%E8%87%AAjson%E7%9A%84%E7%81%B5%E9%AD%82%E5%8F%91%E9%97%AE%EF%BC%9A"><span class="toc-number">20.1.</span> <span class="toc-text">1.来自json的灵魂发问：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E5%AE%9E%E9%AA%8C%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E5%8F%97%E5%BD%B1%E5%93%8D%EF%BC%9F"><span class="toc-number">20.2.</span> <span class="toc-text">2.如何设计实验验证数据是否受影响？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E6%96%B0%E8%8A%82%E7%82%B9"><span class="toc-number">20.3.</span> <span class="toc-text">3.创建新节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E6%89%A9%E5%AE%B9%E6%AD%A5%E9%AA%A4"><span class="toc-number">20.4.</span> <span class="toc-text">4.使用工具扩容步骤</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC20%E7%AB%A0-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E7%BC%A9%E5%AE%B9"><span class="toc-number">21.</span> <span class="toc-text">第20章 使用工具缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">21.1.</span> <span class="toc-text">1.操作命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8F%90%E9%97%AE%EF%BC%9A%E5%85%AC%E5%8F%B8%E5%85%88%E7%94%A8%E7%9A%84%E6%98%AF%E5%93%A8%E5%85%B5%E7%84%B6%E5%90%8E%E5%9C%A8%E6%94%B9%E9%9B%86%E7%BE%A4-%E5%A6%82%E4%BD%95%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE"><span class="toc-number">21.2.</span> <span class="toc-text">2.提问：公司先用的是哨兵然后在改集群 如何迁移数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC21%E7%AB%A0-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">22.</span> <span class="toc-text">第21章 .验证集群高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%8F%90%E9%97%AE%EF%BC%9A%E6%95%85%E9%9A%9C%E7%9A%84%E4%B8%BB%E5%BA%93%E4%BF%AE%E5%A4%8D%E5%90%8E%E5%90%AF%E5%8A%A8%E4%BC%9A%E5%8F%98%E6%88%90%E5%A4%87%E8%83%8E%E5%90%97%EF%BC%9F"><span class="toc-number">22.1.</span> <span class="toc-text">1.提问：故障的主库修复后启动会变成备胎吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E9%AA%8C%E7%BB%93%E8%AE%BA%EF%BC%9A"><span class="toc-number">22.2.</span> <span class="toc-text">2.实验结论：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%B8%BB%E5%8A%A8%E5%8F%91%E8%B5%B7%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%E5%88%87%E6%8D%A2%EF%BC%9A"><span class="toc-number">22.3.</span> <span class="toc-text">3.主动发起集群角色切换：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC22%E7%AB%A0-%E6%A8%A1%E6%8B%9F%E5%88%86%E9%85%8D%E6%97%B6%E6%95%85%E9%9A%9C"><span class="toc-number">23.</span> <span class="toc-text">第22章 模拟分配时故障</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A8%A1%E6%8B%9F%E5%9C%BA%E6%99%AF%EF%BC%9A%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE%E6%97%B6%E4%BA%BA%E4%B8%BA%E4%B8%AD%E6%96%AD%E4%BA%86%EF%BC%8C%E5%AF%BC%E8%87%B4%E6%A7%BD%E7%9A%84%E7%8A%B6%E6%80%81%E4%B8%8D%E5%AF%B9"><span class="toc-number">23.1.</span> <span class="toc-text">1.模拟场景：迁移数据时人为中断了，导致槽的状态不对</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E4%BF%AE%E5%A4%8D%EF%BC%9A"><span class="toc-number">23.2.</span> <span class="toc-text">2.使用工具修复：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%89%8B%E5%8A%A8%E4%BF%AE%E5%A4%8D%EF%BC%9A"><span class="toc-number">23.3.</span> <span class="toc-text">3.手动修复：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC23%E7%AB%A0-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E7%BB%B4%E6%8A%A4%E9%9B%86%E7%BE%A4%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">24.</span> <span class="toc-text">第23章 使用工具维护集群的好处</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC24%E7%AB%A0-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">25.</span> <span class="toc-text">第24章 数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%96%B0%E7%89%88%E6%9C%AC%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E8%BF%81%E7%A7%BB"><span class="toc-number">25.1.</span> <span class="toc-text">1.新版本直接使用工具迁移</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC25%E7%AB%A0-%E5%88%86%E6%9E%90key%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="toc-number">26.</span> <span class="toc-text">第25章 分析key的大小</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%B8%A6%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90"><span class="toc-number">26.1.</span> <span class="toc-text">0.使用自带工具分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90"><span class="toc-number">26.2.</span> <span class="toc-text">1.使用第三方工具分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4"><span class="toc-number">26.2.1.</span> <span class="toc-text">1.安装命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%9F%E6%88%90%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-number">26.2.2.</span> <span class="toc-text">2.生成测试数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8Cbgsave%E7%94%9F%E6%88%90rdb%E6%96%87%E4%BB%B6"><span class="toc-number">26.2.3.</span> <span class="toc-text">3.执行bgsave生成rdb文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90"><span class="toc-number">26.2.4.</span> <span class="toc-text">4.使用工具分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%BF%87%E6%BB%A4%E5%88%86%E6%9E%90"><span class="toc-number">26.2.5.</span> <span class="toc-text">5.过滤分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%B1%87%E6%8A%A5%E9%A2%86%E5%AF%BC"><span class="toc-number">26.2.6.</span> <span class="toc-text">6.汇报领导</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC26%E7%AB%A0-redis%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">27.</span> <span class="toc-text">第26章 redis的内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E6%9C%80%E5%A4%A7%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="toc-number">27.1.</span> <span class="toc-text">1.设置最大内存限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">27.2.</span> <span class="toc-text">2.内存回收机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%9F%E4%BA%A7%E4%B8%8Aredis%E9%99%90%E5%88%B6%E5%A4%9A%E5%A4%A7%E5%86%85%E5%AD%98"><span class="toc-number">27.3.</span> <span class="toc-text">3.生产上redis限制多大内存</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC27%E7%AB%A0-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">28.</span> <span class="toc-text">第27章 性能测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC28%E7%AB%A0-%E9%9B%86%E7%BE%A4%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">29.</span> <span class="toc-text">第28章 集群相关命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC29%E7%AB%A0-%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93"><span class="toc-number">30.</span> <span class="toc-text">第29章 命令总结</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/xoxoyun/img/raw/master/image/0016.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">北青永恒</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://video.kococ.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Redis-5.x梳理文档</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-04T01:35:19.000Z" title="发表于 2021-01-04 09:35:19">2021-01-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-04T01:36:32.630Z" title="更新于 2021-01-04 09:36:32">2021-01-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux%E5%9F%BA%E7%A1%80/">Linux基础</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Redis-5-x"><a href="#Redis-5-x" class="headerlink" title="Redis-5.x"></a>Redis-5.x</h1><h1 id="第1章-关系型与非关系型"><a href="#第1章-关系型与非关系型" class="headerlink" title="第1章 关系型与非关系型"></a>第1章 关系型与非关系型</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关系型： mysql oracle</span><br><span class="line">非关系型：redis mongo ES </span><br></pre></td></tr></table></figure>

<h1 id="第2章-Redis重要特性"><a href="#第2章-Redis重要特性" class="headerlink" title="第2章 Redis重要特性"></a>第2章 Redis重要特性</h1><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.速度快</span><br><span class="line">  <span class="built_in">c</span>语言写的</span><br><span class="line">  代码优雅</span><br><span class="line">  单线程架构 </span><br><span class="line"><span class="number">2</span>.支持多种数据结构</span><br><span class="line">  字符串，哈希，列表，集合，有序集合，地理位置</span><br><span class="line"><span class="number">3</span>.丰富的功能</span><br><span class="line">  天然计数器</span><br><span class="line">  健过期功能</span><br><span class="line">  消息队列</span><br><span class="line"><span class="number">4</span>.支持客户端语言多</span><br><span class="line">  php,java,python</span><br><span class="line"><span class="number">5</span>.数据持久化</span><br><span class="line">  所有的数据都运行在内存中</span><br><span class="line">  支持<span class="number">2</span>种格式持久化数据<span class="type">AOF</span> <span class="type">RDB</span> <span class="type">AOF</span>&amp;<span class="type">RDB</span></span><br><span class="line"><span class="number">6</span>.自带多种高可用架构</span><br><span class="line">  主从</span><br><span class="line">  哨兵</span><br><span class="line">  集群</span><br></pre></td></tr></table></figure>

<h1 id="第3章-redis应用场景"><a href="#第3章-redis应用场景" class="headerlink" title="第3章 redis应用场景"></a>第3章 redis应用场景</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.缓存-键过期时间</span><br><span class="line">  把session会话存在redis,过期删除</span><br><span class="line">  缓存用户信息，缓存Mysql部分数据，用户先访问redis，redis没有再访问mysql，然后回写给redis</span><br><span class="line">  商城优惠卷过期时间</span><br><span class="line">2.排行榜-列表&amp;有序集合</span><br><span class="line">  热度&#x2F;点击数排行榜</span><br><span class="line">  直播间礼物积分排行</span><br><span class="line">3.计数器-天然支持计数器</span><br><span class="line">  帖子浏览数</span><br><span class="line">  视频播放数</span><br><span class="line">  评论数</span><br><span class="line">  点赞&#x2F;踩</span><br><span class="line">4.社交网络-集合</span><br><span class="line">  粉丝</span><br><span class="line">  共同好友 </span><br><span class="line">  兴趣爱好</span><br><span class="line">  标签</span><br><span class="line">5.消息队列-发布订阅</span><br><span class="line">  配合ELK缓存收集来的日志</span><br></pre></td></tr></table></figure>

<h1 id="第4章-Redis安装部署"><a href="#第4章-Redis安装部署" class="headerlink" title="第4章 Redis安装部署"></a>第4章 Redis安装部署</h1><h2 id="1-redis官网"><a href="#1-redis官网" class="headerlink" title="1.redis官网"></a>1.redis官网</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//redis.io/</span></span><br></pre></td></tr></table></figure>

<h2 id="2-版本选择"><a href="#2-版本选择" class="headerlink" title="2.版本选择"></a>2.版本选择</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2<span class="selector-class">.x</span>     <span class="selector-tag">very</span> <span class="selector-tag">old</span></span><br><span class="line">3<span class="selector-class">.x</span>     <span class="selector-tag">redis-cluster</span> </span><br><span class="line">4<span class="selector-class">.x</span>     混合持久化</span><br><span class="line">5<span class="selector-class">.x</span>     新增加了流处理类型 最新稳定版 </span><br></pre></td></tr></table></figure>

<h2 id="3-规划目录"><a href="#3-规划目录" class="headerlink" title="3.规划目录"></a>3.规划目录</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">data</span>/soft  下载目录  </span><br><span class="line">/opt/redis_6379/&#123;conf,logs,pid&#125; 安装目录,日志目录,pid目录,配置目录</span><br><span class="line">/<span class="keyword">data</span>/redis_6379/  数据目录</span><br></pre></td></tr></table></figure>

<h2 id="4-安装命令"><a href="#4-安装命令" class="headerlink" title="4.安装命令"></a>4.安装命令</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/soft -p</span><br><span class="line">cd /data/soft </span><br><span class="line">wget http:<span class="comment">//download.redis.io/releases/redis-5.0.7.tar.gz</span></span><br><span class="line">tar xf redis<span class="number">-5.0</span><span class="number">.7</span>.tar.gz -C /opt/</span><br><span class="line">ln -s /opt/redis<span class="number">-5.0</span><span class="number">.7</span> /opt/redis</span><br><span class="line">cd /opt/redis</span><br><span class="line"><span class="built_in">make</span> </span><br><span class="line"><span class="built_in">make</span> install </span><br></pre></td></tr></table></figure>

<h2 id="5-配置文件"><a href="#5-配置文件" class="headerlink" title="5.配置文件"></a>5.配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/redis_6379/&#123;conf,pid,logs&#125;</span><br><span class="line">mkdir -p /data/redis_6379</span><br><span class="line">cat &gt;/opt/redis_6379/conf/redis_6379.conf&lt;&lt; EOF</span><br><span class="line">daemonize yes </span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 10.0.0.51</span><br><span class="line">port 6379</span><br><span class="line">pidfile /opt/redis_6379/pid/redis_6379.pid</span><br><span class="line">logfile /opt/redis_6379/logs/redis_6379.log</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="6-启动命令"><a href="#6-启动命令" class="headerlink" title="6.启动命令"></a>6.启动命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server &#x2F;opt&#x2F;redis_6379&#x2F;conf&#x2F;redis_6379.conf</span><br></pre></td></tr></table></figure>

<h2 id="7-检查"><a href="#7-检查" class="headerlink" title="7.检查"></a>7.检查</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef<span class="params">|grep redis</span></span><br><span class="line"><span class="params">netstat -lntup|</span>grep <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<h2 id="8-连接redis终端"><a href="#8-连接redis终端" class="headerlink" title="8.连接redis终端"></a>8.连接redis终端</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@db01 ~]</span># <span class="selector-tag">redis-cli</span></span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; </span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span> </span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">k1</span></span><br><span class="line">&quot;<span class="selector-tag">v1</span>&quot;</span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="9-关闭命令"><a href="#9-关闭命令" class="headerlink" title="9.关闭命令"></a>9.关闭命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> </span><br><span class="line">pkill </span><br><span class="line">redis-cli</span><br><span class="line">&gt;SHUTDOWN</span><br><span class="line">- redis-cli shutdown</span><br></pre></td></tr></table></figure>

<h2 id="10-system启动配置"><a href="#10-system启动配置" class="headerlink" title="10.system启动配置"></a>10.system启动配置</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g <span class="number">1000</span> redis</span><br><span class="line">useradd -u <span class="number">1000</span> -g <span class="number">1000</span> -M -s /sbin/nologin</span><br><span class="line">chown -R redis:redis /data/redis*</span><br><span class="line">chown -R redis:redis /opt/redis*</span><br><span class="line">cat &gt;/usr/lib/systemd/system/redis.service&lt;&lt;EOF</span><br><span class="line">[<span class="meta">Unit</span>]</span><br><span class="line">Description=Redis persistent key-<span class="keyword">value</span> database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[<span class="meta">Service</span>]</span><br><span class="line">ExecStart=/usr/local/bin/redis /opt/redis_6379/conf/redis_6379.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/local/bin/redis-cli -h $(ifconfig eth0|awk <span class="string">&#x27;NR==2&#123;print $2&#125;&#x27;</span>) -p <span class="number">6379</span> shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=<span class="number">0755</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">Install</span>]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start redis</span><br></pre></td></tr></table></figure>

<h1 id="第5章-Redis全局命令"><a href="#第5章-Redis全局命令" class="headerlink" title="第5章 Redis全局命令"></a>第5章 Redis全局命令</h1><p>全局命令是指对所有数据类型都通用的命令</p>
<h2 id="0-redis数据格式"><a href="#0-redis数据格式" class="headerlink" title="0.redis数据格式"></a>0.redis数据格式</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key:<span class="keyword">value</span></span><br><span class="line">键:值</span><br></pre></td></tr></table></figure>

<h2 id="1-写入测试key"><a href="#1-写入测试key" class="headerlink" title="1.写入测试key"></a>1.写入测试key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> k1 v1</span><br><span class="line"><span class="built_in">set</span> k2 v2 </span><br><span class="line"><span class="built_in">set</span> k3 v3</span><br></pre></td></tr></table></figure>

<h2 id="2-查看所有的key"><a href="#2-查看所有的key" class="headerlink" title="2.查看所有的key"></a>2.查看所有的key</h2><p>！！！危险命令！！！此操作未满30岁禁止请在家人的看管下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<h2 id="3-查看有多少个key"><a href="#3-查看有多少个key" class="headerlink" title="3.查看有多少个key"></a>3.查看有多少个key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBSIZE</span><br></pre></td></tr></table></figure>

<h2 id="4-查看某个Key是否存在"><a href="#4-查看某个Key是否存在" class="headerlink" title="4.查看某个Key是否存在"></a>4.查看某个Key是否存在</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXISTS k1 </span><br><span class="line"></span><br><span class="line">状态码：</span><br><span class="line">0 表示这个key不存在 </span><br><span class="line">1 表示这个key存在</span><br><span class="line">N 表示存在N个key</span><br></pre></td></tr></table></figure>

<h2 id="5-删除key"><a href="#5-删除key" class="headerlink" title="5.删除key"></a>5.删除key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DEL k1 </span><br><span class="line">DEL k1 k2 </span><br><span class="line"></span><br><span class="line">状态码：</span><br><span class="line">0   表示这个key不存在</span><br><span class="line">1   表示这个key存在，并且删除成功了</span><br><span class="line">N   表示N个key存在，并且删除成功了N个key</span><br></pre></td></tr></table></figure>

<h2 id="6-键过期"><a href="#6-键过期" class="headerlink" title="6.键过期"></a>6.键过期</h2><p>设置过期时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EXPIRE k1 10</span><br><span class="line"></span><br><span class="line">状态码：</span><br><span class="line">0   这个key不存在</span><br><span class="line">1   这个key存在，并且设置过期时间成功</span><br></pre></td></tr></table></figure>

<p>查看keys是否过期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TTL k1 </span><br><span class="line"></span><br><span class="line">状态码：</span><br><span class="line">-1  这个key存在,并且没有设定存活周期，永不过期</span><br><span class="line">-2  这个key不存在</span><br><span class="line">N   这个key存在，并且在N秒后过期</span><br></pre></td></tr></table></figure>

<p>取消过期时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第一种方法：</span><br><span class="line">PERSIST k1</span><br><span class="line"></span><br><span class="line">第二种方法：</span><br><span class="line"><span class="built_in">set</span> k1 v1</span><br><span class="line"></span><br><span class="line">结论：</span><br><span class="line">过期后的key会被直接删除</span><br></pre></td></tr></table></figure>

<h1 id="第6章-字符串操作"><a href="#第6章-字符串操作" class="headerlink" title="第6章 字符串操作"></a>第6章 字符串操作</h1><h2 id="1-设置一个key"><a href="#1-设置一个key" class="headerlink" title="1.设置一个key"></a>1.设置一个key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> k1 v1</span><br></pre></td></tr></table></figure>

<h2 id="2-查看一个key"><a href="#2-查看一个key" class="headerlink" title="2.查看一个key"></a>2.查看一个key</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> k1</span><br></pre></td></tr></table></figure>

<h2 id="3-设置多个key"><a href="#3-设置多个key" class="headerlink" title="3.设置多个key"></a>3.设置多个key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSET k1 v1 k2 v2 k3 v3 k4 v4</span><br></pre></td></tr></table></figure>

<h2 id="4-查看多个key"><a href="#4-查看多个key" class="headerlink" title="4.查看多个key"></a>4.查看多个key</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MGET k1 k2 k3 k4</span><br></pre></td></tr></table></figure>

<h2 id="5-天然计数器"><a href="#5-天然计数器" class="headerlink" title="5.天然计数器"></a>5.天然计数器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">加1:</span><br><span class="line">SET k1 1</span><br><span class="line">INCR k1</span><br><span class="line">GET k1</span><br><span class="line"></span><br><span class="line">加N：</span><br><span class="line">INCRBY k1 100</span><br><span class="line"></span><br><span class="line">减1:</span><br><span class="line">INCRBY k1 -1</span><br><span class="line"></span><br><span class="line">减N:</span><br><span class="line">INCRBY k1 -100</span><br></pre></td></tr></table></figure>

<h1 id="第7章-列表操作"><a href="#第7章-列表操作" class="headerlink" title="第7章 列表操作"></a>第7章 列表操作</h1><h2 id="1-插入列表"><a href="#1-插入列表" class="headerlink" title="1.插入列表"></a>1.插入列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LPUSH: 从列表左侧插入数据</span><br><span class="line">RPUSH: 从列表右侧插入数据</span><br></pre></td></tr></table></figure>

<h2 id="2-查看列表长度"><a href="#2-查看列表长度" class="headerlink" title="2.查看列表长度"></a>2.查看列表长度</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLEN list1</span><br></pre></td></tr></table></figure>

<h2 id="3-查看列表内容"><a href="#3-查看列表内容" class="headerlink" title="3.查看列表内容"></a>3.查看列表内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LRANGE list1 0 -1</span><br></pre></td></tr></table></figure>

<h2 id="4-删除列表元素"><a href="#4-删除列表元素" class="headerlink" title="4.删除列表元素"></a>4.删除列表元素</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LPOP: 从列表左边删除一个元素</span><br><span class="line">RPOP: 从列表右边删除一个元素</span><br><span class="line"></span><br><span class="line">LPOP list1</span><br><span class="line">RPOP list1 </span><br></pre></td></tr></table></figure>

<h2 id="5-删除整个列表"><a href="#5-删除整个列表" class="headerlink" title="5.删除整个列表"></a>5.删除整个列表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEL list1</span><br></pre></td></tr></table></figure>

<h1 id="第8章-hash操作"><a href="#第8章-hash操作" class="headerlink" title="第8章 hash操作"></a>第8章 hash操作</h1><h2 id="1-mysql数据如何缓存到redis"><a href="#1-mysql数据如何缓存到redis" class="headerlink" title="1.mysql数据如何缓存到redis"></a>1.mysql数据如何缓存到redis</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mysql</span>存储格式：</span><br><span class="line"><span class="selector-tag">user</span></span><br><span class="line"><span class="selector-tag">id</span> <span class="selector-tag">name</span>   <span class="selector-tag">job</span>  <span class="selector-tag">age</span></span><br><span class="line">1  <span class="selector-tag">bobo</span>   <span class="selector-tag">IT</span>   28</span><br><span class="line">2  <span class="selector-tag">json</span>   <span class="selector-tag">py</span>   25</span><br><span class="line">3  <span class="selector-tag">hao</span>    <span class="selector-tag">bug</span>  26</span><br><span class="line">  </span><br><span class="line"><span class="selector-tag">hash</span>类型存储格式：</span><br><span class="line"><span class="selector-tag">key</span>    <span class="selector-tag">field</span> <span class="selector-tag">value</span> <span class="selector-tag">field</span>   <span class="selector-tag">value</span>        </span><br><span class="line"><span class="selector-tag">user</span><span class="selector-pseudo">:1</span>   <span class="selector-tag">name</span>  <span class="selector-tag">bobo</span>  <span class="selector-tag">job</span>     <span class="selector-tag">IT</span>     <span class="selector-tag">age</span> 28</span><br><span class="line"><span class="selector-tag">user</span><span class="selector-pseudo">:2</span>   <span class="selector-tag">name</span>  <span class="selector-tag">json</span>  <span class="selector-tag">job</span>     <span class="selector-tag">py</span>     <span class="selector-tag">age</span> 25</span><br><span class="line"><span class="selector-tag">user</span><span class="selector-pseudo">:3</span>   <span class="selector-tag">name</span>  <span class="selector-tag">hao</span>   <span class="selector-tag">job</span>     <span class="selector-tag">bug</span>    <span class="selector-tag">age</span> 26</span><br></pre></td></tr></table></figure>

<h2 id="2-创建一个Hash数据"><a href="#2-创建一个Hash数据" class="headerlink" title="2.创建一个Hash数据"></a>2.创建一个Hash数据</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">HMSET</span> <span class="selector-tag">user</span><span class="selector-pseudo">:1</span> <span class="selector-tag">name</span> <span class="selector-tag">bobo</span> <span class="selector-tag">job</span> <span class="selector-tag">IT</span> <span class="selector-tag">age</span> 28</span><br><span class="line"><span class="selector-tag">HMSET</span> <span class="selector-tag">user</span><span class="selector-pseudo">:2</span> <span class="selector-tag">name</span> <span class="selector-tag">json</span> <span class="selector-tag">job</span> <span class="selector-tag">py</span> <span class="selector-tag">age</span> 29</span><br><span class="line"><span class="selector-tag">HMSET</span> <span class="selector-tag">user</span><span class="selector-pseudo">:3</span> <span class="selector-tag">name</span> <span class="selector-tag">hao</span> <span class="selector-tag">job</span> <span class="selector-tag">bug</span> <span class="selector-tag">age</span> 19 </span><br></pre></td></tr></table></figure>

<h2 id="3-查看hash里指定的值"><a href="#3-查看hash里指定的值" class="headerlink" title="3.查看hash里指定的值"></a>3.查看hash里指定的值</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> user <span class="keyword">where</span> id =<span class="number">1</span> ;</span><br><span class="line">  </span><br><span class="line">HMGET user:<span class="number">1</span> name  </span><br><span class="line">HMGET user:<span class="number">1</span> name job age</span><br></pre></td></tr></table></figure>

<h2 id="4-查看Hash里所有的值"><a href="#4-查看Hash里所有的值" class="headerlink" title="4.查看Hash里所有的值"></a>4.查看Hash里所有的值</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> user <span class="keyword">where</span> id =<span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">HGETALL user:<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="第9章-集合操作-set"><a href="#第9章-集合操作-set" class="headerlink" title="第9章 集合操作 set"></a>第9章 集合操作 set</h1><h2 id="1-创建集合"><a href="#1-创建集合" class="headerlink" title="1.创建集合"></a>1.创建集合</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SADD set1 1 2 3</span><br><span class="line">SADD set2 1 3 5 7 </span><br></pre></td></tr></table></figure>

<h2 id="2-查看集合成员"><a href="#2-查看集合成员" class="headerlink" title="2.查看集合成员"></a>2.查看集合成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMEMBERS set1</span><br><span class="line">SMEMBERS set2</span><br></pre></td></tr></table></figure>

<h2 id="3-查看集合的交集"><a href="#3-查看集合的交集" class="headerlink" title="3.查看集合的交集"></a>3.查看集合的交集</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SINTER</span> <span class="selector-tag">set1</span> <span class="selector-tag">set2</span></span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-查看集合的并集"><a href="#4-查看集合的并集" class="headerlink" title="4.查看集合的并集"></a>4.查看集合的并集</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">127.0.0.1:6379&gt;</span> SUNION set1 set2</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;7&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-查看集合的差集"><a href="#5-查看集合的差集" class="headerlink" title="5.查看集合的差集"></a>5.查看集合的差集</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SDIFF</span> <span class="selector-tag">set1</span> <span class="selector-tag">set2</span></span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">  </span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">SDIFF</span> <span class="selector-tag">set2</span> <span class="selector-tag">set1</span></span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;7&quot;</span><br></pre></td></tr></table></figure>

<h2 id="6-删除一个成员"><a href="#6-删除一个成员" class="headerlink" title="6.删除一个成员"></a>6.删除一个成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SREM set1 1</span><br></pre></td></tr></table></figure>

<h2 id="6-注意"><a href="#6-注意" class="headerlink" title="6.注意"></a>6.注意</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">集合不允许出现重复的值，自动去重</span><br></pre></td></tr></table></figure>

<h1 id="第10章-有序集合操作"><a href="#第10章-有序集合操作" class="headerlink" title="第10章 有序集合操作"></a>第10章 有序集合操作</h1><h2 id="1-添加成员"><a href="#1-添加成员" class="headerlink" title="1.添加成员"></a>1.添加成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZADD SZ3 100 json</span><br><span class="line">ZADD SZ3 90 bobo</span><br><span class="line">ZADD SZ3 99 xiaocancan</span><br><span class="line">ZADD SZ3 98 bughao</span><br></pre></td></tr></table></figure>

<h2 id="2-计算成员个数"><a href="#2-计算成员个数" class="headerlink" title="2.计算成员个数"></a>2.计算成员个数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZCARD SZ3</span><br></pre></td></tr></table></figure>

<h2 id="3-计算某个成员分数"><a href="#3-计算某个成员分数" class="headerlink" title="3.计算某个成员分数"></a>3.计算某个成员分数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZSCORE SZ3 json</span><br></pre></td></tr></table></figure>

<h2 id="4-按照降序查看成员名次："><a href="#4-按照降序查看成员名次：" class="headerlink" title="4.按照降序查看成员名次："></a>4.按照降序查看成员名次：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANK SZ3 json</span><br><span class="line">ZRANK SZ3 bobo</span><br></pre></td></tr></table></figure>

<h2 id="5-按照升序查看成员名次："><a href="#5-按照升序查看成员名次：" class="headerlink" title="5.按照升序查看成员名次："></a>5.按照升序查看成员名次：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZREVRANK SZ3 json</span><br><span class="line">ZREVRANK SZ3 bobo</span><br></pre></td></tr></table></figure>

<h2 id="6-删除成员"><a href="#6-删除成员" class="headerlink" title="6.删除成员"></a>6.删除成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREM SZ3 json</span><br></pre></td></tr></table></figure>

<h2 id="7-增加成员分数"><a href="#7-增加成员分数" class="headerlink" title="7.增加成员分数"></a>7.增加成员分数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZINCRBY SZ3 2 xiaocancan</span><br><span class="line">ZSCORE SZ3 xiaocancan</span><br></pre></td></tr></table></figure>

<h2 id="8-返回指定排名范围的成员"><a href="#8-返回指定排名范围的成员" class="headerlink" title="8.返回指定排名范围的成员"></a>8.返回指定排名范围的成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANGE SZ3 0 3 </span><br><span class="line">ZRANGE SZ3 0 3 WITHSCORES</span><br></pre></td></tr></table></figure>

<h2 id="9-返回指定分数范围的成员"><a href="#9-返回指定分数范围的成员" class="headerlink" title="9.返回指定分数范围的成员"></a>9.返回指定分数范围的成员</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANGEBYSCORE SZ3 95 100</span><br><span class="line">ZRANGEBYSCORE SZ3 95 100  WITHSCORES</span><br></pre></td></tr></table></figure>

<h2 id="10-返回指定分数范围的成员的个数"><a href="#10-返回指定分数范围的成员的个数" class="headerlink" title="10.返回指定分数范围的成员的个数"></a>10.返回指定分数范围的成员的个数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZCOUNT SZ3 90 110</span><br></pre></td></tr></table></figure>

<h1 id="第11章-持久化"><a href="#第11章-持久化" class="headerlink" title="第11章 持久化"></a>第11章 持久化</h1><p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-4bec444f44920615.png" alt="img"></p>
<p>RDB流程图</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-e70993005208cde6.png" alt="img"></p>
<p>AOF流程图</p>
<h2 id="1-RDB和AOF介绍"><a href="#1-RDB和AOF介绍" class="headerlink" title="1.RDB和AOF介绍"></a>1.RDB和AOF介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RDB：类似于快照的形式，当前内存里的状态持久化到硬盘里</span><br><span class="line">优点：压缩格式&#x2F;恢复速度快</span><br><span class="line">缺点：不是实时的，可能会丢失数据,操作比较重</span><br><span class="line">    </span><br><span class="line">AOF：类似于mysql的binlog，可以设置为每秒&#x2F;每次操作以追加的形式持久化</span><br><span class="line">优点：安全，最多损失1秒的数据，可读</span><br><span class="line">缺点：文件比较大，恢复速度慢</span><br></pre></td></tr></table></figure>

<h2 id="2-配置RDB"><a href="#2-配置RDB" class="headerlink" title="2.配置RDB"></a>2.配置RDB</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save <span class="number">900</span> <span class="number">1</span></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span></span><br><span class="line">dbfilename redis.rdb</span><br><span class="line">dir /<span class="keyword">data</span>/redis_6379/</span><br></pre></td></tr></table></figure>

<h2 id="3-RDB结论"><a href="#3-RDB结论" class="headerlink" title="3.RDB结论"></a>3.RDB结论</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.没有配置save参数时，shutdown不会持久化保存</span><br><span class="line">2.没有配置save参数时，可以手动执行bgsave触发持久化</span><br><span class="line">3.在配置了save参数后，shutdown,<span class="built_in">kill</span>,pkill都会自动触发bgsave</span><br><span class="line">4.恢复的时候，rdb文件名要和配置文件里写的一样。</span><br><span class="line">5.RDB高版本兼容低版本，低版本不兼容高版本</span><br></pre></td></tr></table></figure>

<h2 id="4-AOF配置"><a href="#4-AOF配置" class="headerlink" title="4.AOF配置"></a>4.AOF配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">&quot;redis.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<h2 id="5-AOF重写机制"><a href="#5-AOF重写机制" class="headerlink" title="5.AOF重写机制"></a>5.AOF重写机制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">执行的命令   aof记录        redis的数据       </span><br><span class="line"><span class="built_in">set</span> k1    v1    <span class="built_in">set</span> k1   k1                 </span><br><span class="line"><span class="built_in">set</span> k2    v2    <span class="built_in">set</span> k2   k1 k2          </span><br><span class="line"><span class="built_in">set</span> k3    v3    <span class="built_in">set</span> k3   k1 k2 k3       </span><br><span class="line">del k1      del k1       k2 k3</span><br><span class="line">del k2      del k2       k3 </span><br><span class="line">实际有意义的只有一条记录：</span><br><span class="line"><span class="built_in">set</span> k3</span><br></pre></td></tr></table></figure>

<h2 id="6-aof和rdb实验"><a href="#6-aof和rdb实验" class="headerlink" title="6.aof和rdb实验"></a>6.aof和rdb实验</h2><p>实验背景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aof和rdb同时存在的时候，redis重启会读取哪一个数据？</span><br></pre></td></tr></table></figure>

<p>实验步骤：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> k1 v1</span><br><span class="line"><span class="keyword">set</span> k2 v2 </span><br><span class="line">bgsave </span><br><span class="line">RDB k1 k2</span><br><span class="line">mv redis.rdb /opt/  </span><br><span class="line">    </span><br><span class="line">flushall</span><br><span class="line"><span class="keyword">set</span> k3 v3</span><br><span class="line"><span class="keyword">set</span> k4 v4</span><br><span class="line">AOF k3 k4</span><br><span class="line">mv redis.aof /opt/</span><br><span class="line">  </span><br><span class="line">pkill redis</span><br><span class="line">rm -rf /<span class="keyword">data</span>/redis_6379<span class="comment">/*</span></span><br><span class="line"><span class="comment">mv /opt/redis.rdb .</span></span><br><span class="line"><span class="comment">mv /opt/redis.aof .</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">redis-server /opt/redis_6379/conf/redis.conf</span></span><br><span class="line"><span class="comment">redis-cli </span></span><br><span class="line"><span class="comment">keys * </span></span><br></pre></td></tr></table></figure>

<p>结论：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当aof和rdb同时存在时，重启redis会优先读取aof的内容</span><br></pre></td></tr></table></figure>

<h2 id="7-如何选择是rdb还是aof"><a href="#7-如何选择是rdb还是aof" class="headerlink" title="7.如何选择是rdb还是aof"></a>7.如何选择是rdb还是aof</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//redis.io/topics/persistence</span></span><br><span class="line"><span class="number">1.</span>开启混合模式</span><br><span class="line"><span class="number">2.</span>开启aof</span><br><span class="line"><span class="number">3.</span>不开启rdb</span><br><span class="line"><span class="number">4.</span>rdb采用定时任务的方式定时备份</span><br></pre></td></tr></table></figure>

<h2 id="8-aof文件故障模拟实验结论"><a href="#8-aof文件故障模拟实验结论" class="headerlink" title="8.aof文件故障模拟实验结论"></a>8.aof文件故障模拟实验结论</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1<span class="selector-class">.aof</span>文件损坏之后，使用修复工具，一刀流，从<span class="selector-tag">aof</span>文件出错的地方开始到最后全部删掉</span><br><span class="line">2.任何操作之前，先备份数据</span><br><span class="line">3<span class="selector-class">.aof</span>备份一般情况最多损失1秒的数据</span><br></pre></td></tr></table></figure>

<h2 id="9-实验：如果设置了过期时间，恢复数据会如何处理"><a href="#9-实验：如果设置了过期时间，恢复数据会如何处理" class="headerlink" title="9.实验：如果设置了过期时间，恢复数据会如何处理"></a>9.实验：如果设置了过期时间，恢复数据会如何处理</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1<span class="selector-class">.aof</span>文件会记录下过期的时间</span><br><span class="line">2.恢复的时候会去对比记录的过期时间和当前时间，如果超过了，就删除<span class="selector-tag">key</span></span><br><span class="line">3<span class="selector-class">.key</span>的过期时间不受备份恢复影响</span><br></pre></td></tr></table></figure>

<h1 id="第12章-redis用户认证"><a href="#第12章-redis用户认证" class="headerlink" title="第12章 redis用户认证"></a>第12章 redis用户认证</h1><h2 id="1-写入配置文件"><a href="#1-写入配置文件" class="headerlink" title="1.写入配置文件"></a>1.写入配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass cookzhang</span><br></pre></td></tr></table></figure>

<h2 id="2-使用密码登陆"><a href="#2-使用密码登陆" class="headerlink" title="2.使用密码登陆"></a>2.使用密码登陆</h2><p>第一种：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@db01 ~]</span># <span class="selector-tag">redis-cli</span> </span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">AUTH</span> <span class="selector-tag">cookzhang</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line"><span class="selector-tag">OK</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>第二种：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a cookz <span class="keyword">get</span> k1</span><br></pre></td></tr></table></figure>

<h2 id="3-为什么redis的密码认证这么简单？"><a href="#3-为什么redis的密码认证这么简单？" class="headerlink" title="3.为什么redis的密码认证这么简单？"></a>3.为什么redis的密码认证这么简单？</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1<span class="selector-class">.redis</span>一般都部署在内网环境，默认是比较安全的环境</span><br><span class="line">2.有同学担心密码写在配置文件里，开发不允许登陆到<span class="selector-tag">Linux</span>服务器上，但是可以连接到<span class="selector-tag">redis</span>,设个密码安全些</span><br></pre></td></tr></table></figure>

<h1 id="第13章-禁用或重命名危险命令"><a href="#第13章-禁用或重命名危险命令" class="headerlink" title="第13章 禁用或重命名危险命令"></a>第13章 禁用或重命名危险命令</h1><h2 id="1-禁用危险命令"><a href="#1-禁用危险命令" class="headerlink" title="1.禁用危险命令"></a>1.禁用危险命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rename-command CONFIG <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command KEYS <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command SHUTDOWN <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command FLUSHALL <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command DEL <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command FLUSHDB <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-来自json的灵魂拷问：shutdown禁用了-让后用kill"><a href="#2-来自json的灵魂拷问：shutdown禁用了-让后用kill" class="headerlink" title="2.来自json的灵魂拷问：shutdown禁用了 让后用kill?"></a>2.来自json的灵魂拷问：shutdown禁用了 让后用kill?</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rename-command CONFIG <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command KEYS <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command SHUTDOWN <span class="string">&quot;qq526195417&quot;</span></span><br><span class="line">rename-command FLUSHALL <span class="string">&quot;&quot;</span></span><br><span class="line">rename-command DEL <span class="string">&quot;byebye&quot;</span></span><br><span class="line">rename-command FLUSHDB <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="第14章-Redis主从复制"><a href="#第14章-Redis主从复制" class="headerlink" title="第14章 Redis主从复制"></a>第14章 Redis主从复制</h1><h2 id="1-快速部署第二台服务器"><a href="#1-快速部署第二台服务器" class="headerlink" title="1.快速部署第二台服务器"></a>1.快速部署第二台服务器</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz <span class="number">10.0</span>.<span class="number">0</span>.<span class="number">51</span><span class="symbol">:/opt/*</span> /opt/*</span><br><span class="line">mkdir /data/redis_6379/ -p</span><br><span class="line">cd /opt/redis </span><br><span class="line">make install </span><br><span class="line">sed -i <span class="string">&#x27;s#51#52#g&#x27;</span> /opt/redis_6379/conf/redis_6379.conf</span><br><span class="line">redis-server /opt/redis_6379/conf/redis_6379.conf</span><br></pre></td></tr></table></figure>

<h2 id="2-db01插入测试命令"><a href="#2-db01插入测试命令" class="headerlink" title="2.db01插入测试命令"></a>2.db01插入测试命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1000&#125;;<span class="keyword">do</span> redis-cli -h 10.0.0.51 <span class="built_in">set</span> <span class="variable">$&#123;i&#125;</span> <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置主从复制"><a href="#3-配置主从复制" class="headerlink" title="3.配置主从复制"></a>3.配置主从复制</h2><p>方法1:临时生效</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> <span class="selector-tag">slaveof</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6379 </span><br></pre></td></tr></table></figure>

<p>方法2:写进配置文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">slaveof</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6379</span><br></pre></td></tr></table></figure>

<h2 id="4-主从复制的流程"><a href="#4-主从复制的流程" class="headerlink" title="4.主从复制的流程"></a>4.主从复制的流程</h2><p>1.简单流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.从节点发送同步请求到主节点</span><br><span class="line">2.主节点接收到从节点的请求之后,做了如下操作</span><br><span class="line">  - 立即执行bgsave将当前内存里的数据持久化到磁盘上</span><br><span class="line">  - 持久化完成之后,将rdb文件发送给从节点</span><br><span class="line">3.从节点从主节点接收到rdb文件之后,做了如下操作</span><br><span class="line">  - 清空自己的数据</span><br><span class="line">  - 载入从主节点接收的rdb文件到自己的内存里</span><br><span class="line">4.后面的操作就是和主节点实时的了</span><br></pre></td></tr></table></figure>

<h2 id="5-取消复制"><a href="#5-取消复制" class="headerlink" title="5.取消复制"></a>5.取消复制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLAVEOF no one</span><br></pre></td></tr></table></figure>

<h2 id="6-主从复制注意"><a href="#6-主从复制注意" class="headerlink" title="6.主从复制注意"></a>6.主从复制注意</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.从节点只读不可写</span><br><span class="line"><span class="number">2</span>.从节点不会自动故障转移,它会一直同步主节点</span><br><span class="line"><span class="meta">10.0.0.52:6379&gt;</span> set k1 v1</span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only slave.</span></span><br><span class="line"><span class="string">3.主从复制故障转移需要人工介入</span></span><br><span class="line"><span class="string">  - 修改代码指向REDIS的IP地址</span></span><br><span class="line"><span class="string">  - 从节点需要执行SLAVEOF no one</span></span><br><span class="line"><span class="string">4.从节点会清空自己原有的数据,如果同步的对象写错了,就会导致数据丢失</span></span><br><span class="line"><span class="string">5.从库和主库后续的同步依靠的是redis的SYNC协议，而不是RDB文件，RDB文件只是第一次建立同步时使用。</span></span><br><span class="line"><span class="string">6.从库也可以正常的持久化文件</span></span><br></pre></td></tr></table></figure>

<h2 id="7-安全的操作"><a href="#7-安全的操作" class="headerlink" title="7.安全的操作"></a>7.安全的操作</h2><p>无论是同步,无论是主节点还是从节点,请先备份一下数据</p>
<h1 id="第15章-Redis哨兵"><a href="#第15章-Redis哨兵" class="headerlink" title="第15章 Redis哨兵"></a>第15章 Redis哨兵</h1><p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-c5cf045607671b40.png" alt="img"></p>
<h2 id="1-哨兵的作用"><a href="#1-哨兵的作用" class="headerlink" title="1.哨兵的作用"></a>1.哨兵的作用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.解决了主从复制故障需要人为干预的问题</span><br><span class="line">2.提供了自动的高可用解决方案</span><br></pre></td></tr></table></figure>

<h2 id="2-目录和端口规划"><a href="#2-目录和端口规划" class="headerlink" title="2.目录和端口规划"></a>2.目录和端口规划</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis节点： 6379</span><br><span class="line">哨兵节点：    26379</span><br></pre></td></tr></table></figure>

<h2 id="3-部署3台redis单节点"><a href="#3-部署3台redis单节点" class="headerlink" title="3.部署3台redis单节点"></a>3.部署3台redis单节点</h2><h3 id="db01操作："><a href="#db01操作：" class="headerlink" title="db01操作："></a>db01操作：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pkill redis</span><br><span class="line">cat &gt;/opt/redis_6379/conf/redis_6379.conf &lt;&lt;EOF   </span><br><span class="line">daemonize yes</span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 10.0.0.51</span><br><span class="line">port 6379</span><br><span class="line">pidfile <span class="string">&quot;/opt/redis_6379/pid/redis_6379.pid&quot;</span></span><br><span class="line">logfile <span class="string">&quot;/opt/redis_6379/logs/redis_6379.log&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;redis.rdb&quot;</span></span><br><span class="line">dir <span class="string">&quot;/data/redis_6379&quot;</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">&quot;redis.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">EOF</span><br><span class="line">systemctl start redis</span><br><span class="line">redis-cli</span><br></pre></td></tr></table></figure>

<h3 id="db02和db03的操作："><a href="#db02和db03的操作：" class="headerlink" title="db02和db03的操作："></a>db02和db03的操作：</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pkill redis </span><br><span class="line">rm -rf /opt/redis*</span><br><span class="line">rsync -avz <span class="number">10.0</span>.<span class="number">0</span>.<span class="number">51</span><span class="symbol">:/usr/local/bin/redis-*</span>  /usr/local/bin</span><br><span class="line">rsync -avz <span class="number">10.0</span>.<span class="number">0</span>.<span class="number">51</span><span class="symbol">:/usr/lib/systemd/system/redis</span>.service /usr/lib/systemd/system/</span><br><span class="line">mkdir /opt/redis_6379/&#123;conf,logs,pid&#125; -p</span><br><span class="line">mkdir /data/redis_6379 -p</span><br><span class="line">cat &gt;<span class="regexp">/opt/redis</span>_6379/conf/redis_6379.conf &lt;&lt;EOF   </span><br><span class="line">daemonize yes</span><br><span class="line">bind <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> $(ifconfig eth<span class="number">0</span><span class="params">|awk &#x27;NR==2&#123;print $2&#125;&#x27;)</span></span><br><span class="line"><span class="params">port 6379</span></span><br><span class="line"><span class="params">pidfile &quot;/opt/redis_6379/pid/redis_6379.pid&quot;</span></span><br><span class="line"><span class="params">logfile &quot;/opt/redis_6379/logs/redis_6379.log&quot;</span></span><br><span class="line"><span class="params">dbfilename &quot;redis.rdb&quot;</span></span><br><span class="line"><span class="params">dir &quot;/data/redis_6379&quot;</span></span><br><span class="line"><span class="params">appendonly yes</span></span><br><span class="line"><span class="params">appendfilename &quot;redis.aof&quot;</span></span><br><span class="line"><span class="params">appendfsync everysec</span></span><br><span class="line"><span class="params">EOF</span></span><br><span class="line"><span class="params">useradd redis -M -s /sbin/nologin</span></span><br><span class="line"><span class="params">chown -R redis:redis /opt/redis*</span></span><br><span class="line"><span class="params">chown -R redis:redis /data/redis*</span></span><br><span class="line"><span class="params">systemctl daemon-reload </span></span><br><span class="line"><span class="params">systemctl start redis </span></span><br><span class="line"><span class="params">redis-cli</span></span><br></pre></td></tr></table></figure>

<h2 id="4-配置主从复制"><a href="#4-配置主从复制" class="headerlink" title="4.配置主从复制"></a>4.配置主从复制</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> <span class="selector-tag">slaveof</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6379</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> <span class="selector-tag">slaveof</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6379</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> <span class="selector-tag">info</span> <span class="selector-tag">Replication</span></span><br></pre></td></tr></table></figure>

<h2 id="5-部署哨兵节点-3台机器都操作"><a href="#5-部署哨兵节点-3台机器都操作" class="headerlink" title="5.部署哨兵节点-3台机器都操作"></a>5.部署哨兵节点-3台机器都操作</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /<span class="keyword">data</span>/redis_26379</span><br><span class="line">mkdir -p /opt/redis_26379/&#123;conf,pid,logs&#125;</span><br><span class="line">cat &gt;/opt/redis_26379/conf/redis_26379.conf &lt;&lt; EOF</span><br><span class="line">bind $(ifconfig eth0|awk <span class="string">&#x27;NR==2&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">port <span class="number">26379</span></span><br><span class="line">daemonize yes</span><br><span class="line">logfile /opt/redis_26379/logs/redis_26379.log</span><br><span class="line">dir /<span class="keyword">data</span>/redis_26379</span><br><span class="line">sentinel monitor myredis <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="number">6379</span> <span class="number">2</span></span><br><span class="line">sentinel down-after-milliseconds myredis <span class="number">3000</span></span><br><span class="line">sentinel parallel-syncs myredis <span class="number">1</span></span><br><span class="line">sentinel failover-timeout myredis <span class="number">18000</span></span><br><span class="line">EOF</span><br><span class="line">chown -R redis:redis  /<span class="keyword">data</span>/redis*</span><br><span class="line">chown -R redis:redis  /opt/redis*</span><br></pre></td></tr></table></figure>

<p>参数解释：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 10.0.0.51 6379 2</span><br><span class="line"><span class="comment">#mymaster 主节点别名 主节点 ip 和端口， 判断主节点失败， 两个 sentinel 节点同意</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 3000</span><br><span class="line"><span class="comment">#选项指定了 Sentinel 认为服务器已经断线所需的毫秒数。</span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"><span class="comment">#向新的主节点发起复制操作的从节点个数， 1 轮询发起复制</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"><span class="comment">#故障转移超时时间</span></span><br></pre></td></tr></table></figure>

<h2 id="6-编写哨兵system配置文件-3台机器都操作"><a href="#6-编写哨兵system配置文件-3台机器都操作" class="headerlink" title="6.编写哨兵system配置文件-3台机器都操作"></a>6.编写哨兵system配置文件-3台机器都操作</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/usr/lib/systemd/system/redis-sentinel.service&lt;&lt;EOF</span><br><span class="line">[<span class="meta">Unit</span>]</span><br><span class="line">Description=Redis persistent key-<span class="keyword">value</span> database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[<span class="meta">Service</span>]</span><br><span class="line">ExecStart=/usr/local/bin/redis-sentinel /opt/redis_26379/conf/redis_26379.conf --supervised systemd</span><br><span class="line">ExecStop=/usr/local/bin/redis-cli -h $(ifconfig eth0|awk <span class="string">&#x27;NR==2&#123;print $2&#125;&#x27;</span>) -p <span class="number">26379</span> shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=<span class="number">0755</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">Install</span>]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload </span><br></pre></td></tr></table></figure>

<h2 id="7-启动哨兵并检查"><a href="#7-启动哨兵并检查" class="headerlink" title="7.启动哨兵并检查"></a>7.启动哨兵并检查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start redis-sentinel </span><br></pre></td></tr></table></figure>

<h2 id="8-验证主节点"><a href="#8-验证主节点" class="headerlink" title="8.验证主节点"></a>8.验证主节点</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> <span class="selector-tag">-p</span> 26379 <span class="selector-tag">Sentinel</span> <span class="selector-tag">get-master-addr-by-name</span> <span class="selector-tag">myredis</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> <span class="selector-tag">-p</span> 26379 <span class="selector-tag">Sentinel</span> <span class="selector-tag">get-master-addr-by-name</span> <span class="selector-tag">myredis</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> <span class="selector-tag">-p</span> 26379 <span class="selector-tag">Sentinel</span> <span class="selector-tag">get-master-addr-by-name</span> <span class="selector-tag">myredis</span></span><br></pre></td></tr></table></figure>

<h2 id="9-模拟故障转移"><a href="#9-模拟故障转移" class="headerlink" title="9.模拟故障转移"></a>9.模拟故障转移</h2><p>关闭主节点服务上的所有redis进程<br>观察其他2个节点会不会发生选举<br>查看配置文件里会不会自动更新<br>查看新的主节点能不能写入<br>查看从节点能否正常同步</p>
<h2 id="10-模拟故障修复上线"><a href="#10-模拟故障修复上线" class="headerlink" title="10.模拟故障修复上线"></a>10.模拟故障修复上线</h2><p>启动单节点<br>启动哨兵</p>
<h2 id="11-来自json的灵魂发问：能够给redis-节点加权-来确定优先备选主节点嘛"><a href="#11-来自json的灵魂发问：能够给redis-节点加权-来确定优先备选主节点嘛" class="headerlink" title="11.来自json的灵魂发问：能够给redis 节点加权 来确定优先备选主节点嘛?"></a>11.来自json的灵魂发问：能够给redis 节点加权 来确定优先备选主节点嘛?</h2><p>流程说明：<br>设置其他节点的权重为0<br>手动发起重新选举<br>观察所有节点消息是否同步<br>观察切换结果是否符合预期</p>
<p>命令解释：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询命令<span class="selector-pseudo">:CONFIG</span> <span class="selector-tag">GET</span> <span class="selector-tag">slave-priority</span></span><br><span class="line">设置命令<span class="selector-pseudo">:CONFIG</span> <span class="selector-tag">SET</span> <span class="selector-tag">slave-priority</span> 0</span><br><span class="line">主动切换<span class="selector-pseudo">:sentinel</span> <span class="selector-tag">failover</span> <span class="selector-tag">myredis</span></span><br></pre></td></tr></table></figure>

<p>操作命令：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> <span class="selector-tag">-p</span> 6379 <span class="selector-tag">CONFIG</span> <span class="selector-tag">SET</span> <span class="selector-tag">slave-priority</span> 0</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> <span class="selector-tag">-p</span> 6379 <span class="selector-tag">CONFIG</span> <span class="selector-tag">SET</span> <span class="selector-tag">slave-priority</span> 0</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> <span class="selector-tag">-p</span> 26379 <span class="selector-tag">sentinel</span> <span class="selector-tag">failover</span> <span class="selector-tag">myredis</span></span><br></pre></td></tr></table></figure>

<p>验证选举结果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> <span class="selector-tag">-p</span> 26379 <span class="selector-tag">Sentinel</span> <span class="selector-tag">get-master-addr-by-name</span> <span class="selector-tag">myredis</span></span><br></pre></td></tr></table></figure>

<h1 id="第16章-手动部署Redis集群"><a href="#第16章-手动部署Redis集群" class="headerlink" title="第16章 手动部署Redis集群"></a>第16章 手动部署Redis集群</h1><p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-f6153b9ec44340b7.png" alt="img"></p>
<p>集群架构图1</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-4c60e0aa042e4599.png" alt="img"></p>
<p>集群架构图2</p>
<h2 id="1-烧饼的不足"><a href="#1-烧饼的不足" class="headerlink" title="1.烧饼的不足"></a>1.烧饼的不足</h2><p>资源利用率不高<br>主库压力大<br>连接过程繁琐</p>
<h2 id="2-集群重要概念"><a href="#2-集群重要概念" class="headerlink" title="2.集群重要概念"></a>2.集群重要概念</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis集群，无论有几个节点，一共只有16384个槽</span><br><span class="line">所有的槽位都必须分配，哪怕有1个槽位不正常，整个集群都不能用</span><br><span class="line">每个节点的槽的顺序不重要，重点是数量</span><br><span class="line"><span class="built_in">hash</span>算法足够随机，足够平均</span><br><span class="line">每个槽被分配到数据的概率是相当的</span><br><span class="line">集群的高可用依赖于主从复制</span><br><span class="line">集群拥有自己的配置文件，动态更新，不要手欠修改</span><br><span class="line">集群通讯会使用基础端口号+10000的端口，这个是自动创建的，不是配置文件配置的</span><br><span class="line">集群槽位分配比例允许误差在%2之间</span><br></pre></td></tr></table></figure>

<h2 id="3-目录规划"><a href="#3-目录规划" class="headerlink" title="3.目录规划"></a>3.目录规划</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">主节点  6380</span><br><span class="line">从节点  6381</span><br></pre></td></tr></table></figure>

<h2 id="4-db01的操作"><a href="#4-db01的操作" class="headerlink" title="4.db01的操作"></a>4.db01的操作</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">ssh-copy-id <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span></span><br><span class="line">pkill redis</span><br><span class="line">mkdir -p /opt/redis_&#123;<span class="number">6380</span>,<span class="number">6381</span>&#125;/&#123;conf,logs,pid&#125;</span><br><span class="line">mkdir -p /data/redis_&#123;<span class="number">6380</span>,<span class="number">6381</span>&#125;</span><br><span class="line">cat &gt;<span class="regexp">/opt/</span>redis_6380/conf/redis_6380.conf&lt;&lt;EOF</span><br><span class="line">bind <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">port <span class="number">6380</span></span><br><span class="line">daemonize yes</span><br><span class="line">pidfile <span class="string">&quot;/opt/redis_6380/pid/redis_6380.pid&quot;</span></span><br><span class="line">logfile <span class="string">&quot;/opt/redis_6380/logs/redis_6380.log&quot;</span></span><br><span class="line">dbfilename <span class="string">&quot;redis_6380.rdb&quot;</span></span><br><span class="line">dir <span class="string">&quot;/data/redis_6380/&quot;</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">&quot;redis.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes_6380.conf</span><br><span class="line">cluster-node-timeout <span class="number">15000</span></span><br><span class="line">EOF</span><br><span class="line">cd /opt/</span><br><span class="line">cp redis_6380/conf/redis_6380.conf redis_6381/conf/redis_6381.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#6380#6381#g&#x27;</span> redis_6381/conf/redis_6381.conf </span><br><span class="line">chown -R redis:redis /opt/redis_*</span><br><span class="line">chown -R redis:redis /data/redis_*</span><br><span class="line">cat &gt;<span class="regexp">/usr/</span>lib/systemd/system/redis-master.service&lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis persistent key-value database</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=<span class="regexp">/usr/</span>local/bin/redis-server /opt/redis_6380/conf/redis_6380.conf --supervised systemd</span><br><span class="line">ExecStop=<span class="regexp">/usr/</span>local/bin/redis-cli -h $(ifconfig eth0|awk <span class="string">&#x27;NR==2&#123;print $2&#125;&#x27;</span>) -p <span class="number">6380</span> shutdown</span><br><span class="line">Type=notify</span><br><span class="line">User=redis</span><br><span class="line">Group=redis</span><br><span class="line">RuntimeDirectory=redis</span><br><span class="line">RuntimeDirectoryMode=<span class="number">0755</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">cd /usr/lib/systemd/system/</span><br><span class="line">cp redis-master.service redis-slave.service</span><br><span class="line">sed -i <span class="string">&#x27;s#6380#6381#g&#x27;</span> redis-slave.service</span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start redis-master</span><br><span class="line">systemctl start redis-slave</span><br><span class="line">ps -ef|grep redis</span><br><span class="line">rsync -avz /opt/redis_638* <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="regexp">/opt/</span></span><br><span class="line">rsync -avz /opt/redis_638* <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>:<span class="regexp">/opt/</span></span><br><span class="line">rsync -avz /usr/lib/systemd/system/redis-*.service <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="regexp">/usr/</span>lib/systemd/system/redis-master.service</span><br><span class="line">rsync -avz /usr/lib/systemd/system/redis-*.service <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>:<span class="regexp">/usr/</span>lib/systemd/system/redis-master.service</span><br></pre></td></tr></table></figure>

<h2 id="5-db02的操作"><a href="#5-db02的操作" class="headerlink" title="5.db02的操作"></a>5.db02的操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pkill redis</span><br><span class="line">find /opt/redis_638* -<span class="built_in">type</span> f -name <span class="string">&quot;*.conf&quot;</span>|xargs sed -i <span class="string">&quot;/bind/s#51#52#g&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /usr/lib/systemd/system/</span><br><span class="line">sed -i <span class="string">&#x27;s#51#52#g&#x27;</span> redis-*.service </span><br><span class="line">mkdir –p /data/redis_&#123;6380,6381&#125;</span><br><span class="line">chown -R redis:redis /opt/redis_*</span><br><span class="line">chown -R redis:redis /data/redis_*</span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start redis-master</span><br><span class="line">systemctl start redis-slave</span><br><span class="line">ps -ef|grep redis</span><br></pre></td></tr></table></figure>

<h2 id="6-db03的操作"><a href="#6-db03的操作" class="headerlink" title="6.db03的操作"></a>6.db03的操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pkill redis</span><br><span class="line">find /opt/redis_638* -<span class="built_in">type</span> f -name <span class="string">&quot;*.conf&quot;</span>|xargs sed -i <span class="string">&quot;/bind/s#51#53#g&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /usr/lib/systemd/system/</span><br><span class="line">sed -i <span class="string">&#x27;s#51#53#g&#x27;</span> redis-*.service </span><br><span class="line">mkdir –p /data/redis_&#123;6380,6381&#125;</span><br><span class="line">chown -R redis:redis /opt/redis_*</span><br><span class="line">chown -R redis:redis /data/redis_*</span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl start redis-master</span><br><span class="line">systemctl start redis-slave</span><br><span class="line">ps -ef|grep redis</span><br></pre></td></tr></table></figure>

<h2 id="7-集群手动发现节点"><a href="#7-集群手动发现节点" class="headerlink" title="7.集群手动发现节点"></a>7.集群手动发现节点</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> 6380</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> 6380</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6381</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> 6381</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> 6381</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">NODES</span>  </span><br></pre></td></tr></table></figure>

<h2 id="8-集群手动分配槽位"><a href="#8-集群手动分配槽位" class="headerlink" title="8.集群手动分配槽位"></a>8.集群手动分配槽位</h2><h3 id="1-槽位规划"><a href="#1-槽位规划" class="headerlink" title="1.槽位规划"></a>1.槽位规划</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db01</span><span class="selector-pseudo">:6380</span> 5461  0<span class="selector-tag">-5460</span></span><br><span class="line"><span class="selector-tag">db02</span><span class="selector-pseudo">:6380</span> 5461  5461<span class="selector-tag">-10921</span></span><br><span class="line"><span class="selector-tag">db03</span><span class="selector-pseudo">:6380</span> 5462  10922<span class="selector-tag">-16383</span></span><br></pre></td></tr></table></figure>

<h3 id="2-分配槽位"><a href="#2-分配槽位" class="headerlink" title="2.分配槽位"></a>2.分配槽位</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">0.</span><span class="number">.5460</span>&#125;</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">5461.</span><span class="number">.10921</span>&#125;</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">10922.</span><span class="number">.16383</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-查看集群状态"><a href="#3-查看集群状态" class="headerlink" title="3.查看集群状态"></a>3.查看集群状态</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> NODES</span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> INFO</span><br></pre></td></tr></table></figure>

<h2 id="9-手动部署复制关系"><a href="#9-手动部署复制关系" class="headerlink" title="9.手动部署复制关系"></a>9.手动部署复制关系</h2><h3 id="0-先获取集群节点信息"><a href="#0-先获取集群节点信息" class="headerlink" title="0.先获取集群节点信息"></a>0.先获取集群节点信息</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> NODES</span><br></pre></td></tr></table></figure>

<h3 id="1-先删除所有6381的内容和不需要内容"><a href="#1-先删除所有6381的内容和不需要内容" class="headerlink" title="1.先删除所有6381的内容和不需要内容"></a>1.先删除所有6381的内容和不需要内容</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">6380的<span class="selector-tag">ID</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span></span><br><span class="line">6380的<span class="selector-tag">ID</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span></span><br><span class="line">6380的<span class="selector-tag">ID</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span></span><br></pre></td></tr></table></figure>

<h3 id="2-画图"><a href="#2-画图" class="headerlink" title="2.画图"></a>2.画图</h3><h3 id="3-确定复制关系"><a href="#3-确定复制关系" class="headerlink" title="3.确定复制关系"></a>3.确定复制关系</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> REPLICATE <span class="number">52</span>的<span class="number">6380</span>的ID</span><br><span class="line">redis-cli -h db02 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> REPLICATE <span class="number">53</span>的<span class="number">6380</span>的ID</span><br><span class="line">redis-cli -h db03 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> REPLICATE <span class="number">51</span>的<span class="number">6380</span>的ID</span><br></pre></td></tr></table></figure>

<h3 id="4-检查复制关系"><a href="#4-检查复制关系" class="headerlink" title="4.检查复制关系"></a>4.检查复制关系</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> NODES</span><br></pre></td></tr></table></figure>

<h2 id="10-集群插入数据"><a href="#10-集群插入数据" class="headerlink" title="10.集群插入数据"></a>10.集群插入数据</h2><h3 id="1-尝试插入一条数据发现报错"><a href="#1-尝试插入一条数据发现报错" class="headerlink" title="1.尝试插入一条数据发现报错"></a>1.尝试插入一条数据发现报错</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">k1</span> <span class="selector-tag">v1</span></span><br><span class="line">(<span class="selector-tag">error</span>) <span class="selector-tag">MOVED</span> 12706 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span><span class="selector-pseudo">:6380</span></span><br></pre></td></tr></table></figure>

<h3 id="2-目前的现象"><a href="#2-目前的现象" class="headerlink" title="2.目前的现象"></a>2.目前的现象</h3><p>在db01的6380节点插入数据提示报错<br>报错内容提示应该移动到db03的6380上<br>在db03的6380上执行相同的插入命令可以插入成功<br>在db01的6380节点插入数据有时候可以,有时候不行<br>使用-c参数后,可以正常插入命令,并且节点切换到了提示的对应节点上</p>
<h3 id="3-问题原因"><a href="#3-问题原因" class="headerlink" title="3.问题原因"></a>3.问题原因</h3><p>因为集群模式有ASK路由规则,加入-c参数后,会自动跳转到目标节点处理<br>并且最后由目标节点返回信息</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-328242f763d20b0b.png" alt="img"></p>
<h2 id="11-验证集群是否足够足迹足够平均"><a href="#11-验证集群是否足够足迹足够平均" class="headerlink" title="11.验证集群是否足够足迹足够平均"></a>11.验证集群是否足够足迹足够平均</h2><h3 id="0-写入测试数据"><a href="#0-写入测试数据" class="headerlink" title="0.写入测试数据"></a>0.写入测试数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10000&#125;;<span class="keyword">do</span> redis-cli -c -h db01 -p 6380 <span class="built_in">set</span> k_<span class="variable">$&#123;i&#125;</span> v_<span class="variable">$&#123;i&#125;</span>;<span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="1-验证足够平均"><a href="#1-验证足够平均" class="headerlink" title="1.验证足够平均:"></a>1.验证足够平均:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DBSIZE</span><br></pre></td></tr></table></figure>

<h3 id="2-验证足够随机："><a href="#2-验证足够随机：" class="headerlink" title="2.验证足够随机："></a>2.验证足够随机：</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -<span class="built_in">c</span> -h db03 -p <span class="number">6380</span> keys \* &gt; keys_all.txt</span><br><span class="line">cat keys_all.txt |awk -<span class="type">F</span> <span class="string">&quot;_&quot;</span> &#x27;&#123;<span class="built_in">print</span> $<span class="number">2</span>&#125;&#x27;|<span class="built_in">sort</span> -rn </span><br></pre></td></tr></table></figure>

<h3 id="3-允许节点的key在2-误差的依据来源："><a href="#3-允许节点的key在2-误差的依据来源：" class="headerlink" title="3.允许节点的key在2%误差的依据来源："></a>3.允许节点的key在2%误差的依据来源：</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@db01 /opt/redis/src]</span># <span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">rebalance</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6380</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Performing</span> <span class="selector-tag">Cluster</span> <span class="selector-tag">Check</span> (<span class="selector-tag">using</span> <span class="selector-tag">node</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380)</span></span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> <span class="selector-tag">nodes</span> <span class="selector-tag">agree</span> <span class="selector-tag">about</span> <span class="selector-tag">slots</span> <span class="selector-tag">configuration</span>.</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">for</span> <span class="selector-tag">open</span> <span class="selector-tag">slots</span>...</span><br><span class="line">&gt;&gt;&gt; <span class="selector-tag">Check</span> <span class="selector-tag">slots</span> <span class="selector-tag">coverage</span>...</span><br><span class="line"><span class="selector-attr">[OK]</span> <span class="selector-tag">All</span> 16384 <span class="selector-tag">slots</span> <span class="selector-tag">covered</span>.</span><br><span class="line">*** <span class="selector-tag">No</span> <span class="selector-tag">rebalancing</span> <span class="selector-tag">needed</span>! <span class="selector-tag">All</span> <span class="selector-tag">nodes</span> <span class="selector-tag">are</span> <span class="selector-tag">within</span> <span class="selector-tag">the</span> 2<span class="selector-class">.00</span>% <span class="selector-tag">threshold</span>.</span><br></pre></td></tr></table></figure>

<h3 id="4-检查集群健康状态："><a href="#4-检查集群健康状态：" class="headerlink" title="4.检查集群健康状态："></a>4.检查集群健康状态：</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 /opt/redis/src]<span class="comment"># redis-cli --cluster info 10.0.0.51 6380</span></span><br><span class="line"><span class="meta">10.0.0.51:6380 (ccaa5dcb...) -&gt;</span> <span class="number">3343</span> keys <span class="params">| 5461 slots |</span> <span class="number">1</span> slaves.</span><br><span class="line"><span class="meta">10.0.0.53:6380 (a69e46ea...) -&gt;</span> <span class="number">3343</span> keys <span class="params">| 5462 slots |</span> <span class="number">1</span> slaves.</span><br><span class="line"><span class="meta">10.0.0.52:6380 (b2719c41...) -&gt;</span> <span class="number">3314</span> keys <span class="params">| 5461 slots |</span> <span class="number">1</span> slaves.</span><br><span class="line">[OK] <span class="number">10000</span> keys <span class="keyword">in</span> <span class="number">3</span> masters.</span><br><span class="line"><span class="number">0</span>.<span class="number">61</span> keys per slot on average.</span><br></pre></td></tr></table></figure>

<h1 id="第17章-实战-槽位分配错误如何调整"><a href="#第17章-实战-槽位分配错误如何调整" class="headerlink" title="第17章 实战-槽位分配错误如何调整"></a>第17章 实战-槽位分配错误如何调整</h1><h2 id="1-故障背景"><a href="#1-故障背景" class="headerlink" title="1.故障背景"></a>1.故障背景</h2><p>某日某豪接到任务，需要部署redis集群结果不小心无脑复制粘贴，把所有的槽都分配给了1个节点，还没发现，然后就交付使用了，过了1天才发现问题。</p>
<p>而此时，已经有不少数据写入了，如何在不丢失数据的情况下解决这个问题？</p>
<h2 id="2-前提"><a href="#2-前提" class="headerlink" title="2.前提"></a>2.前提</h2><p>数据不能丢，最好不中断业务</p>
<h2 id="3-实验现象"><a href="#3-实验现象" class="headerlink" title="3.实验现象"></a>3.实验现象</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]<span class="comment"># redis-cli --cluster info 10.0.0.51 6380</span></span><br><span class="line"><span class="meta">10.0.0.51:6380 (ccaa5dcb...) -&gt;</span> <span class="number">1000</span> keys <span class="params">| 16384 slots |</span> <span class="number">3</span> slaves.</span><br><span class="line"><span class="meta">10.0.0.53:6380 (a69e46ea...) -&gt;</span> <span class="number">0</span> keys <span class="params">| 0 slots |</span> <span class="number">0</span> slaves.</span><br><span class="line"><span class="meta">10.0.0.52:6380 (b2719c41...) -&gt;</span> <span class="number">0</span> keys <span class="params">| 0 slots |</span> <span class="number">0</span> slaves.</span><br><span class="line">[OK] <span class="number">1000</span> keys <span class="keyword">in</span> <span class="number">3</span> masters.</span><br><span class="line"><span class="number">0</span>.<span class="number">06</span> keys per slot on average.</span><br></pre></td></tr></table></figure>

<h2 id="解决思路1：备份数据，重做集群，导入数据"><a href="#解决思路1：备份数据，重做集群，导入数据" class="headerlink" title="解决思路1：备份数据，重做集群，导入数据"></a>解决思路1：备份数据，重做集群，导入数据</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">来自json的灵魂发问：</span><br><span class="line">redis.cof的数据  集群重做后 aof文件里面的数据能被hash嘛?</span><br><span class="line"></span><br><span class="line">备份数据：</span><br><span class="line">redis-cli -c -h db01 -p <span class="number">6380</span></span><br><span class="line">db01:<span class="number">6380</span>&gt; BGREWRITEAOF</span><br><span class="line">cp redis.aof redis.aof<span class="number">-1000.</span>bak</span><br><span class="line"></span><br><span class="line">重做集群：</span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line"></span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line"></span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> MEET <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span> <span class="number">6380</span></span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> MEET <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span> <span class="number">6380</span></span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> NODES  </span><br><span class="line"></span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">0.</span><span class="number">.5460</span>&#125;</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">5461.</span><span class="number">.10921</span>&#125;</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> ADDSLOTS &#123;<span class="number">10922.</span><span class="number">.16383</span>&#125;</span><br><span class="line"></span><br><span class="line">redis-cli --cluster info <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> <span class="number">6380</span></span><br><span class="line"></span><br><span class="line">实验结论：</span><br><span class="line">重启后所有的数据还是在db01上。</span><br><span class="line">db01重启后数据虽然可以写入，但是访问的时候还是按照正常的hash规则去分配的，所以db01的数据实际上是没用的。</span><br><span class="line">所以这样的方法是不可行的。</span><br><span class="line"></span><br><span class="line">相关日志：</span><br><span class="line"><span class="number">16790</span>:M <span class="number">12</span> Mar <span class="number">2020</span> <span class="number">10</span>:<span class="number">08</span>:<span class="number">08.875</span> # I have keys <span class="keyword">for</span> slot <span class="number">5812</span>, but the slot is assigned to another node. Setting it to importing state.</span><br><span class="line"><span class="number">16790</span>:M <span class="number">12</span> Mar <span class="number">2020</span> <span class="number">10</span>:<span class="number">08</span>:<span class="number">08.875</span> # I have keys <span class="keyword">for</span> slot <span class="number">5821</span>, but the slot is assigned to another node. Setting it to importing state.</span><br><span class="line"><span class="number">16790</span>:M <span class="number">12</span> Mar <span class="number">2020</span> <span class="number">10</span>:<span class="number">08</span>:<span class="number">08.875</span> # I have keys <span class="keyword">for</span> slot <span class="number">5842</span>, but the slot is assigned to another node. Setting it to importing state.</span><br></pre></td></tr></table></figure>

<h2 id="解决思路2-获得所有key的名称，导出再导入"><a href="#解决思路2-获得所有key的名称，导出再导入" class="headerlink" title="解决思路2:获得所有key的名称，导出再导入"></a>解决思路2:获得所有key的名称，导出再导入</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0.重新制作一个测试集群，槽位分布和线上出错的一样</span><br><span class="line">1.将线上环境里的aof导出来</span><br><span class="line">2.恢复到测试的集群里</span><br><span class="line">3.收集所有的key</span><br><span class="line">redis-cli -c -h db01 -p 6380 keys \* &gt; keys_all.txt</span><br><span class="line">4.编写脚本遍历所有的key获取值</span><br><span class="line">cat &gt;get_key.sh&lt;&lt;EOF </span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> $(cat keys_all.txt)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  value=$(redis-cli -c -h 10.0.0.51 -p 6380 get <span class="variable">$&#123;key&#125;</span>)</span><br><span class="line">  <span class="built_in">echo</span> redis-cli -c -h 10.0.0.51 -p 6380 <span class="built_in">set</span> <span class="variable">$&#123;key&#125;</span> <span class="variable">$&#123;value&#125;</span> &gt;&gt; backup_all_key.txt</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">5.按照正常槽位分配去重新初始化集群</span><br><span class="line">redis-cli -h db01 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h db02 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h db03 -p 6380 FLUSHALL</span><br><span class="line">redis-cli -h db01 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h db02 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h db03 -p 6380 CLUSTER RESET</span><br><span class="line">redis-cli -h db01 -p 6380 CLUSTER MEET 10.0.0.52 6380</span><br><span class="line">redis-cli -h db01 -p 6380 CLUSTER MEET 10.0.0.53 6380</span><br><span class="line">redis-cli -h db01 -p 6380 CLUSTER NODES  </span><br><span class="line">redis-cli -h db01 -p 6380 CLUSTER ADDSLOTS &#123;0..5460&#125;</span><br><span class="line">redis-cli -h db02 -p 6380 CLUSTER ADDSLOTS &#123;5461..10921&#125;</span><br><span class="line">redis-cli -h db03 -p 6380 CLUSTER ADDSLOTS &#123;10922..16383&#125;</span><br><span class="line">redis-cli --cluster info 10.0.0.51 6380</span><br><span class="line"></span><br><span class="line">6.执行导入脚本</span><br><span class="line">bash backup_all_key.txt</span><br><span class="line"></span><br><span class="line">7.检查是否导入成功</span><br><span class="line">redis-cli --cluster info 10.0.0.51 6380</span><br><span class="line"></span><br><span class="line">8.测试环境没问题之后再去生产环境操作</span><br></pre></td></tr></table></figure>

<h2 id="解决思路3-流水线-pipline"><a href="#解决思路3-流水线-pipline" class="headerlink" title="解决思路3: 流水线 pipline"></a>解决思路3: 流水线 pipline</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">前提条件：</span><br><span class="line">1.了解<span class="selector-tag">aof</span>格式</span><br><span class="line">2.了解新版本<span class="selector-tag">redis</span>默认是开启混合模式的</span><br><span class="line">3.需要修改为普通的<span class="selector-tag">aof</span>格式并重启</span><br><span class="line">4.恢复时使用<span class="selector-tag">-c</span>参数无效，需要在每一个节点都执行</span><br><span class="line"></span><br><span class="line">命令：</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-c</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">--pipe</span> &lt; <span class="selector-tag">redis</span><span class="selector-class">.aof</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-c</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">--pipe</span> &lt; <span class="selector-tag">redis</span><span class="selector-class">.aof</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-c</span> <span class="selector-tag">-h</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">--pipe</span> &lt; <span class="selector-tag">redis</span><span class="selector-class">.aof</span></span><br></pre></td></tr></table></figure>

<h2 id="解决思路4-使用redis-cli工具重新分配槽位"><a href="#解决思路4-使用redis-cli工具重新分配槽位" class="headerlink" title="解决思路4: 使用redis-cli工具重新分配槽位"></a>解决思路4: 使用redis-cli工具重新分配槽位</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">重新分配槽位</span><br><span class="line">redis-cli --cluster reshard 10.0.0.51:6380</span><br><span class="line"></span><br><span class="line">第一次交互：输入迁出的槽的数量</span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (from 1 to 16384)? 5461</span><br><span class="line"></span><br><span class="line">第二次交互：输入接受的ID</span><br><span class="line">What is the receiving node ID? db02的6380的ID</span><br><span class="line"></span><br><span class="line">第三次交互：输入发送者的ID</span><br><span class="line">Please enter all the <span class="built_in">source</span> node IDs.</span><br><span class="line">  Type <span class="string">&#x27;all&#x27;</span> to use all the nodes as <span class="built_in">source</span> nodes <span class="keyword">for</span> the <span class="built_in">hash</span> slots.</span><br><span class="line">  Type <span class="string">&#x27;done&#x27;</span> once you entered all the <span class="built_in">source</span> nodes IDs.</span><br><span class="line">Source node <span class="comment">#1: db01的6390的ID</span></span><br><span class="line">Source node <span class="comment">#2: done</span></span><br><span class="line"></span><br><span class="line">第四次交互：YES!</span><br><span class="line"></span><br><span class="line">重复上面的操作，知道所有的节点槽位都分配正确</span><br></pre></td></tr></table></figure>

<h2 id="解决思路5-直接使用工具在线导入"><a href="#解决思路5-直接使用工具在线导入" class="headerlink" title="解决思路5:直接使用工具在线导入"></a>解决思路5:直接使用工具在线导入</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">import</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> <span class="selector-tag">--cluster-copy</span> <span class="selector-tag">--cluster-replace</span> <span class="selector-tag">--cluster-from</span>  10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6379</span> </span><br></pre></td></tr></table></figure>

<h1 id="第18章-使用工具自动部署redis集群"><a href="#第18章-使用工具自动部署redis集群" class="headerlink" title="第18章 使用工具自动部署redis集群"></a>第18章 使用工具自动部署redis集群</h1><h2 id="1-恢复集群初始化"><a href="#1-恢复集群初始化" class="headerlink" title="1.恢复集群初始化"></a>1.恢复集群初始化</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> FLUSHALL</span><br><span class="line">redis-cli -h db01 -p <span class="number">6381</span> FLUSHALL</span><br><span class="line">redis-cli -h db02 -p <span class="number">6381</span> FLUSHALL</span><br><span class="line">redis-cli -h db03 -p <span class="number">6381</span> FLUSHALL</span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db02 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db03 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db01 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db02 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db03 -p <span class="number">6381</span> <span class="built_in">CLUSTER</span> RESET</span><br><span class="line">redis-cli -h db01 -p <span class="number">6380</span> <span class="built_in">CLUSTER</span> NODES  </span><br></pre></td></tr></table></figure>

<h2 id="2-使用工具初始化"><a href="#2-使用工具初始化" class="headerlink" title="2.使用工具初始化"></a>2.使用工具初始化</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">create</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span><span class="selector-pseudo">:6380</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span><span class="selector-pseudo">:6380</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6381</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span><span class="selector-pseudo">:6381</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.53</span><span class="selector-pseudo">:6381</span> <span class="selector-tag">--cluster-replicas</span> 1</span><br></pre></td></tr></table></figure>

<h2 id="3-检查集群"><a href="#3-检查集群" class="headerlink" title="3.检查集群"></a>3.检查集群</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">info</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6380</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380 <span class="selector-tag">CLUSTER</span> <span class="selector-tag">NODES</span> </span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">check</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6380  </span><br></pre></td></tr></table></figure>

<h1 id="第19章-使用工具扩容"><a href="#第19章-使用工具扩容" class="headerlink" title="第19章 使用工具扩容"></a>第19章 使用工具扩容</h1><p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-e7e156608ed2c55c.png" alt="img"></p>
<h2 id="1-来自json的灵魂发问："><a href="#1-来自json的灵魂发问：" class="headerlink" title="1.来自json的灵魂发问："></a>1.来自json的灵魂发问：</h2><p>迁移时候槽的数据咋办？<br>需要停库吗？<br>访问受影响吗？<br>从库呢？</p>
<h2 id="2-如何设计实验验证数据是否受影响？"><a href="#2-如何设计实验验证数据是否受影响？" class="headerlink" title="2.如何设计实验验证数据是否受影响？"></a>2.如何设计实验验证数据是否受影响？</h2><p>迁移的过程中<br>一个窗口不断的写数据<br>一个窗口不断的读数据<br>观察是否会中断</p>
<h2 id="3-创建新节点"><a href="#3-创建新节点" class="headerlink" title="3.创建新节点"></a>3.创建新节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/redis_&#123;6390,6391&#125;/&#123;conf,logs,pid&#125;</span><br><span class="line">mkdir -p /data/redis_&#123;6390,6391&#125;</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">cp redis_6380/conf/redis_6380.conf redis_6390/conf/redis_6390.conf</span><br><span class="line">cp redis_6380/conf/redis_6380.conf redis_6391/conf/redis_6391.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#6380#6390#g&#x27;</span> redis_6390/conf/redis_6390.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#6380#6391#g&#x27;</span> redis_6391/conf/redis_6391.conf</span><br><span class="line">redis-server /opt/redis_6390/conf/redis_6390.conf</span><br><span class="line">redis-server /opt/redis_6391/conf/redis_6391.conf</span><br><span class="line">ps -ef|grep redis</span><br><span class="line">redis-cli -c -h db01 -p 6380 cluster meet 10.0.0.51 6390</span><br><span class="line">redis-cli -c -h db01 -p 6380 cluster meet 10.0.0.51 6391</span><br><span class="line">redis-cli -c -h db01 -p 6380 cluster nodes</span><br></pre></td></tr></table></figure>

<h2 id="4-使用工具扩容步骤"><a href="#4-使用工具扩容步骤" class="headerlink" title="4.使用工具扩容步骤"></a>4.使用工具扩容步骤</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">重新分配槽位</span><br><span class="line">redis-cli --cluster reshard <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">6380</span></span><br><span class="line"></span><br><span class="line">第一次交互：每个节点分配多少个槽位</span><br><span class="line"><span class="function">How many slots <span class="keyword">do</span> you want to <span class="title">move</span> (<span class="params"><span class="keyword">from</span> <span class="number">1</span> to <span class="number">16384</span></span>)? 4096</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第二次交互：接受节点的ID是什么</span></span><br><span class="line"><span class="function">What <span class="keyword">is</span> the receiving node ID? 6390的ID</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第三次交互：哪些节点需要导出</span></span><br><span class="line"><span class="function">Source node #1: all</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">第四次交互：确认是否执行</span></span><br><span class="line"><span class="function">Do you want to proceed with the proposed reshard <span class="title">plan</span> (<span class="params">yes/no</span>)? yes</span></span><br></pre></td></tr></table></figure>

<h1 id="第20章-使用工具缩容"><a href="#第20章-使用工具缩容" class="headerlink" title="第20章 使用工具缩容"></a>第20章 使用工具缩容</h1><p><img src="https://gitee.com/xoxoyun/img/raw/master/image/14248468-eea042bfbf7c3d19.png" alt="img"></p>
<h2 id="1-操作命令"><a href="#1-操作命令" class="headerlink" title="1.操作命令"></a>1.操作命令</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">重新分配槽位</span><br><span class="line">redis-cli --cluster reshard <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">6380</span></span><br><span class="line"></span><br><span class="line">第一次交互：需要迁移多少个槽位</span><br><span class="line">How many slots <span class="keyword">do</span> you want to move (<span class="keyword">from</span> <span class="number">1</span> to <span class="number">16384</span>)? <span class="number">1365</span></span><br><span class="line"></span><br><span class="line">第二次交互：接受节点的ID是什么</span><br><span class="line">What is the receiving node ID? db01的<span class="number">6380</span>的ID </span><br><span class="line"></span><br><span class="line">第三次交互：哪些节点需要导出</span><br><span class="line">Source node <span class="comment">#1: db01的6390的ID </span></span><br><span class="line">Source node <span class="comment">#2: done</span></span><br><span class="line"></span><br><span class="line">第四次交互：确认</span><br><span class="line"><span class="keyword">Do</span> you want to proceed with the proposed reshard plan (yes/no)? yes</span><br><span class="line"></span><br><span class="line">重复上面的操作，直到<span class="number">6390</span>所有的槽位都被分配出去了</span><br><span class="line"></span><br><span class="line">检查集群状态，确认<span class="number">6390</span>没有槽位了</span><br><span class="line">redis-cli --cluster info <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">6380</span></span><br><span class="line"></span><br><span class="line">使用工具删除节点了</span><br><span class="line">redis-cli --cluster del-node <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">6390</span> <span class="number">6390</span>的ID</span><br><span class="line">redis-cli --cluster del-node <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">6391</span> <span class="number">6391</span>的ID</span><br></pre></td></tr></table></figure>

<h2 id="2-提问：公司先用的是哨兵然后在改集群-如何迁移数据"><a href="#2-提问：公司先用的是哨兵然后在改集群-如何迁移数据" class="headerlink" title="2.提问：公司先用的是哨兵然后在改集群 如何迁移数据"></a>2.提问：公司先用的是哨兵然后在改集群 如何迁移数据</h2><p>用槽位分配解决方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.搭建好Redis集群并互相发现</span><br><span class="line">2.把所有的key都分配到db01上</span><br><span class="line">3.把哨兵里的数据AOF持久化</span><br><span class="line">4.拷贝到db01上，启动集群节点</span><br><span class="line">5.重新分配槽位迁移到其他2个节点</span><br></pre></td></tr></table></figure>

<h1 id="第21章-验证集群高可用"><a href="#第21章-验证集群高可用" class="headerlink" title="第21章 .验证集群高可用"></a>第21章 .验证集群高可用</h1><h2 id="1-提问：故障的主库修复后启动会变成备胎吗？"><a href="#1-提问：故障的主库修复后启动会变成备胎吗？" class="headerlink" title="1.提问：故障的主库修复后启动会变成备胎吗？"></a>1.提问：故障的主库修复后启动会变成备胎吗？</h2><h2 id="2-实验结论："><a href="#2-实验结论：" class="headerlink" title="2.实验结论："></a>2.实验结论：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.主库挂了，从库会自动接替主库的角色，集群恢复正常会受超时时间控制</span><br><span class="line">2.老得主库修复上线后，会自动变成从库，同步新的主库</span><br></pre></td></tr></table></figure>

<h2 id="3-主动发起集群角色切换："><a href="#3-主动发起集群角色切换：" class="headerlink" title="3.主动发起集群角色切换："></a>3.主动发起集群角色切换：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CLUSTER</span> FAILOVER</span><br></pre></td></tr></table></figure>

<h1 id="第22章-模拟分配时故障"><a href="#第22章-模拟分配时故障" class="headerlink" title="第22章 模拟分配时故障"></a>第22章 模拟分配时故障</h1><h2 id="1-模拟场景：迁移数据时人为中断了，导致槽的状态不对"><a href="#1-模拟场景：迁移数据时人为中断了，导致槽的状态不对" class="headerlink" title="1.模拟场景：迁移数据时人为中断了，导致槽的状态不对"></a>1.模拟场景：迁移数据时人为中断了，导致槽的状态不对</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">11213</span>-&lt;-a69e46ea7560684a7061ddb6dc3f854a1ef3dbd4] <span class="number">51</span></span><br><span class="line">[<span class="number">11213</span>-&gt;-ccaa5dcb0f0320332100594d629122b2702660d5] <span class="number">53</span></span><br></pre></td></tr></table></figure>

<h2 id="2-使用工具修复："><a href="#2-使用工具修复：" class="headerlink" title="2.使用工具修复："></a>2.使用工具修复：</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">fix</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span></span><br></pre></td></tr></table></figure>

<h2 id="3-手动修复："><a href="#3-手动修复：" class="headerlink" title="3.手动修复："></a>3.手动修复：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CLUSTER</span> SETSLOT &lt;slot&gt; STABLE</span><br></pre></td></tr></table></figure>

<h1 id="第23章-使用工具维护集群的好处"><a href="#第23章-使用工具维护集群的好处" class="headerlink" title="第23章 使用工具维护集群的好处"></a>第23章 使用工具维护集群的好处</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">工具有很多判断条件，更加严谨，健壮性更好</span><br><span class="line">删除槽，使用工具会判断，如果槽里有数据，就不执行</span><br><span class="line">添加节点使用工具会判断，如果新增加的节点本身不为空，不允许加入到集群里</span><br><span class="line">删除节点使用工具会判断，如果本删除节点本身还有槽，不允许删除</span><br></pre></td></tr></table></figure>

<h1 id="第24章-数据迁移"><a href="#第24章-数据迁移" class="headerlink" title="第24章 数据迁移"></a>第24章 数据迁移</h1><h2 id="1-新版本直接使用工具迁移"><a href="#1-新版本直接使用工具迁移" class="headerlink" title="1.新版本直接使用工具迁移"></a>1.新版本直接使用工具迁移</h2><p>不加copy参数相当于mv，老数据迁移成功就删掉了</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">import</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> <span class="selector-tag">--cluster-from</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6379</span></span><br></pre></td></tr></table></figure>

<p>添加copy参数相当于cp,老数据迁移成功后会保留</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">import</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> <span class="selector-tag">--cluster-copy</span> <span class="selector-tag">--cluster-from</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6379</span> </span><br></pre></td></tr></table></figure>

<p>添加replace参数会覆盖掉同名的数据，对新集群新增加的数据不受影响</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">import</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> <span class="selector-tag">--cluster-copy</span> <span class="selector-tag">--cluster-replace</span> <span class="selector-tag">--cluster-from</span>  10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6379</span> </span><br></pre></td></tr></table></figure>

<p>验证迁移期间边写边导会不会影响: 同时开2个终端，一个写入key，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1000&#125;;<span class="keyword">do</span> redis-cli <span class="built_in">set</span> k_<span class="variable">$&#123;i&#125;</span> v_<span class="variable">$&#123;i&#125;</span>;sleep 0.2;<span class="built_in">echo</span> <span class="variable">$&#123;i&#125;</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>一个执行导入命令</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">import</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span> <span class="selector-tag">--cluster-copy</span> <span class="selector-tag">--cluster-replace</span> <span class="selector-tag">--cluster-from</span>  10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6379</span> </span><br></pre></td></tr></table></figure>

<p>得出结论：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">只会导入当你执行导入命令那一刻时，当前被导入节点的所有数据，类似于快照，对于后面再写入的数据不会更新</span><br></pre></td></tr></table></figure>

<h1 id="第25章-分析key的大小"><a href="#第25章-分析key的大小" class="headerlink" title="第25章 分析key的大小"></a>第25章 分析key的大小</h1><h2 id="0-使用自带工具分析"><a href="#0-使用自带工具分析" class="headerlink" title="0.使用自带工具分析"></a>0.使用自带工具分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --bigkeys </span><br></pre></td></tr></table></figure>

<h2 id="1-使用第三方工具分析"><a href="#1-使用第三方工具分析" class="headerlink" title="1.使用第三方工具分析"></a>1.使用第三方工具分析</h2><h3 id="1-安装命令"><a href="#1-安装命令" class="headerlink" title="1.安装命令"></a>1.安装命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install python-pip gcc python-devel -y</span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/sripathikrishnan/redis-rdb-tools</span><br><span class="line"><span class="built_in">cd</span> redis-rdb-tools</span><br><span class="line">pip install python-lzf</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>

<h3 id="2-生成测试数据"><a href="#2-生成测试数据" class="headerlink" title="2.生成测试数据"></a>2.生成测试数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p 6379 set txt $(cat txt.txt)</span><br></pre></td></tr></table></figure>

<h3 id="3-执行bgsave生成rdb文件"><a href="#3-执行bgsave生成rdb文件" class="headerlink" title="3.执行bgsave生成rdb文件"></a>3.执行bgsave生成rdb文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h db01 -p 6379 BGSAVE</span><br></pre></td></tr></table></figure>

<h3 id="4-使用工具分析"><a href="#4-使用工具分析" class="headerlink" title="4.使用工具分析"></a>4.使用工具分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/redis_6379/</span><br><span class="line">rdb -c memory redis_6379.rdb -f redis_6379.rdb.csv</span><br></pre></td></tr></table></figure>

<h3 id="5-过滤分析"><a href="#5-过滤分析" class="headerlink" title="5.过滤分析"></a>5.过滤分析</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&quot;,&quot;</span> <span class="string">&#x27;&#123;print <span class="subst">$4</span>,<span class="subst">$3</span>&#125;&#x27;</span> redis_6379.rdb.csv |sort -r</span><br></pre></td></tr></table></figure>

<h3 id="6-汇报领导"><a href="#6-汇报领导" class="headerlink" title="6.汇报领导"></a>6.汇报领导</h3><p>将结果整理汇报给领导,询问开发这个key是否可以删除</p>
<h1 id="第26章-redis的内存管理"><a href="#第26章-redis的内存管理" class="headerlink" title="第26章 redis的内存管理"></a>第26章 redis的内存管理</h1><h2 id="1-设置最大内存限制"><a href="#1-设置最大内存限制" class="headerlink" title="1.设置最大内存限制"></a>1.设置最大内存限制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> maxmemory 2G</span><br></pre></td></tr></table></figure>

<h2 id="2-内存回收机制"><a href="#2-内存回收机制" class="headerlink" title="2.内存回收机制"></a>2.内存回收机制</h2><p>生产上一定要限制redis的内存使用大小。</p>
<p>当达到内存使用限制之后redis会出发对应的控制策略</p>
<p>redis支持6种策略：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1<span class="selector-class">.noevicition</span>       默认策略，不会删除任务数据，拒绝所有写入操作并返回客户端错误信息，此时只响应读操作</span><br><span class="line">2<span class="selector-class">.volatile-lru</span>      根据<span class="selector-tag">LRU</span>算法删除设置了超时属性的<span class="selector-tag">key</span>，指导腾出足够空间为止，如果没有可删除的<span class="selector-tag">key</span>，则退回到<span class="selector-tag">noevicition</span>策略</span><br><span class="line">3<span class="selector-class">.allkeys-lru</span>       根据<span class="selector-tag">LRU</span>算法删除<span class="selector-tag">key</span>，不管数据有没有设置超时属性</span><br><span class="line">4<span class="selector-class">.allkeys-random</span>    随机删除所有<span class="selector-tag">key</span></span><br><span class="line">5<span class="selector-class">.volatile-random</span>   随机删除过期<span class="selector-tag">key</span></span><br><span class="line">5<span class="selector-class">.volatile-ttl</span>      根据<span class="selector-tag">key</span>的<span class="selector-tag">ttl</span>，删除最近要过期的<span class="selector-tag">key</span></span><br></pre></td></tr></table></figure>

<h2 id="3-生产上redis限制多大内存"><a href="#3-生产上redis限制多大内存" class="headerlink" title="3.生产上redis限制多大内存"></a>3.生产上redis限制多大内存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">先空出来系统一半内存</span><br><span class="line">48G 一共 </span><br><span class="line">24G 系统</span><br><span class="line">24G redis </span><br><span class="line">redis先给8G内存 满了之后，分析结果告诉老大和开发，让他们排查一下是否所有的key都是必须的</span><br><span class="line">redis再给到12G内存 满了之后，分析结果告诉老大和开发，让他们排查一下是否所有的key都是必须的</span><br><span class="line">redis再给到16G内存 满了之后，分析结果告诉老大和开发，让他们排查一下是否所有的key都是必须的</span><br><span class="line">等到24G都用完了之后，汇报领导，要考虑买内存了。</span><br><span class="line">等到35G的时候，就要考虑是加内存，还是扩容机器。</span><br></pre></td></tr></table></figure>

<h1 id="第27章-性能测试"><a href="#第27章-性能测试" class="headerlink" title="第27章 性能测试"></a>第27章 性能测试</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark -n 10000  -q</span><br></pre></td></tr></table></figure>

<h1 id="第28章-集群相关命令"><a href="#第28章-集群相关命令" class="headerlink" title="第28章 集群相关命令"></a>第28章 集群相关命令</h1><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">-h</span> <span class="selector-tag">db01</span> <span class="selector-tag">-p</span> 6380</span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">NODES</span>    </span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">MEET</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.52</span> 6380</span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">INFO</span></span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">REPLICATE</span></span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">ADDSLOTS</span></span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">RESET</span></span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">FAILOVER</span></span><br><span class="line"><span class="selector-tag">CLUSTER</span> <span class="selector-tag">SETSLOT</span> &lt;<span class="selector-tag">slot</span>&gt; <span class="selector-tag">STABLE</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">info</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6380</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">rebalance</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span> 6380</span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">del-node</span></span><br><span class="line"><span class="selector-tag">redis-cli</span> <span class="selector-tag">--cluster</span> <span class="selector-tag">fix</span> 10<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.51</span><span class="selector-pseudo">:6380</span></span><br></pre></td></tr></table></figure>

<h1 id="第29章-命令总结"><a href="#第29章-命令总结" class="headerlink" title="第29章 命令总结"></a>第29章 命令总结</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>全局命令</span><br><span class="line">keys *                </span><br><span class="line">DBSIZE                </span><br><span class="line">EXISTS k1         </span><br><span class="line">EXPIRE k1 <span class="number">10</span>      </span><br><span class="line">TTL k1            </span><br><span class="line">DEL k1                </span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>字符串:</span><br><span class="line"><span class="keyword">set</span> k1 v1</span><br><span class="line"><span class="keyword">get</span> k1</span><br><span class="line"></span><br><span class="line">mset k1 v1 k2 v2 k3 v3 </span><br><span class="line">mget k1 k2 k3 </span><br><span class="line"></span><br><span class="line">incr k1 </span><br><span class="line">incrby k1 N </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>列表：</span><br><span class="line">LPUSH</span><br><span class="line">RPUSH</span><br><span class="line">LPOP</span><br><span class="line">RPOP</span><br><span class="line"></span><br><span class="line">LLEN</span><br><span class="line">LRANGE list1 <span class="number">0</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">HASH:</span><br><span class="line">HMSET </span><br><span class="line">HGET</span><br><span class="line">HMGET</span><br><span class="line">HGETALL</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>集合：</span><br><span class="line">SADD </span><br><span class="line">SDIFF</span><br><span class="line">SINTER</span><br><span class="line">SUNION</span><br><span class="line">SREM</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>有序集合：</span><br><span class="line">ZADD</span><br><span class="line">ZCARD</span><br><span class="line">ZSCORE</span><br><span class="line">ZRANK</span><br><span class="line">ZREVRANK</span><br><span class="line">ZRANGE</span><br><span class="line">ZRANGEBYSCORE</span><br><span class="line">ZINCRBY</span><br><span class="line">ZCOUNT</span><br></pre></td></tr></table></figure>

<p>转自：简书张导<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/9622d5906bcf">https://www.jianshu.com/p/9622d5906bcf</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/nb/38272646">老男孩-NoSQL</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Thaons</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kococ.cn/posts/24624/">https://kococ.cn/posts/24624/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kococ.cn" target="_blank">北青永恒</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis5-0/">Redis5.0</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/xoxoyun/img/raw/master/image/0016.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/24909/"><img class="next-cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0015.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">linux中利用curl命令批量检查连接的状态和文件的MD5值比对</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By Thaons</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">既来之 则安之</div><div class="icp"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="https://gitee.com/xoxoyun/img/raw/master/image/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="964294791" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="true" data-order="random" data-preload="none" data-autoplay="true" muted></div><script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('setup',{'key':'BIF1XgHYU5uifiTn-nijbfi-j2pofrfj7Aws6myNxi04-3ZwnuLbOAvV65krmTdyRmzx7KWMmiMRB-AJ10FTlEs', 'integration':'popup'  });</script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

})</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div><script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BIF1XgHYU5uifiTn-nijbfi-j2pofrfj7Aws6myNxi04-3ZwnuLbOAvV65krmTdyRmzx7KWMmiMRB-AJ10FTlEs');</script></body></html>