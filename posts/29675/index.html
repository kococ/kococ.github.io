<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>二进制安装kubernetes落地实践 | 北青永恒</title><meta name="keywords" content="kubernetes"><meta name="author" content="Thaons"><meta name="copyright" content="Thaons"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="二进制安装kubernetes（一） 环境准备及etcd组件安装及etcd管理软件etcdkeeper安装 实验环境：  架构图：    主机环境：  操作系统：因docker对内核需要，本次部署操作系统全部采用centos7.6(需要内核3.8以上)  VM ：2C 2G 50G * 5 PS:因后面实验需要向k8s交付java服务，所以运算节点直接4c8g，如果不交付服务，全部2c2g即可。">
<meta property="og:type" content="article">
<meta property="og:title" content="二进制安装kubernetes落地实践">
<meta property="og:url" content="https://kococ.cn/posts/29675/index.html">
<meta property="og:site_name" content="北青永恒">
<meta property="og:description" content="二进制安装kubernetes（一） 环境准备及etcd组件安装及etcd管理软件etcdkeeper安装 实验环境：  架构图：    主机环境：  操作系统：因docker对内核需要，本次部署操作系统全部采用centos7.6(需要内核3.8以上)  VM ：2C 2G 50G * 5 PS:因后面实验需要向k8s交付java服务，所以运算节点直接4c8g，如果不交付服务，全部2c2g即可。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg">
<meta property="article:published_time" content="2020-10-20T09:19:53.000Z">
<meta property="article:modified_time" content="2020-11-18T02:17:50.459Z">
<meta property="article:author" content="Thaons">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="https://kococ.cn/posts/29675/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.0.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-11-18 10:17:50'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><link rel="stylesheet" href="/css/footer.css"><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xoxoyun/img/raw/master/image/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">85</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://video.kococ.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E4%B8%80%EF%BC%89-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E5%8F%8Aetcd%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85%E5%8F%8Aetcd%E7%AE%A1%E7%90%86%E8%BD%AF%E4%BB%B6etcdkeeper%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">二进制安装kubernetes（一） 环境准备及etcd组件安装及etcd管理软件etcdkeeper安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDetcd-%E5%9C%A8etcd%E8%8A%82%E7%82%B9%E9%80%89%E4%B8%80%E5%8F%B0"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">下载etcd,在etcd节点选一台</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E6%96%87%E4%BB%B6"><span class="toc-number">1.0.0.1.1.</span> <span class="toc-text">编写一个服务文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%8E%A7%E5%88%B6"><span class="toc-number">1.0.0.1.2.</span> <span class="toc-text">服务的控制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%AE%89%E5%85%A8"><span class="toc-number">1.0.0.1.3.</span> <span class="toc-text">访问安全</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.0.0.1.4.</span> <span class="toc-text">遗留的问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">测试访问</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E4%BA%8C%EF%BC%89-kube-apiserver%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">二进制安装kubernetes（二） kube-apiserver组件安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E4%B8%89%EF%BC%89-kube-controller-manager%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">二进制安装kubernetes（三） kube-controller-manager组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-Manager%E7%AE%80%E4%BB%8B"><span class="toc-number">3.0.1.</span> <span class="toc-text">Controller Manager简介</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E5%9B%9B%EF%BC%89-kube-scheduler%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text">二进制安装kubernetes（四） kube-scheduler组件安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E4%BA%94%EF%BC%89-kubelet%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">5.</span> <span class="toc-text">二进制安装kubernetes（五） kubelet组件安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E5%85%AD%EF%BC%89-kube-proxy%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-number">6.</span> <span class="toc-text">二进制安装kubernetes（六） kube-proxy组件安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85kubernetes%EF%BC%88%E4%B8%83%EF%BC%89-%E9%83%A8%E7%BD%B2%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">二进制安装kubernetes（七） 部署知识点总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E4%B8%80%EF%BC%89-kubectl%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.</span> <span class="toc-text">kubernetes进阶（一） kubectl工具使用详解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E4%BA%8C%EF%BC%89%E6%A0%B8%E5%BF%83%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6Flannel"><span class="toc-number">9.</span> <span class="toc-text">kubernetes进阶（二）核心网络插件Flannel</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E4%B8%89%EF%BC%89%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-coredns"><span class="toc-number">10.</span> <span class="toc-text">kubernetes进阶（三）服务发现-coredns</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E5%9B%9B%EF%BC%89%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2-ingress%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B9%8Btraefik"><span class="toc-number">11.</span> <span class="toc-text">kubernetes进阶（四）服务暴露-ingress控制器之traefik</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E4%BA%94%EF%BC%89dashboard%E2%80%93WEB%E7%AE%A1%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text">kubernetes进阶（五）dashboard–WEB管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E8%BF%9B%E9%98%B6%EF%BC%88%E5%85%AD%EF%BC%89k8s%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7"><span class="toc-number">13.</span> <span class="toc-text">kubernetes进阶（六）k8s平滑升级</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E4%B8%80%EF%BC%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">14.</span> <span class="toc-text">kubernetes实战-交付dubbo服务到k8s集群（一）准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E4%BA%8C%EF%BC%89%E4%BA%A4%E4%BB%98jenkins%E5%88%B0k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">15.</span> <span class="toc-text">Kubernetes实战-交付dubbo服务到k8s集群（二）交付jenkins到k8s集群</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E4%B8%89%EF%BC%89%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEmaven%E5%92%8Cjava%E8%BF%90%E8%A1%8C%E6%97%B6%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BA%95%E5%8C%85%E9%95%9C%E5%83%8F"><span class="toc-number">16.</span> <span class="toc-text">kubernetes实战-交付dubbo服务到k8s集群（三）安装配置maven和java运行时环境的底包镜像</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BD%BF%E7%94%A8blue-ocean%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%9E%84%E5%BB%BAdubbo-demo-service"><span class="toc-number">17.</span> <span class="toc-text">kubernetes实战-交付dubbo服务到k8s集群（四）使用blue ocean流水线构建dubbo-demo-service</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E4%BA%94%EF%BC%89%E4%BA%A4%E4%BB%98dubbo-monitor%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E5%88%B0k8s"><span class="toc-number">18.</span> <span class="toc-text">kubernetes实战-交付dubbo服务到k8s集群（五）交付dubbo-monitor监控服务到k8s</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E4%BA%A4%E4%BB%98dubbo%E6%9C%8D%E5%8A%A1%E5%88%B0k8s%E9%9B%86%E7%BE%A4%EF%BC%88%E5%85%AD%EF%BC%89%E4%BD%BF%E7%94%A8blue-ocean%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%9E%84%E5%BB%BAdubbo-consumer%E6%9C%8D%E5%8A%A1"><span class="toc-number">19.</span> <span class="toc-text">kubernetes实战-交付dubbo服务到k8s集群（六）使用blue ocean流水线构建dubbo-consumer服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%88%E4%B8%80%EF%BC%89configmap%E8%B5%84%E6%BA%90"><span class="toc-number">20.</span> <span class="toc-text">kubernetes实战-配置中心（一）configmap资源</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%88%E4%BA%8C%EF%BC%89%E4%BA%A4%E4%BB%98apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%88%B0k8s"><span class="toc-number">21.</span> <span class="toc-text">kubernetes实战-配置中心（二）交付apollo配置中心到k8s</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E5%AE%9E%E6%88%98-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%88%E4%B8%89%EF%BC%89%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">22.</span> <span class="toc-text">kubernetes实战-配置中心（三）配置服务使用apollo配置中心</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E7%94%9F%E6%80%81%E2%80%93%E4%BA%A4%E4%BB%98prometheus%E7%9B%91%E6%8E%A7%E5%8F%8Agrafana%E7%82%AB%E9%85%B7dashboard%E5%88%B0k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">23.</span> <span class="toc-text">kubernetes生态–交付prometheus监控及grafana炫酷dashboard到k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPrometheus"><span class="toc-number">23.1.</span> <span class="toc-text">什么是Prometheus?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">23.2.</span> <span class="toc-text">Prometheus的特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-number">23.3.</span> <span class="toc-text">基本原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">23.4.</span> <span class="toc-text">服务过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%A4%A7%E5%A5%97%E4%BB%B6"><span class="toc-number">23.5.</span> <span class="toc-text">三大套件</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">北青永恒</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="https://music.kococ.cn"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" target="_blank" rel="noopener external nofollow noreferrer" href="http://video.kococ.cn"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">二进制安装kubernetes落地实践</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-20T09:19:53.000Z" title="发表于 2020-10-20 17:19:53">2020-10-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-18T02:17:50.459Z" title="更新于 2020-11-18 10:17:50">2020-11-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Devops/">Devops</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">31k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>154分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="二进制安装kubernetes（一）-环境准备及etcd组件安装及etcd管理软件etcdkeeper安装"><a href="#二进制安装kubernetes（一）-环境准备及etcd组件安装及etcd管理软件etcdkeeper安装" class="headerlink" title="二进制安装kubernetes（一） 环境准备及etcd组件安装及etcd管理软件etcdkeeper安装"></a>二进制安装kubernetes（一） 环境准备及etcd组件安装及etcd管理软件etcdkeeper安装</h1><p>实验环境：</p>
<p>架构图：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111143911357-804943981.png" alt="img"></p>
<p>主机环境：</p>
<p>操作系统：因docker对内核需要，本次部署操作系统全部采用centos7.6(需要内核3.8以上)</p>
<p>VM ：2C 2G 50G * 5 PS:因后面实验需要向k8s交付java服务，所以运算节点直接4c8g，如果不交付服务，全部2c2g即可。</p>
<p>IP及服务规划：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111151053586-610713573.png" alt="img"></p>
<p> 安装步骤：</p>
<p>所有机器上安装epel源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#yum -y install epel-release</span><br></pre></td></tr></table></figure>

<p>关闭防火墙以及selinux：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># systemctl stop firewalld</span><br><span class="line"># systemctl disable firewalld</span><br><span class="line">#setenforce 1</span><br><span class="line">vi &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">SELINUX&#x3D;disabled </span><br></pre></td></tr></table></figure>



<p>hdss7-11上安装bind9：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#yum -y install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y</span><br><span class="line">#yum install bind -y</span><br></pre></td></tr></table></figure>

<p>配置bind：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#vi &#x2F;etc&#x2F;named.conf</span><br></pre></td></tr></table></figure>

<p>修改以下配置项：</p>
<p>注意此服务对配置文件格式要求比较严格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen-on port 53 &#123; 127.0.0.1; &#125;; ----&gt; listen-on port 53 &#123; 10.4.7.11; &#125;; #将127.0.0.1修改为当前主机IP</span><br><span class="line">allow-query     &#123; localhost; &#125;; ----&gt; allow-query &#123; any; &#125;; #为哪些服务器提供解析服务</span><br><span class="line">dnssec-enable yes; ----&gt; dnssec-enable no; # 是否支持DNSSEC开关 PS：dnssec作用：1.为DNS数据提供来源验证 2.为数据提供完整性性验证 3.为查询提供否定存在验证</span><br><span class="line">dnssec-validation yes; ----&gt; dnssec-validation no; #是否进行DNSSEC确认开关</span><br></pre></td></tr></table></figure>

<p>添加以下配置项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forwarders      &#123; 10.4.7.1; &#125;; #用来指定上一层DNS地址，一般指定网关，确保服务能够访问公网</span><br></pre></td></tr></table></figure>

<p>如果不适用IPV6，可以将以下配置删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen-on-v6 port 53 &#123; ::1; &#125;;</span><br></pre></td></tr></table></figure>

<p>配置文件截图：（仅粘贴修改部分）</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111160549170-421438496.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111160352520-1184501218.png" alt="img"></p>
<p>检查配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#named-checkconf</span><br></pre></td></tr></table></figure>

<p>修改zons文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#vi &#x2F;etc&#x2F;named.rfc1912.zones</span><br></pre></td></tr></table></figure>

<p>在文件最后，添加本次需要用到的两个dns域：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;kococ.cn&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;kococ.cn.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>编辑刚刚添加的两个域的配置文件：将用到的DNS域解析A记录添加到配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;host.com.zone</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 600    ; 10 minutes</span><br><span class="line">@       IN SOA    dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                2019111001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">            NS   dns.host.com.</span><br><span class="line">$TTL 60    ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">HDSS7-11           A    10.4.7.11</span><br><span class="line">HDSS7-12           A    10.4.7.12</span><br><span class="line">HDSS7-21           A    10.4.7.21</span><br><span class="line">HDSS7-22           A    10.4.7.22</span><br><span class="line">HDSS7-200          A    10.4.7.200</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN kococ.cn.</span><br><span class="line">$TTL 600    ; 10 minutes</span><br><span class="line">@           IN SOA    dns.kococ.cn. dnsadmin.kococ.cn. (</span><br><span class="line">                2019111001 ; serial</span><br><span class="line">                10800      ; refresh (3 hours)</span><br><span class="line">                900        ; retry (15 minutes)</span><br><span class="line">                604800     ; expire (1 week)</span><br><span class="line">                86400      ; minimum (1 day)</span><br><span class="line">                )</span><br><span class="line">                NS   dns.kococ.cn.</span><br><span class="line">$TTL 60    ; 1 minute</span><br><span class="line">dns                A    10.4.7.11harbor             A    10.4.7.200</span><br></pre></td></tr></table></figure>



<p>修改主机dns：将nameserver 修改为bind9搭建的服务器地址（所有主机都要修改）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;resolv.conf</span><br><span class="line">search host.com</span><br><span class="line">nameserver 10.4.7.11</span><br></pre></td></tr></table></figure>

<p>修改网卡配置：PS：如果网卡指定了DNS1配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0</span><br><span class="line">DNS1&#x3D;10.4.7.11</span><br></pre></td></tr></table></figure>

<p>重启网卡(所有主机)，重启named服务(bind主机)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#systemctl restart network</span><br><span class="line"># systemctl enable named  #10.4.7.11上执行</span><br><span class="line"># systemctl restart named   #10.4.7.11上执行</span><br></pre></td></tr></table></figure>

<p>验证是否可以访问公网，以及是否是走的我们自己搭建的dns服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#nslookup www.baidu.com</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111163932833-1936947965.png" alt="img"></p>
<p> PS：如果虚拟机vm的宿主机在自己的windows或者mac上，将宿主机的dns指向10.4.7.11，方便一会使用浏览器验证内容</p>
<p>配置CA证书服务：</p>
<p>使用cfssl</p>
<p>在主机hdss7-200上操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;usr&#x2F;bin</span><br><span class="line"># wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl</span><br><span class="line"># wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssljson_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-json</span><br><span class="line"># wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl-certinfo_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-certinfo</span><br></pre></td></tr></table></figure>

<p>给执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;usr&#x2F;bin&#x2F;cfssl*</span><br></pre></td></tr></table></figure>

<p>创建证书存放位置(可自己设置)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;opt&#x2F;certs</span><br><span class="line"># cd &#x2F;opt&#x2F;certs</span><br></pre></td></tr></table></figure>

<p>创建证书申请文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;certs&#x2F;ca-csr.json</span><br></pre></td></tr></table></figure>

<p>文件内容：#这里注意”expiry”: “175200h”，key，如果使用kubeadmin安装，默认证书有效期是1年，我们这里手动部署为20年，这里如果证书失效，会导致整个k8s集群瘫痪。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;OldboyEdu&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>申请证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br></pre></td></tr></table></figure>

<p>申请成功：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191111174928113-1795492364.png" alt="img"></p>
<p>PS:我们后面的所有证书，都是基于这套ca证书签发的。</p>
<p>接下来继续在hdss7-21,hdss7-22,hdss-7-200服务器上安装docker，配置私有仓库harbor(hdss7-200)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># curl -fsSL https:&#x2F;&#x2F;get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure>

<p>编辑docker配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;etc&#x2F;docker</span><br><span class="line"># mkdir &#x2F;data&#x2F;docker</span><br><span class="line"># vi &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;&#x2F;data&#x2F;docker&quot;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.kococ.cn&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;q2gr04ke.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1&#x2F;24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动docker并添加开机启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start docker</span><br><span class="line"># systemctl enable docker</span><br></pre></td></tr></table></figure>

<p>在opt下创建安装包存放目录：hdss7-200上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;opt&#x2F;src</span><br><span class="line"># cd &#x2F;opt&#x2F;src</span><br></pre></td></tr></table></figure>

<p>下面开始安装harbor私有仓库：</p>
<p>下载地址:</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/goharbor/harbor/releases/tag/">https://github.com/goharbor/harbor/releases/tag/</a></p>
<p>我这里使用的是最新版本：1.9.2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;goharbor&#x2F;harbor&#x2F;releases&#x2F;download&#x2F;v1.9.2&#x2F;harbor-offline-installer-v1.9.2.tgz</span><br><span class="line"># tar -zxf harbor-offline-installer-v1.9.2.tgz -C &#x2F;opt&#x2F;</span><br><span class="line"># cd &#x2F;opt&#x2F;</span><br><span class="line"># mv harbor harbor-1.9.2</span><br><span class="line"># ln -s &#x2F;opt&#x2F;harbor-1.9.2 &#x2F;opt&#x2F;harbor  #方便版本管理</span><br></pre></td></tr></table></figure>



<p>编辑harbor配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;opt&#x2F;harbor&#x2F;harbor.yml</span><br></pre></td></tr></table></figure>

<p> 修改成如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostname: harbor.kococ.cn #这里添加的是我们开始在hdss7-11的自建dns上添加的域名解析</span><br><span class="line">port: 180 #避免和nginx端口冲突</span><br><span class="line">data_volume: &#x2F;data&#x2F;harbor</span><br><span class="line">location: &#x2F;data&#x2F;harbor&#x2F;logs</span><br><span class="line">external_url: http:&#x2F;&#x2F;harbor.kococ.cn:80</span><br></pre></td></tr></table></figure>



<p>创建数据目录和日志目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;harbor&#x2F;logs</span><br></pre></td></tr></table></figure>

<p>接下来安装docker-compose：</p>
<p>docker-compose介绍：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://links.jianshu.com/go?to=https://github.com/docker/compose">Docker Compose</a>是 docker 提供的一个命令行工具，用来定义和运行由多个容器组成的应用。使用 compose，我们可以通过 YAML 文件声明式的定义应用程序的各个服务，并由单个命令完成应用的创建和启动。</p>
<p>简书链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/ca1623ac7723">https://www.jianshu.com/p/ca1623ac7723</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#yum install docker-compose -y   #根据网络情况不同，可能需要一些时间</span><br></pre></td></tr></table></figure>

<p>执行harbor脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh &#x2F;opt&#x2F;harbor&#x2F;install.sh #根据网络情况不同，可能需要一些时间</span><br></pre></td></tr></table></figure>

<p>进入到harbor目录执行以下命令：如果报以下错误，请检查目录</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112105738149-964180777.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;harbor </span><br><span class="line"># docker-compose ps</span><br></pre></td></tr></table></figure>

<p>全是up表示正常：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112105822942-354513313.png" alt="img"></p>
<p>安装nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install nginx -y #可是直接yum，也可以安装源码安装</span><br></pre></td></tr></table></figure>

<p>编辑nginx配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;harbor.kococ.cn.conf</span><br></pre></td></tr></table></figure>

<p>反代harbor：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.kococ.cn;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动nginx并设置开机启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start nginx</span><br><span class="line"># systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p>检查harbor端口及nginx端口：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112110514027-574218373.png" alt="img"></p>
<p> 试着访问harbor，使用宿主机浏览器打开harbor.kococ.cn，如果访问不了，检查dns是否是10.4.7.11，也就是部署bind服务的服务器IP,也可以做host解析:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">harbor.kococ.cn</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112111201926-749548456.png" alt="img"></p>
<p>默认账号：admin</p>
<p>默认密码：Harbor12345</p>
<p>登录后创建一个新的仓库，一会测试用：</p>
<p> 使用docker下载一个nginx，测试私有仓库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># docker pull nginx:1.7.9</span><br><span class="line"># docker login harbor.kococ.cn</span><br><span class="line"># docker tag 84581e99d807 harbor.kococ.cn&#x2F;public&#x2F;nginx:v1.7.9</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;nginx:v1.7.9</span><br></pre></td></tr></table></figure>



<p>然后去私有仓库上看下：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112113755367-36111642.png" alt="img"></p>
<p>看到我们的镜像已经上传到私有仓库了</p>
<p>现在正式开始部署etcd组件：</p>
<p>首先申请证书，我们所有申请证书的操作，都在hdss7-200上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;certs</span><br><span class="line"># vi &#x2F;opt&#x2F;certs&#x2F;ca-config.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi etcd-peer-csr.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行签发证书命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;certs　　</span><br><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br></pre></td></tr></table></figure>

<p>按照架构设计，在hdss7-12，hdss7-21, hdss7-22三台上部署etcd服务：</p>
<p>首先创建etcd用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># useradd -s &#x2F;sbin&#x2F;nologin -M etcd</span><br></pre></td></tr></table></figure>

<p>创建应用包存放目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;opt&#x2F;src</span><br><span class="line"># cd &#x2F;opt&#x2F;src</span><br></pre></td></tr></table></figure>

<p>下载etcd组件：</p>
<p>地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/etcd-io/etcd/tags">https://github.com/etcd-io/etcd/tags</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.2.28&#x2F;etcd-v3.2.28-linux-amd64.tar.gz</span><br><span class="line"># tar -zxf etcd-v3.2.28-linux-amd64.tar.gz -C ..&#x2F;</span><br><span class="line"># ln -s &#x2F;opt&#x2F;etcd-v3.2.28-linux-amd64&#x2F; &#x2F;opt&#x2F;etcd</span><br><span class="line"># mkdir -p &#x2F;opt&#x2F;etcd&#x2F;certs &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br></pre></td></tr></table></figure>



<p>编辑etcd启动脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>标红处在另外两台服务器上需要修改成对应自己的ip地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir &#x2F;data&#x2F;etcd&#x2F;etcd-server \</span><br><span class="line">       --listen-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12&#x3D;https:&#x2F;&#x2F;10.4.7.12:2380,etcd-server-7-21&#x3D;https:&#x2F;&#x2F;10.4.7.21:2380,etcd-server-7-22&#x3D;https:&#x2F;&#x2F;10.4.7.22:2380 \</span><br><span class="line">       --ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">       --key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --peer-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --peer-cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">       --peer-key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></table></figure>



<p>添加执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p>创建证书存放目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;opt&#x2F;etcd&#x2F;certs</span><br><span class="line"># cd &#x2F;opt&#x2F;etcd&#x2F;certs</span><br></pre></td></tr></table></figure>

<p>拷贝证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;etcd-peer.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;etcd-peer-key.pem .&#x2F;</span><br></pre></td></tr></table></figure>

<p>给目录授权：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -R etcd.etcd &#x2F;opt&#x2F;etcd&#x2F;certs &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br></pre></td></tr></table></figure>

<p>安装supervisor管理服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install supervisor -y</span><br></pre></td></tr></table></figure>

<p>启动服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start supervisord </span><br><span class="line"># systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<p>编辑etcd启动脚本：红色部分根据主机修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;etcd-server.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                   ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;etcd-server&#x2F;etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                     ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                     ; emit events on stdout writes (default false)killasgroup&#x3D;truestopasgroup&#x3D;true</span><br></pre></td></tr></table></figure>



<p>更新supervisord</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br></pre></td></tr></table></figure>

<p>检查状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112163323903-385009522.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112163338054-1610372131.png" alt="img"></p>
<p> 检查etcd集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;etcd&#x2F;</span><br><span class="line"># .&#x2F;etcdctl member list</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191112164102130-115595684.png" alt="img"></p>
<p>etcd服务搭建完成后，里面其实存储了很多的key，如何查看和管理这些key，需要使用一个小工具，叫做etcdkeeper：</p>
<p>　　原文链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/gytangyao/p/11407205.html">https://www.cnblogs.com/gytangyao/p/11407205.html</a></p>
<h4 id="下载etcd-在etcd节点选一台"><a href="#下载etcd-在etcd节点选一台" class="headerlink" title="下载etcd,在etcd节点选一台"></a>下载etcd,在etcd节点选一台</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;evildecay&#x2F;etcdkeeper&#x2F;releases&#x2F;download&#x2F;v0.7.5&#x2F;etcdkeeper-v0.7.5-linux_x86_64.zip</span><br><span class="line">##解开压缩包，需安装unzip：  yum install unzip -y</span><br><span class="line"># unzip etcdkeeper-*-linux_x86_64.zip</span><br><span class="line"># rm etcdkeeper-*-linux_x86_64.zip</span><br><span class="line"># mv etcdkeeper ..&#x2F;etcdkeeper-0.7.5# ln -s &#x2F;opt&#x2F;etcdkeeper-0.7.5&#x2F; &#x2F;opt&#x2F;etcdkeeper# cd &#x2F;opt&#x2F;etcdkeeper</span><br><span class="line"># chmod +x etcdkeeper</span><br></pre></td></tr></table></figure>



<h5 id="编写一个服务文件"><a href="#编写一个服务文件" class="headerlink" title="编写一个服务文件"></a>编写一个服务文件</h5><p>该服务文件主要用于在后台运行etcd程序,用以提供http服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;lib&#x2F;systemd&#x2F;system</span><br><span class="line"># vim etcdkeeper.service</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;etcdkeeper service</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">ExecStart&#x3D;&#x2F;opt&#x2F;etcdkeeper&#x2F;etcdkeeper -h 10.4.7.12 -p 8800</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -HUP $MAINPID</span><br><span class="line">KillMode&#x3D;process</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>



<p>-h 指定etcdkeeper http监听的地址,这里监听的是IPV4地址10.4.7.12<br> -p 指定etcdkeeper http监听的端口</p>
<h5 id="服务的控制"><a href="#服务的控制" class="headerlink" title="服务的控制"></a>服务的控制</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start etcdkeeper          启动etcdkeeper服务</span><br><span class="line"># systemctl stop etcdkeeper          停止etcdkeeper服务</span><br><span class="line"># systemctl enable etcdkeeper.service          设置开机自启动</span><br><span class="line"># systemctl disable etcdkeeper.service         停止开机自启动</span><br></pre></td></tr></table></figure>



<h5 id="访问安全"><a href="#访问安全" class="headerlink" title="访问安全"></a>访问安全</h5><p>如果启用了etcd自身的授权,无需特别关心<br> 如果没有自动,可以考虑使用Nginx反代,使用base auth授权.</p>
<h5 id="遗留的问题"><a href="#遗留的问题" class="headerlink" title="遗留的问题"></a>遗留的问题</h5><p>当发布到公网环境时,v2可以查看到数据,v3查看不到数据。 目前没查到原因.</p>
<h4 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h4><p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://10.4.7.12:8800/">http://10.4.7.12:8800</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191205165335451-1336641427.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191205165345257-1843612752.png" alt="img"></p>
<p> 至此，etcd服务集群已经搭建完成了，接下来部署kube-apiserver服务，etcd属于服务端，kube-apiserver属于客户端，搭建kube-apiserver的过程将在下个章节。</p>
<h1 id="二进制安装kubernetes（二）-kube-apiserver组件安装"><a href="#二进制安装kubernetes（二）-kube-apiserver组件安装" class="headerlink" title="二进制安装kubernetes（二） kube-apiserver组件安装"></a>二进制安装kubernetes（二） kube-apiserver组件安装</h1><p>根据架构图，我们的apiserver部署在hdss7-21和hdss7-22上：</p>
<p>首先在hdss7-200上申请证书并拷贝到21和22上：</p>
<p>创建证书文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;certs</span><br><span class="line"># vi client-csr.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>申请证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;client client-csr.json |cfssl-json -bare client</span><br><span class="line"># vi apiserver-csr.json</span><br><span class="line">知识点：</span><br><span class="line">                这个证书目前专属于 apiserver加了一个 *.kubernetes.master 域名以便内部私有 DNS 解析使用(可删除)；至于很多人问过 kubernetes 这几个能不能删掉，答案是不可以的；因为当集群创建好后，default namespace 下会创建一个叫 kubenretes 的 svc，有一些组件会直接连接这个 svc 来跟 api 通讯的，证书如果不包含可能会出现无法连接的情况；其他几个 kubernetes 开头的域名作用相同</span><br><span class="line">                hosts包含的是授权范围，不在此范围的的节点或者服务使用此证书就会报证书不匹配错误。</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;,</span><br><span class="line">        &quot;10.4.7.23&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;server apiserver-csr.json |cfssl-json -bare apiserver</span><br></pre></td></tr></table></figure>

<p>下载kubernetes，放到21，22服务器上，官方地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl">https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl</a></p>
<p>我这里用的是1.15版本，下载后操作：21,22上操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># tar -zxf kubernetes-server-linux-amd64-v1.15.4.tar.gz -C ..&#x2F;</span><br><span class="line"># cd ..</span><br><span class="line"># mv kubernetes&#x2F; kubernetes-1.15</span><br><span class="line"># ln -s &#x2F;opt&#x2F;kubernetes-1.15&#x2F; &#x2F;opt&#x2F;kubernete</span><br></pre></td></tr></table></figure>

<p>创建证书和配置文件存放目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br></pre></td></tr></table></figure>

<p>接下来拷贝证书，将apiserver证书拷贝到hdss7-21,7-22上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver-key.pem .&#x2F;# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca-key.pem .&#x2F;# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client-key.pem .&#x2F;# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client.pem .&#x2F;</span><br></pre></td></tr></table></figure>



<p>进入配置文件目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br></pre></td></tr></table></figure>

<p>编辑配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi audit.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io&#x2F;v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&#39;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;&#x2F;api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;&#x2F;version&quot;</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>



<p>便携启动脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">.&#x2F;kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;audit-log \</span><br><span class="line">  --audit-policy-file .&#x2F;conf&#x2F;audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --requestheader-client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --etcd-certfile .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-keyfile .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-servers https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb&#x3D;1024 \</span><br><span class="line">  --kubelet-client-certificate .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --kubelet-client-key .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --log-dir  &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;apiserver.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;apiserver-key.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh</span><br></pre></td></tr></table></figure>

<p>编写supervisord启动文件：红色部分对应主机修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-apiserver.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-apiserver-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                   ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                     ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                     ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<p>创建日志存放目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver</span><br></pre></td></tr></table></figure>

<p>更新supervisord：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br></pre></td></tr></table></figure>

<p>检查是否启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113161103150-1839664051.png" alt="img"></p>
<p>至此，kube-apiserver核心组件已经安装完成，接下来要对apiserver做高可用负载：</p>
<p>在hdss7-11,hdss7-12上部署nginx：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install nginx -y</span><br><span class="line"># vi &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>nginx四层负载，必须与http同级：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"># systemctl start nginx</span><br><span class="line"># systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p>部署keepalived实现高可用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> # yum install keepalived -y</span><br><span class="line"># vi &#x2F;etc&#x2F;keepalived&#x2F;check_port.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 6379&quot; #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#&#125;</span><br><span class="line">CHK_PORT&#x3D;$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS&#x3D;&#96;ss -lnt|grep $CHK_PORT|wc -l&#96;</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;etc&#x2F;keepalived&#x2F;check_port.sh</span><br></pre></td></tr></table></figure>

<p>编辑keepalived配置文件，注意主从配置文件不一样：</p>
<p>hdss7-11 主：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt   #非抢占式 ，当主节点挂了以后，从节点vip飘到从上，主节点恢复以后，不主动飘回主，需要手动重启keepalived</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>hdss7-12 从：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    mcast_src_ip 10.4.7.12</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>启动keepalived并配置开机自启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start keepalived</span><br><span class="line"># systemctl enable keepalived</span><br></pre></td></tr></table></figure>

<p>检查VIP情况：</p>
<p>7-11是主，现在vip绑定在主上，正常：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113163151886-1369051614.png" alt="img"></p>
<p> 如果keepalived出现脑裂问题，两台上面都有vip，可以加入以下配置，将多播修改成单播：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191209165848123-1526028674.png" alt="img"></p>
<p>至此，apiserver部署完成，并且配置了负载高可用。下一章节部署kube-controller-manager。</p>
<h1 id="二进制安装kubernetes（三）-kube-controller-manager组件安装"><a href="#二进制安装kubernetes（三）-kube-controller-manager组件安装" class="headerlink" title="二进制安装kubernetes（三） kube-controller-manager组件安装"></a>二进制安装kubernetes（三） kube-controller-manager组件安装</h1><h3 id="Controller-Manager简介"><a href="#Controller-Manager简介" class="headerlink" title="Controller Manager简介"></a>Controller Manager简介</h3><p>详细介绍请参考链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/bbwangj/article/details/82557705">Kubernetes组件之kube-controller-manager</a></p>
<p>Controller Manager作为集群内部的管理控制中心，负责集群内的Node、Pod副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理，当某个Node意外宕机时，Controller Manager会及时发现并执行自动化修复流程，确保集群始终处于预期的工作状态。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113170548235-2063928773.png" alt="img"></p>
<p> 每个Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。</p>
<p>controller-manager安装在apiserver节点服务器上，hdss7-21，22：</p>
<p>编辑controller-manager启动脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --root-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>



<p>执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br></pre></td></tr></table></figure>

<p>创建日志存储目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager</span><br></pre></td></tr></table></figure>

<p>编辑supervisord启动脚本：红色字体部分根据部署主机修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-conntroller-manager.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-controller-manager-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                                     ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager&#x2F;controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                                       ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<p>添加supervisord：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br></pre></td></tr></table></figure>

<p>检查状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113172600977-1718819197.png" alt="img"></p>
<p>至此 controller manager已经部署完成，接下来部署kube-scheduler。</p>
<h1 id="二进制安装kubernetes（四）-kube-scheduler组件安装"><a href="#二进制安装kubernetes（四）-kube-scheduler组件安装" class="headerlink" title="二进制安装kubernetes（四） kube-scheduler组件安装"></a>二进制安装kubernetes（四） kube-scheduler组件安装</h1><p>介绍资料转载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/c4c60ccda8d0">https://www.jianshu.com/p/c4c60ccda8d0</a></p>
<p>kube-scheduler在集群中的作用</p>
<p>kube-scheduler是以插件形式存在的组件，正因为以插件形式存在，所以其具有可扩展可定制的特性。kube-scheduler相当于整个集群的调度决策者，其通过预选和优选两个过程决定容器的最佳调度位置。</p>
<p>kube-scheduler源码中的关键性调用链</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113173136155-1364045240.png" alt="img"></p>
<p>kube-scheduler部署在hdss7-21,22上：</p>
<p>创建启动脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<p>执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br></pre></td></tr></table></figure>

<p>创建日志存储目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler</span><br></pre></td></tr></table></figure>

<p>编辑supervisord脚本：红色部分第二台需要修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-scheduler.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-scheduler-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                            ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler&#x2F;scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                              ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                              ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<p>更新supervisord：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113174157245-1579314383.png" alt="img"></p>
<p> 检查一下状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ln -s &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubectl &#x2F;usr&#x2F;bin&#x2F;kubectl</span><br><span class="line"># kubectl get cs</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113174511829-1730805155.png" alt="img"></p>
<p>至此kube-scheduler已经安装完成，接下来安装kubelet。</p>
<h1 id="二进制安装kubernetes（五）-kubelet组件安装"><a href="#二进制安装kubernetes（五）-kubelet组件安装" class="headerlink" title="二进制安装kubernetes（五） kubelet组件安装"></a>二进制安装kubernetes（五） kubelet组件安装</h1><p>概述资料地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/bbwangj/article/details/81904350">https://blog.csdn.net/bbwangj/article/details/81904350</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113174751232-1888238592.png" alt="img"></p>
<p>Kubelet组件运行在Node节点上，维持运行中的Pods以及提供kuberntes运行时环境，主要完成以下使命：<br>１．监视分配给该Node节点的pods<br>２．挂载pod所需要的volumes<br>３．下载pod的secret<br>４．通过docker/rkt来运行pod中的容器<br>５．周期的执行pod中为容器定义的liveness探针<br>６．上报pod的状态给系统的其他组件<br>７．上报Node的状态</p>
<p>kubelet安装在node节点，我们的node跟apiserver在一起，这里安装在hdss7-21,22上：</p>
<p>首先，kubernetes依赖pause，我们先将此服务上传到们自己的docker私有仓库：</p>
<p>kubernetes中的pause容器主要为每个业务容器提供以下功能：</p>
<ul>
<li>在pod中担任Linux命名空间共享的基础；</li>
<li>启用pid命名空间，开启init进程。</li>
</ul>
<p>HDSS7-200上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull kubernetes&#x2F;pause</span><br><span class="line"># docker tag f9d5de079539 harbor.kococ.cn&#x2F;public&#x2F;pause:latest</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;pause:latest</span><br></pre></td></tr></table></figure>



<p>首先在hdss7-200上申请证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;certs&#x2F;kubelet-csr.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-kubelet&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>申请证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;server kubelet-csr.json | cfssl-json -bare kubelet</span><br></pre></td></tr></table></figure>

<p>拷贝证书到21，22上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet-key.pem .&#x2F;</span><br></pre></td></tr></table></figure>

<p>进入到conf目录执行以下命令：21，22上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cert]# cd ..&#x2F;conf&#x2F;</span><br><span class="line"># kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig&#x3D;kubelet.kubeconfig</span><br><span class="line"># kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kubelet.kubeconfig </span><br><span class="line"># kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster&#x3D;myk8s \</span><br><span class="line">  --user&#x3D;k8s-node \</span><br><span class="line">  --kubeconfig&#x3D;kubelet.kubeconfig</span><br><span class="line"># kubectl config use-context myk8s-context --kubeconfig&#x3D;kubelet.kubeconfig</span><br></pre></td></tr></table></figure>

<p>hdss7-21上执行：PS：因为不论在哪个节点创建，已经同步到etcd上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conf]# vi k8s-node.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f k8s-node.yaml</span><br></pre></td></tr></table></figure>

<p>检查k8s-node资源创建状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get clusterrolebinding k8s-node -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113180538172-2055028227.png" alt="img"></p>
<p>编辑kubelet启动脚本：标红部分第二台要修改成对应的主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kubelet \</span><br><span class="line">  --anonymous-auth&#x3D;false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --kubelet-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --fail-swap-on&#x3D;&quot;false&quot; \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;kubelet.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;kubelet-key.pem \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig .&#x2F;conf&#x2F;kubelet.kubeconfig \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.kococ.cn&#x2F;public&#x2F;pause:latest \</span><br><span class="line">  --root-dir &#x2F;data&#x2F;kubelet</span><br></pre></td></tr></table></figure>



<p>执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod u+x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br></pre></td></tr></table></figure>

<p>创建日志存储目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet</span><br></pre></td></tr></table></figure>

<p>编辑supervisord启动文件：红色部分自行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-kubelet.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-kubelet-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                     ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet&#x2F;kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                       ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113184508160-1125579373.png" alt="img"></p>
<p>给node打tag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl label node hdss7-21.host.com node-role.kubernetes.io&#x2F;master&#x3D;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191113191113083-612100625.png" alt="img"></p>
<h1 id="二进制安装kubernetes（六）-kube-proxy组件安装"><a href="#二进制安装kubernetes（六）-kube-proxy组件安装" class="headerlink" title="二进制安装kubernetes（六） kube-proxy组件安装"></a>二进制安装kubernetes（六） kube-proxy组件安装</h1><p><strong>Kube-Proxy简述</strong></p>
<p>参考文献：<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://ywnz.com/linuxyffq/2530.html">https://ywnz.com/linuxyffq/2530.html</a></p>
<p>运行在每个节点上，监听 API Server 中服务对象的变化，再通过管理 IPtables 来实现网络的转发<br>Kube-Proxy 目前支持三种模式：</p>
<ul>
<li><p>UserSpace</p>
<ul>
<li>k8s v1.2 后就已经淘汰</li>
</ul>
</li>
<li><p>IPtables</p>
<ul>
<li>目前默认方式</li>
</ul>
</li>
<li><p>IPVS–推荐，支持7层</p>
<ul>
<li>需要安装ipvsadm、ipset 工具包和加载 ip_vs 内核模块</li>
</ul>
</li>
</ul>
<p>kube-proxy部署在hdss7-21,hdss7-22上：</p>
<p>首先安装ipset，ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># yum install   ipset  -y </span><br><span class="line"># yum -y install ipvsadm</span><br></pre></td></tr></table></figure>

<p>然后在hdss7-200上申请证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;certs&#x2F;kube-proxy-csr.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span><br></pre></td></tr></table></figure>

<p>拷贝证书到21，22上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client-key.pem .&#x2F;</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client.pem .&#x2F;</span><br></pre></td></tr></table></figure>

<p>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line"># kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"># kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"># kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster&#x3D;myk8s \</span><br><span class="line">  --user&#x3D;kube-proxy \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"># kubectl config use-context myk8s-context --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>编辑开启ipvs内核的脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;root&#x2F;ipvs.sh</span><br><span class="line"></span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">ipvs_mods_dir&#x3D;&quot;&#x2F;usr&#x2F;lib&#x2F;modules&#x2F;$(uname -r)&#x2F;kernel&#x2F;net&#x2F;netfilter&#x2F;ipvs&quot;</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)</span><br><span class="line">do</span><br><span class="line">  &#x2F;sbin&#x2F;modinfo -F filename $i &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    &#x2F;sbin&#x2F;modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chmod u+x &#x2F;root&#x2F;ipvs.sh</span><br><span class="line"># sh &#x2F;root&#x2F;ipvs.sh</span><br></pre></td></tr></table></figure>

<p>编辑kube-proxy启动脚本：红色部分根据IP修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --proxy-mode&#x3D;ipvs \</span><br><span class="line">  --ipvs-scheduler&#x3D;nq \</span><br><span class="line">  --kubeconfig .&#x2F;conf&#x2F;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>



<p>执行权限并创建日志存储目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy</span><br></pre></td></tr></table></figure>

<p>编辑supervisord启动文件：红色部分根据IP修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-proxy.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-proxy-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                        ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                            ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                          ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                          ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<p>更新supervisord：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br><span class="line"># supervisorctl status</span><br></pre></td></tr></table></figure>

<p>创建nginx-ds pod：（21上执行就行）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;root&#x2F;nginx-ds.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;nginx:v1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f nginx-ds.yaml</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pods </span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191114150438957-101353459.png" alt="img"></p>
<p>最后验证集群状态：</p>
<p>etcd controller-manager scheduler状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#kubectl get cs</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191114150543989-1361893568.png" alt="img"></p>
<p>nodes状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get nodes</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191114150712395-165764939.png" alt="img"></p>
<p> pods状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#kubectl get pods</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191114150712395-165764939.png" alt="img"></p>
<p>至此，kubernets的核心组件已经安装部署完成，接下来会部署附加组件。</p>
<h1 id="二进制安装kubernetes（七）-部署知识点总结"><a href="#二进制安装kubernetes（七）-部署知识点总结" class="headerlink" title="二进制安装kubernetes（七） 部署知识点总结"></a>二进制安装kubernetes（七） 部署知识点总结</h1><p>1、k8s各个组件之间通信，在高版本中，基本都是使用TSL通信，所以申请证书，是必不可少的，而且建议使用二进制安装，或者在接手一套K8S集群的时候，第一件事情是检查证书有效期，证书过期或者TSL通信问题会报x509相关错误。</p>
<p>可以从k8s kubelet-kuberconfig 使用 echo ‘证书’ | base64 -d 反解获得k8s证书(比如阿里云)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl-certinfo -domain&#x3D;ca.pem -cert&#x3D;client.pem</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120110308446-345298667.png" alt="img"></p>
<p>2、在安装k8s运算节点的时候，建议关闭kubelet节点的swap交换分区，否则要在启动脚本中指定–fail-swap-on=”false”，在屋里内存足够大的情况下，建议关闭交换分区。</p>
<p>3、etcd在大规模集群中，可以跟apiserver、controller-manager、scheduler分开部署，但是apiserver、controller-manager、scheduler这三个服务，尽量部署在一起，因为controller-manager、scheduler跟apiserver通信是使用本机的127.0.0.1:8080端口进行通信，这样会节省网络资源。</p>
<p>4、linux内核版本大于3.8.X</p>
<p>5、使用supervisord管理服务的时候，为了避免在重启的时候出现端口存在(默认supervisord不会stop子进程)，需要在服务的.ini配置文件中添加以下两项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">killasgroup&#x3D;true  #这个东西主要用于，supervisord管理的子进程，这个子进程本身还有，子进程。那么我们如果仅仅干掉supervisord的子进程的话，子进程的子进程，有可能会变成孤儿进程。所以咱们可以设置可个选项，把整个该子进程的，整个进程组都干掉。 设置为true的话，一般killasgroup也会被设置为true。需要注意的是，该选项发送的是stop信号，默认为false。。非必须设置。</span><br><span class="line">stopasgroup&#x3D;true  #这个和上面的stopasgroup类似，不过发送的是kill信号</span><br></pre></td></tr></table></figure>

<h1 id="kubernetes进阶（一）-kubectl工具使用详解"><a href="#kubernetes进阶（一）-kubectl工具使用详解" class="headerlink" title="kubernetes进阶（一） kubectl工具使用详解"></a>kubernetes进阶（一） kubectl工具使用详解</h1><p><strong>管理k8s核心资源的三种基本方法：</strong></p>
<p>一、陈述式-主要依赖命令行工具 –可以满足90%以上的使用场景，但是缺点也很明显：</p>
<p>　　命令冗长，复杂，难以记忆</p>
<p>　　特定场景下，无法实现管理需求</p>
<p>　　对资源的增、删、查操作比较容易，改比较麻烦，需要patch来使用json串来更改。</p>
<p>　　<strong>1.1 查看名称空间</strong> 查询时，为了避免重名，需要指定名称空间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get namespace</span><br><span class="line">简写：</span><br><span class="line"># kubectl get ns</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120162038299-1719142838.png" alt="img"></p>
<p>　　<strong>1.2 查询命名空间中的资源</strong>，使用-n 指定命名空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get all -n default</span><br><span class="line"># kubectl get pods -n default</span><br><span class="line"># kubectl get nodes -n default</span><br></pre></td></tr></table></figure>



<p>　　<strong>1.3 创建命名空间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create ns app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120163051927-1329056471.png" alt="img"></p>
<p>　　<strong>1.4 删除命名空间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete ns app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120163157819-1947277387.png" alt="img"></p>
<p> 　<strong>1.5 创建一个deployment类型的pod控制器</strong>：PS:1.16版本以后，控制器有变化，具体变化参考k8s官网。</p>
<p>　　 pod控制器类型参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/weiyiming007/p/10246118.html">https://www.cnblogs.com/weiyiming007/p/10246118.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create deployment nginx-dp --image&#x3D;harbor.kococ.cn&#x2F;public&#x2F;nginx:v1.7.9 -n kube-public</span><br><span class="line"># kubectl get deploy -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120181727487-1964819809.png" alt="img"></p>
<p>　　<strong>1.6 查看pod控制器或者pod概览信息</strong> : -o wide</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get deploy -o wide -n kube-public</span><br><span class="line"># kubectl get pod -o wide -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120182326063-1712655305.png" alt="img"></p>
<p>　　<strong>1.7 查看pod控制器、pod、service等资源的详细信息</strong>：describe</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl describe deploy nginx-dp -n kube-public</span><br><span class="line"># kubectl describe pod nginx-dp-5dfc689474-4bhfh -n kube-public</span><br><span class="line"># kubectl describe svc nginx-dp -n kube-public　</span><br></pre></td></tr></table></figure>

<p>　详细信息太多，就不截图了。</p>
<p>　　<strong>1.8 进入pod容器，用法和docker exec一致</strong>，但是需要使用-n 指定命名空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl exec -ti nginx-dp-5dfc689474-4bhfh &#x2F;bin&#x2F;bash -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120183446194-77387750.png" alt="img"></p>
<p>　　<strong>1.9 删除pod容器</strong>，此删除，只是删除了pod容器，并没有删除pod控制器，所以此操作相当于删除pod后，pod控制器在拉起一个新的pod。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete pods nginx-dp-5dfc689474-4bhfh -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120184142792-1084906192.png" alt="img"></p>
<p> 可以看到我们删除pod以后，pod控制器又帮我们从新拉起了一个新的pod，想要完全删除，需要删除pod控制器。</p>
<p>　　<strong>1.10 删除pod控制器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete deploy nginx-dp -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120184830277-1576468381.png" alt="img"></p>
<p>可以看到，当我们删除了pod控制器以后，pod容器也随之被删除了。</p>
<p>　　<strong>1.11 扩容pod –replicas=数量</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl scale deployment nginx-dp --replicas&#x3D;2 -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120191239821-1469821172.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120191254127-1868023507.png" alt="img"></p>
<p>　　<strong>1.12 管理service资源 service资源</strong>：为pod资源提供稳定的接入点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create deploy nginx-dp --image&#x3D;harbor.kococ.cn&#x2F;public&#x2F;nginx:v1.7.9</span><br><span class="line"># kubectl expose deploy nginx-dp --port&#x3D;80 -n kube-public</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120190417014-1885879823.png" alt="img"></p>
<p> 看到我们已经创建了一个service资源，可以通过192.168.234.234的80，访问到后面pod，为了解决pod漂移导致IP变化的问题。</p>
<p>可以使用ipvsadm -Ln来查看：nq为ipvs调度算法中的一种，其他调度算法请自行查阅。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120190609614-39153588.png" alt="img"></p>
<p>我们通过删除pod的方式，让pod漂移到另一台node节点，再来查看一下：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120190907800-107826727.png" alt="img"></p>
<p> 可以看到，虽然pod漂移了，但是service资源提供的接入点是不变的，这得益于ipvs的强大。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120191007242-742957714.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120191351319-1327643689.png" alt="img"></p>
<p> 　<strong>1.13 查看资源配置清单详细信息</strong>：-o yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod nginx-dp-5dfc689474-c5r9r -o yaml -n kube-public</span><br><span class="line"># kubectl get deploy nginx-dp -o yaml -n kube-public</span><br><span class="line"># kubectl get svc -o yaml -n kube-public</span><br></pre></td></tr></table></figure>



<p>　　<strong>1.14 查看属性的定义及用法</strong>：例：查看service资源下metadata的定义及用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain service.metadata</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191120192527111-2002912807.png" alt="img"></p>
<p><strong>2、声明式-依赖统一资源配置清单(manifest) yaml/json</strong></p>
<p>　　<strong>2.1 创建一个svc资源配置清单</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191121151749735-1039780189.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get svc nginx-ds -o yaml -n default</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191121152848475-1793715531.png" alt="img"></p>
<p> 　<strong>2.2 离线修改资源配置清单：</strong></p>
<p>　　修改资源配置清单后可以使用apply应用。</p>
<p>这里增加一个知识点，就是kube-apiserver这个服务当中，有一个限制端口范围的参数：–service-node-port-range 10-29999，这个参数在使用apply修改资源配置清单的时候，会有作用</p>
<p>如果修改后的资源配置清单中的port不在这个范围，会报错，修改这个以后，重启kube-apiserver即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vi nginx-ds-svc.yaml #将对外暴露的端口改为881</span><br><span class="line"># kubectl apply -f nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>

<p>可以看到端口从80变成了881</p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191121183313312-407916940.png" alt="img"></p>
<p> 修改资源配置清单分为在线修改和离线修改（推荐离线修改）：</p>
<p>　　<strong>2.3 在线修改：</strong>我这里使用在线修改，将端口修改为888</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl edit svc nginx-ds -n default</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191121184355023-942641319.png" alt="img"></p>
<p> 　2.4 删除资源：</p>
<p>　　　　2.4.1 陈述式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete svc nginx-ds -n default</span><br></pre></td></tr></table></figure>

<p>　　　　2.4.2 声明式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete -f nginx-ds-svc.yaml</span><br></pre></td></tr></table></figure>



<p>3、GUI式-主要依赖图形化操作界面(web界面)</p>
<h1 id="kubernetes进阶（二）核心网络插件Flannel"><a href="#kubernetes进阶（二）核心网络插件Flannel" class="headerlink" title="kubernetes进阶（二）核心网络插件Flannel"></a>kubernetes进阶（二）核心网络插件Flannel</h1><p><strong>网络插件Flannel介绍：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.kubernetes.org.cn/3682.html">https://www.kubernetes.org.cn/3682.html</a></strong></p>
<p>首先，flannel利用Kubernetes API或者etcd用于存储整个集群的网络配置，其中最主要的内容为设置集群的网络地址空间。例如，设定整个集群内所有容器的IP都取自网段“10.1.0.0/16”。</p>
<p>接着，flannel在每个主机中运行flanneld作为agent，它会为所在主机从集群的网络地址空间中，获取一个小的网段subnet，本主机内所有容器的IP地址都将从中分配。</p>
<p>然后，flanneld再将本主机获取的subnet以及用于主机间通信的Public IP，同样通过kubernetes API或者etcd存储起来。</p>
<p>最后，flannel利用各种backend mechanism，例如udp，vxlan等等，跨主机转发容器间的网络流量，完成容器间的跨主机通信。</p>
<p>一、下载flannel插件</p>
<p>在所有node节点安装flannel插件，本次环境在hdss7-21，hdss7-22上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;flannel&#x2F;releases&#x2F;download&#x2F;v0.11.0&#x2F;flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line"># mkdir &#x2F;opt&#x2F;flannel-v0.11.0</span><br><span class="line"># tar xf flannel-v0.11.0-linux-amd64.tar.gz -C &#x2F;opt&#x2F;flannel-v0.11.0&#x2F;</span><br><span class="line"># ln -s &#x2F;opt&#x2F;flannel-v0.11.0&#x2F; &#x2F;opt&#x2F;flannel</span><br><span class="line"># cd &#x2F;opt&#x2F;flannel</span><br><span class="line"># mkdir cert</span><br></pre></td></tr></table></figure>

<p>因为要和apiserver通信，所以要配置client证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem . </span><br><span class="line"></span><br><span class="line">cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client.pem .</span><br><span class="line"></span><br><span class="line">cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client-key.pem .</span><br></pre></td></tr></table></figure>

<p>编辑环境变量env文件：红色部分根据node节点信息修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi subnet.env</span><br><span class="line"></span><br><span class="line">FLANNEL_NETWORK&#x3D;172.7.0.0&#x2F;16</span><br><span class="line">FLANNEL_SUBNET&#x3D;172.7.21.1&#x2F;24</span><br><span class="line">FLANNEL_MTU&#x3D;1500</span><br><span class="line">FLANNEL_IPMASQ&#x3D;false</span><br></pre></td></tr></table></figure>

<p>编辑启动脚本：红色部分根据node节点信息修改，并且eth0信息根据本机网卡信息修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi flanneld.sh </span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;flanneld \</span><br><span class="line">  --public-ip&#x3D;10.4.7.21 \</span><br><span class="line">  --etcd-endpoints&#x3D;https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile&#x3D;.&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-certfile&#x3D;.&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-cafile&#x3D;.&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --iface&#x3D;eth0 \</span><br><span class="line">  --subnet-file&#x3D;.&#x2F;subnet.env \</span><br><span class="line">  --healthz-port&#x3D;2401</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod u+x flanneld.sh</span><br></pre></td></tr></table></figure>

<p>创建日志存放目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;logs&#x2F;flanneld</span><br></pre></td></tr></table></figure>

<p>在etcd中增加网络配置信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;etcd</span><br></pre></td></tr></table></figure>

<p>测试使用 host-gw模型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;etcdctl set &#x2F;coreos.com&#x2F;network&#x2F;config &#39;&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>查看网络模型配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;etcdctl get &#x2F;coreos.com&#x2F;network&#x2F;config</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019112120002239-1697140830.png" alt="img"></p>
<p>编辑supervisor启动脚本：红色部分记得修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;supervisord.d&#x2F;flannel.ini</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[program:flanneld-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;flannel&#x2F;flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                 ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                               ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                              ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                              ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                         ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;flanneld&#x2F;flanneld.stdout.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                  ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                  ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>



<p>更新supervisor配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl update</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019112200204515-28730350.png" alt="img"></p>
<p><strong>这里需要修改iptables优化SNAT规则，否则在访问时，其他节点记录的是node节点的ip 10.4.7.21，而不是pod集群内部的172.7.21.x，红色部分按需修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># yum install iptables-services -y</span><br><span class="line"># iptables -t nat -D POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br><span class="line"># iptables -t nat -I POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br><span class="line"># iptables-save |grep -i postrouting</span><br><span class="line"># iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br></pre></td></tr></table></figure>

<p>修改后会影响到docker原本的iptables链的规则，所以需要重启docker服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart docker</span><br></pre></td></tr></table></figure>



<p>配置vxlan模型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;etcd</span><br><span class="line"># .&#x2F;etcdctl set &#x2F;coreos.com&#x2F;network&#x2F;config  &#39;&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;vxlan&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>重启flanneld：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl restart flanneld-7-21</span><br></pre></td></tr></table></figure>

<p>可以发现多了一块网卡，这块网卡就是vxlan用于隧道通信的虚拟网卡：</p>
<h1 id="kubernetes进阶（三）服务发现-coredns"><a href="#kubernetes进阶（三）服务发现-coredns" class="headerlink" title="kubernetes进阶（三）服务发现-coredns"></a>kubernetes进阶（三）服务发现-coredns</h1><p>服务发现需要解决的问题：</p>
<p>　　1、服务动态性强–容器在k8s中ip变化或迁移</p>
<p>　　2、更新发布频繁–版本迭代快</p>
<p>　　3、支持自动伸缩–大促或流量高峰</p>
<p>我们为了解决pod地址变化的问题，我们之前部署了service资源，将pod地址通过service资源暴露的固定地址，来解决以上问题，</p>
<p>那么，如何解决service资源名称和service资源暴露出来的集群网络IP做自动的对应呢，从而达到服务的自动发现呢？</p>
<p>在k8s中，coredns就是为了解决以上问题。</p>
<p>从coredns开始，我们采用向k8s中交付容器的方式，来部署服务，并且使用声明式的方式，来部署服务。</p>
<p>首先在hdss7-200上创建一个nginx虚拟主机，用来获取资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;k8s-yaml.kococ.cn.conf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.kococ.cn;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text&#x2F;plain;</span><br><span class="line">        root &#x2F;data&#x2F;k8s-yaml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;coredns# nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure>

<p>添加域名解析：hdss-11上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br><span class="line">在最后添加一条解析记录</span><br><span class="line"></span><br><span class="line">$ORIGIN kococ.cn.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.kococ.cn. dnsadmin.kococ.cn. (</span><br><span class="line">                                2019061803 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.kococ.cn.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line">k8s-yaml           A    10.4.7.200</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<p>coredns github地址：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/dns/coredns/coredns.yaml.base</a></p>
<p>在hdss7-200上部署coredns：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;coredns</span><br><span class="line"># docker pull docker.io&#x2F;coredns&#x2F;coredns:1.6.1</span><br><span class="line"># docker tag c0f6e815079e harbor.kococ.cn&#x2F;public&#x2F;coredns:v1.6.1</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;coredns:v1.6.1</span><br></pre></td></tr></table></figure>

<p>然后编辑资源配置清单：可以从官网上参考资源配置清单</p>
<p>1.rbac.yaml–拿到集群相关权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi rbac.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io&#x2F;autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>



<p>2.cm.yaml–configmap 对集群的相关配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi cm.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local 192.168.0.0&#x2F;16  #service资源cluster地址</span><br><span class="line">        forward . 10.4.7.11   #上级DNS地址</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>



<p>3.dp.yaml—pod控制器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io&#x2F;name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;coredns:v1.6.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - &#x2F;etc&#x2F;coredns&#x2F;Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></table></figure>



<p>4.svc.yaml—service资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io&#x2F;name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 192.168.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></table></figure>



<p>然后使用http请求资源配置清单yaml的方式来创建资源：在任意node节点上创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;coredns&#x2F;rbac.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;coredns&#x2F;cm.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;coredns&#x2F;dp.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;coredns&#x2F;svc.yaml</span><br></pre></td></tr></table></figure>



<p>查看运行情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get all -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019112317511586-952619728.png" alt="img"></p>
<p> 查看coredns的cluster ip：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get svc -o wide -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019123171846178-306539553.png" alt="img"></p>
<p> 测试coredns：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># dig -t A www.baidu.com @192.168.0.2 +short</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019112372154297-518829231.png" alt="img"></p>
<p> 看到已经可以解析到百度。</p>
<p>测试coredns解析service资源名称，首先查看kube-public下是否有service资源，如果没有，创建一个，使用kubectl expose nginx-dp –port=80 -n kube-public</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl expose nginx-dp --port&#x3D;80 -n kube-public</span><br></pre></td></tr></table></figure>

<p>测试：使用coredns测试解析，需要使用SQDN规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># dig -t A nginx-dp.kube-public.svc.cluster.local. @192.168.0.2 +short</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019123173004191-1776516653.png" alt="img"></p>
<p> 可以看到我们没有手动添加任何解析记录，我们nginx-dp的service资源的IP，已经被解析了：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-2019112373122519-900176878.png" alt="img"></p>
<p> 那么为什么呢？</p>
<p>推荐大家了解一下coredns都做了什么：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://ccnuo.com/2019/08/25/CoreDNS%EF%BC%9AKubernetes%E5%86%85%E9%83%A8%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86%E3%80%81%E5%BC%8A%E7%AB%AF%E5%8F%8A%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F/">Kubernetes内部域名解析原理、弊端及优化方式</a></p>
<p>大家可以看到，当我进入到pod内部以后，我们会发现我们的dns地址是我们的coredns地址，以及搜索域：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191174517612-971806757.png" alt="img"></p>
<p>现在，我们已经解决了在集群内部解析的问题，但是我们怎么做到在集群外部访问我们的服务呢？</p>
<p>接下来我们来学习k8s服务暴露。</p>
<h1 id="kubernetes进阶（四）服务暴露-ingress控制器之traefik"><a href="#kubernetes进阶（四）服务暴露-ingress控制器之traefik" class="headerlink" title="kubernetes进阶（四）服务暴露-ingress控制器之traefik"></a>kubernetes进阶（四）服务暴露-ingress控制器之traefik</h1><p>上一章我们测试了在集群内部解析service名称，</p>
<p>下面我们测试在集群外部解析：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191123175410495-632059730.png" alt="img"></p>
<p> 根本解析不到，因为我们外部用的dns是10.4.7.11，也就是我们的自建bind dns，这个DNS服务器上也没有响应的搜索域。</p>
<p>如何能让集群外部访问nginx-dp？</p>
<p>这里有两种服务暴露方式：修改工作模式，在kube-proxy中修改，并重启</p>
<p>1、使用nodeport方式，但是这种方式不能使用ipvs，只能使用iptables，iptables只能使用rr调度方式。原理相当于端口映射，将容器内的端口映射到宿主机上的某个端口。</p>
<p>2、使用ingress，但是只能工作在七层网络下，建议暴露http, https可以使用前端nginx来做证书方面的卸载 —推荐使用</p>
<p>Ingress是基于域名和URL路径，将用户的请求转发至特定的service资源。</p>
<p>下面我们部署traefik：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/containous/traefik">GITHUB官方地址</a>  在hdss7-200上执行：</p>
<p>下载镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull traefik:v1.7.2-alpine</span><br><span class="line"># docker tag add5fac61ae5 harbor.kococ.cn&#x2F;public&#x2F;traefik:v1.7.2</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;traefik:v1.7.</span><br></pre></td></tr></table></figure>

<p>创建资源配置清单：</p>
<p>1.rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;traefik&#x2F;</span><br><span class="line"># vi rbac.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>



<p>2.ds.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi ds.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.kococ.cn&#x2F;public&#x2F;traefik:v1.7.2</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: controller</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin-web</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - --api</span><br><span class="line">        - --kubernetes</span><br><span class="line">        - --logLevel&#x3D;INFO</span><br><span class="line">        - --insecureskipverify&#x3D;true</span><br><span class="line">        - --kubernetes.endpoint&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --accesslog.filepath&#x3D;&#x2F;var&#x2F;log&#x2F;traefik_access.log</span><br><span class="line">        - --traefiklog</span><br><span class="line">        - --traefiklog.filepath&#x3D;&#x2F;var&#x2F;log&#x2F;traefik.log</span><br><span class="line">        - --metrics.prometheus</span><br></pre></td></tr></table></figure>



<p>3.svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: controller</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin-web</span><br></pre></td></tr></table></figure>



<p>4.ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi ingress.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>





<p>然后到node节点上创建资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;traefik&#x2F;rbac.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;traefik&#x2F;ds.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;traefik&#x2F;svc.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;traefik&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>



<p>配置nginx解析：hdss7-11,hdss7-12</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;kococ.cn.conf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 10.4.7.21:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.kococ.cn;</span><br><span class="line">  </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>在hdss7-11上添加域名解析：在ingress.yaml中的host值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br></pre></td></tr></table></figure>

<p>在最后加上traefik的域名解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN kococ.cn.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.kococ.cn. dnsadmin.kococ.cn. (</span><br><span class="line">                                2019061804 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.kococ.cn.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line">k8s-yaml           A    10.4.7.200</span><br><span class="line">traefik            A    10.4.7.10</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<p>然后我们就可以在集群外，通过浏览器访问这个域名了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;traefik.kococ.cn  #我们的宿主机的虚拟网卡指定了bind域名解析服务器</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191123195126520-796246549.png" alt="img"></p>
<h1 id="kubernetes进阶（五）dashboard–WEB管理"><a href="#kubernetes进阶（五）dashboard–WEB管理" class="headerlink" title="kubernetes进阶（五）dashboard–WEB管理"></a>kubernetes进阶（五）dashboard–WEB管理</h1><p>dashboard是k8s的可视化管理平台，是三种管理k8s集群方法之一</p>
<p>首先下载镜像上传到我们的私有仓库中：hdss7-200</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull k8scn&#x2F;kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line"># docker tag fcac9aa03fd6 harbor.kococ.cn&#x2F;public&#x2F;dashboard:v1.8.3</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;dashboard:v1.8.3</span><br></pre></td></tr></table></figure>

<p>编辑dashboard资源配置清单：</p>
<p>1、rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi rbac.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;dashboard</span><br><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;dashboard</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io&#x2F;critical-pod: &#39;&#39;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;dashboard:v1.8.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - --auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: &#x2F;tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">        operator: &quot;Exists&quot;</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi ingress.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br></pre></td></tr></table></figure>



<p>创建资源：任意node</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dashboard&#x2F;rbac.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dashboard&#x2F;dp.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dashboard&#x2F;svc.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dashboard&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p>添加域名解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br><span class="line">dashboard          A    10.4.7.10</span><br><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<p>通过浏览器访问：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://dashboard.kococ.cn/">http://dashboard.kococ.cn</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191125193911658-1073438860.png" alt="img"></p>
<p>美好的点点点运维开始了~</p>
<p>但是，我们可以看到我们安装1.8版本的dashboard，默认是可以跳过验证的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126161244510-1269371002.png" alt="img"></p>
<p>很显然，跳过登录，是不科学的，因为我们在配置dashboard的rbac权限时，绑定的角色是system:admin，这个是集群管理员的角色，权限很大，所以这里我们把版本换成1.10以上版本</p>
<p>下载1.10.1版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull loveone&#x2F;kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line"># docker tag f9aed6605b81 harbor.kococ.cn&#x2F;public&#x2F;dashboard:v1.10.1</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;dashboard:v1.10.1</span><br></pre></td></tr></table></figure>

<p>修改dp.yaml重新应用，我直接用edit修改了，没有使用apply</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl edit deploy kubernetes-dashboard -n kube-system</span><br></pre></td></tr></table></figure>

<p>等待滚动发布完成后，在刷新dashboard页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126163610063-918814879.png" alt="img"></p>
<p> 可以看到这里原来的skip跳过已经没有了，我们如果想登陆，必须输入token，那我们如何获取token呢：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get secret  -n kube-system</span><br><span class="line"># kubectl describe secret kubernetes-dashboard-admin-token-pg77n  -n kube-system</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126172440979-1913961041.png" alt="img"></p>
<p> 这样我们就拿到了token，接下来我们试试能不能登录：</p>
<p>我们发现我们还是无法登录，原因是必须使用https登录，接下来我们需要申请证书：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126172608230-363720611.png" alt="img"></p>
<p>接下来我们申请证书：</p>
<p>依然使用cfssl来申请证书：hdss7-200</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line"># vi dashboard-csr.json</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;*.kococ.cn&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;server dashboard-csr.json |cfssl-json -bare dashboard</span><br></pre></td></tr></table></figure>

<p>然后拷贝到我们nginx的服务器上：7-11 7-12 都需要</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;etc&#x2F;nginx&#x2F;</span><br><span class="line"># mkdir certs</span><br><span class="line"># cd certs</span><br><span class="line"># scp hdss7-200:&#x2F;opt&#x2F;cert&#x2F;dash* .&#x2F;</span><br><span class="line"># cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line"># vi dashboard.kococ.cn.conf</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.kococ.cn;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https:&#x2F;&#x2F;$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.kococ.cn;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs&#x2F;dashboard.pem&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs&#x2F;dashboard-key.pem&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure>

<p>然后刷新页面：虽然证书无效(因为是自签证书)，但是已经是https了，试下我们刚才的token能不能登录了</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126183554740-658611982.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191126183711805-835833813.png" alt="img"></p>
<p>可以登录了~</p>
<p>登录是登录了，但是我们要思考一个问题，我们使用rbac授权来访问dashboard,如何做到权限精细化呢？比如开发，只能看，不能摸，不同的项目组，看到的资源应该是不一样的，测试看到的应该是测试相关的资源。</p>
<p>我们在下一章详解sa授权和ua授权。</p>
<h1 id="kubernetes进阶（六）k8s平滑升级"><a href="#kubernetes进阶（六）k8s平滑升级" class="headerlink" title="kubernetes进阶（六）k8s平滑升级"></a>kubernetes进阶（六）k8s平滑升级</h1><p>当我们遇到K8S有漏洞的时候，或者为了满足需求，有时候可能会需要升级或者降级版本，</p>
<p>为了减少对业务的影响，尽量选择在业务低谷的时候来升级：</p>
<p>首先准备好文件：我这里选择的是内网文件服务器上下载的，请自行下载所需的k8s源文件：3</p>
<p>这里演示更换一个节点：7-21</p>
<p>查看版本：将7-21更换成1.15.2</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128181938447-420585628.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br></pre></td></tr></table></figure>

<p>\</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># wget http:&#x2F;&#x2F;192.168.1.60:8080&#x2F;day1&#x2F;kubernetes-server-linux-amd64-v1.15.2.tar.gz</span><br><span class="line"># tar -zxf kubernetes-server-linux-amd64-v1.15.2.tar.gz</span><br><span class="line"># cd .. </span><br><span class="line"># cp -r kubernetes &#x2F;opt&#x2F;kubernetes-v1.15.2</span><br><span class="line"># cd kubernetes-v1.15.2&#x2F;</span><br><span class="line"># rm -rf kubernetes-src.tar.gz</span><br><span class="line"># cd server&#x2F;bin&#x2F; </span><br><span class="line"># rm -rf *.tar</span><br><span class="line"># rm -rf *tag</span><br><span class="line"># mkdir cert conf</span><br><span class="line"># cp &#x2F;opt&#x2F;kubernetes-v1.15.4&#x2F;server&#x2F;bin&#x2F;cert&#x2F;* .&#x2F;cert&#x2F;</span><br><span class="line"># cp &#x2F;opt&#x2F;kubernetes-v1.15.4&#x2F;server&#x2F;bin&#x2F;conf&#x2F;* .&#x2F;conf&#x2F;</span><br><span class="line"># cp &#x2F;opt&#x2F;kubernetes-v1.15.4&#x2F;server&#x2F;bin&#x2F;*.sh &#x2F;opt&#x2F;kubernetes-v1.15.2&#x2F;server&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<p>\</p>
<p>然后在nginx上摘除api-server的四层负载：7-11，7-12</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>把我们要升级的apiserver节点注释掉：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128181520668-1713984935.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nginx -t</span><br><span class="line"># nginx -s reload</span><br></pre></td></tr></table></figure>

<p>准备好后，摘除node，先看下哪个node上跑的pod少：我们这里一样多，那我们就搞7-21，</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128182818349-1528346077.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl delete node hdss7-21.host.com</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128183109611-326242097.png" alt="img"></p>
<p>我们的coredns已经从node7-21迁移到了7-22上，接下来我们更换软连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rm -rf kubernetes</span><br><span class="line"># ln -s &#x2F;opt&#x2F;kubernetes-v1.15.2 &#x2F;opt&#x2F;kubernetes</span><br></pre></td></tr></table></figure>

<p>然后重启使用supervisor重启服务：生产上记得一个一个重启，我们这里为了方便，直接重启所有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># supervisorctl restart all</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128183955698-809875028.png" alt="img"></p>
<p> 启动成功后，查看版本：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128184043612-695283976.png" alt="img"></p>
<p> 可以看到node版本已经从1.15.4变更为了1.15.2，并且kubelet已经自动帮我们把节点加入到了集群，然后打开nginx负载，即可。</p>
<h1 id="kubernetes实战-交付dubbo服务到k8s集群（一）准备工作"><a href="#kubernetes实战-交付dubbo服务到k8s集群（一）准备工作" class="headerlink" title="kubernetes实战-交付dubbo服务到k8s集群（一）准备工作"></a>kubernetes实战-交付dubbo服务到k8s集群（一）准备工作</h1><p>本次交付的服务架构图：因为zookeeper属于有状态服务，不建议将有状态服务，交付到k8s，如mysql，zk等。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128190859232-1477530286.png" alt="img"></p>
<p>首先部署zk集群：zk是java服务，需要依赖jdk，jdk请自行下载：</p>
<p>集群分布：7-11，7-12，7-21</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;opt&#x2F;src</span><br><span class="line"># mkdir &#x2F;usr&#x2F;jav</span><br><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># tar -xf jdk-8u221-linux-x64.tar.gz -C &#x2F;usr&#x2F;java&#x2F;</span><br><span class="line"># ln -s &#x2F;usr&#x2F;java&#x2F;jdk1.8.0_221&#x2F; &#x2F;usr&#x2F;java&#x2F;jdk</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;profile</span><br><span class="line"></span><br><span class="line">#JAVA HOME</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;usr&#x2F;java&#x2F;jdk</span><br><span class="line">export PATH&#x3D;$JAVA_HOME&#x2F;bin:$JAVA_HOME&#x2F;bin:$PATH</span><br><span class="line">export CLASSPATH&#x3D;$CLASSPATH:$JAVA_HOME&#x2F;lib:$JAVA_HOME&#x2F;lib&#x2F;tools.jar</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># source &#x2F;etc&#x2F;profile</span><br><span class="line"># java -version</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128192651792-1828529411.png" alt="img"></p>
<p> 下载zookeeper：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://archive.apache.org/dist/zookeeper/">下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br></pre></td></tr></table></figure>

<p>我这里使用的内网地址下载的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># wget http:&#x2F;&#x2F;192.168.1.60:8080&#x2F;day3&#x2F;zookeeper-3.4.14.tar.gz</span><br><span class="line"># tar -zxf zookeeper-3.4.14.tar.gz -C ..&#x2F;</span><br><span class="line"># ln -s &#x2F;opt&#x2F;zookeeper-3.4.14&#x2F; &#x2F;opt&#x2F;zookeeper</span><br><span class="line"># mkdir -pv &#x2F;data&#x2F;zookeeper&#x2F;data &#x2F;data&#x2F;zookeeper&#x2F;logs</span><br></pre></td></tr></table></figure>

<p>编辑配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;zookeeper&#x2F;conf&#x2F;zoo.cfg</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tickTime&#x3D;2000</span><br><span class="line">initLimit&#x3D;10</span><br><span class="line">syncLimit&#x3D;5</span><br><span class="line">dataDir&#x3D;&#x2F;data&#x2F;zookeeper&#x2F;data</span><br><span class="line">dataLogDir&#x3D;&#x2F;data&#x2F;zookeeper&#x2F;logs</span><br><span class="line">clientPort&#x3D;2181</span><br><span class="line">server.1&#x3D;zk1.kococ.cn:2888:3888</span><br><span class="line">server.2&#x3D;zk2.kococ.cn:2888:3888</span><br><span class="line">server.3&#x3D;zk3.kococ.cn:2888:3888</span><br></pre></td></tr></table></figure>



<p>修改dns：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br></pre></td></tr></table></figure>

<p>添加zk1，zk2,zk3的解析：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128193931699-456528467.png" alt="img"></p>
<p> 修改zk集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">7-11</span><br><span class="line"># echo 1 &gt; &#x2F;data&#x2F;zookeeper&#x2F;data&#x2F;myid</span><br><span class="line">7-12</span><br><span class="line"># echo 2 &gt; &#x2F;data&#x2F;zookeeper&#x2F;data&#x2F;myid</span><br><span class="line">7-21</span><br><span class="line"># echo 3 &gt; &#x2F;data&#x2F;zookeeper&#x2F;data&#x2F;myid</span><br></pre></td></tr></table></figure>



<p>启动zookeeper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;opt&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh start</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128194348892-1300121134.png" alt="img"></p>
<p> 查看集群情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;opt&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh status</span><br></pre></td></tr></table></figure>

<p>可以看到我们的7-12是leader：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128195441749-1928316302.png" alt="img"></p>
<p> 到此，zookeeper集群就搭建好了。</p>
<h1 id="Kubernetes实战-交付dubbo服务到k8s集群（二）交付jenkins到k8s集群"><a href="#Kubernetes实战-交付dubbo服务到k8s集群（二）交付jenkins到k8s集群" class="headerlink" title="Kubernetes实战-交付dubbo服务到k8s集群（二）交付jenkins到k8s集群"></a>Kubernetes实战-交付dubbo服务到k8s集群（二）交付jenkins到k8s集群</h1><p>首先下载jenkins镜像并上传到我们自己的私有仓库：7-200</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull jenkins&#x2F;jenkins:2.190.3</span><br><span class="line"># docker tag 22b8b9a84dbe harbor.kococ.cn&#x2F;public&#x2F;jenkins:v2.190.3</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;jenkins:v2.190.3</span><br></pre></td></tr></table></figure>

<p>为了适应我们的环境，我们的jenkins不能直接使用，需要进行配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;dockerfile&#x2F;jenkins&#x2F;</span><br><span class="line"># cd &#x2F;data&#x2F;dockerfile&#x2F;jenkins</span><br><span class="line"># vi Dockerfile</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM harbor.kococ.cn&#x2F;public&#x2F;jenkins:v2.190.3</span><br><span class="line">USER root  #定义启动jenkins的用户</span><br><span class="line">RUN &#x2F;bin&#x2F;cp &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime &amp;&amp;\ </span><br><span class="line">    echo &#39;Asia&#x2F;Shanghai&#39; &gt;&#x2F;etc&#x2F;timezone  #修改时区 改成东八区</span><br><span class="line">ADD id_rsa &#x2F;root&#x2F;.ssh&#x2F;id_rsa  #加载用户密钥，dubbo服务拉取代码使用的ssh</span><br><span class="line">ADD config.json &#x2F;root&#x2F;.docker&#x2F;config.json  #加载宿主机的docker配置文件，登录远程仓库的认证信息加载到容器里面。</span><br><span class="line">ADD get-docker.sh &#x2F;get-docker.sh # 在jenkins容器内安装docker 客户端，jenkins要执行docker build，docker引擎用的是宿主机的docker引擎</span><br><span class="line">RUN echo &quot;    StrictHostKeyChecking no&quot; &gt;&gt; &#x2F;etc&#x2F;ssh&#x2F;ssh_config &amp;&amp;\</span><br><span class="line">    &#x2F;get-docker.sh  # 跳过 ssh时候输入 yes 步骤，并执行安装docker</span><br></pre></td></tr></table></figure>



<p>首先创建密钥：<strong>邮箱请根据自己的邮箱自行修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ssh-keygen -t rsa -b 2048 -C &quot;xxx@xx.xxx&quot; -N &quot;&quot; -f &#x2F;root&#x2F;.ssh&#x2F;id_rsa</span><br></pre></td></tr></table></figure>

<p>将私钥加载到jenkins，将公钥配置到git仓库中，否则不能拉取代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128201131435-718180792.png" alt="img"></p>
<p> 接下来创建Dockerfile中需要的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># curl -fsSL get.docker.com -o get-docker.sh</span><br></pre></td></tr></table></figure>

<p>添加执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># chmod u+x get-docker.sh</span><br><span class="line"># cp &#x2F;root&#x2F;.ssh&#x2F;id_rsa .&#x2F;</span><br><span class="line"># cp &#x2F;root&#x2F;.docker&#x2F;config.json .&#x2F;</span><br></pre></td></tr></table></figure>

<p>创建运维私有仓库，打开我们的harbor.kococ.cn创建一个infra的私有仓库：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128202309113-723672747.png" alt="img"></p>
<p> 然后build镜像：过程漫长，可以抽根烟，喝杯茶了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker build . -t harbor.kococ.cn&#x2F;infra&#x2F;jenkins:v2.190.3</span><br></pre></td></tr></table></figure>

<p>build完以后将镜像上传到我们的私有仓库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker push harbor.kococ.cn&#x2F;infra&#x2F;jenkins:v2.190.3</span><br></pre></td></tr></table></figure>

<p>为jenkins创建名称空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create ns infra</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128204331330-1829762592.png" alt="img"></p>
<p>创建一条secret，用于访问我们的私有仓库infra：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create secret docker-registry harbor --docker-server&#x3D;harbor.kococ.cn --docker-username&#x3D;admin --docker-password&#x3D;Harbor12345 -n infra</span><br></pre></td></tr></table></figure>

<p>解释一下上面的命令：创建一条secret，资源类型是docker-registry，名字是 harbor，docker-server=harbor.kococ.cn ，docker-username=admin ，docker-password=Harbor12345 -n 指定私有仓库名称infra</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128204425675-681258493.png" alt="img"></p>
<p> 为了让jenkins中一些需要持久化的数据，能够存储，我们需要使用共享存储，然后进行挂载：这里使用最简单的NFS共享存储，因为k8s默认支持nfs模块</p>
<p>在运维主机和所有的node节点安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install nfs-utils -y</span><br></pre></td></tr></table></figure>

<p>使用7-200作为服务端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;exports</span><br><span class="line">&#x2F;data&#x2F;nfs-volume 10.4.7.0&#x2F;24(rw,no_root_squash)</span><br><span class="line"># mkdir -p mkdir &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home</span><br><span class="line"># systemctl start nfs</span><br><span class="line"># systemctl enable nfs</span><br></pre></td></tr></table></figure>

<p>准备jenkins资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;</span><br><span class="line"># mkdir jenkins# cd jenkins</span><br></pre></td></tr></table></figure>

<p>1、dp.yaml</p>
<p>这里挂载了宿主机的docker.sock，使容器内的docker客户端可以直接与宿主机的docker引擎进行通信</p>
<p>在使用私有仓库的时候，资源清单中，一定要声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> imagePullSecrets:</span><br><span class="line"> - name: harbor</span><br><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: jenkins</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: jenkins</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: jenkins </span><br><span class="line">        name: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs: </span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath: </span><br><span class="line">          path: &#x2F;run&#x2F;docker.sock   </span><br><span class="line">          type: &#39;&#39;</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;jenkins:v2.190.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx512m -Xms512m</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: &#x2F;var&#x2F;jenkins_home</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: &#x2F;run&#x2F;docker.sock</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>2、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins</span><br></pre></td></tr></table></figure>



<p>3、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jenkins.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: jenkins</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：node节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;jenkins&#x2F;dp.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;jenkins&#x2F;svc.yaml</span><br><span class="line"># kubectl create -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;jenkins&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p>查看我们创建的pod：这个启动时间还是挺长的，大概要几分钟时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n infra</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191128211126421-1682620137.png" alt="img"></p>
<p> 检查jenkins需要持久化的数据是否保存下来了：7-200</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191128211422046-837137067.png" alt="img"></p>
<p> 已经起来了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128211515695-254028924.png" alt="img"></p>
<p> 添加解析：7-11</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<p>浏览器访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;jenkins.kococ.cn</span><br></pre></td></tr></table></figure>

<p>经过配置我们已经部署好了jenkins：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128212009048-1239442402.png" alt="img"></p>
<p>安全配置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128212139087-374243948.png" alt="img"></p>
<p> 允许跨域：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191128212152398-811156861.png" alt="img"></p>
<p> 安装插件：</p>
<p>替换jenkins更新源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">###hdss7-200</span><br><span class="line"># cd &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home&#x2F;updates</span><br><span class="line"># sed -i &#39;s&#x2F;http:\&#x2F;\&#x2F;updates.jenkins-ci.org\&#x2F;download&#x2F;https:\&#x2F;\&#x2F;mirrors.tuna.tsinghua.edu.cn\&#x2F;jenkins&#x2F;g&#39; default.json &amp;&amp; sed -i &#39;s&#x2F;http:\&#x2F;\&#x2F;www.google.com&#x2F;https:\&#x2F;\&#x2F;www.baidu.com&#x2F;g&#39; default.json</span><br></pre></td></tr></table></figure>

<p>搜索蓝海插件并安装：blue ocean</p>
<p>验证jenkins容器状态：</p>
<p>1、是否是root用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker ps -a | grep jenkins</span><br><span class="line"># docker exec -it 8ff92f08e3aa &#x2F;bin&#x2F;bash</span><br><span class="line"># whoami</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203165445440-610903170.png" alt="img"></p>
<p>2、时区是否是东八区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># date</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203165507623-1969196294.png" alt="img"></p>
<p>3、是否使用宿主机docker引擎,在容器内查看宿主机上的docker资源情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker ps </span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203165556025-1179815135.png" alt="img"></p>
<p>4、是否能免密访问gitee</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ssh -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa -T git@gitee.com</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203170039528-832937712.png" alt="img"></p>
<p>5、是否能访问harbor私有仓库 ：原因是我们挂载了宿主机的docker config.json</p>
<p> <img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203165845072-313858884.png" alt="img"></p>
<p>完成验证以上内容后，证明我们基于本次实验环境的jenkins容器已经安装配置完成了。</p>
<h1 id="kubernetes实战-交付dubbo服务到k8s集群（三）安装配置maven和java运行时环境的底包镜像"><a href="#kubernetes实战-交付dubbo服务到k8s集群（三）安装配置maven和java运行时环境的底包镜像" class="headerlink" title="kubernetes实战-交付dubbo服务到k8s集群（三）安装配置maven和java运行时环境的底包镜像"></a>kubernetes实战-交付dubbo服务到k8s集群（三）安装配置maven和java运行时环境的底包镜像</h1><p>maven 官方地址： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://archive.apache.org/dist/maven/maven-3/">官方地址</a></p>
<p>下载maven，shdd7-200</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># wget https:&#x2F;&#x2F;archive.apache.org&#x2F;dist&#x2F;maven&#x2F;maven-3&#x2F;3.6.1&#x2F;binaries&#x2F;apache-maven-3.6.1-bin.tar.gz</span><br><span class="line"># mkdir &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home&#x2F;maven-3.6.1-8u232</span><br><span class="line"># tar -zxf apache-maven-3.6.1-bin.tar.gz -C &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home&#x2F;maven-3.6.1-8u232&#x2F;</span><br><span class="line"># cd &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home&#x2F;maven-3.6.1-8u232</span><br><span class="line"># mv apache-maven-3.6.1&#x2F;* .&#x2F;</span><br><span class="line"># rm -rf apache-maven-3.6.1&#x2F;</span><br></pre></td></tr></table></figure>

<p>初始化maven配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;data&#x2F;nfs-volume&#x2F;jenkins_home&#x2F;maven-3.6.1-8u232&#x2F;conf&#x2F;settings.xml </span><br><span class="line">&lt;mirror&gt;</span><br><span class="line">  &lt;id&gt;nexus-aliyun&lt;&#x2F;id&gt;</span><br><span class="line">  &lt;mirrorOf&gt;*&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">  &lt;name&gt;Nexus aliyun&lt;&#x2F;name&gt;</span><br><span class="line">  &lt;url&gt;http:&#x2F;&#x2F;maven.aliyun.com&#x2F;nexus&#x2F;content&#x2F;groups&#x2F;public&lt;&#x2F;url&gt;</span><br><span class="line">&lt;&#x2F;mirror&gt;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/kococ/TYPECHO_IMG/mu77/1034759-20191203171903321-603678527.png" alt="img"></p>
<p>制作dubbo微服务底包镜像：JAVA运行时环境的底包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker push stanleyws&#x2F;jre8:8u112</span><br><span class="line"># docker tag fa3a085d6ef1 harbor.kococ.cn&#x2F;public&#x2F;jre:8u112</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;jre:8u112</span><br></pre></td></tr></table></figure>

<p>创建Dockerfile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;dockerfile&#x2F;</span><br><span class="line"># mkdir jre8</span><br><span class="line"># cd jre8</span><br><span class="line"># vi Dockerfile</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM harbor.kococ.cn&#x2F;public&#x2F;jre:8u112</span><br><span class="line">RUN &#x2F;bin&#x2F;cp &#x2F;usr&#x2F;share&#x2F;zoneinfo&#x2F;Asia&#x2F;Shanghai &#x2F;etc&#x2F;localtime &amp;&amp;\</span><br><span class="line">    echo &#39;Asia&#x2F;Shanghai&#39; &gt;&#x2F;etc&#x2F;timezone</span><br><span class="line">ADD config.yml &#x2F;opt&#x2F;prom&#x2F;config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar &#x2F;opt&#x2F;prom&#x2F;</span><br><span class="line">WORKDIR &#x2F;opt&#x2F;project_dir</span><br><span class="line">ADD entrypoint.sh &#x2F;entrypoint.sh</span><br><span class="line">CMD [&quot;&#x2F;entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure>



<p>创建Dockerfile所需文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># vi config.yml</span><br><span class="line">--- </span><br><span class="line">rules: </span><br><span class="line"> - pattern: &#39;.*&#39;</span><br></pre></td></tr></table></figure>

<p>下载jmx_javaagent,监控jvm信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;io&#x2F;prometheus&#x2F;jmx&#x2F;jmx_prometheus_javaagent&#x2F;0.3.1&#x2F;jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure>

<p>创建entrypoint.sh：<strong>使用exec 来运行java的jar包，能够使脚本将自己的pid 为‘1’ 传递给java进程，避免docker容器因没有前台进程而退出。并且不要加&amp;符。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi entrypoint.sh</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">M_OPTS&#x3D;&quot;-Duser.timezone&#x3D;Asia&#x2F;Shanghai -javaagent:&#x2F;opt&#x2F;prom&#x2F;jmx_javaagent-0.3.1.jar&#x3D;$(hostname -i):$&#123;M_PORT:-&quot;12346&quot;&#125;:&#x2F;opt&#x2F;prom&#x2F;config.yml&quot;</span><br><span class="line">C_OPTS&#x3D;$&#123;C_OPTS&#125;</span><br><span class="line">JAR_BALL&#x3D;$&#123;JAR_BALL&#125;</span><br><span class="line">exec java -jar $&#123;M_OPTS&#125; $&#123;C_OPTS&#125; $&#123;JAR_BALL&#125;</span><br></pre></td></tr></table></figure>



<p>执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chmod u+x entrypoint.sh</span><br></pre></td></tr></table></figure>

<p>执行docker build：base仓库自行创建，权限公开</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker build . -t harbor.kococ.cn&#x2F;base&#x2F;jre8:8u112</span><br></pre></td></tr></table></figure>



<h1 id="kubernetes实战-交付dubbo服务到k8s集群（四）使用blue-ocean流水线构建dubbo-demo-service"><a href="#kubernetes实战-交付dubbo服务到k8s集群（四）使用blue-ocean流水线构建dubbo-demo-service" class="headerlink" title="kubernetes实战-交付dubbo服务到k8s集群（四）使用blue ocean流水线构建dubbo-demo-service"></a>kubernetes实战-交付dubbo服务到k8s集群（四）使用blue ocean流水线构建dubbo-demo-service</h1><p>使用jenkins创建一个新的项目：dubbo-demo,选择流水线构建</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203180042177-1510394754.png" alt="img"></p>
<p> 勾选保存构建历史和指定项目为参数化构建项目：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203180042177-1510394754.png" alt="img"></p>
<p>添加构建参数：以下配置项，是王导根据多年生产经验总结出来的<strong>甩锅大法</strong>：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203181514853-2140160446.png" alt="img"></p>
<p>除了base_image和maven是choice parameter，其他都是string parameter</p>
<p>添加完成后，效果如图：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203184033235-840482716.png" alt="img"></p>
<p> 编写pipeline:仔细查看这个pipeline，里面都是我们上面编写的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any </span><br><span class="line">    stages &#123;</span><br><span class="line">      stage(&#39;pull&#39;) &#123; &#x2F;&#x2F;get project code from repo </span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;git clone $&#123;params.git_repo&#125; $&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125; &amp;&amp; git checkout $&#123;params.git_ver&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&#39;build&#39;) &#123; &#x2F;&#x2F;exec mvn cmd</span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;cd $&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125;  &amp;&amp; &#x2F;var&#x2F;jenkins_home&#x2F;maven-$&#123;params.maven&#125;&#x2F;bin&#x2F;$&#123;params.mvn_cmd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&#39;package&#39;) &#123; &#x2F;&#x2F;move jar file into project_dir</span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;cd $&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.target_dir&#125; &amp;&amp; mkdir project_dir &amp;&amp; mv *.jar .&#x2F;project_dir&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&#39;image&#39;) &#123; &#x2F;&#x2F;build image and push to registry</span><br><span class="line">        steps &#123;</span><br><span class="line">          writeFile file: &quot;$&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125;&#x2F;Dockerfile&quot;, text: &quot;&quot;&quot;FROM harbor.kococ.cn&#x2F;$&#123;params.base_image&#125;</span><br><span class="line">ADD $&#123;params.target_dir&#125;&#x2F;project_dir &#x2F;opt&#x2F;project_dir&quot;&quot;&quot;</span><br><span class="line">          sh &quot;cd  $&#123;params.app_name&#125;&#x2F;$&#123;env.BUILD_NUMBER&#125; &amp;&amp; docker build -t harbor.kococ.cn&#x2F;$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125; . &amp;&amp; docker push harbor.kococ.cn&#x2F;$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203184959067-708998069.png" alt="img"></p>
<p> <strong>完成第一次构建：填写我们刚才配置的参数化构建参数：</strong></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203185132374-366958806.png" alt="img"></p>
<p><strong>填写完以后执行bulid：第一次构建需要下载很多依赖包，时间很长，抽根烟，喝杯茶~</strong></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203185726935-8648216.png" alt="img"></p>
<p> 经过漫长的等待后，已经构建完成了，可以点击open blue ocean 查看构建历史及过程：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203192252033-1883276642.png" alt="img"></p>
<p> 检查harbor是否已经有这版镜像：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203192356152-1303859737.png" alt="img"></p>
<p>已经有了，接下来交付dubbo-demo-service服务到个人\个人\k8s：</p>
<p>准备个人\个人\k8s资源配置清单：7-200 <strong>红色部分，需要根据自己构建镜像的tag来进行修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-server&#x2F;</span><br><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-server</span><br><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-service:master_191201_1200</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>由于我们使用的harbor私有镜像的项目是app，是个私有项目，所以需要创建secret资源：</p>
<p>创建 app命名空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create ns app</span><br></pre></td></tr></table></figure>

<p>创建secret资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create secret docker-registry harbor --docker-server&#x3D;harbor.kococ.cn --docker-username&#x3D;admin --docker-password&#x3D;Harbor12345 -n app</span><br></pre></td></tr></table></figure>

<p>应用资源配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-server&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p>检查pod是否创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203194609759-1456128063.png" alt="img"></p>
<p> 检查是否启动成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl logs dubbo-demo-service-77b687c6f8-v556v -n app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203194700522-516827915.png" alt="img"></p>
<p> 检查dubbo-server服务是否已经注册到了zookeeper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># sh &#x2F;opt&#x2F;zookeeper&#x2F;bin&#x2F;zkCli.sh</span><br><span class="line"># ls &#x2F;</span><br><span class="line"># ls &#x2F;dubbo</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191203195337128-394541579.png" alt="img"></p>
<p>至此，dubbo-demo-service就已经交付到个人\个人\k8s中了。</p>
<h1 id="kubernetes实战-交付dubbo服务到k8s集群（五）交付dubbo-monitor监控服务到k8s"><a href="#kubernetes实战-交付dubbo服务到k8s集群（五）交付dubbo-monitor监控服务到k8s" class="headerlink" title="kubernetes实战-交付dubbo服务到k8s集群（五）交付dubbo-monitor监控服务到k8s"></a>kubernetes实战-交付dubbo服务到k8s集群（五）交付dubbo-monitor监控服务到k8s</h1><p>首先下载 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Jeromefromcn/dubbo-monitor.git">dubbo-monitor源码包 </a>7-200</p>
<p>dubbo-monitor是监控zookeeper状态的一个服务，另外还有dubbo-admin，效果一样，感兴趣的可以自己研究一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;src</span><br><span class="line"># wget https:&#x2F;&#x2F;github.com&#x2F;Jeromefromcn&#x2F;dubbo-monitor&#x2F;archive&#x2F;master.zip</span><br><span class="line"># yum -y install unzip</span><br><span class="line"># unzip master.zip</span><br><span class="line"># mv dubbo-monitor-mster dubbo-monitor</span><br><span class="line"># cd &#x2F;opt&#x2F;src&#x2F;dubbo-monitor</span><br></pre></td></tr></table></figure>

<p>修改配置文件：对应修改，不要全部删除内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;opt&#x2F;src&#x2F;dubbo-monitor&#x2F;dubbo-monitor-simple&#x2F;conf&#x2F;dubbo_origin.properties</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;zk1.kococ.cn:2181?backup&#x3D;zk2.kococ.cn:2181,zk3.kococ.cn:2181</span><br><span class="line">dubbo.protocol.port&#x3D;20880</span><br><span class="line">dubbo.jetty.port&#x3D;8080</span><br><span class="line">dubbo.jetty.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;monitor</span><br><span class="line">dubbo.statistics.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;statistics</span><br><span class="line">dubbo.charts.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;charts</span><br><span class="line">dubbo.log4j.file&#x3D;logs&#x2F;dubbo-monitor.log</span><br></pre></td></tr></table></figure>



<p>优化修改Dockerfile并限制jvm资源，将最后的exec命令的后台&amp;符号删除，并且将exec命令下面的都干掉：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sed -r -i -e &#39;&#x2F;^nohup&#x2F;&#123;p;:a;N;$!ba;d&#125;&#39;  .&#x2F;dubbo-monitor-simple&#x2F;bin&#x2F;start.sh &amp;&amp; sed  -r -i -e &quot;s%^nohup(.*)%exec \1%&quot;  .&#x2F;dubbo-monitor-simple&#x2F;bin&#x2F;start.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204170257428-630090879.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204170348252-2119039276.png" alt="img"></p>
<p>执行docker build并上传镜像到我们的私有仓库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cp -a dubbo-monitor&#x2F; &#x2F;data&#x2F;dockerfile&#x2F;</span><br><span class="line"># cd &#x2F;data&#x2F;dockerfile&#x2F;dubbo-monitor</span><br><span class="line"># docker build . -t harbor.kococ.cn&#x2F;infra&#x2F;dubbo-monitor:latest</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;infra&#x2F;dubbo-monitor:latest</span><br></pre></td></tr></table></figure>

<p>制作资源配置清单：</p>
<p>1、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-monitor</span><br><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-monitor</span><br><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-monitor</span><br><span class="line">        name: dubbo-monitor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-monitor</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;dubbo-monitor:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>2、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-monitor</span><br></pre></td></tr></table></figure>



<p>3、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi ingress.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dubbo-monitor.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: dubbo-monitor</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：node节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n infra</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204172205205-1999264565.png" alt="img"></p>
<p>这个服务是有web页面的，我们添加dns解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204172558908-1186059488.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl restart named</span><br><span class="line"># dig -t A dubbo-monitor.kococ.cn @10.4.7.11 +short</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204172706557-975888331.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204172824046-788139848.png" alt="img"></p>
<p> 这里已经可以看到我们之前部署的dubbo-demo-service服务了，启动了两个进程来提供服务。</p>
<p> 至此，dubbo-monitor监控服务已经部署完成。</p>
<h1 id="kubernetes实战-交付dubbo服务到k8s集群（六）使用blue-ocean流水线构建dubbo-consumer服务"><a href="#kubernetes实战-交付dubbo服务到k8s集群（六）使用blue-ocean流水线构建dubbo-consumer服务" class="headerlink" title="kubernetes实战-交付dubbo服务到k8s集群（六）使用blue ocean流水线构建dubbo-consumer服务"></a>kubernetes实战-交付dubbo服务到k8s集群（六）使用blue ocean流水线构建dubbo-consumer服务</h1><p>我们这里的dubbo-consumer是dubbo-demo-service的消费者：</p>
<p>我们之前已经在jenkins配置好了流水线，只需要填写参数就行了。</p>
<p>由于dubbo-consumer用的gitee的私有仓库，需要添加公钥，这里大家可以自己找个client服务来做实验。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204182953280-549617155.png" alt="img"></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204182149184-1988121109.png" alt="img"></p>
<p>下面是我们通过jenkins构建的镜像，已经上传到我们的harbor私有仓库当中了：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204184217980-511779709.png" alt="img"></p>
<p> 这里我们构建了两次，构建了两个镜像，11bb9cd这个用来做模拟生产发版更新实验。</p>
<p>准备资源配置清单：</p>
<p>1、dp.yaml <strong>红色部分根据实际镜像tag修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-consumer</span><br><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;dubbo-consumer</span><br><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-consumer:master_191201_1600</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>2、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi svc.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-demo-consumer</span><br></pre></td></tr></table></figure>



<p>3、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi ingress.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: demo.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: dubbo-demo-consumer</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>





<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-consumer&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-consumer&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-consumer&#x2F;ingress.yaml</span><br><span class="line"># kubectl get pod -n app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204185606980-173323108.png" alt="img"></p>
<p> 查看log，是否启动成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl logs dubbo-demo-consumer-f8d5f5f74-dgmqd -n app</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204185706184-726464405.png" alt="img"></p>
<p>检查dubbo-monitor是否已经注册成功：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204185901594-1794752720.png" alt="img"></p>
<p>添加个dns解析，来验证：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190330710-1152106839.png" alt="img"></p>
<p> 浏览器访问<a target="_blank" rel="noopener external nofollow noreferrer" href="http://demo.kococ.cn/hello?name=slim">http://demo.kococ.cn/hello?name=slim</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190424208-1227852511.png" alt="img"></p>
<p> 接下来我们模拟升级发版，我们提前修改了代码，并提交到了git仓库，发版的前提是使用jenkins提前构建了镜像并且上传到了我们的私有harbor仓库中，具体的构建流程不在赘述，只需要将远程git仓库的版本修改后构建就行了。</p>
<p>修改dp.yaml资源配置清单，修改harbor镜像仓库中对应的tag版本：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190648470-1335170472.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi dp.yaml</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190718713-1299242715.png" alt="img"></p>
<p> 应用修改后的资源配置清单，当然也可以在dashboard中进行在线修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-consumer&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190846796-129289757.png" alt="img"></p>
<p> 已经启动起来了，使用浏览器验证：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://demo.kococ.cn/hello?name=slim">http://demo.kococ.cn/hello?name=slim</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191204190916621-98388740.png" alt="img"></p>
<p>至此，我们一套完成的dubbo服务就已经交付到k8s集群当中了，并且也演示了如何发版。</p>
<h1 id="kubernetes实战-配置中心（一）configmap资源"><a href="#kubernetes实战-配置中心（一）configmap资源" class="headerlink" title="kubernetes实战-配置中心（一）configmap资源"></a>kubernetes实战-配置中心（一）configmap资源</h1><p>在我们的环境中测试使用configmap资源，需要先对我们的环境进行一些准备，首先将dubbo服务调整为0个pod ，然后把zookeeper进行拆分：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206152200951-1152409322.png" alt="img"></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206152906998-1949229974.png" alt="img"></p>
<p> 拆分zk环境，模拟测试环境跟生产环境：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206152002087-1033990054.png" alt="img"></p>
<p>停止zookeeper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># sh &#x2F;opt&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh stop</span><br><span class="line"># rm -rf &#x2F;data&#x2F;zookeeper&#x2F;data&#x2F;*</span><br><span class="line"># rm -rf &#x2F;data&#x2F;zookeeper&#x2F;logs&#x2F;*</span><br><span class="line"># vi &#x2F;opt&#x2F;zookeeper&#x2F;conf&#x2F;zoo.cfg</span><br></pre></td></tr></table></figure>

<p>注释掉集群配置：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206160332428-705993688.png" alt="img"></p>
<p> 启动zookeeper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># sh &#x2F;opt&#x2F;zookeeper&#x2F;bin&#x2F;zkServer.sh start</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206160503691-1722226541.png" alt="img"></p>
<p> 创建资源配置清单：</p>
<p>1、cm.yaml 红色部分是配置文件的name，下面的是内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  dubbo.properties: |</span><br><span class="line">    dubbo.container&#x3D;log4j,spring,registry,jetty</span><br><span class="line">    dubbo.application.name&#x3D;simple-monitor</span><br><span class="line">    dubbo.application.owner&#x3D;OldboyEdu</span><br><span class="line">    dubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;zk1.kococ.cn:2181</span><br><span class="line">    dubbo.protocol.port&#x3D;20880</span><br><span class="line">    dubbo.jetty.port&#x3D;8080</span><br><span class="line">    dubbo.jetty.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;monitor</span><br><span class="line">    dubbo.charts.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;charts</span><br><span class="line">    dubbo.statistics.directory&#x3D;&#x2F;dubbo-monitor-simple&#x2F;statistics</span><br><span class="line">    dubbo.log4j.file&#x3D;&#x2F;dubbo-monitor-simple&#x2F;logs&#x2F;dubbo-monitor.log</span><br><span class="line">    dubbo.log4j.level&#x3D;WARN</span><br></pre></td></tr></table></figure>



<p>2、dp-cm.yaml</p>
<p>在dp里面如何使用configmap资源：</p>
<p>首先声明一个卷，卷的名字叫configmap-volume,然后指定这个卷使用的configmap</p>
<p>然后定义这个卷的挂载，挂载到哪里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi dp-cm.yaml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-monitor</span><br><span class="line">        name: dubbo-monitor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-monitor</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;dubbo-monitor:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: configmap-volume</span><br><span class="line">            mountPath: &#x2F;dubbo-monitor-simple&#x2F;conf</span><br><span class="line">      volumes:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: dubbo-monitor-cm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;cm.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;dp-cm.yaml</span><br></pre></td></tr></table></figure>

<p>去dashboard查看configmap资源：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206162727749-1572811779.png" alt="img"></p>
<p>我们可以创建多个configmap资源，然后在dp中去挂载应用这些configmap资源，达到修改配置的功能。</p>
<p>我们检查一下我们的容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n infra</span><br></pre></td></tr></table></figure>

<p>已经起来了</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206163613708-1755986854.png" alt="img"></p>
<p> 我们检查一下我们挂载的配置是不是我们定义的configmap资源中的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl exec -it dubbo-monitor-6676dd74cc-pvf2f -n infra &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>

<p>我们把配置文件挂载到了**/dubbo-monitor-simple/<strong>**conf</strong> 这里，我们去看一下。（上面的dp-cm.yaml中声明的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cat &#x2F;dubbo-monitor-simple&#x2F;conf&#x2F;dubbo.properties</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206163854491-1881028587.png" alt="img"></p>
<p> 跟我们定义的一模一样。</p>
<p>这里如果想更换配置，有两种方法：</p>
<p>　　一、修改configmap 资源，然后apply一下更新资源，然后重启挂载这个configmap资源的dp。</p>
<p>　　二、准备多个configmap资源，然后在dp中更改挂载的configmap,apply以后，dp自动重启。</p>
<p>检查dubbo-monitor页面的注册信息：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206165345407-471585294.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206165403504-1421689285.png" alt="img"></p>
<p>连接的zk1.kococ.cn，下面我们模拟更换configmap资源，来切换环境：</p>
<p>这里使用第二种方法，准备多个configmap，我们在准备一个configmap,就叫cm-pro.yaml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp cm.yaml cm-pro.yaml</span><br><span class="line"># vi cm-pro.yaml</span><br></pre></td></tr></table></figure>

<p>然后我们把服务注册到zk2.kococ.cn上：</p>
<p>把资源名字改成dubbo-monitor-cm-pro</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206165858875-962602223.png" alt="img"></p>
<p> 把服务注册到zk2上：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206165703012-1393173343.png" alt="img"></p>
<p> 应用一下cm-pro.yaml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;cm-pro.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170016686-52804254.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170032252-234364529.png" alt="img"></p>
<p> 然后我们修改dp-cm.yaml:</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170127881-234365593.png" alt="img"></p>
<p> 然后apply这个dp-cm.yaml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-monitor&#x2F;dp-cm.yaml</span><br></pre></td></tr></table></figure>

<p>新的已经起来了，我们进去看看是不是应用的新的configmap配置：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170323857-307632334.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl exec -it dubbo-monitor-5cb756cc6c-xtnrt -n infra &#x2F;bin&#x2F;bash</span><br><span class="line"># cat &#x2F;dubbo-monitor-simple&#x2F;conf&#x2F;dubbo.properties </span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170428519-1061937897.png" alt="img"></p>
<p> 已经生效了。</p>
<p><strong>更新configmap资源来更改配置需要更新(删除/apply/update)pod，否则无效。</strong></p>
<p>看下dubbo-monitor的页面：已经是zk2了。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206170524240-1778093972.png" alt="img"></p>
<p>但是注意，我们这里使用的是mountPath，这个是挂载整个目录，会使容器内的被挂载目录中原有的文件不可见，可以看见我们原来脚本中的命令已经无法对挂载的目录操作了。</p>
<p>查看我们pod容器启动的命令可以看见：如果想单独挂载一个配置配件，而不是整个目录，如何操作：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206163227083-533233850.png" alt="img"></p>
<p>这里我使用之前的nginx:curl来做如何挂载单个的文件：</p>
<p>查看资源key的使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl explain pod.spec.containers.volumeMounts</span><br></pre></td></tr></table></figure>

<p>这里有个挂载方法是：subPath,使用这个方法，可以挂载指定的文件，要结合mountPath来使用：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206174308385-1399833041.png" alt="img"></p>
<p>查看我们原来实验做的nginx:curl这个容器：在default命名空间里。</p>
<p>我们实验的需求，把<strong>dubbo.properties</strong>这个配置文件挂载到/usr/lib/目录下，并且保证原来容器内/usr/lib/目录下的文件都还在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206174637314-738116987.png" alt="img"></p>
<p> 进入容器查看容器内/usr/lib/下有哪些文件：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206175137440-354418017.png" alt="img"></p>
<p>在default命名空间下创建configmap资源：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206175731510-1447265675.png" alt="img"></p>
<p> 应用configmap资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;nginx-ds&#x2F;cm.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206175920895-1307672044.png" alt="img"></p>
<p>然后修改这个容器的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl edit ds nginx-ds -n default</span><br></pre></td></tr></table></figure>

<p>挂载configmap资源：一定要注意格式跟缩进<del>~</del></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206182032491-2128792466.png" alt="img"></p>
<p> 然后重启pod</p>
<p>登录进容器中，查看：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191206182217982-1739358712.png" alt="img"></p>
<p><img src="C:\Users\mu77ops\Desktop\个人\个人\k8s\img\1034759-20191206175137440-354418017.png" alt="img"></p>
<p> 经过对比，我们原来/usr/lib/下的文件还在，并且新增了一个配置文件dubbo-properties这个配置文件。</p>
<h1 id="kubernetes实战-配置中心（二）交付apollo配置中心到k8s"><a href="#kubernetes实战-配置中心（二）交付apollo配置中心到k8s" class="headerlink" title="kubernetes实战-配置中心（二）交付apollo配置中心到k8s"></a>kubernetes实战-配置中心（二）交付apollo配置中心到k8s</h1><p>apollo官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ctripcorp/apollo">官方地址</a></p>
<p>apollo架构图：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211110416988-457984528.png" alt="img"></p>
<p>apollo需要使用数据库，这里使用mysql，注意版本需要在5.6以上：</p>
<p>本次环境mysql部署在10.4.7.11上，使用mariadb：10.1以上版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;yum.repos.d&#x2F;MariaDB.repo</span><br><span class="line">[mariadb]</span><br><span class="line">name &#x3D; MariaDB</span><br><span class="line">baseurl &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;mariadb&#x2F;yum&#x2F;10.1&#x2F;centos7-amd64&#x2F;</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;mariadb&#x2F;yum&#x2F;RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck&#x3D;1</span><br></pre></td></tr></table></figure>

<p>导入key：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rpm --import https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;mariadb&#x2F;yum&#x2F;RPM-GPG-KEY-MariaDB</span><br><span class="line"># yum install MariaDB-server -y</span><br></pre></td></tr></table></figure>

<p>简单配置mysql：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;my.cnf.d&#x2F;server.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server &#x3D; utf8mb4</span><br><span class="line">collation_server &#x3D; utf8mb4_general_ci</span><br><span class="line">init_connect &#x3D; &quot;SET NAMES &#39;utf8mb4&#39;&quot;</span><br><span class="line"># vi &#x2F;etc&#x2F;my.cnf.d&#x2F;mysql-clients.cnf</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set &#x3D; utf8mb4</span><br><span class="line"># systemctl start mariadb</span><br><span class="line"># systemctl enable mariadb</span><br><span class="line"># mysqladmin -u root password </span><br></pre></td></tr></table></figure>

<p>登录检查字符集：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mysql -uroot -p</span><br><span class="line">&gt; \s</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211112612161-1900642767.png" alt="img"></p>
<p> 执行数据库初始化脚本：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ctripcorp/apollo/blob/1.5.1/scripts/db/migration/configdb/V1.0.0__initialization.sql">configdb初始化脚本</a></p>
<p>下载脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;ctripcorp&#x2F;apollo&#x2F;1.5.1&#x2F;scripts&#x2F;db&#x2F;migration&#x2F;configdb&#x2F;V1.0.0__initialization.sql -O apolloconfig.sql</span><br></pre></td></tr></table></figure>

<p>执行初始化脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mysql -uroot -p &lt; apolloconfig.sql</span><br></pre></td></tr></table></figure>

<p>检查数据库：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211113247771-1778301598.png" alt="img"></p>
<p> 给数据库授权：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to &#39;apolloconfig&#39;@&#39;10.4.7.%&#39;  identified by &quot;123456&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211114116673-2001410083.png" alt="img"></p>
<p> 修改初始化数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; update ServerConfig set Value&#x3D;&#39;http:&#x2F;&#x2F;config.kococ.cn&#x2F;eureka&#39; where Id&#x3D;1;</span><br><span class="line">也可以使用下面的sql：执行一个即可</span><br></pre></td></tr></table></figure>

<h1 id="kubernetes实战-配置中心（三）配置服务使用apollo配置中心"><a href="#kubernetes实战-配置中心（三）配置服务使用apollo配置中心" class="headerlink" title="kubernetes实战-配置中心（三）配置服务使用apollo配置中心"></a>kubernetes实战-配置中心（三）配置服务使用apollo配置中心</h1><p>使用配置中心，需要开发对代码进行调整，将一些配置，通过变量的形式配置到apollo中，服务通过配置中心来获取具体的配置</p>
<p>在配置中心修改新增如下配置：</p>
<p>项目信息：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211191509591-224073067.png" alt="img"></p>
<p> 配置：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211191453532-1276390692.png" alt="img"></p>
<p> 重新打包镜像，使用apollo版本的代码：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191211191820356-768052077.png" alt="img"></p>
<p> 修改dp.yaml，将镜像使用我们刚刚打包的这个：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212165021897-875544258.png" alt="img"></p>
<p> 应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;dubbo-server&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p>创建dubbo服务消费者：</p>
<p>apollo中新建一个项目：dubbo-demo-web,新建配置dubbo.registry,值为zookeeper地址</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212171234674-1033346701.png" alt="img"></p>
<p>使用jenkins重新打包构建一版镜像： <a href="mailto:&#x67;&#105;&#116;&#64;&#103;&#105;&#116;&#x65;&#x65;&#46;&#x63;&#111;&#109;" rel="external nofollow noreferrer">&#x67;&#105;&#116;&#64;&#103;&#105;&#116;&#x65;&#x65;&#46;&#x63;&#111;&#109;</a>:stanleywang/dubbo-demo-web.git</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212171435845-1940297947.png" alt="img"></p>
<p> 构建完成后，修改资源配置清单并应用：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212172433630-1495231734.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212172612084-965629920.png" alt="img"></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212172635322-132994833.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191212172732355-402822084.png" alt="img"></p>
<p> kubernetes实战-配置中心（四）分环境使用apollo配置中心</p>
<p>要进行分环境，需要将现有实验环境进行拆分</p>
<p><strong>portal服务，可以各个环境共用，但是apollo-adminservice和apollo-configservice必须要分开。</strong></p>
<p>1、zk环境拆分为test和prod环境</p>
<p>添加dns解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br></pre></td></tr></table></figure>

<p>zk-test.kococ.cn    A    10.4.7.11</p>
<p>zk-prod.kococ.cn   A    10.4.7.12</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214163421698-1711732614.png" alt="img"></p>
<p>2、namespace 分环境，创建test 和prod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create ns test</span><br><span class="line"># kubectl create ns prod</span><br></pre></td></tr></table></figure>

<p>创建secret：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create secret docker-registry harbor --docker-server&#x3D;harbor.kococ.cn --docker-username&#x3D;harbor --docker-password&#x3D;Harbor12345 -n test</span><br><span class="line"></span><br><span class="line"># kubectl create secret docker-registry harbor --docker-server&#x3D;harbor.kococ.cn --docker-username&#x3D;harbor --docker-password&#x3D;Harbor12345 -n prod</span><br></pre></td></tr></table></figure>

<p>3、数据库进行拆分，因实验资源有限，故使用分库的形式模拟分环境</p>
<p>修改数据库初始化脚本，分别创建ApolloConfigTestDB和ApolloConfigProdDB</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214165050503-1289549000.png" alt="img"></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214165155176-1839439337.png" alt="img"></p>
<p> 修改数据库中eureka的地址，这里用到了两个新的域名，自行在bind9中添加解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; update ApolloConfigProdDB.ServerConfig set ServerConfig.Value&#x3D;&quot;http:&#x2F;&#x2F;config-prod.kococ.cn&#x2F;eureka&quot; where ServerConfig.Key&#x3D;&quot;eureka.service.url&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to &quot;apolloconfig&quot;@&quot;10.4.7.%&quot; identified by &quot;123456&quot;;</span><br><span class="line"></span><br><span class="line">&gt; update ApolloConfigTestDB.ServerConfig set ServerConfig.Value&#x3D;&quot;http:&#x2F;&#x2F;config-test.kococ.cn&#x2F;eureka&quot; where ServerConfig.Key&#x3D;&quot;eureka.service.url&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to &quot;apolloconfig&quot;@&quot;10.4.7.%&quot; identified by &quot;123456&quot;;</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214165539852-746921994.png" alt="img"></p>
<p>修改portal数据，支持fat和pro环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; update ServerConfig set Value&#x3D;&#39;fat,pro&#39; where Id&#x3D;1;</span><br></pre></td></tr></table></figure>

<p>修改portal的cm资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;data&#x2F;k8s-yaml&#x2F;apollo-portal&#x2F;cm.yaml</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214170042505-861528126.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;apollo-portal&#x2F;cm.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214170419427-36077926.png" alt="img"></p>
<p>分别创建修改两个环境的资源配置文件：</p>
<p>test：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml</span><br><span class="line"># mkdir -p test&#x2F;&#123;apollo-adminservice,apollo-configservice,dubbo-demo-server,dubbo-demo-consumer&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># mkdir -p prod&#x2F;&#123;apollo-adminservice,apollo-configservice,dubbo-demo-server,dubbo-demo-consumer&#125;</span><br></pre></td></tr></table></figure>

<p>将之前的资源配置清单cp到对应环境的目录中，进行修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd  test&#x2F;apollo-configservice&#x2F;</span><br><span class="line"># cp ..&#x2F;..&#x2F;apollo-configservice&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、cm.yaml 修改ns，数据库库名，eureka地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice-cm</span><br><span class="line">  namespace: test</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;mysql.kococ.cn:3306&#x2F;ApolloConfigTestDB?characterEncoding&#x3D;utf8</span><br><span class="line">    spring.datasource.username &#x3D; apolloconfig</span><br><span class="line">    spring.datasource.password &#x3D; 123456</span><br><span class="line">    eureka.service.url &#x3D; http:&#x2F;&#x2F;config-test.kococ.cn&#x2F;eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId&#x3D;100003171</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: test </span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-configservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-configservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-configservice </span><br><span class="line">        name: apollo-configservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-configservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-configservice</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;apollo-configservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: &#x2F;apollo-configservice&#x2F;config</span><br><span class="line">        terminationMessagePath: &#x2F;dev&#x2F;termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: test </span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: apollo-configservice</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: test </span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: config-test.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: apollo-configservice</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>



<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214204757028-115716474.png" alt="img"></p>
<p> 服务已经注册进来了</p>
<p>接下来部署apollo-adminservice</p>
<p>修改apollo-adminservice的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;apollo-adminservice</span><br><span class="line"># cp ..&#x2F;..&#x2F;apollo-adminservice&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、cm.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice-cm</span><br><span class="line">  namespace: test</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;mysql.kococ.cn:3306&#x2F;ApolloConfigTestDB?characterEncoding&#x3D;utf8</span><br><span class="line">    spring.datasource.username &#x3D; apolloconfig</span><br><span class="line">    spring.datasource.password &#x3D; 123456</span><br><span class="line">    eureka.service.url &#x3D; http:&#x2F;&#x2F;config-test.kococ.cn&#x2F;eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId&#x3D;100003172</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice</span><br><span class="line">  namespace: test </span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-adminservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-adminservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: apollo-adminservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-adminservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-adminservice</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;apollo-adminservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: &#x2F;apollo-adminservice&#x2F;config</span><br><span class="line">        terminationMessagePath: &#x2F;dev&#x2F;termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;apollo-adminservice&#x2F;cm.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;apollo-adminservice&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214205736284-1671020943.png" alt="img"></p>
<p>接下来部署prod环境的apollo-configservice，还是一样的套路：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd ..&#x2F;..&#x2F;prod&#x2F;apollo-configservice&#x2F;</span><br><span class="line"># cp ..&#x2F;..&#x2F;apollo-configservice&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>修改资源配置清单：</p>
<p>1、cm.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice-cm</span><br><span class="line">  namespace: prod</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;mysql.kococ.cn:3306&#x2F;ApolloConfigProdDB?characterEncoding&#x3D;utf8</span><br><span class="line">    spring.datasource.username &#x3D; apolloconfig</span><br><span class="line">    spring.datasource.password &#x3D; 123456</span><br><span class="line">    eureka.service.url &#x3D; http:&#x2F;&#x2F;config-prod.kococ.cn&#x2F;eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId&#x3D;100003171</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: prod </span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-configservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-configservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-configservice </span><br><span class="line">        name: apollo-configservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-configservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-configservice</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;apollo-configservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: &#x2F;apollo-configservice&#x2F;config</span><br><span class="line">        terminationMessagePath: &#x2F;dev&#x2F;termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: prod</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: apollo-configservice</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: prod</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: config-prod.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: apollo-configservice</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-configservice&#x2F;cm.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-configservice&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-configservice&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-configservice&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p>修改apollo-adminservice的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd ..&#x2F;apollo-adminservice&#x2F;</span><br><span class="line"># cp ..&#x2F;..&#x2F;apollo-adminservice&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、cm.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice-cm</span><br><span class="line">  namespace: prod</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;mysql.kococ.cn:3306&#x2F;ApolloConfigProdDB?characterEncoding&#x3D;utf8</span><br><span class="line">    spring.datasource.username &#x3D; apolloconfig</span><br><span class="line">    spring.datasource.password &#x3D; 123456</span><br><span class="line">    eureka.service.url &#x3D; http:&#x2F;&#x2F;config-prod.kococ.cn&#x2F;eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId&#x3D;100003172</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice</span><br><span class="line">  namespace: prod </span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-adminservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-adminservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        name: apollo-adminservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-adminservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-adminservice</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;apollo-adminservice:v1.5.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: &#x2F;apollo-adminservice&#x2F;config</span><br><span class="line">        terminationMessagePath: &#x2F;dev&#x2F;termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-adminservice&#x2F;cm.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;apollo-adminservice&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214212310351-1011324990.png" alt="img"></p>
<p>两个服务都已经注册进来了，删除portal数据库中存储的关于之前项目的配置，接下来启动portal项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># mysql -uroot -p</span><br><span class="line">&gt; use ApolloPortalDB ;</span><br><span class="line">&gt; truncate table App;</span><br><span class="line">&gt; truncate table AppNamespace;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214212517854-1153075154.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214213528868-1456818381.png" alt="img"></p>
<p>打开portal.kococ.cn验证，并且创建两个项目：</p>
<p>首先创建dubbo-demo-service</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214213803923-653264700.png" alt="img"></p>
<p> 添加配置：两个环境都添加上：注意连接地址一个是test.kococ.cn,一个是prod.kococ.cn</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214214212905-915228782.png" alt="img"></p>
<p> 接下来创建dubbo-demo-web项目：同样是两个环境都发布，注意一个是test.kococ.cn,一个是prod.kococ.cn</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214214541219-415571329.png" alt="img"></p>
<p>接下来交付dubbo服务分环境交付：</p>
<p>同样操作，修改之前项目的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-server</span><br><span class="line"># cp ..&#x2F;..&#x2F;dubbo-server&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: test </span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-service:apollo_191211_1916</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv&#x3D;fat -Dapollo.meta&#x3D;http:&#x2F;&#x2F;config-test.kococ.cn</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214214859225-1098759731.png" alt="img"></p>
<p> 接下来交付dubbo-demo-consumer:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;test&#x2F;dubbo-demo-consumer</span><br><span class="line"># cp ..&#x2F;..&#x2F;dubbo-consumer&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test </span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-web:apollo_191212_1715</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv&#x3D;fat -Dapollo.meta&#x3D;http:&#x2F;&#x2F;config-test.kococ.cn</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>2、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: dubbo-demo-consumer</span><br></pre></td></tr></table></figure>



<p>3、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: demo-test.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: dubbo-demo-consumer</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>



<p>这里会用到两个新的域名，添加解析：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214215712256-1053122700.png" alt="img"></p>
<p> 应用test环境的dubbo-consumer资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214215942748-1280830276.png" alt="img"></p>
<p>接下来交付prod环境的dubbo-demo-server和dubbo-demo-consumer服务：</p>
<p>同样套路，复制资源配置清单，然后修改成prod环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;data&#x2F;k8s-yaml&#x2F;prod&#x2F;dubbo-demo-server</span><br><span class="line"># cp ..&#x2F;..&#x2F;dubbo-server&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: prod </span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-service:apollo_191211_1916</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv&#x3D;pro -Dapollo.meta&#x3D;http:&#x2F;&#x2F;config-prod.kococ.cn</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;dubbo-demo-server&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214220552006-1254762527.png" alt="img"></p>
<p> 接下来做dubbo-demo-consumer的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;k8s-yaml&#x2F;prod&#x2F;dubbo-demo-consumer</span><br><span class="line"># cp ..&#x2F;..&#x2F;dubbo-consumer&#x2F;* .&#x2F;</span><br></pre></td></tr></table></figure>

<p>1、dp.yaml  <strong><a target="_blank" rel="noopener external nofollow noreferrer" href="http://apollo-configservice:8080/">http://apollo-configservice:8080</a> 这里可以直接使用svc资源名称调用，不用走ingress，因为svc资源只在当前namespace中生效。</strong></p>
<p><strong><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214222349710-562062556.png" alt="img"></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: prod </span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.kococ.cn&#x2F;app&#x2F;dubbo-demo-web:apollo_191212_1715</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv&#x3D;pro -Dapollo.meta&#x3D;http:&#x2F;&#x2F;apollo-configservice:8080</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>





<p>2、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: prod </span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-demo-consumer</span><br></pre></td></tr></table></figure>





<p>3、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: prod </span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-demo-consumer</span><br><span class="line">[root@hdss7-200 dubbo-demo-consumer]# cat ingress.yaml </span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: prod </span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: demo-prod.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: dubbo-demo-consumer</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;dubbo-demo-consumer&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prod&#x2F;dubbo-demo-consumer&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214221038814-2061052893.png" alt="img"></p>
<p>访问两个环境的不同url：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://demo-test.kococ.cn/">http://demo-test.kococ.cn</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214221153725-1544677039.png" alt="img"></p>
<p> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://demo-prod.kococ.cn/">http://demo-prod.kococ.cn</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214221216571-965731507.png" alt="img"></p>
<p>模拟发版：</p>
<p>使用jenkins构建新的镜像：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214224525002-320211269.png" alt="img"></p>
<p> 构建成功，然后我们在测试环境发布此版本镜像：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214224834931-992581230.png" alt="img"></p>
<p> 修改测试环境的dp.yaml</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214224922504-230549710.png" alt="img"></p>
<p> 应用修改后的资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;test&#x2F;dubbo-demo-consumer&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214225241007-949796109.png" alt="img"></p>
<p>已经成功将新代码上线到test环境，接下来上线到prod环境</p>
<p>同样修改prod环境的dp.yaml,并且应用该资源配置清单：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191214225558477-850571422.png" alt="img"></p>
<p> 已经上线到生产环境，这样一套完整的分环境使用apollo配置中心发布流程已经可以使用了，并且真正做到了一次构建，多平台使用。</p>
<h1 id="kubernetes生态–交付prometheus监控及grafana炫酷dashboard到k8s集群"><a href="#kubernetes生态–交付prometheus监控及grafana炫酷dashboard到k8s集群" class="headerlink" title="kubernetes生态–交付prometheus监控及grafana炫酷dashboard到k8s集群"></a>kubernetes生态–交付prometheus监控及grafana炫酷dashboard到k8s集群</h1><p>由于docker容器的特殊性，传统的zabbix无法对k8s集群内的docker状态进行监控，所以需要使用prometheus来进行监控：</p>
<h2 id="什么是Prometheus"><a href="#什么是Prometheus" class="headerlink" title="什么是Prometheus?"></a>什么是Prometheus?</h2><p>Prometheus是由SoundCloud开发的开源监控报警系统和时序列数据库(TSDB)。Prometheus使用Go语言开发，是Google BorgMon监控系统的开源版本。<br>2016年由Google发起Linux基金会旗下的原生云基金会(Cloud Native Computing Foundation), 将Prometheus纳入其下第二大开源项目。<br>Prometheus目前在开源社区相当活跃。<br>Prometheus和Heapster(Heapster是K8S的一个子项目，用于获取集群的性能数据。)相比功能更完善、更全面。Prometheus性能也足够支撑上万台规模的集群。</p>
<h2 id="Prometheus的特点"><a href="#Prometheus的特点" class="headerlink" title="Prometheus的特点"></a>Prometheus的特点</h2><ul>
<li><ul>
<li>多维度数据模型。</li>
<li>灵活的查询语言。</li>
<li>不依赖分布式存储，单个服务器节点是自主的。</li>
<li>通过基于HTTP的pull方式采集时序数据。</li>
<li>可以通过中间网关进行时序列数据推送。</li>
<li>通过服务发现或者静态配置来发现目标服务对象。</li>
<li>支持多种多样的图表和界面展示，比如Grafana等。</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217174524209-1830352204.png" alt="img"></p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>Prometheus的基本原理是通过HTTP协议周期性抓取被监控组件的状态，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。输出被监控组件信息的HTTP接口被叫做exporter 。目前互联网公司常用的组件大部分都有exporter可以直接使用，比如Varnish、Haproxy、Nginx、MySQL、Linux系统信息(包括磁盘、内存、CPU、网络等等)。</p>
<h2 id="服务过程"><a href="#服务过程" class="headerlink" title="服务过程"></a>服务过程</h2><ul>
<li>Prometheus Daemon负责定时去目标上抓取metrics(指标)数据，每个抓取目标需要暴露一个http服务的接口给它定时抓取。Prometheus支持通过配置文件、文本文件、Zookeeper、Consul、DNS SRV Lookup等方式指定抓取目标。Prometheus采用PULL的方式进行监控，即服务器可以直接通过目标PULL数据或者间接地通过中间网关来Push数据。</li>
<li>Prometheus在本地存储抓取的所有数据，并通过一定规则进行清理和整理数据，并把得到的结果存储到新的时间序列中。</li>
<li>Prometheus通过PromQL和其他API可视化地展示收集的数据。Prometheus支持很多方式的图表可视化，例如Grafana、自带的Promdash以及自身提供的模版引擎等等。Prometheus还提供HTTP API的查询方式，自定义所需要的输出。</li>
<li>PushGateway支持Client主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。</li>
<li>Alertmanager是独立于Prometheus的一个组件，可以支持Prometheus的查询语句，提供十分灵活的报警方式。</li>
</ul>
<h2 id="三大套件"><a href="#三大套件" class="headerlink" title="三大套件"></a>三大套件</h2><ul>
<li>Server 主要负责数据采集和存储，提供PromQL查询语言的支持。</li>
<li>Alertmanager 警告管理器，用来进行报警。</li>
<li>Push Gateway 支持临时性Job主动推送指标的中间网关。</li>
</ul>
<p>prometheus不同于zabbix，没有agent，使用的是针对不同服务的exporter：</p>
<p>prometheus官网：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://prometheus.io/">官网地址</a></p>
<p>正常情况下，监控k8s集群及node，pod，常用的exporter有四个：</p>
<ul>
<li><strong>kube-state-metrics – 收集k8s集群master&amp;etcd等基本状态信息</strong></li>
<li><strong>node-exporter – 收集k8s集群node信息</strong></li>
<li><strong>cadvisor – 收集k8s集群docker容器内部使用资源信息</strong></li>
<li><strong>blackbox-exporte – 收集k8s集群docker容器服务是否存活</strong></li>
</ul>
<p>接下来逐一创建以上exporter：</p>
<p>老套路，下载docker镜像，准备资源配置清单，应用资源配置清单：</p>
<p><strong>一、kube-state-metrics</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull quay.io&#x2F;coreos&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line"># docker tag 91599517197a harbor.kococ.cn&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br></pre></td></tr></table></figure>

<p>准备资源配置清单：</p>
<p>1、rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;data&#x2F;k8s-yaml&#x2F;kube-state-metrics &amp;&amp; cd &#x2F;data&#x2F;k8s-yaml&#x2F;kube-state-metrics</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - policy</span><br><span class="line">  resources:</span><br><span class="line">  - poddisruptionbudgets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - batch</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - jobs</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - autoscaling</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: &quot;2&quot;</span><br><span class="line">  labels:</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;kube-state-metrics:v1.5.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;kube-state-metrics&#x2F;rbac.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;kube-state-metrics&#x2F;dp.yaml</span><br></pre></td></tr></table></figure>

<p>测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217180718964-1295555935.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># curl http:&#x2F;&#x2F;172.7.22.10:8080&#x2F;healthz</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217180813579-382804868.png" alt="img"></p>
<p> 已经成功运行。</p>
<p><strong>二、**</strong>node-exporter**</p>
<p><strong>由于node-exporter是监控node的，所有需要每个节点启动一个，所以使用ds控制器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker pull prom&#x2F;node-exporter:v0.15.0</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># docker tag 12d51ffa2b22 harbor.kococ.cn&#x2F;public&#x2F;node-exporter:v0.15.0</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;node-exporter:v0.15.0</span><br></pre></td></tr></table></figure>

<p>准备资源配置清单：</p>
<p>1、ds.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir node-exporter &amp;&amp; cd node-exporter</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    daemon: &quot;node-exporter&quot;</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      daemon: &quot;node-exporter&quot;</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        daemon: &quot;node-exporter&quot;</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: proc</span><br><span class="line">        hostPath: </span><br><span class="line">          path: &#x2F;proc</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;sys</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      containers:</span><br><span class="line">      - name: node-exporter</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;node-exporter:v0.15.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --path.procfs&#x3D;&#x2F;host_proc</span><br><span class="line">        - --path.sysfs&#x3D;&#x2F;host_sys</span><br><span class="line">        ports:</span><br><span class="line">        - name: node-exporter</span><br><span class="line">          hostPort: 9100</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: sys</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: &#x2F;host_sys</span><br><span class="line">        - name: proc</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: &#x2F;host_proc</span><br><span class="line">      hostNetwork: true</span><br></pre></td></tr></table></figure>



<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;node-exporter&#x2F;ds.yaml</span><br><span class="line"># kubectl get pod -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p>我们有两个node，每个node节点启动一个：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217181605759-1998938636.png" alt="img"></p>
<p> <strong>三、cadvisor</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull google&#x2F;cadvisor:v0.28.3</span><br><span class="line"># docker tag 75f88e3ec333 harbor.kococ.cn&#x2F;public&#x2F;cadvisor:0.28.3</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;cadvisor:0.28.3</span><br></pre></td></tr></table></figure>

<p>准备资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir cadvisor &amp;&amp; cd cadvisor</span><br></pre></td></tr></table></figure>

<p>1、ds.yaml <strong>标红部分是k8s资源配置清单中一个重要的高级属性，下一篇博客着重介绍</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: cadvisor</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: cadvisor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: cadvisor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: cadvisor</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io&#x2F;master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: cadvisor</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;cadvisor:v0.28.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: rootfs</span><br><span class="line">          mountPath: &#x2F;rootfs</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: var-run</span><br><span class="line">          mountPath: &#x2F;var&#x2F;run</span><br><span class="line">        - name: sys</span><br><span class="line">          mountPath: &#x2F;sys</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: &#x2F;var&#x2F;lib&#x2F;docker</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 4194</span><br><span class="line">            protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 4194</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        args:</span><br><span class="line">          - --housekeeping_interval&#x3D;10s</span><br><span class="line">          - --port&#x3D;4194</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: rootfs</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;</span><br><span class="line">      - name: var-run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;run</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;sys</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;data&#x2F;docker</span><br></pre></td></tr></table></figure>



<p>针对挂载资源，做一些调整：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mount -o remount,rw &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;</span><br><span class="line"># ln -s &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpu,cpuacct &#x2F;sys&#x2F;fs&#x2F;cgroup&#x2F;cpuacct,cpu</span><br></pre></td></tr></table></figure>

<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;cadvisor&#x2F;ds.yaml</span><br></pre></td></tr></table></figure>

<p>检查：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217184252982-1773513807.png" alt="img"></p>
<p><strong>四、blackbox-exporter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull prom&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line"># docker tag 81b70b6158be  harbor.kococ.cn&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br></pre></td></tr></table></figure>

<p>创建资源配置清单：</p>
<p>1、cm.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 2s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP&#x2F;1.1&quot;, &quot;HTTP&#x2F;2&quot;]</span><br><span class="line">          valid_status_codes: [200,301,302]</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 2s</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: 1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: blackbox-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: blackbox-exporter</span><br><span class="line">          defaultMode: 420</span><br><span class="line">      containers:</span><br><span class="line">      - name: blackbox-exporter</span><br><span class="line">        image: harbor.kococ.cn&#x2F;public&#x2F;blackbox-exporter:v0.15.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - --config.file&#x3D;&#x2F;etc&#x2F;blackbox_exporter&#x2F;blackbox.yml</span><br><span class="line">        - --log.level&#x3D;info</span><br><span class="line">        - --web.listen-address&#x3D;:9115</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;blackbox_exporter</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 3</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">    - name: blackbox-port</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 9115</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blackbox.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: blackbox-exporter</span><br><span class="line">          servicePort: blackbox-port</span><br></pre></td></tr></table></figure>



<p>这里用到了一个域名，添加解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;var&#x2F;named&#x2F;kococ.cn.zone</span><br><span class="line">blackbox       A    10.4.7.10</span><br></pre></td></tr></table></figure>

<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;blackbox-exporter&#x2F;cm.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;blackbox-exporter&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;blackbox-exporter&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;blackbox-exporter&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217185516382-1860732768.png" alt="img"></p>
<p>访问域名测试：</p>
<p>访问到以下界面，表示blackbox已经运行成功</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217185636620-1445438345.png" alt="img"></p>
<p> <strong>接下来部署prometheus server：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull prom&#x2F;prometheus:v2.14.0</span><br><span class="line"># docker tag 7317640d555e harbor.kococ.cn&#x2F;infra&#x2F;prometheus:v2.14.0</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;infra&#x2F;prometheus:v2.14.0</span><br></pre></td></tr></table></figure>

<p>准备资源配置清单：</p>
<p>1、rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes&#x2F;metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - &#x2F;metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<p>加上–web.enable-lifecycle启用远程热加载配置文件<br>调用指令是curl -X POST <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9090/-/reload">http://localhost:9090/-/reload</a></p>
<p>storage.tsdb.min-block-duration=10m #只加载10分钟数据到内</p>
<p>storage.tsdb.retention=72h #保留72小时数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io&#x2F;revision: &quot;5&quot;</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;prometheus:v2.14.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - &#x2F;bin&#x2F;prometheus</span><br><span class="line">        args:</span><br><span class="line">        - --config.file&#x3D;&#x2F;data&#x2F;etc&#x2F;prometheus.yml</span><br><span class="line">        - --storage.tsdb.path&#x3D;&#x2F;data&#x2F;prom-db</span><br><span class="line">        - --storage.tsdb.min-block-duration&#x3D;10m</span><br><span class="line">        - --storage.tsdb.retention&#x3D;72h</span><br><span class="line">        - --web.enable-lifecycle</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;data</span><br><span class="line">          name: data</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;1000m&quot;</span><br><span class="line">            memory: &quot;1.5Gi&quot;</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;2000m&quot;</span><br><span class="line">            memory: &quot;3Gi&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;prometheus</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9090</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: traefik</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure>



<p>这里用到一个域名，添加解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prometheus         A    10.4.7.10</span><br></pre></td></tr></table></figure>

<p>记得重启named服务</p>
<p>创建需要的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;&#123;etc,prom-db&#125;</span><br></pre></td></tr></table></figure>

<p>修改prometheus配置文件：别问为啥这么写，问就是不懂~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;prometheus.yml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: &#39;etcd&#39;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &#x2F;data&#x2F;etc&#x2F;ca.pem</span><br><span class="line">    cert_file: &#x2F;data&#x2F;etc&#x2F;client.pem</span><br><span class="line">    key_file: &#x2F;data&#x2F;etc&#x2F;client-key.pem</span><br><span class="line">  scheme: https</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - &#39;10.4.7.12:2379&#39;</span><br><span class="line">    - &#39;10.4.7.21:2379&#39;</span><br><span class="line">    - &#39;10.4.7.22:2379&#39;</span><br><span class="line">- job_name: &#39;kubernetes-apiservers&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;ca.crt</span><br><span class="line">  bearer_token_file: &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: default;kubernetes;https</span><br><span class="line">- job_name: &#39;kubernetes-pods&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: true</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &#39;kubernetes-kubelet&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10255</span><br><span class="line">- job_name: &#39;kubernetes-cadvisor&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:4194</span><br><span class="line">- job_name: &#39;kubernetes-kube-state&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_grafanak8sapp]</span><br><span class="line">    regex: .*true.*</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [&#39;__meta_kubernetes_pod_label_daemon&#39;, &#39;__meta_kubernetes_pod_node_name&#39;]</span><br><span class="line">    regex: &#39;node-exporter;(.*)&#39;</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: nodename</span><br><span class="line">- job_name: &#39;blackbox_http_pod_probe&#39;</span><br><span class="line">  metrics_path: &#x2F;probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: http</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port,  __meta_kubernetes_pod_annotation_blackbox_path]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+);(.+)</span><br><span class="line">    replacement: $1:$2$3</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &#39;blackbox_tcp_pod_probe&#39;</span><br><span class="line">  metrics_path: &#x2F;probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: tcp</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &#39;traefik&#39;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: traefik</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br></pre></td></tr></table></figure>





<p>拷贝配置文件中用到的证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;# cp &#x2F;opt&#x2F;certs&#x2F;ca.pem .&#x2F;</span><br><span class="line"># cp &#x2F;opt&#x2F;certs&#x2F;client.pem .&#x2F;</span><br><span class="line"># cp &#x2F;opt&#x2F;certs&#x2F;client-key.pem .&#x2F;</span><br></pre></td></tr></table></figure>

<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prometheus-server&#x2F;rbac.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prometheus-server&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prometheus-server&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;prometheus-server&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217193646033-135940431.png" alt="img"></p>
<p>浏览器验证：prometheus.kococ.cn</p>
<p>这里点击status-targets，这里展示的就是我们在prometheus.yml中配置的job-name，这些targets基本可以满足我们收集数据的需求。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191217193825301-1559250334.png" alt="img"></p>
<p>点击status-configuration就是我们的配置文件</p>
<p><img src="C:\Users\mu77ops\Desktop\个人\k8s\img\1034759-20191217193951620-86033895.png" alt="img"></p>
<p> 我们在配置文件中，除了etcd使用的静态配置以外，其他job都是使用的自动发现。</p>
<p> 静态配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: &#39;etcd&#39;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: &#x2F;data&#x2F;etc&#x2F;ca.pem</span><br><span class="line">    cert_file: &#x2F;data&#x2F;etc&#x2F;client.pem</span><br><span class="line">    key_file: &#x2F;data&#x2F;etc&#x2F;client-key.pem</span><br><span class="line">  scheme: https</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - &#39;10.4.7.12:2379&#39;</span><br><span class="line">    - &#39;10.4.7.21:2379&#39;</span><br><span class="line">    - &#39;10.4.7.22:2379&#39;</span><br></pre></td></tr></table></figure>



<p>自动发现：自动发现资源是pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#39;blackbox_http_pod_probe&#39;</span><br><span class="line">  metrics_path: &#x2F;probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br></pre></td></tr></table></figure>





<p>这里还有很多数据没有收集到，是因为我们在启动服务的时候，没有添加annotations，下面给需要收集数据的服务添加annotations</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218105127737-1378083314.png" alt="img"></p>
<p> 1、traefik：</p>
<p>修改traefik的yaml：</p>
<p>从dashboard里找到traefik的yaml，跟labels同级添加annotations</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scheme&quot;: &quot;traefik&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;&#x2F;metrics&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;8080&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218105807546-605452742.png" alt="img"></p>
<p> 等待pod重启以后，在去prometheus上去看</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218110258286-969134963.png" alt="img"></p>
<p> 2、blackbox：</p>
<p>这个是检测容器内服务存活性的，也就是端口健康状态检查，分为tcp和http</p>
<p>首先准备两个服务，将dubbo-demo-service和dubbo-demo-consumer都调整为使用master镜像，不依赖apollo的（节省资源）</p>
<p>等两个服务起来以后，首先在dubbo-demo-service资源中添加一个TCP的annotation：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;20880&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;tcp&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218114049185-289549656.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218114215347-1007468579.png" alt="img"></p>
<p>这里会自动发现我们服务中，运行tcp port端口为20880的服务，并监控其状态</p>
<p>接下来在dubbo-demo-consumer资源中添加一个HTTP的annotation：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;blackbox_path&quot;: &quot;&#x2F;hello?name&#x3D;health&quot;,</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;8080&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;http&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218114140050-1303905475.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218114226257-429843371.png" alt="img"></p>
<p> 去检查blackbox.kococ.cn</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://blackbox.kococ.cn/">http://blackbox.kococ.cn/</a></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218114841470-1455492210.png" alt="img"></p>
<p> 接下来添加监控jvm信息的annotation：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scrape&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;12346&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;&#x2F;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dubbo-demo-service和dubbo-demo-consumer都添加：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218115419279-1197993355.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218115443784-1236702705.png" alt="img"></p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218115505536-1101147354.png" alt="img"></p>
<p> 匹配规则，要去prometheus.yml中去看。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218115652344-500964534.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218115708456-1158104936.png" alt="img"></p>
<p> 接下来部署炫酷的dashboard工具grafana：</p>
<p> 下载镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull grafana&#x2F;grafana:5.4.2</span><br><span class="line"># docker tag 6f18ddf9e552 harbor.kococ.cn&#x2F;infra&#x2F;grafana:v5.4.2</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;infra&#x2F;grafana:v5.4.2</span><br></pre></td></tr></table></figure>

<p>准备资源配置清单：</p>
<p>1、rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - deployments</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">    kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: grafana</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    name: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: grafana</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        name: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;grafana:v5.4.2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &#x2F;var&#x2F;lib&#x2F;grafana</span><br><span class="line">          name: data</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: &#x2F;data&#x2F;nfs-volume&#x2F;grafana</span><br><span class="line">        name: data</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir &#x2F;data&#x2F;nfs-volume&#x2F;grafana</span><br></pre></td></tr></table></figure>

<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br></pre></td></tr></table></figure>



<p>4、ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.kococ.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure>



<p>域名解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana            A    10.4.7.10</span><br></pre></td></tr></table></figure>

<p>应用资源配置清单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;grafana&#x2F;rbac.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;grafana&#x2F;dp.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;grafana&#x2F;svc.yaml</span><br><span class="line"># kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.kococ.cn&#x2F;grafana&#x2F;ingress.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218145402221-1808300862.png" alt="img"></p>
<p> 浏览器访问验证：</p>
<p>grafana.kococ.cn</p>
<p>默认用户名密码admin</p>
<p>进入容器安装插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># kubectl exec  -it grafana-d6588db94-xr4s6 &#x2F;bin&#x2F;bash -n infra</span><br><span class="line">grafana-cli plugins install grafana-kubernetes-app</span><br><span class="line">grafana-cli plugins install grafana-clock-panel</span><br><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br><span class="line">grafana-cli plugins install briangann-gauge-panel</span><br><span class="line">grafana-cli plugins install natel-discrete-panel</span><br></pre></td></tr></table></figure>

<p>配置数据源：选择prometheus，把三个证书添加进来</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218150843677-574385113.png" alt="img"></p>
<p> 重启grafana</p>
<p>找到我们刚才安装的插件里面的kubernetes,启用，然后新建cluster</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218151453446-763104384.png" alt="img"></p>
<p> 添加完需要稍等几分钟，在没有取到数据之前，会报http forbidden，没关系，等一会就好。大概2-5分钟。</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218151955768-1516493063.png" alt="img"></p>
<p> <img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218152034611-252542525.png" alt="img"></p>
<p>配置alert告警插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker pull docker.io&#x2F;prom&#x2F;alertmanager:v0.14.0</span><br><span class="line"># docker tag 30594e96cbe8 harbor.kococ.cn&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br><span class="line"># docker push harbor.kococ.cn&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br></pre></td></tr></table></figure>

<p>资源配置清单：</p>
<p>1、cm.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager-config</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  config.yml: |-</span><br><span class="line">    global:</span><br><span class="line">      # 在没有报警的情况下声明为已解决的时间</span><br><span class="line">      resolve_timeout: 5m</span><br><span class="line">      # 配置邮件发送信息</span><br><span class="line">      smtp_smarthost: &#39;smtp.163.com:25&#39;</span><br><span class="line">      smtp_from: &#39;xxx@163.com&#39;</span><br><span class="line">      smtp_auth_username: &#39;xxx@163.com&#39;</span><br><span class="line">      smtp_auth_password: &#39;xxxxxx&#39;</span><br><span class="line">      smtp_require_tls: false</span><br><span class="line">    # 所有报警信息进入后的根路由，用来设置报警的分发策略</span><br><span class="line">    route:</span><br><span class="line">      # 这里的标签列表是接收到报警信息后的重新分组标签，例如，接收到的报警信息里面有许多具有 cluster&#x3D;A 和 alertname&#x3D;LatncyHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span><br><span class="line">      group_by: [&#39;alertname&#39;, &#39;cluster&#39;]</span><br><span class="line">      # 当一个新的报警分组被创建后，需要等待至少group_wait时间来初始化通知，这种方式可以确保您能有足够的时间为同一分组来获取多个警报，然后一起触发这个报警信息。</span><br><span class="line">      group_wait: 30s</span><br><span class="line"></span><br><span class="line">      # 当第一个报警发送后，等待&#39;group_interval&#39;时间来发送新的一组报警信息。</span><br><span class="line">      group_interval: 5m</span><br><span class="line"></span><br><span class="line">      # 如果一个报警信息已经发送成功了，等待&#39;repeat_interval&#39;时间来重新发送他们</span><br><span class="line">      repeat_interval: 5m</span><br><span class="line"></span><br><span class="line">      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span><br><span class="line">      receiver: default</span><br><span class="line"></span><br><span class="line">    receivers:</span><br><span class="line">    - name: &#39;default&#39;</span><br><span class="line">      email_configs:</span><br><span class="line">      - to: &#39;xxxx@qq.com&#39;</span><br><span class="line">        send_resolved: true</span><br></pre></td></tr></table></figure>



<p>2、dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: alertmanager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alertmanager</span><br><span class="line">        image: harbor.kococ.cn&#x2F;infra&#x2F;alertmanager:v0.14.0</span><br><span class="line">        args:</span><br><span class="line">          - &quot;--config.file&#x3D;&#x2F;etc&#x2F;alertmanager&#x2F;config.yml&quot;</span><br><span class="line">          - &quot;--storage.path&#x3D;&#x2F;alertmanager&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - name: alertmanager</span><br><span class="line">          containerPort: 9093</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: alertmanager-cm</span><br><span class="line">          mountPath: &#x2F;etc&#x2F;alertmanager</span><br><span class="line">      volumes:</span><br><span class="line">      - name: alertmanager-cm</span><br><span class="line">        configMap:</span><br><span class="line">          name: alertmanager-config</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure>



<p>3、svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    app: alertmanager</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 9093</span><br></pre></td></tr></table></figure>



<p>基础报警规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;data&#x2F;nfs-volume&#x2F;prometheus&#x2F;etc&#x2F;rules.yml</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: hostStatsAlert</span><br><span class="line">  rules:</span><br><span class="line">  - alert: hostCpuUsageAlert</span><br><span class="line">    expr: sum(avg without (cpu)(irate(node_cpu&#123;mode!&#x3D;&#39;idle&#39;&#125;[5m]))) by (instance) &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="line">  - alert: hostMemUsageAlert</span><br><span class="line">    expr: (node_memory_MemTotal - node_memory_MemAvailable)&#x2F;node_memory_MemTotal &gt; 0.85</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br><span class="line">  - alert: OutOfInodes</span><br><span class="line">    expr: node_filesystem_free&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;&quot;&#125; &#x2F; node_filesystem_size&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;&quot;&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Out of inodes (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is almost running out of available inodes (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: OutOfDiskSpace</span><br><span class="line">    expr: node_filesystem_free&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;rootfs&quot;&#125; &#x2F; node_filesystem_size&#123;fstype&#x3D;&quot;overlay&quot;,mountpoint &#x3D;&quot;&#x2F;rootfs&quot;&#125; * 100 &lt; 10</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Out of disk space (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is almost full (&lt; 10% left) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualNetworkThroughputIn</span><br><span class="line">    expr: sum by (instance) (irate(node_network_receive_bytes[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual network throughput in (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Host network interfaces are probably receiving too much data (&gt; 100 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualNetworkThroughputOut</span><br><span class="line">    expr: sum by (instance) (irate(node_network_transmit_bytes[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual network throughput out (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Host network interfaces are probably sending too much data (&gt; 100 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskReadRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_read[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably reading too much data (&gt; 50 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskWriteRate</span><br><span class="line">    expr: sum by (instance) (irate(node_disk_bytes_written[2m])) &#x2F; 1024 &#x2F; 1024 &gt; 50</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write rate (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk is probably writing too much data (&gt; 50 MB&#x2F;s) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskReadLatency</span><br><span class="line">    expr: rate(node_disk_read_time_ms[1m]) &#x2F; rate(node_disk_reads_completed[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk read latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (read operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: UnusualDiskWriteLatency</span><br><span class="line">    expr: rate(node_disk_write_time_ms[1m]) &#x2F; rate(node_disk_writes_completedl[1m]) &gt; 100</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Unusual disk write latency (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Disk latency is growing (write operations &gt; 100ms) (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">- name: http_status</span><br><span class="line">  rules:</span><br><span class="line">  - alert: ProbeFailed</span><br><span class="line">    expr: probe_success &#x3D;&#x3D; 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Probe failed (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Probe failed (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: StatusCode</span><br><span class="line">    expr: probe_http_status_code &lt;&#x3D; 199 OR probe_http_status_code &gt;&#x3D; 400</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Status Code (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;HTTP status code is not 200-399 (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: SslCertificateWillExpireSoon</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;SSL certificate will expire soon (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;SSL certificate expires in 30 days (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: SslCertificateHasExpired</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time()  &lt;&#x3D; 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: error</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;SSL certificate has expired (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;SSL certificate has expired already (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: BlackboxSlowPing</span><br><span class="line">    expr: probe_icmp_duration_seconds &gt; 2</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox slow ping (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Blackbox ping took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: BlackboxSlowRequests</span><br><span class="line">    expr: probe_http_duration_seconds &gt; 2 </span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox slow requests (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;Blackbox request took more than 2s (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class="line">  - alert: PodCpuUsagePercent</span><br><span class="line">    expr: sum(sum(label_replace(irate(container_cpu_usage_seconds_total[1m]),&quot;pod&quot;,&quot;$1&quot;,&quot;container_label_io_kubernetes_pod_name&quot;, &quot;(.*)&quot;))by(pod) &#x2F; on(pod) group_right kube_pod_container_resource_limits_cpu_cores *100 )by(container,namespace,node,pod,severity) &gt; 80</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      severity: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Pod cpu usage percent has exceeded 80% (current value: &#123;&#123; $value &#125;&#125;%)&quot;</span><br></pre></td></tr></table></figure>



<p>在prometheus.yml中添加配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vi prometheus.yml</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: [&quot;alertmanager&quot;]</span><br><span class="line">rule_files:</span><br><span class="line"> - &quot;&#x2F;data&#x2F;etc&#x2F;rules.yml&quot;</span><br></pre></td></tr></table></figure>

<p>重载配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># curl -X POST http:&#x2F;&#x2F;prometheus.kococ.cn&#x2F;-&#x2F;reload</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218173411675-688635972.png" alt="img"></p>
<p> 以上这些就是我们的告警规则</p>
<p>测试告警：</p>
<p>把app命名空间里的dubbo-demo-service给停掉：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218173935193-1795591117.png" alt="img"></p>
<p> 看下blackbox里的信息：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218174004624-1646255779.png" alt="img"></p>
<p>看下alert：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218174052248-183200263.png" alt="img"></p>
<p> 红色的时候就开会发邮件告警：</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218174118507-915764907.png" alt="img"></p>
<p> 已经收到告警了，后续上生产，还会更新如何添加微信、钉钉、短信告警</p>
<p><img src="https://gitee.com/xoxoyun/img/raw/master/image/1034759-20191218174253105-950989449.png" alt="img"></p>
<p> 如果需要自己定制告警规则和告警内容，需要研究一下promql，自己修改配置文件。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">Thaons</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://kococ.cn/posts/29675/">https://kococ.cn/posts/29675/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kococ.cn" target="_blank">北青永恒</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/xoxoyun/img/raw/master/image/0114.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/15965/"><img class="prev-cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0039.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Shell从入门到精通</div></div></a></div><div class="next-post pull-right"><a href="/posts/39737/"><img class="next-cover" src="https://gitee.com/xoxoyun/img/raw/master/image/0136.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jenkins汉化并修改插件源为国内源</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Thaons</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">既来之 则安之</div><div class="icp"><a target="_blank" rel="noopener external nofollow noreferrer" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="https://gitee.com/xoxoyun/img/raw/master/image/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="aplayer no-destroy" data-id="964294791" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="true" data-order="random" data-preload="none" data-autoplay="true" muted></div><script>(function(w,d, s, id) {if(typeof(w.webpushr)!=='undefined') return;w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.async=1;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('setup',{'key':'BIF1XgHYU5uifiTn-nijbfi-j2pofrfj7Aws6myNxi04-3ZwnuLbOAvV65krmTdyRmzx7KWMmiMRB-AJ10FTlEs', 'integration':'popup'  });</script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  $('script[data-pjax]').each(function () {
    $(this).parent().append($(this).remove())
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  $(window).off('scroll')

  //reset readmode
  $('body').hasClass('read-mode') && $('body').removeClass('read-mode')

})</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div><script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BIF1XgHYU5uifiTn-nijbfi-j2pofrfj7Aws6myNxi04-3ZwnuLbOAvV65krmTdyRmzx7KWMmiMRB-AJ10FTlEs');</script></body></html>