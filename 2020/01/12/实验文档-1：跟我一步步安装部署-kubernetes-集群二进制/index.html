<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>跟我一步步安装部署 kubernetes 集群 | Prous</title><meta name="description" content="实验文档 1：跟我一步步安装部署 kubernetes 集群(二进制)实验环境展开目录基础架构展开目录主机名 角色 ip HDSS7-11.host.com k8s 代理节点 1 10.4.7.11 HDSS7-12.host.com k8s 代理节点 2 10.4.7.12 HDSS7-21.host.com k8s 运算节点 1 10.4.7.21 HDSS7-22.host.com k8s"><meta name="keywords" content="K8s"><meta name="author" content="Prous"><meta name="copyright" content="Prous"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://www.kococ.cn/favicon.ico"><link rel="canonical" href="http://yoursite.com/2020/01/12/%E5%AE%9E%E9%AA%8C%E6%96%87%E6%A1%A3-1%EF%BC%9A%E8%B7%9F%E6%88%91%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="跟我一步步安装部署 kubernetes 集群"><meta property="og:url" content="http://yoursite.com/2020/01/12/%E5%AE%9E%E9%AA%8C%E6%96%87%E6%A1%A3-1%EF%BC%9A%E8%B7%9F%E6%88%91%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6/"><meta property="og:site_name" content="Prous"><meta property="og:description" content="实验文档 1：跟我一步步安装部署 kubernetes 集群(二进制)实验环境展开目录基础架构展开目录主机名 角色 ip HDSS7-11.host.com k8s 代理节点 1 10.4.7.11 HDSS7-12.host.com k8s 代理节点 2 10.4.7.12 HDSS7-21.host.com k8s 运算节点 1 10.4.7.21 HDSS7-22.host.com k8s"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg"><meta property="article:published_time" content="2020-01-12T03:43:00.000Z"><meta property="article:modified_time" content="2020-08-02T12:40:46.920Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-08-02 20:40:46'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="https://www.kococ.cn/wxuser.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">62</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">59</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%96%87%E6%A1%A3-1%EF%BC%9A%E8%B7%9F%E6%88%91%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4-%E4%BA%8C%E8%BF%9B%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">实验文档 1：跟我一步步安装部署 kubernetes 集群(二进制)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number"></span> <span class="toc-text">实验环境展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">基础架构展开目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E7%8E%AF%E5%A2%83%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">硬件环境展开目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">软件环境展开目录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number"></span> <span class="toc-text">前置准备工作展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DNS-%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">DNS 服务安装部署展开目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">准备签发证书环境展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-CFSSL%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.</span> <span class="toc-text">安装 CFSSL展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">签发证书展开目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-docker-%E7%8E%AF%E5%A2%83%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.</span> <span class="toc-text">部署 docker 环境展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.1.</span> <span class="toc-text">安装展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.2.</span> <span class="toc-text">启动展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-docker-%E9%95%9C%E5%83%8F%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93-harbor%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">5.</span> <span class="toc-text">部署 docker 镜像私有仓库 harbor展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85%E5%B9%B6%E8%A7%A3%E5%8E%8B%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">5.1.</span> <span class="toc-text">下载软件二进制包并解压展开目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-Master-%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number"></span> <span class="toc-text">部署 Master 节点服务展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-etcd-%E9%9B%86%E7%BE%A4%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">部署 etcd 集群展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">集群规划展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kube-apiserver-%E9%9B%86%E7%BE%A4%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">部署 kube-apiserver 集群展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.1.</span> <span class="toc-text">集群规划展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%EF%BC%8C%E8%A7%A3%E5%8E%8B%EF%BC%8C%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.</span> <span class="toc-text">下载软件，解压，做软连接展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%B8%BB%E6%8E%A7%E8%8A%82%E7%82%B9-4-%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">安装部署主控节点 4 层反向代理服务展开目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-controller-manager%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.</span> <span class="toc-text">部署 controller-manager展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-2"><span class="toc-number">4.1.</span> <span class="toc-text">集群规划展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.2.</span> <span class="toc-text">创建启动脚本展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">调整文件权限，创建目录展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-supervisor-%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.4.</span> <span class="toc-text">创建 supervisor 配置展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.5.</span> <span class="toc-text">启动服务并检查展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84-kube-controller-manager-%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">4.6.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的 kube-controller-manager 服务展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kube-scheduler%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">5.</span> <span class="toc-text">部署 kube-scheduler展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-3"><span class="toc-number">5.1.</span> <span class="toc-text">集群规划展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">5.2.</span> <span class="toc-text">创建启动脚本展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">5.3.</span> <span class="toc-text">调整文件权限，创建目录展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-supervisor-%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">5.4.</span> <span class="toc-text">创建 supervisor 配置展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">5.5.</span> <span class="toc-text">启动服务并检查展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84-kube-scheduler-%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">5.6.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的 kube-scheduler 服务展开目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-Node-%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number"></span> <span class="toc-text">部署 Node 节点服务展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kubelet%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">部署 kubelet展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-4"><span class="toc-number">1.1.</span> <span class="toc-text">集群规划展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91-kubelet-%E8%AF%81%E4%B9%A6%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.</span> <span class="toc-text">签发 kubelet 证书展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84-JSON-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建生成证书签名请求（csr）的 JSON 配置文件展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-kubelet-%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">生成 kubelet 证书和私钥展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.3.</span> <span class="toc-text">检查生成的证书、私钥展开目录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7-600%EF%BC%8C%E6%8B%B7%E8%B4%9D%E8%87%B3%EF%BC%9A-opt-kubernetes-server-bin-cert-%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性 600，拷贝至：&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7-600%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性 600展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.</span> <span class="toc-text">创建配置展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%99-kubectl-%E5%88%9B%E5%BB%BA%E8%BD%AF%E8%BF%9E%E6%8E%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">给 kubectl 创建软连接展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-cluster%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">set-cluster展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-credentials%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">set-credentials展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-context%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">set-context展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#use-context%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">use-context展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#k8s-node-yaml%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">k8s-node.yaml展开目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-pause-%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F-%E2%80%93-%E8%BE%B9%E8%BD%A6%E6%A8%A1%E5%BC%8F%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.4.</span> <span class="toc-text">准备 pause 基础镜像 – 边车模式展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84-kubelet-%E6%9C%8D%E5%8A%A1%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">1.5.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的 kubelet 服务展开目录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kube-proxy%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.</span> <span class="toc-text">部署 kube-proxy展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-5"><span class="toc-number">2.1.</span> <span class="toc-text">集群规划展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91-kube-proxy-%E8%AF%81%E4%B9%A6%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.</span> <span class="toc-text">签发 kube-proxy 证书展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A7%E7%89%88%E6%9C%AC%E9%9A%90%E8%97%8F%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.1.</span> <span class="toc-text">旧版本隐藏展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90-kube-proxy-%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.2.2.</span> <span class="toc-text">生成 kube-proxy 证书和私钥展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.2.3.</span> <span class="toc-text">检查生成的证书、私钥展开目录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E8%87%B3%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.</span> <span class="toc-text">拷贝证书至各运算节点，并创建配置展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7-600%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性 600展开目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">创建配置展开目录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#set-cluster%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">set-cluster展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-credentials%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">set-credentials展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set-context%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">set-context展开目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#use-context%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">use-context展开目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-kube-proxy-%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.4.</span> <span class="toc-text">创建 kube-proxy 启动脚本展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95"><span class="toc-number">2.5.</span> <span class="toc-text">检查配置，权限，创建日志目录展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-supervisor-%E9%85%8D%E7%BD%AE%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-2"><span class="toc-number">2.6.</span> <span class="toc-text">创建 supervisor 配置展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5%E5%B1%95%E5%BC%80%E7%9B%AE%E5%BD%95-2"><span class="toc-number">2.7.</span> <span class="toc-text">启动服务并检查展开目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84-kube-proxy-%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.8.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的 kube-proxy 服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-addons-%E6%8F%92%E4%BB%B6"><span class="toc-number"></span> <span class="toc-text">部署 addons 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-kubernetes-%E9%9B%86%E7%BE%A4"><span class="toc-number">1.</span> <span class="toc-text">验证 kubernetes 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">1.1.</span> <span class="toc-text">在任意一个运算节点，创建一个资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-flannel"><span class="toc-number">2.</span> <span class="toc-text">部署 flannel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="toc-number">2.1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B8%8A%E5%A2%9E%E5%8A%A0-iptables-%E8%A7%84%E5%88%99"><span class="toc-number">2.2.</span> <span class="toc-text">在各运算节点上增加 iptables 规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%BF%9D%E5%AD%98-iptables-%E8%A7%84%E5%88%99"><span class="toc-number">2.3.</span> <span class="toc-text">各运算节点保存 iptables 规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%EF%BC%8C%E8%A7%A3%E5%8E%8B%EF%BC%8C%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.4.</span> <span class="toc-text">下载软件，解压，做软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.5.</span> <span class="toc-text">最终目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-etcd%EF%BC%8C%E5%A2%9E%E5%8A%A0-host-gw"><span class="toc-number">2.6.</span> <span class="toc-text">操作 etcd，增加 host-gw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">2.8.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95"><span class="toc-number">2.9.</span> <span class="toc-text">检查配置，权限，创建日志目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-supervisor-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.10.</span> <span class="toc-text">创建 supervisor 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">2.11.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84-flannel-%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.12.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的 flannel 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-number">2.13.</span> <span class="toc-text">再次验证集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-k8s-%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91-http-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">部署 k8s 资源配置清单的内网 http 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BA-HDSS7-200-host-com-%E4%B8%8A%EF%BC%8C%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%AA-nginx-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%EF%BC%8C%E7%94%A8%E4%BB%A5%E6%8F%90%E4%BE%9B-k8s-%E7%BB%9F%E4%B8%80%E7%9A%84%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E8%AE%BF%E9%97%AE%E5%85%A5%E5%8F%A3"><span class="toc-number">3.1.</span> <span class="toc-text">在运维主机 HDSS7-200.host.com 上，配置一个 nginx 虚拟主机，用以提供 k8s 统一的资源配置清单访问入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91-DNS-%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">配置内网 DNS 解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-kube-dns-coredns"><span class="toc-number">4.</span> <span class="toc-text">部署 kube-dns (coredns)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-coredns-v1-3-1-%E9%95%9C%E5%83%8F"><span class="toc-number">4.1.</span> <span class="toc-text">准备 coredns-v1.3.1 镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">准备资源配置清单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA"><span class="toc-number">4.2.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5"><span class="toc-number">4.3.</span> <span class="toc-text">检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-traefik%EF%BC%88ingress%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">部署 traefik（ingress）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-traefik-%E9%95%9C%E5%83%8F"><span class="toc-number">5.1.</span> <span class="toc-text">准备 traefik 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-1"><span class="toc-number">5.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"><span class="toc-number">5.3.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA-1"><span class="toc-number">5.4.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%8D%E4%BB%A3"><span class="toc-number">5.5.</span> <span class="toc-text">配置反代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">5.6.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-dashboard"><span class="toc-number">6.</span> <span class="toc-text">部署 dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-dashboard-%E9%95%9C%E5%83%8F"><span class="toc-number">6.1.</span> <span class="toc-text">准备 dashboard 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-2"><span class="toc-number">6.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D-1"><span class="toc-number">6.3.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA-2"><span class="toc-number">6.4.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE-1"><span class="toc-number">6.5.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%A4%E8%AF%81"><span class="toc-number">6.6.</span> <span class="toc-text">配置认证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-heapster"><span class="toc-number">7.</span> <span class="toc-text">部署 heapster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-heapster-%E9%95%9C%E5%83%8F"><span class="toc-number">7.1.</span> <span class="toc-text">准备 heapster 镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-3"><span class="toc-number">7.2.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">7.3.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AF-dashboard"><span class="toc-number">7.4.</span> <span class="toc-text">重启 dashboard</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Prous</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友联</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">跟我一步步安装部署 kubernetes 集群</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-01-12T03:43:00.000Z" title="发表于 2020-01-12 11:43:00">2020-01-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-08-02T12:40:46.920Z" title="更新于 2020-08-02 20:40:46">2020-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker-K8s/">Docker+K8s</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>89分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg"></p>
<h2 id="实验文档-1：跟我一步步安装部署-kubernetes-集群-二进制"><a href="#实验文档-1：跟我一步步安装部署-kubernetes-集群-二进制" class="headerlink" title="实验文档 1：跟我一步步安装部署 kubernetes 集群(二进制)"></a>实验文档 1：跟我一步步安装部署 kubernetes 集群(二进制)</h2><h1 id="实验环境展开目录"><a href="#实验环境展开目录" class="headerlink" title="实验环境展开目录"></a>实验环境展开目录</h1><h2 id="基础架构展开目录"><a href="#基础架构展开目录" class="headerlink" title="基础架构展开目录"></a>基础架构展开目录</h2><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-11.host.com</p>
<p>k8s 代理节点 1</p>
<p>10.4.7.11</p>
<p>HDSS7-12.host.com</p>
<p>k8s 代理节点 2</p>
<p>10.4.7.12</p>
<p>HDSS7-21.host.com</p>
<p>k8s 运算节点 1</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>k8s 运算节点 2</p>
<p>10.4.7.22</p>
<p>HDSS7-200.host.com</p>
<p>k8s 运维节点 (docker 仓库)</p>
<p>10.4.7.200</p>
<h2 id="硬件环境展开目录"><a href="#硬件环境展开目录" class="headerlink" title="硬件环境展开目录"></a>硬件环境展开目录</h2><ul>
<li>5 台 vm，每台至少 2c2g</li>
</ul>
<h2 id="软件环境展开目录"><a href="#软件环境展开目录" class="headerlink" title="软件环境展开目录"></a>软件环境展开目录</h2><ul>
<li>OS: CentOS Linux release 7.6.1810 (Core)</li>
<li>docker: v1.12.6</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm">docker 引擎官方下载地址</a><br><a target="_blank" rel="noopener" href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm">docker 引擎官方 selinux 包</a></p>
</blockquote>
<ul>
<li>kubernetes: v1.13.2</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/releases">kubernetes 官方下载地址</a></p>
</blockquote>
<ul>
<li>etcd: v3.1.18</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases">etcd 官方下载地址</a></p>
</blockquote>
<ul>
<li>flannel: v0.10.0</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/releases">flannel 官方下载地址</a></p>
</blockquote>
<ul>
<li>bind9: v9.9.4</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.isc.org/downloads/#">bind9 官方下载地址</a></p>
</blockquote>
<ul>
<li>harbor: v1.7.1</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">harbor 官方下载地址</a></p>
</blockquote>
<ul>
<li>证书签发工具 CFSSL: R1.2</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64">cfssl 下载地址</a><br><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64">cfssljson 下载地址</a><br><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64">cfssl-certinfo 下载地址</a></p>
</blockquote>
<ul>
<li>其他</li>
</ul>
<blockquote>
<p>其他可能用到的软件，均使用操作系统自带的 yum 源和 epel 源进行安装</p>
</blockquote>
<h1 id="前置准备工作展开目录"><a href="#前置准备工作展开目录" class="headerlink" title="前置准备工作展开目录"></a>前置准备工作展开目录</h1><p>主机命名规则主机命名规则之一：主机名不与业务有关系：地域 + IP 段的后两位<br>所有主机上调整 yum 源：</p>
<p>1. 安装阿里云 Base 源和 epel 源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo  </span><br><span class="line">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo</span><br></pre></td></tr></table></figure>

<p>2. 安装必要工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils </span><br></pre></td></tr></table></figure>

<p>查看内核版本，运行 docker 需要 3.8 以上，查看的为 3.10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<h2 id="DNS-服务安装部署展开目录"><a href="#DNS-服务安装部署展开目录" class="headerlink" title="DNS 服务安装部署展开目录"></a>DNS 服务安装部署展开目录</h2><p><strong>在 hdss7-11 安装 Bind</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# yum install -y bind</span><br><span class="line">[root@hdss7-11 ~]# rpm -qa bind</span><br></pre></td></tr></table></figure>

<p><strong>配置 bind</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;etc&#x2F;named.conf            # BIND进程的工作属性，区域的定义</span><br><span class="line">13         listen-on port 53 &#123; 10.4.7.11; &#125;;    # 监听本机IP</span><br><span class="line">14         listen-on-v6 port 53 &#123; ::1; &#125;;        # 删除，不监听IPV6</span><br><span class="line">20         allow-query     &#123; any; &#125;;            # 允许所有主机查看</span><br><span class="line">21         forwarders      &#123; 10.4.7.2; &#125;;        # 办公网上一级的DNS</span><br><span class="line">33         recursion yes;                # dns采用递归的查询</span><br><span class="line">35         dnssec-enable no;                # 关闭，节省资源（生产可能不需要关闭）</span><br><span class="line">36         dnssec-validation no;            # 关闭，节省资源，不做互联网认证</span><br></pre></td></tr></table></figure>

<p>检查配置文件是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# named-checkconf</span><br><span class="line">[root@hdss7-11 ~]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p><strong>配置区域配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;etc&#x2F;named.rfc1912.zones</span><br><span class="line"># 最后添加</span><br><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;od.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;od.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>配置区域数据文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;var&#x2F;named&#x2F;host.com.zone</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@       IN SOA  dns.host.com. dnsadmin.host.com. (</span><br><span class="line">                                2020062701 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                        NS   dns.host.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">HDSS7-11           A    10.4.7.11</span><br><span class="line">HDSS7-12           A    10.4.7.12</span><br><span class="line">HDSS7-21           A    10.4.7.21</span><br><span class="line">HDSS7-22           A    10.4.7.22</span><br><span class="line">HDSS7-200          A    10.4.7.200</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">$ORIGIN od.com.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.od.com. dnsadmin.od.com. (</span><br><span class="line">                                2020062701 ; serial</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.od.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br></pre></td></tr></table></figure>

<p><strong>检查配置文件是否正确</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# named-checkconf</span><br><span class="line">[root@hdss7-11 ~]# echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p><strong>检测区域数据文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# named-checkzone &quot;host.com&quot; &#x2F;var&#x2F;named&#x2F;host.com.zone</span><br><span class="line">zone host.com&#x2F;IN: loaded serial 2019121001</span><br><span class="line">OK</span><br><span class="line">[root@hdss7-11 named]# named-checkzone &quot;od.com&quot; &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">zone od.com&#x2F;IN: loaded serial 2019120901</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p><strong>更改文件的属组，权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# chown root:named &#x2F;var&#x2F;named&#x2F;host.com.zone </span><br><span class="line">[root@hdss7-11 named]# chown root:named &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">[root@hdss7-11 named]# chmod 640 &#x2F;var&#x2F;named&#x2F;host.com.zone </span><br><span class="line">[root@hdss7-11 named]# chmod 640 &#x2F;var&#x2F;named&#x2F;od.com.zone</span><br></pre></td></tr></table></figure>

<p><strong>启动 named</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# systemctl restart named</span><br><span class="line">[root@hdss7-11 named]# systemctl enable named</span><br></pre></td></tr></table></figure>

<p><strong>查看启动端口</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# netstat -luntp | grep 53</span><br></pre></td></tr></table></figure>

<p><strong>验证解析</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# dig -t A hdss7-21.host.com @10.4.7.11 +short</span><br><span class="line">192.168.153.21</span><br><span class="line">[root@hdss7-11 named]# dig -t A hdss7-200.host.com @10.4.7.11 +short </span><br></pre></td></tr></table></figure>

<p><strong>更改客户端 dns</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# vi &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33</span><br><span class="line">DNS1&#x3D;&quot;10.4.7.11&quot;</span><br><span class="line">[root@hdss7-11 named]# systemctl restart network</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# cat &#x2F;etc&#x2F;resolv.conf </span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">search host.com</span><br><span class="line">nameserver 10.4.7.11</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# ping hdss7-21.host.com</span><br></pre></td></tr></table></figure>

<p><strong>添加主机域 search host.com 使用短域名</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# cat &#x2F;etc&#x2F;resolv.conf </span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">search host.com</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# ping hdss7-21</span><br></pre></td></tr></table></figure>

<p><strong>更改所有主机的 DNS，重启网卡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vi &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-ens33</span><br><span class="line">DNS1&#x3D;&quot;10.4.7.11&quot;</span><br><span class="line"># systemctl restart network</span><br></pre></td></tr></table></figure>

<p>可修改可不修改将虚拟机的网卡 DNS 也改成 10.4.7.11 IPV4 – 高级 – 越点改成 20<br>将本机的网卡 DNS 也改成 10.4.7.11 IPV4 – 高级 – 越点改成 20</p>
<h2 id="准备签发证书环境展开目录"><a href="#准备签发证书环境展开目录" class="headerlink" title="准备签发证书环境展开目录"></a>准备签发证书环境展开目录</h2><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<h3 id="安装-CFSSL展开目录"><a href="#安装-CFSSL展开目录" class="headerlink" title="安装 CFSSL展开目录"></a>安装 CFSSL展开目录</h3><ul>
<li>证书签发工具 CFSSL: R1.2</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64">cfssl 下载地址</a><br><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64">cfssljson 下载地址</a><br><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64">cfssl-certinfo 下载地址</a></p>
</blockquote>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl</span><br><span class="line">[root@hdss7-200 ~]# wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssljson_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-json</span><br><span class="line">[root@hdss7-200 ~]# wget https:&#x2F;&#x2F;pkg.cfssl.org&#x2F;R1.2&#x2F;cfssl-certinfo_linux-amd64 -O &#x2F;usr&#x2F;bin&#x2F;cfssl-certinfo</span><br><span class="line">[root@hdss7-200 ~]# chmod +x &#x2F;usr&#x2F;bin&#x2F;cfssl*</span><br><span class="line">[root@hdss7-200 ~]# which cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h2 id="签发证书展开目录"><a href="#签发证书展开目录" class="headerlink" title="签发证书展开目录"></a>签发证书展开目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# cd &#x2F;opt&#x2F;</span><br><span class="line">[root@hdss7-200 opt]# mkdir certs</span><br><span class="line">[root@hdss7-200 opt]# cd certs&#x2F;</span><br><span class="line">[root@hdss7-200 ~]# vi &#x2F;opt&#x2F;certs&#x2F;ca-csr.json</span><br></pre></td></tr></table></figure>

<p><strong>签发根证书 – 创建生成 CA 证书签名请求（csr）的 JSON 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;OldboyEdu&quot;,        # 机构名称，浏览器使用该字段验证网站是否合法，一般写的是域名，非常重要，浏览器使用该字段验证网站是否合法</span><br><span class="line">    &quot;hosts&quot;: [    </span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;            </span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,        # 算法</span><br><span class="line">        &quot;size&quot;: 2048        # 长度</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,        # C，国家</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,    # ST 州，省</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,    # L 地区 城市</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,        # O 组织名称，公司名称</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;        # OU 组织单位名称，公司部门</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;    # expiry 过期时间，任何证书都有过期时间.20年</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>签发承载式证书</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">总用量 16</span><br><span class="line">-rw-r--r-- 1 root root  993 12月 10 11:54 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  328 12月 10 11:53 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1679 12月 10 11:54 ca-key.pem    # 根证书的私钥</span><br><span class="line">-rw-r--r-- 1 root root 1346 12月 10 11:54 ca.pem        # 根证书</span><br></pre></td></tr></table></figure>

<p>隐藏内容</p>
<h2 id="部署-docker-环境展开目录"><a href="#部署-docker-环境展开目录" class="headerlink" title="部署 docker 环境展开目录"></a>部署 docker 环境展开目录</h2><p><code>HDSS7-200.host.com</code>,<code>HDSS7-21.host.com</code>,<code>HDSS7-22.host.com</code> 上：</p>
<h3 id="安装展开目录"><a href="#安装展开目录" class="headerlink" title="安装展开目录"></a>安装展开目录</h3><ul>
<li>docker: v19.03.12</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm">docker 引擎官方下载地址</a><br><a target="_blank" rel="noopener" href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm">docker 引擎官方 selinux 包</a></p>
</blockquote>
<p>hdss7-200hdss7-21hdss7-22[root@hdss7-200 ]# curl -fsSL <a target="_blank" rel="noopener" href="https://get.docker.com/">https://get.docker.com</a> | bash -s docker –mirror Aliyun<br>[root@hdss7-200 ]# mkdir -p /etc/docker<br>[root@hdss7-200 ]# mkdir -p /data/docker<br>[root@hdss7-200 ]# vi /etc/docker/daemon.json<br>{<br>“graph”: “/data/docker”,<br>“storage-driver”: “overlay2”,<br>“insecure-registries”: [“registry.access.redhat.com”,”quay.io”,”harbor.od.com”],<br>“registry-mirrors”: [“<a target="_blank" rel="noopener" href="https://q2gr04ke.mirror.aliyuncs.com&quot;/]">https://q2gr04ke.mirror.aliyuncs.com&quot;\]</a>,<br>“bip”: “172.7.200.1/24”, # 定义 k8s 主机上 k8s pod 的 ip 地址网段<br>“exec-opts”: [“native.cgroupdriver=systemd”],<br>“live-restore”: true<br>}</p>
<p>旧版本隐藏</p>
<h3 id="启动展开目录"><a href="#启动展开目录" class="headerlink" title="启动展开目录"></a>启动展开目录</h3><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker.service</span><br><span class="line"># systemctl start docker.service</span><br></pre></td></tr></table></figure>

<h2 id="部署-docker-镜像私有仓库-harbor展开目录"><a href="#部署-docker-镜像私有仓库-harbor展开目录" class="headerlink" title="部署 docker 镜像私有仓库 harbor展开目录"></a>部署 docker 镜像私有仓库 harbor展开目录</h2><p>安装 1.7.6 以上版本安装 1.7.6 以上版本<br>**<code>HDSS7-200.host.com</code> 上：**</p>
<h3 id="下载软件二进制包并解压展开目录"><a href="#下载软件二进制包并解压展开目录" class="headerlink" title="下载软件二进制包并解压展开目录"></a>下载软件二进制包并解压展开目录</h3><p><a target="_blank" rel="noopener" href="https://storage.googleapis.com/harbor-releases/release-1.9.0/harbor-offline-installer-v1.9.1.tgz">harbor 下载地址</a></p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir &#x2F;opt&#x2F;src</span><br><span class="line">[root@hdss7-200 ~]# cd &#x2F;opt&#x2F;src&#x2F;</span><br><span class="line">[root@hdss7-200 src]# ls</span><br><span class="line">harbor-offline-installer-v1.9.1.tgz</span><br><span class="line">[root@hdss7-200 src]# tar zxvf harbor-offline-installer-v1.9.1.tgz -C &#x2F;opt&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong># 把软件包做版本标识，做一个软链接，便于以后升级</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# cd ..</span><br><span class="line">[root@hdss7-200 opt]# mv harbor&#x2F; harbor-v1.9.1</span><br><span class="line">[root@hdss7-200 opt]# ln -s &#x2F;opt&#x2F;harbor-v1.9.1&#x2F; &#x2F;opt&#x2F;harbor</span><br><span class="line">[root@hdss7-200 opt]# ll</span><br><span class="line">总用量 0</span><br><span class="line">drwx--x--x 4 root root  28 12月 10 14:30 containerd</span><br><span class="line">lrwxrwxrwx 1 root root  19 12月 10 15:00 harbor -&gt; &#x2F;opt&#x2F;harbor-v1.9.1&#x2F;</span><br><span class="line">drwxr-xr-x 2 root root 100 12月 10 14:58 harbor-v1.9.1</span><br><span class="line">drwxr-xr-x 2 root root  49 12月 10 14:56 src</span><br></pre></td></tr></table></figure>

<p><strong>编辑 harbor 文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 opt]# cd harbor</span><br><span class="line">[root@hdss7-200 harbor]# vi harbor.yml</span><br><span class="line">5 hostname: harbor.od.com</span><br><span class="line">10   port: 180</span><br><span class="line">27 harbor_admin_password: Harbor12345</span><br><span class="line">40 data_volume: &#x2F;data&#x2F;harbor</span><br><span class="line">87     location: &#x2F;data&#x2F;harbor&#x2F;logs    # 更改日志存储路径</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# mkdir -p &#x2F;data&#x2F;harbor&#x2F;logs</span><br></pre></td></tr></table></figure>

<p><strong>单机编排工具</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install -y docker-compose</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line">docker-compose-1.18.0-4.el7.noarch</span><br></pre></td></tr></table></figure>

<p><strong>安装</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# .&#x2F;install.sh </span><br><span class="line">[root@hdss7-200 harbor]# docker-compose ps</span><br></pre></td></tr></table></figure>

<p><strong>每次重启 docker 需要执行</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><strong>安装 nginx 做反向代理</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install -y nginx</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;harbor.od.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>检测配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# nginx -t</span><br><span class="line">nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# systemctl start nginx</span><br><span class="line">[root@hdss7-200 harbor]# systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p>DNS 服务器操作下面内容用眼睛看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# vi &#x2F;var&#x2F;named&#x2F;od.com.zone </span><br><span class="line">$ORIGIN od.com.</span><br><span class="line">$TTL 600        ; 10 minutes</span><br><span class="line">@               IN SOA  dns.od.com. dnsadmin.od.com. (</span><br><span class="line">                                2019120902 ; serial        # 往后滚动一个记录编号02，每次更改配置，必须滚动一个序号</span><br><span class="line">                                10800      ; refresh (3 hours)</span><br><span class="line">                                900        ; retry (15 minutes)</span><br><span class="line">                                604800     ; expire (1 week)</span><br><span class="line">                                86400      ; minimum (1 day)</span><br><span class="line">                                )</span><br><span class="line">                                NS   dns.od.com.</span><br><span class="line">$TTL 60 ; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">harbor             A    10.4.7.200</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 named]# systemctl restart named </span><br></pre></td></tr></table></figure>

<p><strong>验证</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 named]# dig -t A harbor.od.com +short</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://harbor.od.com/">http://harbor.od.com/</a></p>
<p>新建一个 public 项目，公开访问 harbor.od.com 操作，别傻。默认用户 admin 密码 Harbor12345</p>
<p>[root@hdss7-200 harbor]# docker pull nginx:1.7.9</p>
<p>[root@hdss7-200 harbor]# docker tag nginx:1.7.9 harbor.od.com/public/nginx:v1.7.9</p>
<p>[root@hdss7-200 harbor]# docker login harbor.od.com</p>
<p>[root@hdss7-200 harbor]# docker push harbor.od.com/public/nginx:v1.7.9</p>
<p>旧版本隐藏</p>
<h1 id="部署-Master-节点服务展开目录"><a href="#部署-Master-节点服务展开目录" class="headerlink" title="部署 Master 节点服务展开目录"></a>部署 Master 节点服务展开目录</h1><h2 id="部署-etcd-集群展开目录"><a href="#部署-etcd-集群展开目录" class="headerlink" title="部署 etcd 集群展开目录"></a>部署 etcd 集群展开目录</h2><h3 id="集群规划展开目录"><a href="#集群规划展开目录" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-12.host.com</p>
<p>etcd lead</p>
<p>10.4.7.12</p>
<p>HDSS7-21.host.com</p>
<p>etcd follow</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>etcd follow</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-12.host.com</code> 主机为例，另外两台主机安装部署方法类似<br><strong>在 HDss7-200 上创建基于根证书的 config 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi &#x2F;opt&#x2F;certs&#x2F;ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;                </span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>此文档 IP 地址必须在文档内更改好再粘贴复制进去，IP 地址为有可能装 ETCD 的主机，多一个 IP 为预备</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi &#x2F;opt&#x2F;certs&#x2F;etcd-peer-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;peer etcd-peer-csr.json |cfssl-json -bare etcd-peer</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">总用量 36</span><br><span class="line">-rw-r--r-- 1 root root  836 12月 10 16:29 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  993 12月 10 11:54 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  328 12月 10 11:53 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1679 12月 10 11:54 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1346 12月 10 11:54 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1062 12月 10 16:31 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root  383 12月 10 16:31 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 12月 10 16:31 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1428 12月 10 16:31 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<p><strong>三台操作</strong><br><strong>在 etcd 主机上创建 etcd 用户</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># useradd -s &#x2F;sbin&#x2F;nologin -M etcd</span><br><span class="line"># id etcd</span><br><span class="line"></span><br><span class="line"># mkdir &#x2F;opt&#x2F;src</span><br><span class="line"># cd &#x2F;opt&#x2F;src&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>下载 etcd 软件，建议用不超 3.3 的版本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ls</span><br><span class="line">etcd-v3.1.20-linux-amd64.tar.gz</span><br><span class="line"># tar xfv etcd-v3.1.20-linux-amd64.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line"># cd ..</span><br><span class="line"># mv etcd-v3.1.20-linux-amd64 etcd-v3.1.20</span><br></pre></td></tr></table></figure>

<p><strong>创建软链接方便以后更新版本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 opt]# ln -s &#x2F;opt&#x2F;etcd-v3.1.20 &#x2F;opt&#x2F;etcd</span><br><span class="line"># ll</span><br><span class="line">总用量 0</span><br><span class="line">lrwxrwxrwx 1 root   root   17 12月 10 16:45 etcd -&gt; &#x2F;opt&#x2F;etcd-v3.1.20</span><br><span class="line">drwxr-xr-x 3 478493 89939 123 10月 11 2018 etcd-v3.1.20</span><br><span class="line">drwxr-xr-x 2 root   root   45 12月 10 16:41 src</span><br></pre></td></tr></table></figure>

<p><strong>创建目录，拷贝证书、私钥</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;opt&#x2F;etcd&#x2F;certs &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br></pre></td></tr></table></figure>

<p><strong>将运维主机上生成的 ca.pem etc-peer-key.pem etc-peer.pem 拷贝到 /opt/etcd/certs 目录中，私钥文件权限为 600</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# scp ca.pem 10.4.7.22:&#x2F;opt&#x2F;etcd&#x2F;certs </span><br><span class="line">[root@hdss7-200 certs]# scp etcd-peer-key.pem 10.4.7.22:&#x2F;opt&#x2F;etcd&#x2F;certs</span><br><span class="line">[root@hdss7-200 certs]# scp etcd-peer.pem 10.4.7.22:&#x2F;opt&#x2F;etcd&#x2F;certs</span><br></pre></td></tr></table></figure>

<p><strong>更改属主属组</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cd &#x2F;opt&#x2F;etcd&#x2F;certs</span><br><span class="line"># chown -R etcd.etcd &#x2F;opt&#x2F;etcd&#x2F;certs &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br><span class="line"># ll</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1346 12月 10 16:52 ca.pem</span><br><span class="line">-rw------- 1 etcd etcd 1679 12月 10 16:53 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1428 12月 10 16:53 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<p><strong>创建 etcd 服务启动脚本 IP 地址改成本机 IP</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# vi &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br><span class="line">[root@hdss7-12 certs]# vi &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir &#x2F;data&#x2F;etcd&#x2F;etcd-server \</span><br><span class="line">       --listen-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https:&#x2F;&#x2F;10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https:&#x2F;&#x2F;10.4.7.12:2379,http:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12&#x3D;https:&#x2F;&#x2F;10.4.7.12:2380,etcd-server-7-21&#x3D;https:&#x2F;&#x2F;10.4.7.21:2380,etcd-server-7-22&#x3D;https:&#x2F;&#x2F;10.4.7.22:2380 \</span><br><span class="line">       --ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">       --key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --peer-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --peer-cert-file .&#x2F;certs&#x2F;etcd-peer.pem \</span><br><span class="line">       --peer-key-file .&#x2F;certs&#x2F;etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file .&#x2F;certs&#x2F;ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></table></figure>

<p><strong>赋予执行权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod +x &#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<p><strong>更改属主属组</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chown -R etcd.etcd &#x2F;opt&#x2F;etcd-v3.1.20&#x2F; &#x2F;data&#x2F;etcd &#x2F;data&#x2F;logs&#x2F;etcd-server</span><br></pre></td></tr></table></figure>

<p><strong>使 etcd 后端运行</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 logs]# yum install supervisor -y</span><br><span class="line">[root@hdss7-12 logs]# systemctl start supervisord</span><br><span class="line">[root@hdss7-12 logs]# systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<p>名字需要根据实际更改 “]<br>更改 supervisord 的配置文件：[program:etcd-server-7-12] 名字需要根据实际更改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 logs]# vi &#x2F;etc&#x2F;supervisord.d&#x2F;etcd-server.ini</span><br><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;etcd&#x2F;etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)    </span><br><span class="line">numprocs&#x3D;1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                   ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;etcd-server&#x2F;etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                     ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                     ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<p><strong>创建后端启动 etcd</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 logs]# supervisorctl update</span><br><span class="line">etcd-server-7-12: added process group</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 logs]# supervisorctl status</span><br><span class="line">etcd-server-7-12                 STARTING </span><br><span class="line"></span><br><span class="line">[root@hdss7-12 logs]# netstat -luntp|grep etcd</span><br><span class="line">tcp        0      0 192.168.153.12:2379     0.0.0.0:*               LISTEN      19395&#x2F;.&#x2F;etcd        </span><br><span class="line">tcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      19395&#x2F;.&#x2F;etcd        </span><br><span class="line">tcp        0      0 192.168.153.12:2380     0.0.0.0:*               LISTEN      19395&#x2F;.&#x2F;etcd  </span><br></pre></td></tr></table></figure>

<p><strong>查看日志</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 logs]# tail -fn 200 &#x2F;data&#x2F;logs&#x2F;etcd-server&#x2F;etcd.stdout.log</span><br></pre></td></tr></table></figure>

<p>旧版本隐藏</p>
<h2 id="部署-kube-apiserver-集群展开目录"><a href="#部署-kube-apiserver-集群展开目录" class="headerlink" title="部署 kube-apiserver 集群展开目录"></a>部署 kube-apiserver 集群展开目录</h2><h3 id="集群规划展开目录-1"><a href="#集群规划展开目录-1" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>kube-apiserver</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>kube-apiserver</p>
<p>10.4.7.22</p>
<p>HDSS7-11.host.com</p>
<p>4 层负载均衡</p>
<p>10.4.7.11</p>
<p>HDSS7-12.host.com</p>
<p>4 层负载均衡</p>
<p>10.4.7.12</p>
<p><strong>注意：</strong>这里 <code>10.4.7.11</code> 和 <code>10.4.7.12</code> 使用 nginx 做 4 层负载均衡器，用 keepalived 跑一个 vip：10.4.7.10，代理两个 kube-apiserver，实现高可用</p>
<p>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="下载软件，解压，做软连接展开目录"><a href="#下载软件，解压，做软连接展开目录" class="headerlink" title="下载软件，解压，做软连接展开目录"></a>下载软件，解压，做软连接展开目录</h3><p><code>HDSS7-21.host.com</code> 上：<br><a target="_blank" rel="noopener" href="https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz">kubernetes 下载地址</a></p>
<p>旧版本隐藏<br><strong>下载软件，解压，做软连接，安装 1.15.2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# cd &#x2F;opt&#x2F;src&#x2F;</span><br><span class="line">[root@hdss7-21 src]# ls</span><br><span class="line">kubernetes-server-linux-amd64-v1.15.2.tar.gz</span><br></pre></td></tr></table></figure>

<p>查看文件大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# du -sh kubernetes-server-linux-amd64-v1.15.2.tar.gz</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 src]# tar xf kubernetes-server-linux-amd64-v1.15.2.tar.gz -C &#x2F;opt&#x2F;</span><br><span class="line">[root@hdss7-21 src]# cd ..</span><br><span class="line">[root@hdss7-21 opt]# mv kubernetes&#x2F; kubernetes-v1.15.2</span><br></pre></td></tr></table></figure>

<p><strong>做软连接，方便以后更新</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 opt]# ln -s &#x2F;opt&#x2F;kubernetes-v1.15.2&#x2F; &#x2F;opt&#x2F;kubernetes</span><br><span class="line">[root@hdss7-21 opt]# ll</span><br><span class="line">总用量 0</span><br><span class="line">drwx--x--x 4 root root  28 12月 10 14:28 containerd</span><br><span class="line">lrwxrwxrwx 1 root root  17 12月 10 16:45 etcd -&gt; &#x2F;opt&#x2F;etcd-v3.1.20</span><br><span class="line">drwxr-xr-x 4 etcd etcd 166 12月 10 17:43 etcd-v3.1.20</span><br><span class="line">lrwxrwxrwx 1 root root  24 12月 10 18:33 kubernetes -&gt; &#x2F;opt&#x2F;kubernetes-v1.15.2&#x2F;</span><br><span class="line">drwxr-xr-x 4 root root  79 8月   5 18:01 kubernetes-v1.15.2</span><br><span class="line">drwxr-xr-x 2 root root  97 12月 10 18:29 src</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 opt]# cd kubernetes</span><br><span class="line">[root@hdss7-21 kubernetes]# ls</span><br><span class="line">addons  kubernetes-src.tar.gz  LICENSES  server</span><br></pre></td></tr></table></figure>

<p><strong>删除源码包</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 kubernetes]# rm -rf kubernetes-src.tar.gz </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 kubernetes]# cd server&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>删除没用的文件 docker 镜像等</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# rm -rf *.tar</span><br><span class="line">[root@hdss7-21 bin]# rm -rf *_tag </span><br></pre></td></tr></table></figure>

<p><strong>剩余一些可执行文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# ll</span><br><span class="line">总用量 884636</span><br><span class="line">-rwxr-xr-x 1 root root  43534816 8月   5 18:01 apiextensions-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 100548640 8月   5 18:01 cloud-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root 200648416 8月   5 18:01 hyperkube</span><br><span class="line">-rwxr-xr-x 1 root root  40182208 8月   5 18:01 kubeadm</span><br><span class="line">-rwxr-xr-x 1 root root 164501920 8月   5 18:01 kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 root root 116397088 8月   5 18:01 kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 root root  42985504 8月   5 18:01 kubectl</span><br><span class="line">-rwxr-xr-x 1 root root 119616640 8月   5 18:01 kubelet</span><br><span class="line">-rwxr-xr-x 1 root root  36987488 8月   5 18:01 kube-proxy</span><br><span class="line">-rwxr-xr-x 1 root root  38786144 8月   5 18:01 kube-scheduler</span><br><span class="line">-rwxr-xr-x 1 root root   1648224 8月   5 18:01 mounter</span><br></pre></td></tr></table></figure>

<p>** 签发 apiserver-client 证书：apiserver 与 etc 通信用的证书。apiserver 是客户端，etcd 是服务端<br>运维主机 HDSS-200.host.com 上 **</p>
<p><strong>创建生成证书签名请求（csr）的 JSON 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi &#x2F;opt&#x2F;certs&#x2F;client-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;client client-csr.json |cfssl-json -bare client</span><br></pre></td></tr></table></figure>

<p><strong>创建签名请求（csr）的 JSON 配置文件，apiserver，server 端证书</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# vi apiserver-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.254.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;,</span><br><span class="line">        &quot;10.4.7.23&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;server apiserver-csr.json | cfssljson -bare apiserver</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">总用量 80</span><br><span class="line">total 24</span><br><span class="line">-rw------- 1 root root 1679 Nov 10 17:42 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1598 Nov 10 17:42 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1679 Nov 10 17:41 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1346 Nov 10 17:41 ca.pem</span><br><span class="line">-rw------- 1 root root 1675 Nov 10 17:41 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1363 Nov 10 17:41 client.pem</span><br></pre></td></tr></table></figure>

<p><strong>拷贝证书</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# mkdir cert</span><br><span class="line">[root@hdss7-21 bin]# cd cert&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>最后有个点，表示拷贝到当前目录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca.pem . </span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;ca-key.pem .</span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client.pem .</span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;client-key.pem .</span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver.pem .</span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;apiserver-key.pem .</span><br></pre></td></tr></table></figure>

<p><strong>创建启动配置脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 cert]# cd ..</span><br><span class="line">[root@hdss7-21 bin]# mkdir conf</span><br><span class="line">[root@hdss7-21 bin]# cd conf&#x2F;</span><br><span class="line">[root@hdss7-21 conf]# </span><br><span class="line">[root@hdss7-21 conf]# vi audit.yaml</span><br><span class="line">apiVersion: audit.k8s.io&#x2F;v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&#39;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&#39;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods&#x2F;log&quot;, &quot;pods&#x2F;status&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&#39;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;&#x2F;api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;&#x2F;version&quot;</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>

<p><strong>编写启动脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">.&#x2F;kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \   API服务器存在的数量</span><br><span class="line">  --audit-log-path &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;audit-log \</span><br><span class="line">  --audit-policy-file .&#x2F;conf&#x2F;audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --requestheader-client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --etcd-certfile .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-keyfile .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-servers https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb&#x3D;1024 \</span><br><span class="line">  --kubelet-client-certificate .&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --kubelet-client-key .&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --log-dir  &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;apiserver.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;apiserver-key.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<p><strong>查看帮助命令，查看每行的意思</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# .&#x2F;kube-apiserver --help|grep -A 5 target-ram-mb </span><br></pre></td></tr></table></figure>

<p><strong>添加执行权限</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x kube-apiserver.sh</span><br></pre></td></tr></table></figure>

<p><strong>创建后台启动</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-apiserver.ini</span><br><span class="line">[program:kube-apiserver-7-21]                    # 21根据实际IP地址更改</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                   ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver&#x2F;apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                     ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                     ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 bin]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-apiserver</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 bin]# netstat -luntp | grep kube-api</span><br><span class="line">tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      27303&#x2F;.&#x2F;kube-apiser </span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      27303&#x2F;.&#x2F;kube-apiser </span><br></pre></td></tr></table></figure>

<h2 id="安装部署主控节点-4-层反向代理服务展开目录"><a href="#安装部署主控节点-4-层反向代理服务展开目录" class="headerlink" title="安装部署主控节点 4 层反向代理服务展开目录"></a>安装部署主控节点 4 层反向代理服务展开目录</h2><p><strong>部署在 <code>hdss7-11 hdss7-12</code> 机器上，用 VIP <code>10.4.7.10</code> 的 7443 端口，反代 <code>hdss7-21、hdss7-22</code> 的 apiserver6443 端口</strong></p>
<p>HDSS7-11 和 HDSS7-12 上同时操作</p>
<p><strong>nginx 配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# yum install -y nginx    </span><br><span class="line"></span><br><span class="line">[root@hdss7-11 ~]# vi &#x2F;etc&#x2F;nginx&#x2F;nginx.conf        </span><br><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails&#x3D;3 fail_timeout&#x3D;30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# nginx -t</span><br><span class="line">nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 ~]# systemctl start nginx</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p><strong>keepalived 安装配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# yum install keepalived -y</span><br></pre></td></tr></table></figure>

<p><strong>编写监听脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# vi &#x2F;etc&#x2F;keepalived&#x2F;check_port.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 6379&quot; #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#&#125;</span><br><span class="line">CHK_PORT&#x3D;$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS&#x3D;&#96;ss -lnt|grep $CHK_PORT|wc -l&#96;</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 ~]# # chmod +x &#x2F;etc&#x2F;keepalived&#x2F;check_port.sh</span><br></pre></td></tr></table></figure>

<p><strong>配置 keepalived</strong><br>keepalived 主keepalived 从[root@hdss7-11 ~]# vi /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived</p>
<p>global_defs {<br>router_id 10.4.7.11</p>
<p>}</p>
<p>vrrp_script chk_nginx {</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script &quot;&#x2F;etc&#x2F;keepalived&#x2F;check_port.sh 7443&quot;</span><br><span class="line">interval 2</span><br><span class="line">weight -20</span><br></pre></td></tr></table></figure>

<p>}</p>
<p>vrrp_instance VI_1 {</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">state MASTER</span><br><span class="line">interface eth0    # 根据实际网卡更改</span><br><span class="line">virtual_router_id 251</span><br><span class="line">priority 100</span><br><span class="line">advert_int 1</span><br><span class="line">mcast_src_ip 10.4.7.11</span><br><span class="line">nopreempt</span><br><span class="line"></span><br><span class="line">authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass 11111111</span><br><span class="line">&#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">     chk_nginx</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">    10.4.7.10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-11 keepalived]# ss -lnt|grep 7443|wc -l         </span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">[root@hdss7-11 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable keepalived</span><br></pre></td></tr></table></figure>

<p><strong>如果 vip 出现变动，主 keepalived 恢复后，一定要确认主 keepalived 端口起来， 服务搞好，重启 keepalived，是 vip 变回主 keepalived</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# netstat -luntp | grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      22071&#x2F;nginx: master </span><br></pre></td></tr></table></figure>

<h2 id="部署-controller-manager展开目录"><a href="#部署-controller-manager展开目录" class="headerlink" title="部署 controller-manager展开目录"></a>部署 controller-manager展开目录</h2><h3 id="集群规划展开目录-2"><a href="#集群规划展开目录-2" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>controller-manager</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>controller-manager</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本展开目录"><a href="#创建启动脚本展开目录" class="headerlink" title="创建启动脚本展开目录"></a>创建启动脚本展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file .&#x2F;cert&#x2F;ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0&#x2F;16 \</span><br><span class="line">  --root-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录展开目录"><a href="#调整文件权限，创建目录展开目录" class="headerlink" title="调整文件权限，创建目录展开目录"></a>调整文件权限，创建目录展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">[root@hdss7-21 bin]# chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager</span><br></pre></td></tr></table></figure>

<h3 id="创建-supervisor-配置展开目录"><a href="#创建-supervisor-配置展开目录" class="headerlink" title="创建 supervisor 配置展开目录"></a>创建 supervisor 配置展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;supervisord.d&#x2F;kube-conntroller-manager.ini</span><br><span class="line">[program:kube-controller-manager-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                                     ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-controller-manager&#x2F;controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                                       ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查展开目录"><a href="#启动服务并检查展开目录" class="headerlink" title="启动服务并检查展开目录"></a>启动服务并检查展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-controller-manager: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status   </span><br><span class="line">etcd-server-7-21                 RUNNING   pid 30474, uptime 17:25:13</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 30473, uptime 17:25:13</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 32962, uptime 0:00:31</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的-kube-controller-manager-服务展开目录"><a href="#安装部署启动检查所有集群规划主机上的-kube-controller-manager-服务展开目录" class="headerlink" title="安装部署启动检查所有集群规划主机上的 kube-controller-manager 服务展开目录"></a>安装部署启动检查所有集群规划主机上的 kube-controller-manager 服务展开目录</h3><p>步骤相似略</p>
<h2 id="部署-kube-scheduler展开目录"><a href="#部署-kube-scheduler展开目录" class="headerlink" title="部署 kube-scheduler展开目录"></a>部署 kube-scheduler展开目录</h2><h3 id="集群规划展开目录-3"><a href="#集群规划展开目录-3" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>kube-scheduler</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>kube-scheduler</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本展开目录-1"><a href="#创建启动脚本展开目录-1" class="headerlink" title="创建启动脚本展开目录"></a>创建启动脚本展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler \</span><br><span class="line">  --master http:&#x2F;&#x2F;127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录展开目录-1"><a href="#调整文件权限，创建目录展开目录-1" class="headerlink" title="调整文件权限，创建目录展开目录"></a>调整文件权限，创建目录展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">[root@hdss7-21 bin]# chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="创建-supervisor-配置展开目录-1"><a href="#创建-supervisor-配置展开目录-1" class="headerlink" title="创建 supervisor 配置展开目录"></a>创建 supervisor 配置展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;supervisord.d&#x2F;kube-scheduler.ini</span><br><span class="line">[program:kube-scheduler-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                            ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-scheduler&#x2F;scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                              ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                              ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查展开目录-1"><a href="#启动服务并检查展开目录-1" class="headerlink" title="启动服务并检查展开目录"></a>启动服务并检查展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-scheduler: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 27300, uptime 18:45:03</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 27301, uptime 18:45:03</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 79809, uptime 1:24:14</span><br><span class="line">kube-scheduler-7-21              RUNNING   pid 81360, uptime 0:54:28</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的-kube-scheduler-服务展开目录"><a href="#安装部署启动检查所有集群规划主机上的-kube-scheduler-服务展开目录" class="headerlink" title="安装部署启动检查所有集群规划主机上的 kube-scheduler 服务展开目录"></a>安装部署启动检查所有集群规划主机上的 kube-scheduler 服务展开目录</h3><p>略<br><code>下面操作在集群规划主机21/22上做</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# ln -s &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubectl &#x2F;usr&#x2F;bin&#x2F;kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;kubectl</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 bin]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="部署-Node-节点服务展开目录"><a href="#部署-Node-节点服务展开目录" class="headerlink" title="部署 Node 节点服务展开目录"></a>部署 Node 节点服务展开目录</h1><h2 id="部署-kubelet展开目录"><a href="#部署-kubelet展开目录" class="headerlink" title="部署 kubelet展开目录"></a>部署 kubelet展开目录</h2><h3 id="集群规划展开目录-4"><a href="#集群规划展开目录-4" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>kubelet</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>kubelet</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发-kubelet-证书展开目录"><a href="#签发-kubelet-证书展开目录" class="headerlink" title="签发 kubelet 证书展开目录"></a>签发 kubelet 证书展开目录</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<h4 id="创建生成证书签名请求（csr）的-JSON-配置文件展开目录"><a href="#创建生成证书签名请求（csr）的-JSON-配置文件展开目录" class="headerlink" title="创建生成证书签名请求（csr）的 JSON 配置文件展开目录"></a>创建生成证书签名请求（csr）的 JSON 配置文件展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@hdss7-200 etc]# cd &#x2F;opt&#x2F;certs&#x2F;</span><br><span class="line">[root@hdss7-200 certs]# vi kubelet-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubelet-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成-kubelet-证书和私钥展开目录"><a href="#生成-kubelet-证书和私钥展开目录" class="headerlink" title="生成 kubelet 证书和私钥展开目录"></a>生成 kubelet 证书和私钥展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;certs</span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;server kubelet-csr.json | cfssl-json -bare kubelet</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥展开目录"><a href="#检查生成的证书、私钥展开目录" class="headerlink" title="检查生成的证书、私钥展开目录"></a>检查生成的证书、私钥展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;certs</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">-rw-r--r-- 1 root root 1115 12月 11 16:16 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root  498 12月 11 16:16 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 12月 11 16:16 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1468 12月 11 16:16 kubelet.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书、私钥，注意私钥文件属性-600，拷贝至：-opt-kubernetes-server-bin-cert-展开目录"><a href="#拷贝证书、私钥，注意私钥文件属性-600，拷贝至：-opt-kubernetes-server-bin-cert-展开目录" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性 600，拷贝至：/opt/kubernetes/server/bin/cert/展开目录"></a>拷贝证书、私钥，注意私钥文件属性 600，拷贝至：/opt/kubernetes/server/bin/cert/展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性-600展开目录"><a href="#拷贝证书、私钥，注意私钥文件属性-600展开目录" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性 600展开目录"></a>拷贝证书、私钥，注意私钥文件属性 600展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;</span><br><span class="line">root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet.pem .</span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-200:&#x2F;opt&#x2F;certs&#x2F;kubelet-key.pem .</span><br><span class="line">注意：后面的点代表当前目录</span><br></pre></td></tr></table></figure>

<h4 id="创建配置展开目录"><a href="#创建配置展开目录" class="headerlink" title="创建配置展开目录"></a>创建配置展开目录</h4><p><code>HDSS7-21.host.com</code> 上：</p>
<h5 id="给-kubectl-创建软连接展开目录"><a href="#给-kubectl-创建软连接展开目录" class="headerlink" title="给 kubectl 创建软连接展开目录"></a>给 kubectl 创建软连接展开目录</h5><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin</span><br><span class="line">[root@hdss7-21 bin]# ln -s &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubectl &#x2F;usr&#x2F;bin&#x2F;kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;kubectl</span><br><span class="line">前面已经做过</span><br></pre></td></tr></table></figure>

<h5 id="set-cluster展开目录"><a href="#set-cluster展开目录" class="headerlink" title="set-cluster展开目录"></a>set-cluster展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># IP地址提前改好再粘贴复制IP为keeplive的VIP地址</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">    --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">    --embed-certs&#x3D;true \</span><br><span class="line">    --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">    --kubeconfig&#x3D;kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials展开目录"><a href="#set-credentials展开目录" class="headerlink" title="set-credentials展开目录"></a>set-credentials展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kubelet.kubeconfig </span><br><span class="line"></span><br><span class="line">User &quot;k8s-node&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context展开目录"><a href="#set-context展开目录" class="headerlink" title="set-context展开目录"></a>set-context展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster&#x3D;myk8s \</span><br><span class="line">  --user&#x3D;k8s-node \</span><br><span class="line">  --kubeconfig&#x3D;kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context展开目录"><a href="#use-context展开目录" class="headerlink" title="use-context展开目录"></a>use-context展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig&#x3D;kubelet.kubeconfig</span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h5 id="k8s-node-yaml展开目录"><a href="#k8s-node-yaml展开目录" class="headerlink" title="k8s-node.yaml展开目录"></a>k8s-node.yaml展开目录</h5><ul>
<li>创建资源配置文件</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf&#x2F;k8s-node.yaml</span><br><span class="line">[root@hdss7-21 conf]# vi k8s-node.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line"></span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>

<ul>
<li>应用资源配置文件</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;k8s-node created</span><br></pre></td></tr></table></figure>

<ul>
<li>检查</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node -o yaml</span><br><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME           AGE</span><br><span class="line">k8s-node       3m</span><br></pre></td></tr></table></figure>

<p>提示授予权限，角色绑定 – 只创建一次就好，存到 etcd 里，然后拷贝 kubelet.kubeconfig（同时还有证书）到各个 node 节点上<br>HDSS7-22 上:<br>[root@hdss7-22 cert]# cd /opt/kubernetes/server/bin/conf<br>[root@hdss7-22 conf]# scp hdss7-13:/opt/kubernetes/server/bin/conf/kubelet.kubeconfig .</p>
<h3 id="准备-pause-基础镜像-–-边车模式展开目录"><a href="#准备-pause-基础镜像-–-边车模式展开目录" class="headerlink" title="准备 pause 基础镜像 – 边车模式展开目录"></a>准备 pause 基础镜像 – 边车模式展开目录</h3><p><strong>运维主机 hdss7-200.host.com 上：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kubernetes&#x2F;pause</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9d5de079539 harbor.od.com&#x2F;public&#x2F;pause:latest</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com&#x2F;public&#x2F;pause:latest</span><br></pre></td></tr></table></figure>

<p><strong>编写启动脚本 – # 更改主机名</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kubelet \</span><br><span class="line">  --anonymous-auth&#x3D;false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \  </span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --kubelet-cgroups&#x3D;&#x2F;systemd&#x2F;system.slice \</span><br><span class="line">  --fail-swap-on&#x3D;&quot;false&quot; \</span><br><span class="line">  --client-ca-file .&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --tls-cert-file .&#x2F;cert&#x2F;kubelet.pem \</span><br><span class="line">  --tls-private-key-file .&#x2F;cert&#x2F;kubelet-key.pem \</span><br><span class="line">  --hostname-override hdss7-21.host.com \               记得修改主机名        </span><br><span class="line">  --kubeconfig .&#x2F;conf&#x2F;kubelet.kubeconfig \</span><br><span class="line">  --log-dir &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com&#x2F;public&#x2F;pause:latest \</span><br><span class="line">  --root-dir &#x2F;data&#x2F;kubelet</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet &#x2F;data&#x2F;kubelet</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-kubelet.ini</span><br><span class="line">[program:kube-kubelet-7-21]    </span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                     ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-kubelet&#x2F;kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                       ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                       ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 conf]# supervisorctl update</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6565, uptime 0:24:15</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 6566, uptime 0:24:15</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 6551, uptime 0:24:15</span><br><span class="line">kube-kubelet-7-21                RUNNING   pid 16663, uptime 0:01:14</span><br><span class="line">kube-scheduler-7-21              RUNNING   pid 6552, uptime 0:24:15</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 cert]# kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE     VERSION</span><br><span class="line">hdss7-21.host.com   Ready    &lt;none&gt;   15h     v1.15.2</span><br><span class="line">hdss7-22.host.com   Ready    &lt;none&gt;   8m51s   v1.15.2</span><br></pre></td></tr></table></figure>

<p><strong># ROlES 添加标签，设定节点角色，可同时加两个标签</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]# kubectl label node hdss7-21.host.com node-role.kubernetes.io&#x2F;master&#x3D;</span><br><span class="line">[root@hdss7-21 cert]# kubectl label node hdss7-21.host.com node-role.kubernetes.io&#x2F;node&#x3D;</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# kubectl get nodes                               </span><br><span class="line">NAME                STATUS   ROLES         AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    master,node   15h   v1.15.2</span><br><span class="line">hdss7-22.host.com   Ready    master,node   12m   v1.15.2</span><br></pre></td></tr></table></figure>

<p><strong>非常重要！</strong></p>
<h3 id="安装部署启动检查所有集群规划主机上的-kubelet-服务展开目录"><a href="#安装部署启动检查所有集群规划主机上的-kubelet-服务展开目录" class="headerlink" title="安装部署启动检查所有集群规划主机上的 kubelet 服务展开目录"></a>安装部署启动检查所有集群规划主机上的 kubelet 服务展开目录</h3><p>略</p>
<h2 id="部署-kube-proxy展开目录"><a href="#部署-kube-proxy展开目录" class="headerlink" title="部署 kube-proxy展开目录"></a>部署 kube-proxy展开目录</h2><h3 id="集群规划展开目录-5"><a href="#集群规划展开目录-5" class="headerlink" title="集群规划展开目录"></a>集群规划展开目录</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>kube-proxy</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>kube-proxy</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发-kube-proxy-证书展开目录"><a href="#签发-kube-proxy-证书展开目录" class="headerlink" title="签发 kube-proxy 证书展开目录"></a>签发 kube-proxy 证书展开目录</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p><strong>签发生成证书签名请求（CSR）的 JSON 配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# vi &#x2F;opt&#x2F;certs&#x2F;kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>生成证书</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;client kube-proxy-csr.json |cfssl-json -bare kube-proxy-client</span><br><span class="line">[root@hdss7-200 certs]# ll</span><br><span class="line">-rw-r--r-- 1 root root 1005 12月 12 10:23 kube-proxy-client.csr</span><br><span class="line">-rw------- 1 root root 1679 12月 12 10:23 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1375 12月 12 10:23 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  267 12月 12 10:22 kube-proxy-csr.json</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>分发证书，将证书拷贝到 node 节点，注意私钥文件属性 600</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-12:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client-key.pem .</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 cert]# scp hdss7-12:&#x2F;opt&#x2F;certs&#x2F;kube-proxy-client.pem .</span><br></pre></td></tr></table></figure>

<p><strong>在 conf 文件夹下创建配置 – 只做一次，然后将 kube-proxy.kubeconfig 拷贝至各个 node 节点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]# cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line"></span><br><span class="line"># --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 此IP地址是keeplive的VIP地址，注意修改</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# ls</span><br><span class="line">audit.yaml  k8s-node.yaml  kubelet.kubeconfig  kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster&#x3D;myk8s \</span><br><span class="line">  --user&#x3D;kube-proxy \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><strong>第一台 node 节点部署完成后，将生成的配置文件拷贝至各个 Node 节点（记得证书）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 cert]# cd &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 conf]# scp hdss7-14:&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf&#x2F;kube-proxy.kubeconfig .</span><br></pre></td></tr></table></figure>

<p><strong>* 加载 ipvs 模块 – 脚本需要设置成开启自动运行</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# vi &#x2F;root&#x2F;ipvs.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">ipvs_mods_dir&#x3D;&quot;&#x2F;usr&#x2F;lib&#x2F;modules&#x2F;$(uname -r)&#x2F;kernel&#x2F;net&#x2F;netfilter&#x2F;ipvs&quot;</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)</span><br><span class="line">do</span><br><span class="line">  &#x2F;sbin&#x2F;modinfo -F filename $i &amp;&gt;&#x2F;dev&#x2F;null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    &#x2F;sbin&#x2F;modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x &#x2F;root&#x2F;ipvs.sh </span><br></pre></td></tr></table></figure>

<p><strong>执行脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# &#x2F;root&#x2F;ipvs.sh </span><br></pre></td></tr></table></figure>

<p><strong>查看内核是否加载 ipvs 模块</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# lsmod | grep ip_vs     </span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_wlc              12519  0 </span><br><span class="line">ip_vs_sh               12688  0 </span><br><span class="line">ip_vs_sed              12519  0 </span><br><span class="line">ip_vs_rr               12600  0 </span><br><span class="line">ip_vs_pe_sip           12740  0 </span><br><span class="line">nf_conntrack_sip       33860  1 ip_vs_pe_sip</span><br><span class="line">ip_vs_nq               12516  0 </span><br><span class="line">ip_vs_lc               12516  0 </span><br><span class="line">ip_vs_lblcr            12922  0 </span><br><span class="line">ip_vs_lblc             12819  0 </span><br><span class="line">ip_vs_ftp              13079  0 </span><br><span class="line">ip_vs_dh               12688  0 </span><br><span class="line">ip_vs                 145497  24 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_pe_sip,ip_vs_lblcr,ip_vs_lblc</span><br><span class="line">nf_nat                 26787  3 ip_vs_ftp,nf_nat_ipv4,nf_nat_masquerade_ipv4</span><br><span class="line">nf_conntrack          133095  8 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_sip,nf_conntrack_ipv4</span><br><span class="line">libcrc32c              12644  4 xfs,ip_vs,nf_nat,nf_conntrack</span><br></pre></td></tr></table></figure>

<p><strong>设置开机自动启动</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# vi &#x2F;etc&#x2F;rc.d&#x2F;rc.local</span><br><span class="line">&#x2F;root&#x2F;ipvs.sh</span><br></pre></td></tr></table></figure>

<p>开启开机自启动脚本（可选）<br><strong>创建 kube-prox y 启动脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">HDSS-7-21.host.com：</span><br><span class="line">[root@hdss7-22 ~]# vi &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --proxy-mode&#x3D;ipvs \</span><br><span class="line">  --ipvs-scheduler&#x3D;nq \</span><br><span class="line">  --kubeconfig .&#x2F;conf&#x2F;kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# vi &#x2F;etc&#x2F;supervisord.d&#x2F;kube-proxy.ini</span><br><span class="line">[program:kube-proxy-7-21]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                        ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                            ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;true                                                 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                          ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                          ; emit events on stdout writes (default false)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# supervisorctl update</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# supervisorctl status</span><br><span class="line">kube-proxy-7-22                  RUNNING   pid 6873, uptime 0:28:15</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# netstat -luntp |grep kube-proxy</span><br><span class="line">tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      7310&#x2F;.&#x2F;kube-proxy   </span><br><span class="line">tcp6       0      0 :::10256                :::*                    LISTEN      7310&#x2F;.&#x2F;kube-proxy  </span><br></pre></td></tr></table></figure>

<p><strong>查看 ipvs 是否生效</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# yum install -y ipvsadm    # 只安装，不启动</span><br><span class="line">[root@hdss7-21 ~]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size&#x3D;4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 nq</span><br><span class="line">  -&gt; 192.168.153.21:6443          Masq    1      0          0         </span><br><span class="line">  -&gt; 192.168.153.22:6443          Masq    1      0          0  </span><br></pre></td></tr></table></figure>

<p><strong># 注意：kube-proxy 集群各主机启动脚本略有不同，部署其他节点注意修改</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# cat &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stdout.log </span><br></pre></td></tr></table></figure>

<h4 id="旧版本隐藏展开目录"><a href="#旧版本隐藏展开目录" class="headerlink" title="旧版本隐藏展开目录"></a>旧版本隐藏展开目录</h4><p>创建生成证书签名请求（csr）的 JSON 配置文件</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;certs&#x2F;kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成-kube-proxy-证书和私钥展开目录"><a href="#生成-kube-proxy-证书和私钥展开目录" class="headerlink" title="生成 kube-proxy 证书和私钥展开目录"></a>生成 kube-proxy 证书和私钥展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;certs</span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;client kube-proxy-csr.json | cfssljson -bare kube-proxy-client</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [INFO] generate received request</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [INFO] received CSR</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [INFO] generating key: rsa-2048</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [INFO] encoded CSR</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [INFO] signed certificate with serial number 375797145588654714099258750873820528127028390681</span><br><span class="line">2019&#x2F;01&#x2F;18 18:14:23 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA&#x2F;Browser Forum (https:&#x2F;&#x2F;cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥展开目录-1"><a href="#检查生成的证书、私钥展开目录-1" class="headerlink" title="检查生成的证书、私钥展开目录"></a>检查生成的证书、私钥展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;certs</span><br><span class="line">[root@hdss7-200 certs]# ls -l|grep kube-proxy</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1005 Jan 22 17:31 kube-proxy-client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  268 Jan 22 17:23 kube-proxy-csr.json</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置展开目录"><a href="#拷贝证书至各运算节点，并创建配置展开目录" class="headerlink" title="拷贝证书至各运算节点，并创建配置展开目录"></a>拷贝证书至各运算节点，并创建配置展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性-600展开目录-1"><a href="#拷贝证书、私钥，注意私钥文件属性-600展开目录-1" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性 600展开目录"></a>拷贝证书、私钥，注意私钥文件属性 600展开目录</h4><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">[root@hdss7-21 cert]# ls -l &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert</span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root 1676 Jan 21 16:39 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 16:36 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 13:55 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 21 13:50 ca.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 13:53 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1368 Jan 21 13:53 client.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置展开目录-1"><a href="#创建配置展开目录-1" class="headerlink" title="创建配置展开目录"></a>创建配置展开目录</h4><h5 id="set-cluster展开目录-1"><a href="#set-cluster展开目录-1" class="headerlink" title="set-cluster展开目录"></a>set-cluster展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;https:&#x2F;&#x2F;10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials展开目录-1"><a href="#set-credentials展开目录-1" class="headerlink" title="set-credentials展开目录"></a>set-credentials展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;cert&#x2F;kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">User &quot;kube-proxy&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context展开目录-1"><a href="#set-context展开目录-1" class="headerlink" title="set-context展开目录"></a>set-context展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster&#x3D;myk8s \</span><br><span class="line">  --user&#x3D;kube-proxy \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context展开目录-1"><a href="#use-context展开目录-1" class="headerlink" title="use-context展开目录"></a>use-context展开目录</h5><p><strong>注意：</strong>在 conf 目录下</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h3 id="创建-kube-proxy-启动脚本展开目录"><a href="#创建-kube-proxy-启动脚本展开目录" class="headerlink" title="创建 kube-proxy 启动脚本展开目录"></a>创建 kube-proxy 启动脚本展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy-721.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0&#x2F;16 \</span><br><span class="line">  --hostname-override 10.4.7.21 \</span><br><span class="line">  --kubeconfig .&#x2F;conf&#x2F;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kube-proxy 集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录展开目录"><a href="#检查配置，权限，创建日志目录展开目录" class="headerlink" title="检查配置，权限，创建日志目录展开目录"></a>检查配置，权限，创建日志目录展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;conf</span><br><span class="line">[root@hdss7-21 conf]# ls -l|grep kube-proxy.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x &#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p &#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="创建-supervisor-配置展开目录-2"><a href="#创建-supervisor-配置展开目录-2" class="headerlink" title="创建 supervisor 配置展开目录"></a>创建 supervisor 配置展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;supervisord.d&#x2F;kube-proxy.ini</span><br><span class="line">[program:kube-proxy]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin&#x2F;kube-proxy-721.sh                 ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;kubernetes&#x2F;server&#x2F;bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;22                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                                                        ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                                 ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;false                                                    ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stdout.log     ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                              ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                              ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;kubernetes&#x2F;kube-proxy&#x2F;proxy.stderr.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes&#x3D;64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups&#x3D;4                                                 ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes&#x3D;1MB                                                      ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stderr_events_enabled&#x3D;false                                                      ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查展开目录-2"><a href="#启动服务并检查展开目录-2" class="headerlink" title="启动服务并检查展开目录"></a>启动服务并检查展开目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-proxy: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     RUNNING   pid 14597, uptime 0:32:59</span><br><span class="line">kube-proxy                       STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的-kube-proxy-服务"><a href="#安装部署启动检查所有集群规划主机上的-kube-proxy-服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的 kube-proxy 服务"></a>安装部署启动检查所有集群规划主机上的 kube-proxy 服务</h3><p>略</p>
<h1 id="部署-addons-插件"><a href="#部署-addons-插件" class="headerlink" title="部署 addons 插件"></a>部署 addons 插件</h1><h2 id="验证-kubernetes-集群"><a href="#验证-kubernetes-集群" class="headerlink" title="验证 kubernetes 集群"></a>验证 kubernetes 集群</h2><h3 id="在任意一个运算节点，创建一个资源配置清单"><a href="#在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="在任意一个运算节点，创建一个资源配置清单"></a>在任意一个运算节点，创建一个资源配置清单</h3><p><strong>这里我们选择 <code>HDSS7-22.host.com</code> 主机</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# vi &#x2F;root&#x2F;nginx-ds.yaml</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.od.com&#x2F;public&#x2F;nginx:v1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<p><strong>测试完删除</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# kubectl create -f nginx-ds.yaml </span><br><span class="line">daemonset.extensions&#x2F;nginx-ds created</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP           NODE                NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-72zm5   1&#x2F;1     Running   0          86s   172.7.21.2   hdss7-21.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-cb7ct   1&#x2F;1     Running   0          86s   172.7.22.2   hdss7-22.host.com   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# kubectl delete -f nginx-ds.yaml </span><br><span class="line"></span><br><span class="line">[root@hdss7-22 ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125; </span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>补</p>
<h2 id="部署-flannel"><a href="#部署-flannel" class="headerlink" title="部署 flannel"></a>部署 flannel</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><p>主机名</p>
<p>角色</p>
<p>ip</p>
<p>HDSS7-21.host.com</p>
<p>flannel</p>
<p>10.4.7.21</p>
<p>HDSS7-22.host.com</p>
<p>flannel</p>
<p>10.4.7.22</p>
<p><strong>注意：</strong>这里部署文档以 <code>HDSS7-21.host.com</code> 主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="在各运算节点上增加-iptables-规则"><a href="#在各运算节点上增加-iptables-规则" class="headerlink" title="在各运算节点上增加 iptables 规则"></a>在各运算节点上增加 iptables 规则</h3><p><strong>注意：</strong>iptables 规则各主机的略有不同，其他运算节点上执行时注意修改。</p>
<ul>
<li>优化 SNAT 规则，各运算节点之间的各 POD 之间的网络通信不再出网</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># iptables -t nat -D POSTROUTING -s 172.7.21.0&#x2F;24 ! -o docker0 -j MASQUERADE</span><br><span class="line"># iptables -t nat -I POSTROUTING -s 172.7.21.0&#x2F;24 ! -d 172.7.0.0&#x2F;16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>10.4.7.21 主机上的，来源是 172.7.21.0/24 段的 docker 的 ip，目标 ip 不是 172.7.0.0/16 段，网络发包不从 docker0 桥设备出站的，才进行 SNAT 转换</p>
</blockquote>
<h3 id="各运算节点保存-iptables-规则"><a href="#各运算节点保存-iptables-规则" class="headerlink" title="各运算节点保存 iptables 规则"></a>各运算节点保存 iptables 规则</h3><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save &gt; &#x2F;etc&#x2F;sysconfig&#x2F;iptables</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;src</span><br><span class="line">[root@hdss7-21 src]# ls -l|grep flannel</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 18:46 flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# mkdir -p &#x2F;opt&#x2F;flannel-v0.10.0-linux-amd64&#x2F;cert</span><br><span class="line">[root@hdss7-21 src]# tar xf flannel-v0.10.0-linux-amd64.tar.gz -C &#x2F;opt&#x2F;flannel-v0.10.0-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s &#x2F;opt&#x2F;flannel-v0.10.0-linux-amd64 &#x2F;opt&#x2F;flannel</span><br><span class="line">[root@hdss7-21 src]# ls -l &#x2F;opt|grep flannel</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 17 18:49 flannel -&gt; flannel-v0.10.0-linux-amd64&#x2F;</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 18:47 flannel-v0.10.0-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="最终目录结构"><a href="#最终目录结构" class="headerlink" title="最终目录结构"></a>最终目录结构</h3><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt</span><br><span class="line">[root@hdss7-21 opt]# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">|-- etcd-v3.1.18-linux-amd64</span><br><span class="line">|   |-- Documentation</span><br><span class="line">|   |-- README-etcdctl.md</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- READMEv2-etcdctl.md</span><br><span class="line">|   |-- certs</span><br><span class="line">|   |-- etcd</span><br><span class="line">|   |-- etcd-server-startup.sh</span><br><span class="line">|   &#96;-- etcdctl</span><br><span class="line">|-- flannel -&gt; flannel-v0.10.0&#x2F;</span><br><span class="line">|-- flannel-v0.10.0</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- cert</span><br><span class="line">|   |-- flanneld</span><br><span class="line">|   &#96;-- mk-docker-opts.sh</span><br><span class="line">|-- kubernetes -&gt; kubernetes-v1.13.2-linux-amd64&#x2F;</span><br><span class="line">|-- kubernetes-v1.13.2-linux-amd64</span><br><span class="line">|   |-- LICENSES</span><br><span class="line">|   |-- addons</span><br><span class="line">|   &#96;-- server</span><br><span class="line">&#96;-- src</span><br><span class="line">    |-- etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">    |-- flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">    &#96;-- kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="操作-etcd，增加-host-gw"><a href="#操作-etcd，增加-host-gw" class="headerlink" title="操作 etcd，增加 host-gw"></a>操作 etcd，增加 host-gw</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;etcd</span><br><span class="line">[root@hdss7-21 etcd]# .&#x2F;etcdctl set &#x2F;coreos.com&#x2F;network&#x2F;config &#39;&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;&#39;</span><br><span class="line">&#123;&quot;Network&quot;: &quot;172.7.0.0&#x2F;16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;flannel&#x2F;subnet.env</span><br><span class="line">FLANNEL_NETWORK&#x3D;172.7.0.0&#x2F;16</span><br><span class="line">FLANNEL_SUBNET&#x3D;172.7.21.1&#x2F;24</span><br><span class="line">FLANNEL_MTU&#x3D;1500</span><br><span class="line">FLANNEL_IPMASQ&#x3D;false</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel 集群各主机的配置略有不同，部署其他节点时注意修改。</p>
<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;flannel&#x2F;flanneld.sh</span><br><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">.&#x2F;flanneld \</span><br><span class="line">  --public-ip&#x3D;10.4.7.21 \</span><br><span class="line">  --etcd-endpoints&#x3D;https:&#x2F;&#x2F;10.4.7.12:2379,https:&#x2F;&#x2F;10.4.7.21:2379,https:&#x2F;&#x2F;10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile&#x3D;.&#x2F;cert&#x2F;client-key.pem \</span><br><span class="line">  --etcd-certfile&#x3D;.&#x2F;cert&#x2F;client.pem \</span><br><span class="line">  --etcd-cafile&#x3D;.&#x2F;cert&#x2F;ca.pem \</span><br><span class="line">  --iface&#x3D;eth0 \</span><br><span class="line">  --subnet-file&#x3D;.&#x2F;subnet.env \</span><br><span class="line">  --healthz-port&#x3D;2401</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel 集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;opt&#x2F;flannel</span><br><span class="line">[root@hdss7-21 flannel]# chmod +x &#x2F;opt&#x2F;flannel&#x2F;flanneld.sh </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 flannel]# mkdir -p &#x2F;data&#x2F;logs&#x2F;flanneld</span><br></pre></td></tr></table></figure>

<h3 id="创建-supervisor-配置"><a href="#创建-supervisor-配置" class="headerlink" title="创建 supervisor 配置"></a>创建 supervisor 配置</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;supervisord.d&#x2F;flanneld.ini</span><br><span class="line">[program:flanneld]</span><br><span class="line">command&#x3D;&#x2F;opt&#x2F;flannel&#x2F;flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs&#x3D;1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory&#x3D;&#x2F;opt&#x2F;flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart&#x3D;true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart&#x3D;true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs&#x3D;22                   ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries&#x3D;3                          ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes&#x3D;0,2                           ; &#39;expected&#39; exit codes for process (default 0,2)</span><br><span class="line">stopsignal&#x3D;QUIT                         ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs&#x3D;10                         ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user&#x3D;root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr&#x3D;false                                        ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;flanneld&#x2F;flanneld.stdout.log       ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes&#x3D;64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups&#x3D;4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes&#x3D;1MB                                  ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stdout_events_enabled&#x3D;false                                  ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile&#x3D;&#x2F;data&#x2F;logs&#x2F;flanneld&#x2F;flanneld.stderr.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes&#x3D;64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups&#x3D;4                                     ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes&#x3D;1MB                                  ; number of bytes in &#39;capturemode&#39; (default 0)</span><br><span class="line">stderr_events_enabled&#x3D;false                                  ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flanneld]# supervisorctl update</span><br><span class="line">flanneld: added process group</span><br><span class="line">[root@hdss7-21 flanneld]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 1 day, 20:35:42</span><br><span class="line">flanneld                         STARTING  </span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 1 day, 19:01:43</span><br><span class="line">kube-controller-manager          RUNNING   pid 37646, uptime 0:58:48</span><br><span class="line">kube-kubelet                     RUNNING   pid 32640, uptime 17:16:36</span><br><span class="line">kube-proxy                       RUNNING   pid 15097, uptime 17:55:36</span><br><span class="line">kube-scheduler                   RUNNING   pid 37803, uptime 0:55:47</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的-flannel-服务"><a href="#安装部署启动检查所有集群规划主机上的-flannel-服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的 flannel 服务"></a>安装部署启动检查所有集群规划主机上的 flannel 服务</h3><p>略</p>
<h3 id="再次验证集群"><a href="#再次验证集群" class="headerlink" title="再次验证集群"></a>再次验证集群</h3><h2 id="部署-k8s-资源配置清单的内网-http-服务"><a href="#部署-k8s-资源配置清单的内网-http-服务" class="headerlink" title="部署 k8s 资源配置清单的内网 http 服务"></a>部署 k8s 资源配置清单的内网 http 服务</h2><h3 id="在运维主机-HDSS7-200-host-com-上，配置一个-nginx-虚拟主机，用以提供-k8s-统一的资源配置清单访问入口"><a href="#在运维主机-HDSS7-200-host-com-上，配置一个-nginx-虚拟主机，用以提供-k8s-统一的资源配置清单访问入口" class="headerlink" title="在运维主机 HDSS7-200.host.com 上，配置一个 nginx 虚拟主机，用以提供 k8s 统一的资源配置清单访问入口"></a>在运维主机 <code>HDSS7-200.host.com</code> 上，配置一个 nginx 虚拟主机，用以提供 k8s 统一的资源配置清单访问入口</h3><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;k8s-yaml.od.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.od.com;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text&#x2F;plain;</span><br><span class="line">        root &#x2F;data&#x2F;k8s-yaml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置内网-DNS-解析"><a href="#配置内网-DNS-解析" class="headerlink" title="配置内网 DNS 解析"></a>配置内网 DNS 解析</h3><p><code>HDSS7-11.host.com</code> 上</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">k8s-yaml    60 IN A 10.4.7.200</span><br></pre></td></tr></table></figure>

<p>以后所有的资源配置清单统一放置在运维主机的 <code>/data/k8s-yaml</code> 目录下即可</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="部署-kube-dns-coredns"><a href="#部署-kube-dns-coredns" class="headerlink" title="部署 kube-dns (coredns)"></a>部署 kube-dns (coredns)</h2><h3 id="准备-coredns-v1-3-1-镜像"><a href="#准备-coredns-v1-3-1-镜像" class="headerlink" title="准备 coredns-v1.3.1 镜像"></a>准备 coredns-v1.3.1 镜像</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull coredns&#x2F;coredns:1.3.1</span><br><span class="line">1.3.1: Pulling from coredns&#x2F;coredns</span><br><span class="line">e0daa8927b68: Pull complete </span><br><span class="line">3928e47de029: Pull complete </span><br><span class="line">Digest: sha256:02382353821b12c21b062c59184e227e001079bb13ebd01f9d3270ba0fcbf1e4</span><br><span class="line">Status: Downloaded newer image for coredns&#x2F;coredns:1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag eb516548c180 harbor.od.com&#x2F;k8s&#x2F;coredns:v1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com&#x2F;k8s&#x2F;coredns:v1.3.1</span><br><span class="line">docker push harbor.od.com&#x2F;k8s&#x2F;coredns:v1.3.1</span><br><span class="line">The push refers to a repository [harbor.od.com&#x2F;k8s&#x2F;coredns]</span><br><span class="line">c6a5fc8a3f01: Pushed </span><br><span class="line">fb61a074724d: Pushed </span><br><span class="line">v1.3.1: digest: sha256:e077b9680c32be06fc9652d57f64aa54770dd6554eb87e7a00b97cf8e9431fda size: 739</span><br></pre></td></tr></table></figure>

<p>任意一台运算节点上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server&#x3D;harbor.od.com --docker-username&#x3D;admin --docker-password&#x3D;Harbor12345 --docker-email&#x3D;stanley.wang.m@qq.com -n kube-system</span><br></pre></td></tr></table></figure>

<h4 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h4><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;coredns &amp;&amp; cd &#x2F;data&#x2F;k8s-yaml&#x2F;coredns</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">RBAC</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">ConfigMap</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Deployment</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Service</a></li>
</ul>
<p>vi /data/k8s-yaml/coredns/rbac.yaml</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io&#x2F;cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io&#x2F;autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io&#x2F;bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建"><a href="#依次执行创建" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/coredns">http://k8s-yaml.od.com/coredns</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点上应用资源配置清单</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;coredns&#x2F;rbac.yaml</span><br><span class="line">serviceaccount&#x2F;coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io&#x2F;system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;system:coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;coredns&#x2F;configmap.yaml</span><br><span class="line">configmap&#x2F;coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;coredns&#x2F;deployment.yaml</span><br><span class="line">deployment.extensions&#x2F;coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;coredns&#x2F;svc.yaml</span><br><span class="line">service&#x2F;coredns created</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7ccccdf57c-5b9ch   1&#x2F;1     Running   0          3m4s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 coredns]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53&#x2F;UDP,53&#x2F;TCP   29s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# dig -t A nginx-ds.default.svc.cluster.local. @192.168.0.2 +short</span><br><span class="line">192.168.0.3</span><br></pre></td></tr></table></figure>

<h2 id="部署-traefik（ingress）"><a href="#部署-traefik（ingress）" class="headerlink" title="部署 traefik（ingress）"></a>部署 traefik（ingress）</h2><h3 id="准备-traefik-镜像"><a href="#准备-traefik-镜像" class="headerlink" title="准备 traefik 镜像"></a>准备 traefik 镜像</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull traefik:v1.7-alpine</span><br><span class="line">v1.7-alpine: Pulling from library&#x2F;traefik</span><br><span class="line">bdf0201b3a05: Pull complete </span><br><span class="line">9dfd896cc066: Pull complete </span><br><span class="line">de06b5685128: Pull complete </span><br><span class="line">c4d82a21fa27: Pull complete </span><br><span class="line">Digest: sha256:0531581bde9da0670fc2c7a4e419e1cc38abff74e7ba06410bf2b1b55c70ef15</span><br><span class="line">Status: Downloaded newer image for traefik:v1.7-alpine</span><br><span class="line">[root@hdss7-200 ~]# docker tag 1930b7508541 harbor.od.com&#x2F;k8s&#x2F;traefik:v1.7       </span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com&#x2F;k8s&#x2F;traefik:v1.7</span><br><span class="line">The push refers to a repository [harbor.od.com&#x2F;k8s&#x2F;traefik]</span><br><span class="line">a3e3d574f6ae: Pushed </span><br><span class="line">a7c355c1a104: Pushed </span><br><span class="line">e89059911fc9: Pushed </span><br><span class="line">a464c54f93a9: Mounted from infra&#x2F;apollo-portal </span><br><span class="line">v1.7: digest: sha256:8f92899f5feb08db600c89d3016145e838fa7ff0d316ee21ecd63d9623643410 size: 1157</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;traefik &amp;&amp; cd &#x2F;data&#x2F;k8s-yaml&#x2F;traefik</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">RBAC</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">DaemonSet</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Service</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Ingress</a></li>
</ul>
<p>vi /data/k8s-yaml/traefik/rbac.yaml</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code> 上</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">traefik    60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-1"><a href="#依次执行创建-1" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/traefik">http://k8s-yaml.od.com/traefik</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;traefik&#x2F;rbac.yaml </span><br><span class="line">serviceaccount&#x2F;traefik-ingress-controller created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io&#x2F;traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;traefik&#x2F;daemonset.yaml </span><br><span class="line">daemonset.extensions&#x2F;traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;traefik&#x2F;svc.yaml </span><br><span class="line">service&#x2F;traefik-ingress-service created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;traefik&#x2F;ingress.yaml </span><br><span class="line">ingress.extensions&#x2F;traefik-web-ui created</span><br></pre></td></tr></table></figure>

<h3 id="配置反代"><a href="#配置反代" class="headerlink" title="配置反代"></a>配置反代</h3><p><code>HDSS7-11.host.com</code> 和 <code>HDSS7-12.host.com</code> 两台主机上的 nginx 均需要配置，这里可以考虑使用 saltstack 或者 ansible 进行统一配置管理</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;od.com.conf</span><br><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 10.4.7.21:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails&#x3D;3 fail_timeout&#x3D;10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.od.com;</span><br><span class="line">  </span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a target="_blank" rel="noopener" href="http://traefik.od.com/">http://traefik.od.com</a></p>
<h2 id="部署-dashboard"><a href="#部署-dashboard" class="headerlink" title="部署 dashboard"></a>部署 dashboard</h2><h3 id="准备-dashboard-镜像"><a href="#准备-dashboard-镜像" class="headerlink" title="准备 dashboard 镜像"></a>准备 dashboard 镜像</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull k8scn&#x2F;kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">v1.8.3: Pulling from k8scn&#x2F;kubernetes-dashboard-amd64</span><br><span class="line">a4026007c47e: Pull complete </span><br><span class="line">Digest: sha256:ebc993303f8a42c301592639770bd1944d80c88be8036e2d4d0aa116148264ff</span><br><span class="line">Status: Downloaded newer image for k8scn&#x2F;kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker tag 0c60bcf89900 harbor.od.com&#x2F;k8s&#x2F;dashboard:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com&#x2F;k8s&#x2F;dashboard:v1.8.3</span><br><span class="line">docker push harbor.od.com&#x2F;k8s&#x2F;dashboard:v1.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com&#x2F;k8s&#x2F;dashboard]</span><br><span class="line">23ddb8cbb75a: Pushed </span><br><span class="line">v1.8.3: digest: sha256:e76c5fe6886c99873898e4c8c0945261709024c4bea773fc477629455631e472 size: 529</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p &#x2F;data&#x2F;k8s-yaml&#x2F;dashboard &amp;&amp; cd &#x2F;data&#x2F;k8s-yaml&#x2F;dashboard</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">RBAC</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Secret</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">ConfigMap</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Service</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Ingress</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Deployment</a></li>
</ul>
<p>vi /data/k8s-yaml/dashboard/rbac.yaml</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io&#x2F;mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code> 上</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;named&#x2F;od.com.zone</span><br><span class="line">dashboard    60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-2"><a href="#依次执行创建-2" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/dashboard">http://k8s-yaml.od.com/dashboard</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;rbac.yaml </span><br><span class="line">serviceaccount&#x2F;kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard-admin created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io&#x2F;kubernetes-dashboard-admin created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;secret.yaml </span><br><span class="line">secret&#x2F;kubernetes-dashboard-certs created</span><br><span class="line">secret&#x2F;kubernetes-dashboard-key-holder created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;configmap.yaml </span><br><span class="line">configmap&#x2F;kubernetes-dashboard-settings created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;svc.yaml </span><br><span class="line">service&#x2F;kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;ingress.yaml </span><br><span class="line">ingress.extensions&#x2F;kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;deployment.yaml </span><br><span class="line">deployment.apps&#x2F;kubernetes-dashboard created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a target="_blank" rel="noopener" href="http://dashboard.od.com/">http://dashboard.od.com</a></p>
<h3 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h3><ul>
<li>下载新版 dashboard</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull hexun&#x2F;kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9aed6605b81 harbor.od.com&#x2F;k8s&#x2F;dashboard:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com&#x2F;k8s&#x2F;dashboard:v1.10.1</span><br></pre></td></tr></table></figure>

<ul>
<li>应用新版 dashboard</li>
<li>修改 nginx 配置，走 https</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;dashboard.od.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https:&#x2F;&#x2F;$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs&#x2F;dashboard.od.com.crt&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs&#x2F;dashboard.od.com.key&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;default_backend_traefik;</span><br><span class="line">          proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取 token</li>
</ul>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdsss7-21 ~]# kubectl describe secret kubernetes-dashboard-admin-token-rhr62 -n kube-system</span><br><span class="line">Name:         kubernetes-dashboard-admin-token-rhr62</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io&#x2F;service-account.name: kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io&#x2F;service-account.uid: cdd3c552-856d-11e9-ae34-782bcb321c07</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io&#x2F;service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">ca.crt:     1354 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1yaHI2MiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNkZDNjNTUyLTg1NmQtMTFlOS1hZTM0LTc4MmJjYjMyMWMwNyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.72OcJZCm_3I-7QZcEJTRPyIJSxQwSwZfVsB6Bx_RAZRJLOv3-BXy88PclYgxRy2dDqeX6cpjvFPBrmNOGQoxT9oD8_H49pvBnqdCdNuoJbXK7aBIZdkZxATzXd-63zmhHhUBsM3Ybgwy5XxD3vj8VUYfux5c5Mr4TzU_rnGLCj1H5mq_JJ3hNabv0rwil-ZAV-3HLikOMiIRhEK7RdMs1bfXF2yvse4VOabe9xv47TvbEYns97S4OlZvsurmOk0B8dD85OSaREEtqa8n_ND9GrHeeL4CcALqWYJHLrr7vLfndXi1QHDVrUzFKvgkAeYpDVAzGwIWL7rgHwp3sQguGA</span><br></pre></td></tr></table></figure>

<h2 id="部署-heapster"><a href="#部署-heapster" class="headerlink" title="部署 heapster"></a>部署 heapster</h2><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-retired/heapster">heapster 官方 github 地址</a></p>
<h3 id="准备-heapster-镜像"><a href="#准备-heapster-镜像" class="headerlink" title="准备 heapster 镜像"></a>准备 heapster 镜像</h3><p>运维主机 <code>HDSS7-200.host.com</code> 上</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull quay.io&#x2F;bitnami&#x2F;heapster:1.5.4</span><br><span class="line">1.5.4: Pulling from bitnami&#x2F;heapster</span><br><span class="line">4018396ca1ba: Pull complete </span><br><span class="line">0e4723f815c4: Pull complete </span><br><span class="line">d8569f30adeb: Pull complete </span><br><span class="line">Digest: sha256:6d891479611ca06a5502bc36e280802cbf9e0426ce4c008dd2919c2294ce0324</span><br><span class="line">Status: Downloaded newer image for quay.io&#x2F;bitnami&#x2F;heapster:1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker tag c359b95ad38b harbor.od.com&#x2F;k8s&#x2F;heapster:v1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com&#x2F;k8s&#x2F;heapster:v1.5.4</span><br><span class="line">The push refers to a repository [harbor.od.com&#x2F;k8s&#x2F;heapster]</span><br><span class="line">20d37d828804: Pushed </span><br><span class="line">b9b192015e25: Pushed </span><br><span class="line">b76dba5a0109: Pushed </span><br><span class="line">v1.5.4: digest: sha256:1203b49f2b2b07e02e77263bce8bb30563a91e1d7ee7c6742e9d125abcb3abe6 size: 952</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">RBAC</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Deployment</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.stanley.wang/2019/01/18/">Service</a></li>
</ul>
<p>vi /data/k8s-yaml/dashboard/heapster/rbac.yaml</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:heapster</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<p>复制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;heapster&#x2F;rbac.yaml </span><br><span class="line">serviceaccount&#x2F;heapster created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io&#x2F;heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;heapster&#x2F;deployment.yaml </span><br><span class="line">deployment.extensions&#x2F;heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard&#x2F;heapster&#x2F;svc.yaml </span><br><span class="line">service&#x2F;heapster created</span><br></pre></td></tr></table></figure>

<h3 id="重启-dashboard"><a href="#重启-dashboard" class="headerlink" title="重启 dashboard"></a>重启 dashboard</h3><p>浏览器访问：<a target="_blank" rel="noopener" href="http://dashboard.od.com/">http://dashboard.od.com</a><br><img src="https://blog.stanley.wang/images/heapster.png" alt="加入heapster插件的dashboard"><a target="_blank" rel="noopener" href="https://www.kococ.cn/tag/K8s/">K8s</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Prous</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/01/12/%E5%AE%9E%E9%AA%8C%E6%96%87%E6%A1%A3-1%EF%BC%9A%E8%B7%9F%E6%88%91%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6/">http://yoursite.com/2020/01/12/%E5%AE%9E%E9%AA%8C%E6%96%87%E6%A1%A3-1%EF%BC%9A%E8%B7%9F%E6%88%91%E4%B8%80%E6%AD%A5%E6%AD%A5%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2-kubernetes-%E9%9B%86%E7%BE%A4%E4%BA%8C%E8%BF%9B%E5%88%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">Prous</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/K8s/">K8s</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/01/12/mysql%E8%BF%9B%E9%98%B6%E4%B9%8B%E8%B7%AF%E5%88%9D%E7%BA%A7dba%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89/"><img class="prev-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL进阶之路初级DBA（十二）</div></div></a></div><div class="next-post pull-right"><a href="/2020/01/12/jenkins%EF%BC%88ca-ci%EF%BC%89%E9%83%A8%E7%BD%B2/"><img class="next-cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/4-4.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jenkins（CA/CI）部署</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/10/认识-k8s/" title="Kubernetes入门"><img class="relatedPosts_cover" data-lazy-src="https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-10</div><div class="relatedPosts_title">Kubernetes入门</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/kococ/IMAGE/1-1.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By Prous</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="icp"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/"><img class="icp-icon" src="/img/icp.png"/><span>豫ICP备20001100号</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    window.valine = new Valine({
      el: '#vcomment',
      appId: '',
      appKey: '',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    });
    if ('nick,mail') { valine.config.requiredFields= 'nick,mail'.split(',') }
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer="defer" id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script></div></body></html>